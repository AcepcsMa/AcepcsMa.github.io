<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-consistent-hash" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/17/consistent-hash/" class="article-date">
  <time datetime="2018-03-17T20:30:01.000Z" itemprop="datePublished">2018-03-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ç®—æ³•/">ç®—æ³•</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/17/consistent-hash/">ä¸€è‡´æ€§Hashç®—æ³•â€”â€”åˆ†æä¸æ¨¡æ‹Ÿ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªå­˜å‚¨é›†ç¾¤â€”â€”<code>Cluster_A</code>ï¼Œ<code>Cluster_A</code>åŒ…å«äº†<code>N</code>ä¸ªå­˜å‚¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šå­˜å‚¨äº†å¤§é‡æ•°æ®ã€‚é‚£ä¹ˆåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ–°è¿›å…¥é›†ç¾¤çš„æ•°æ®ä¼šè¢«è®¡ç®—å‡ºå…¶å¯¹åº”çš„Hashå€¼ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¢«åˆ†é…åˆ°æŸä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šã€‚æœ€å¸¸è§çš„åˆ†é…ç­–ç•¥å¦‚ä¸‹ï¼š</p>
<pre><code>// sha256æˆ–è€…md5å‡ä¸ºå¸¸è§çš„hashå‡½æ•°
node_id = hash(data) % N
</code></pre><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ç§æ•°æ®åˆ†é…ç­–ç•¥çš„æ€§èƒ½å–å†³äºhashç®—æ³•çš„æ€§èƒ½ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºä»€ä¹ˆå¤§é—®é¢˜ã€‚ä½†æ˜¯å¾€å¾€åœ¨ä¸€ä¸ªå¤§é›†ç¾¤ä¸­ä¼šå‡ºç°<strong>å¢ï¼åˆ èŠ‚ç‚¹</strong>çš„éœ€æ±‚ï¼Œè¯•æƒ³å½“<code>N</code>å˜æˆ<code>N+1</code>æˆ–<code>N-1</code>æ—¶ï¼Œæ•°æ®æ‰€å¯¹åº”çš„æ–°<code>node_id</code>å¤§æ¦‚ç‡ä¼šä¸åŸ<code>node_id</code>ä¸ä¸€æ ·ã€‚é‚£ä¹ˆç”¨æˆ·æƒ³ä»é›†ç¾¤è¯»æ•°æ®æ—¶å°±ä¼šæ‰¾ä¸åˆ°è¯¥æ•°æ®ï¼Œå› ä¸ºç®—å‡ºæ¥çš„æ–°<code>node_id</code>ä¸æ•°æ®çœŸæ­£å­˜å‚¨çš„<code>node_id</code>ä¸ä¸€æ ·äº†ã€‚</p>
<pre><code>// åŸdata_1æ‰€å±çš„node_id = 50
// data_1è¢«å­˜åœ¨50å·èŠ‚ç‚¹ä¸Š
node_id1 = hash(data_1) % N = 50 

// å¢åŠ ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹ådata_1å¯¹åº”çš„node_id
// ç”¨æˆ·è¯»å–data_1æ—¶ï¼Œç³»ç»Ÿç®—å‡ºåº”è¯¥å»30å·èŠ‚ç‚¹å–æ•°æ®ï¼Œå¯¼è‡´è¯»å–å¤±è´¥
node_id1 = hash(data_1) % (N+1) = 30
</code></pre><p>ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸ä¸¢å¤±ï¼Œåœ¨å¢ï¼åˆ èŠ‚ç‚¹å‘ç”Ÿåï¼Œéœ€è¦å¯¹é›†ç¾¤é‡Œçš„æ‰€æœ‰æ•°æ®è¿›è¡Œ<strong>é‡æ–°Hash</strong>ï¼Œä»¥è¿›è¡Œæ•°æ®çš„é‡æ–°åˆ†é…ã€‚<strong>ç„¶è€Œï¼Œå¦‚æœæ¯æ¬¡å¢ï¼åˆ èŠ‚ç‚¹éƒ½å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œé‡åˆ†é…ï¼Œç³»ç»Ÿå¼€é”€å°†ä¼šæ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—ï¼Œåœ¨å®é™…å·¥ç¨‹ä¸­éš¾ä»¥æ‰¿å—ï¼Œæ€»ä¸å¯èƒ½è®©ç”¨æˆ·ç­‰å¾…å‡ ååˆ†é’Ÿçš„é‡Hashè¿‡ç¨‹æ‰èƒ½æˆåŠŸè¯»å–æ•°æ®å§</strong>ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§ç‰¹æ®Šçš„è§£å†³æ–¹æ¡ˆâ€”â€”<strong><em>ä¸€è‡´æ€§Hashç®—æ³•</em></strong>æ¨ªç©ºå‡ºä¸–ã€‚</p>
<h2 id="ç®—æ³•è¯¦è§£"><a href="#ç®—æ³•è¯¦è§£" class="headerlink" title="ç®—æ³•è¯¦è§£"></a>ç®—æ³•è¯¦è§£</h2><p><strong>ä¸€è‡´æ€§Hashç®—æ³•çš„æ ¸å¿ƒï¼Œæ˜¯æŠŠèŠ‚ç‚¹æœ¬èº«ä¹Ÿæ˜ å°„åˆ°å’Œæ•°æ®ä¸€è‡´çš„Hashç©ºé—´ã€‚</strong> è¿™å¥è¯å¬èµ·æ¥ä¼¼ä¹æœ‰ç‚¹æ‹—å£ï¼Œ<strong>ç®€å•è€Œè¨€å°±æ˜¯ä½¿ç”¨ä¸€æ ·çš„Hashæ–¹æ³•ï¼Œä¸ä»…å¯¹æ•°æ®è¿›è¡ŒHashï¼ŒåŒæ—¶ä¹Ÿå¯¹èŠ‚ç‚¹è¿›è¡ŒHashã€‚</strong>é€šè¿‡è¿™æ ·åšï¼Œå°±èƒ½å°†æ•°æ®å’ŒèŠ‚ç‚¹æ”¾ç½®åˆ°ä¸€ä¸ªç©ºé—´ä¸­ï¼Œå‡è®¾<code>hash(x)</code>çš„å€¼åŸŸä¸º<code>[0, M]</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥ç”¨ä¸€ä¸ªäºŒç»´çš„ç¯è¡¨ç¤ºæ­¤Hashç©ºé—´ã€‚ç„¶åå¯¹æ¯ä¸€æ¡æ•°æ®<code>data</code>è®¡ç®—<code>hash(data)</code>ï¼ŒæŠŠæ•°æ®æ”¾ç½®åˆ°ç¯ä¸Šé¡ºæ—¶é’ˆæ–¹å‘æœ€è¿‘çš„èŠ‚ç‚¹è¿›è¡Œå­˜å‚¨ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/consistent_hash.png" alt=""></p>
<ul>
<li><p>æ­£å¸¸æƒ…å†µï¼ˆæ— èŠ‚ç‚¹å¢åˆ ï¼‰ å‡è®¾é›†ç¾¤å†…èŠ‚ç‚¹æ•°é‡<code>N = 100</code>ï¼Œæ•°æ®æ¡æ•°<code>DATA_COUNT = 100000</code>ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœHashç®—æ³•çš„ç»“æœæ˜¯å‡åŒ€çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹åº”è¯¥å­˜å‚¨<code>100000 / 100 = 1000</code>æ¡æ•°æ®ã€‚ä¸ºæ­¤æˆ‘ç”¨Pythonå†™äº†ä¸€ä¸ªæ¨¡æ‹Ÿç¨‹åºã€‚</p>
<pre><code># encoding=utf-8
from struct import unpack_from
from hashlib import md5
import matplotlib.pyplot as plt

NUM_NODES = 100
NUM_DATA = 100000
nodes = [0 for i in range(NUM_NODES)]

# hash function
def hash(data):
    data_md5 = md5(str(data)).digest()
    return unpack_from(&quot;=I&quot;, data_md5)[0]

# distribute data to different nodes
def distribute():
    for data in range(NUM_DATA):
        h = hash(data)
        index = h % NUM_NODES
        nodes[index] += 1

if __name__ == &apos;__main__&apos;:
    &apos;&apos;&apos;
        Case 1: æ­£å¸¸æƒ…å†µä¸‹çš„æ•°æ®åˆ†å¸ƒ
    &apos;&apos;&apos;

    distribute()
    max_node = max(nodes)
    min_node = min(nodes)
    print (&quot;Node with max data: {0} piece of data&quot;.format(max_node))
    print (&quot;Node with min data: {0} piece of data&quot;.format(min_node))

    # plot scatter graph
    x = [i for i in range(NUM_NODES)]
    y = nodes
    plt.scatter(x, y, c=&apos;r&apos;)
    plt.yticks(range(0, 2 * NUM_DATA / NUM_NODES, 100))
    plt.xlabel(&quot;Node Index&quot;)
    plt.ylabel(&quot;Data Count&quot;)
    plt.show()
</code></pre></li>
</ul>
<pre><code>ç»è¿‡æ¨¡æ‹Ÿï¼Œå¾—åˆ°å¦‚ä¸‹çš„æ•°æ®åˆ†å¸ƒæ•£ç‚¹å›¾ï¼š ![](https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/common.png) å¯ä»¥çœ‹å‡ºæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å‡åœ¨`1000`ä¸Šä¸‹æµ®åŠ¨ï¼Œå·®è·ä¸å¤§ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å‡åŒ€åˆ†å¸ƒã€‚
</code></pre><ul>
<li><p>å¢åŠ ï¼åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹</p>
<pre><code># encoding=utf-8
from struct import unpack_from
from hashlib import md5

LESS_NUM_NODES = 99         # less nodes
ORIGINAL_NUM_NODES = 100    # original nodes
MORE_NUM_NODES = 101        # more nodes
NUM_DATA = 100000

# hash function
def hash(data):
    data_md5 = md5(str(data)).digest()
    return unpack_from(&quot;=I&quot;, data_md5)[0]

# distribute data to more nodes
def distribute_more():
    transfer_count = 0
    for data in range(NUM_DATA):
        h = hash(data)
        original_index = h % ORIGINAL_NUM_NODES
        more_index = h % MORE_NUM_NODES
        if original_index != more_index:
            transfer_count += 1
    return transfer_count

# distribute data to less nodes
def distribute_less():
    transfer_count = 0
    for data in range(NUM_DATA):
        h = hash(data)
        original_index = h % ORIGINAL_NUM_NODES
        less_index = h % LESS_NUM_NODES
        if original_index != less_index:
            transfer_count += 1
    return transfer_count

if __name__ == &apos;__main__&apos;:
    &apos;&apos;&apos;
        Case 2: å½“å‡ºç°å¢/åˆ èŠ‚ç‚¹æ—¶çš„æ•°æ®åˆ†å¸ƒæƒ…å†µ
    &apos;&apos;&apos;

    # æ–°å¢èŠ‚ç‚¹
    transfer_count = distribute_more()
    print(&quot;##### When one new node is added #####&quot;)
    print(&quot;Data that need to be transferred: {}&quot;.format(transfer_count))
    print(&quot;Percentage of data that need to be transferred: {}%&quot;.format(transfer_count * 100.0 / NUM_DATA))

    # åˆ é™¤èŠ‚ç‚¹
    transfer_count = distribute_less()
    print(&quot;\n##### When one old node is deleted #####&quot;)
    print(&quot;Data that need to be transferred: {}&quot;.format(transfer_count))
    print(&quot;Percentage of data that need to be transferred: {}%&quot;.format(transfer_count * 100.0 / NUM_DATA))
</code></pre></li>
</ul>
<p>æ•°æ®è¿ç§»æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case2.png" alt=""> å¯ä»¥çœ‹åˆ°ï¼Œå°†èŠ‚ç‚¹ä¸ªæ•°ä»<code>N</code>å¢åŠ åˆ°<code>N+1</code>åæˆ–ä»<code>N</code>å‡å°‘åˆ°<code>N-1</code>åï¼Œæœ‰å·®ä¸å¤š<code>99%</code>çš„æ•°æ®ç»è¿‡é‡Hashåéƒ½è¦è¿›è¡Œæ•°æ®è¿ç§»ï¼Œè¿™æ ·çš„æ•°æ®è¿ç§»å‹åŠ›ç»å¯¹æ˜¯æ— æ³•æ‰¿å—çš„ã€‚</p>
<ul>
<li><p>åº”ç”¨ä¸€è‡´æ€§Hashç®—æ³•åæ•°æ®è¿ç§»æƒ…å†µ</p>
<h1 id="encoding-utf-8"><a href="#encoding-utf-8" class="headerlink" title="encoding=utf-8"></a>encoding=utf-8</h1><p>from struct import unpack_from<br>from hashlib import md5<br>from bisect import bisect_left</p>
<p>ORIGINAL_NUM_NODES = 100    # original node count<br>NEW_NUM_NODES = 101         # new node count<br>NUM_DATA = 100000</p>
<h1 id="hash-function"><a href="#hash-function" class="headerlink" title="hash function"></a>hash function</h1><p>def hash(data):</p>
<pre><code>data_md5 = md5(str(data)).digest()
return unpack_from(&quot;=I&quot;, data_md5)[0]
</code></pre><h1 id="distribute-data-to-different-nodes"><a href="#distribute-data-to-different-nodes" class="headerlink" title="distribute data to different nodes"></a>distribute data to different nodes</h1><p>def distribute(original_nodes, new_nodes):</p>
<pre><code>transfer_count = 0
for data in range(NUM_DATA):
    h = hash(data)
    original_index = bisect_left(original_nodes, h) % ORIGINAL_NUM_NODES
    new_index = bisect_left(new_nodes, h) % NEW_NUM_NODES
    if original_index != new_index:
        transfer_count += 1
return transfer_count
</code></pre><p>if <strong>name</strong> == â€˜<strong>main</strong>â€˜:</p>
<pre><code>&apos;&apos;&apos;
    Case 3: åº”ç”¨ä¸€è‡´æ€§Hashå, éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ¯”ä¾‹
&apos;&apos;&apos;

original_nodes = sorted([hash(i) for i in range(ORIGINAL_NUM_NODES)])   # å¯¹nodeæœ¬èº«ä¹Ÿå–hash
new_nodes = sorted([hash(i) for i in range(NEW_NUM_NODES)])             # å¯¹nodeæœ¬èº«ä¹Ÿå–hash

transfer_count = distribute(original_nodes, new_nodes)
print(&quot;Percentage of data that need to be transferred: {}%&quot;.format(transfer_count * 100.0 / NUM_DATA))
</code></pre></li>
</ul>
<p>æ•°æ®è¿ç§»æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case3.png" alt=""> å®ç°äº†ä¸€è‡´æ€§Hashç®—æ³•åï¼Œæˆ‘ä»¬å°†èŠ‚ç‚¹ä¹Ÿæ˜ å°„åˆ°äº†åŒä¸€ç‰‡Hashç©ºé—´ï¼ŒæˆåŠŸåœ°å°†æ•°æ®è¿ç§»çš„æ¯”ä¾‹ä»<code>99%</code>é™ä½åˆ°<code>37%</code>å·¦å³ã€‚</p>
<ul>
<li><p>åº”ç”¨ä¸€è‡´æ€§Hashç®—æ³•åæ•°æ®åˆ†å¸ƒæƒ…å†µ</p>
<h1 id="encoding-utf-8-1"><a href="#encoding-utf-8-1" class="headerlink" title="encoding=utf-8"></a>encoding=utf-8</h1><p>from struct import unpack_from<br>from hashlib import md5<br>from bisect import bisect_left<br>import matplotlib.pyplot as plt</p>
<p>NUM_NODES = 100    # original node count<br>NUM_DATA = 100000</p>
<h1 id="hash-function-1"><a href="#hash-function-1" class="headerlink" title="hash function"></a>hash function</h1><p>def hash(data):</p>
<pre><code>data_md5 = md5(str(data)).digest()
return unpack_from(&quot;=I&quot;, data_md5)[0]
</code></pre><h1 id="distribute-data-to-different-nodes-1"><a href="#distribute-data-to-different-nodes-1" class="headerlink" title="distribute data to different nodes"></a>distribute data to different nodes</h1><p>def distribute(nodes, stat):</p>
<pre><code>for data in range(NUM_DATA):
    h = hash(data)
    index = bisect_left(nodes, h) % NUM_NODES
    stat[index] += 1
</code></pre></li>
</ul>
<pre><code>if __name__ == &apos;__main__&apos;:
    &apos;&apos;&apos;
        Case 4: åº”ç”¨ä¸€è‡´æ€§Hashå, æ•°æ®çš„åˆ†å¸ƒæƒ…å†µ
    &apos;&apos;&apos;

    nodes = sorted([hash(i) for i in range(NUM_NODES)])
    stat = [0 for i in range(NUM_NODES)]

    distribute(nodes, stat)
    max = max(stat)
    min = min(stat)
    print(&quot;Node with max data: {} piece of data&quot;.format(max))
    print(&quot;Node with min data: {} piece of data&quot;.format(min))

    # plot scatter graph
    x = [i for i in range(NUM_NODES)]
    y = stat
    plt.scatter(x, y, c=&apos;r&apos;)
    plt.yticks(range(0, 10 * NUM_DATA / NUM_NODES, 1000))
    plt.xlabel(&quot;Node Index&quot;)
    plt.ylabel(&quot;Data Count&quot;)
    plt.show()
</code></pre><p>åº”ç”¨ä¸€è‡´æ€§Hashåï¼Œæ•°æ®åˆ†å¸ƒæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case4.png" alt=""> å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”æœŸæœ›å€¼<code>1000</code>ï¼Œå‡ºç°äº†åç§»çš„æ•°æ®ï¼Œå­˜åœ¨å¾ˆå¤šä½äº<code>1000</code>æ¡æ•°æ®çš„èŠ‚ç‚¹ã€‚è™½ç„¶æ•°æ®è¿ç§»ç‡é™ä½äº†ï¼Œä½†æ˜¯å‡ºç°äº†å¦ä¸€ä¸ªé—®é¢˜â€”â€”<strong>æ— æ³•å……åˆ†åˆ©ç”¨é›†ç¾¤ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œé€ æˆäº†æ•°æ®ä¸å¹³è¡¡</strong>ã€‚</p>
<ul>
<li>ä¸€è‡´æ€§Hashç®—æ³•â€”â€”è§£å†³æ•°æ®ä¸å¹³è¡¡</li>
</ul>
<p>æ•°æ®ä¸å¹³è¡¡é—®é¢˜ï¼Œæ ¹æœ¬åŸå› å°±åœ¨äºå¯¹èŠ‚ç‚¹è¿›è¡ŒHashåï¼Œå®ƒä»¬çš„Hashå€¼åœ¨ç¯ä¸Šåˆ†å¸ƒä¸å¤Ÿå‡åŒ€ã€‚é‚£ä¹ˆä¸ºäº†â€œåˆ†å¸ƒå‡åŒ€â€ï¼Œè‡ªç„¶è€Œç„¶æˆ‘ä»¬å¯ä»¥åœ¨ç¯ä¸Šç¨€ç–çš„åŒºåŸŸå¤šæ·»åŠ ä¸€äº›â€œå‡â€èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<strong>è™šæ‹ŸèŠ‚ç‚¹ï¼ˆVirtual Nodeï¼‰</strong>ï¼Œä»¥å°†ç¨€ç–çš„åŒºåŸŸå¡«å……å¾—æ»¡ä¸€ç‚¹ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/v_node.png" alt=""> å¦‚å›¾æ‰€ç¤ºï¼Œé€šè¿‡åœ¨ç¨€ç–åŒºåŸŸå¢åŠ <strong>è™šæ‹ŸèŠ‚ç‚¹ï¼ˆVirtual Nodeï¼‰</strong>ï¼ŒåŸæœ¬ä»‹äº<code>Node #3</code>å’Œ<code>data #1</code>é—´çš„æ•°æ®å¯ä»¥è¢«â€œå­˜å‚¨â€åœ¨<code>V-Node #2</code>æˆ–è€…<code>V-Node #1</code>ä¸Šã€‚å†é€šè¿‡æŸ¥è¯¢<code>V-Node</code>åˆ°<code>Node</code>çš„æ˜ å°„å…³ç³»ï¼Œå³å¯ä»å®é™…çš„å­˜å‚¨èŠ‚ç‚¹å–å‡ºæ•°æ®ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/v_node_query.png" alt=""> é€šè¿‡ä¿å­˜<code>V-Node</code>åˆ°<code>Node</code>çš„<code>mapping</code>ï¼Œå¯ä»¥è¿…é€Ÿå®šä½åˆ°å®é™…å­˜å‚¨èŠ‚ç‚¹ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸€è‡´æ€§Hashç®—æ³•ï¼Œæ ¸å¿ƒåœ¨äºè§£å†³é›†ç¾¤èŠ‚ç‚¹å¢åˆ åœºæ™¯ä¸‹çš„æ•°æ®ä¸¢å¤± &amp; å¤§é‡æ•°æ®è¿ç§»é—®é¢˜ã€‚å®ç°çš„å…³é”®æ˜¯å°†èŠ‚ç‚¹æœ¬èº«ä¹Ÿé€šè¿‡Hashå‡½æ•°æ˜ å°„åˆ°æ•°æ®æ‰€åœ¨çš„Hashç©ºé—´ï¼Œä»è€Œä½¿æ•°æ®èƒ½å¤Ÿåœ¨æŸä¸€å›ºå®šç©ºé—´å†…ä½œâ€œç‰©ç†æ€§â€ï¼ˆé¡ºæ—¶é’ˆã€é€†æ—¶é’ˆâ€¦â€¦ï¼‰çš„ä½ç½®åˆ†é…ã€‚</p>
<h2 id="ç›¸å…³ä»£ç "><a href="#ç›¸å…³ä»£ç " class="headerlink" title="ç›¸å…³ä»£ç "></a>ç›¸å…³ä»£ç </h2><p>å…·ä½“ä»£ç è¯·æŸ¥çœ‹<a href="https://github.com/AcepcsMa/Consistent_Hash" target="_blank" rel="noopener">æˆ‘çš„Githubç›®å½•</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/17/consistent-hash/" data-id="cjpg78r6u002mbxuyaacg9z76" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/æ•°æ®ç»“æ„/">æ•°æ®ç»“æ„</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ç®—æ³•/">ç®—æ³•</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-join-di" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/04/join-di/" class="article-date">
  <time datetime="2018-03-04T23:08:53.000Z" itemprop="datePublished">2018-03-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/04/join-di/">æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>æœ¬æ–‡100%ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p><code>join</code>æ“ä½œåœ¨ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ä¸­ç‰¹åˆ«å¸¸è§ï¼Œå¾€å¾€ç”¨æ¥è¿æ¥ä¸¤å¼ æˆ–å¤šå¼ åœ¨æŸäº›é”®ä¸Šæœ‰å…³è”çš„è¡¨ã€‚ä½†å½“æˆ‘ä»¬çš„æ•°æ®å¹¶æ²¡æœ‰è¢«ç»“æ„åŒ–å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰‹ä¸Šä»…æœ‰å¤§é‡çš„<strong><em>raw data</em></strong> â€”â€” æˆåƒä¸Šä¸‡ä¸ªç£ç›˜æ•°æ®æ–‡ä»¶ï¼ˆå¦‚.datæˆ–.txtï¼‰æ—¶ï¼Œåˆæˆ–è€…å½“å¤§é‡çš„æ•°æ®æ–‡ä»¶å­˜æ”¾åœ¨åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆHDFSï¼‰é‡Œï¼Œéš¾ä»¥å°†å…¶é«˜æ•ˆå¯¼å…¥MySQLä¸­æ—¶ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°å°±ä¼šæ€è€ƒï¼š<strong>æœ‰æ²¡æœ‰ä¸éœ€è¦ä¾é å…³ç³»å‹æ•°æ®åº“è€Œå®ç°çš„joinå‘¢ï¼Ÿå¯¹äºæµ·é‡æ–‡ä»¶èƒ½ä¸èƒ½ç”¨Map-Reduceå®ç°joinæ“ä½œå‘¢ï¼Ÿ</strong> å‡è®¾ç°åœ¨ç³»ç»Ÿä¸­æœ‰ä¸¤ç±»æ•°æ®æ–‡ä»¶ï¼š</p>
<ol>
<li><strong><em>ç”¨æˆ·æ•°æ®æ–‡ä»¶ï¼ˆUserï¼‰</em></strong></li>
<li><p><strong><em>è®¢å•æ•°æ®æ–‡ä»¶ï¼ˆOrderï¼‰</em></strong></p>
<p>// useræ–‡ä»¶ç»“æ„<br>user_id, user_name, phone</p>
<pre><code>1,      aa,     10086
2,      bb,     10010
......
</code></pre><p>// orderæ–‡ä»¶ç»“æ„<br>order_id, user_id,  price,  date</p>
<pre><code>1,      1,      15.5    2018-01-01
2,      1,      3.9     2018-01-01
3,      1,      26.0    2018-01-03
4,      2,      2.2     2018-01-04
......
</code></pre></li>
</ol>
<p>éœ€æ±‚æ˜¯å°†<strong><em>ç”¨æˆ·æ•°æ®æ–‡ä»¶ï¼ˆUserï¼‰</em></strong>å’Œ<strong><em>è®¢å•æ•°æ®æ–‡ä»¶ï¼ˆOrderï¼‰</em></strong>é€šè¿‡<code>user_id</code>é”®ç›¸å…³è”ï¼Œå¾—åˆ°æ€»çš„ç”¨æˆ·ä¿¡æ¯+ç”¨æˆ·è®¢å•ä¿¡æ¯çš„æ€»â€œè¡¨â€ï¼ˆä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„å†…å®¹å¯çœ‹ä½œè¡¨çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚</p>
<pre><code>// æœŸæœ›å¾—åˆ°çš„æ€»è¡¨ç»“æ„
user_id, user_name, phone, order_id, price, date
    1,      aa,     10086,      1,    15.5, 2018-01-01
    ......  
</code></pre><p>æœ¬æ–‡å°†åŸºäºä»¥ä¸Šéœ€æ±‚ï¼Œå¯¹Map-Reduceå®ç°ä¸¤è¡¨å…³è”ï¼ˆjoinï¼‰è¿›è¡Œæ¢è®¨ã€‚</p>
<h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>è¦åˆ©ç”¨Map-Reduceå®ç°ä¸¤è¡¨å…³è”ï¼Œå…³é”®ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ol>
<li><p>å¦‚ä½•è¾¨åˆ«å½“å‰å¤„ç†çš„æ•°æ®æ¥è‡ªäº<strong><em>Userè¡¨</em></strong>è¿˜æ˜¯<strong><em>Orderè¡¨</em></strong> å› ä¸ºä¸¤ç§æ–‡ä»¶æœ‰ä¸åŒçš„æ•°æ®æ ¼å¼ï¼Œæˆ‘ä»¬åœ¨Mapperé‡Œå¯¹æ•°æ®é€è¡Œè¿›è¡Œå¤„ç†æ—¶ï¼Œå¿…é¡»è¦çŸ¥é“å½“å‰è¿™è¡Œæ•°æ®æ¥è‡ªäº<strong><em>Userè¡¨</em></strong>è¿˜æ˜¯<strong><em>Orderè¡¨</em></strong>ï¼Œ ä¸ç„¶æ ¹æœ¬æ²¡æœ‰åŠæ³•ç¼–å†™è¿›ä¸€æ­¥çš„å¤„ç†é€»è¾‘ã€‚å…¶å®çœ‹è¿‡æˆ‘ä¹‹å‰æ–‡ç« çš„åŒå­¦åº”è¯¥è§è¿‡åœ¨Mapperé‡Œè·å–å½“å‰æ•°æ®æ‰€å±æ–‡ä»¶åçš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯<strong><em>mapæ–¹æ³•</em></strong>çš„<code>Context</code>å‚æ•°å…¶å®å¸¦æœ‰äº†å¾ˆå¤šæœ¬æ¬¡Jobçš„è¿è¡Œä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†å½“å‰æ•°æ®æ¥è‡ªäºå“ªä¸ª<code>FileSplit</code>ï¼Œè¿›ä¸€æ­¥å¯ä»¥è·å¾—è¯¥<code>FileSplit</code>æ‰€å±çš„æ–‡ä»¶åã€‚</p>
<pre><code>FileSplit fileSplit = (FileSplit)context.getInputSplit();
String fileName = fileSplit.getPath().getName();
</code></pre></li>
</ol>
<ol start="2">
<li><p>æœ‰ä¸¤ç§ä¸åŒçš„æ•°æ®æ–‡ä»¶ï¼Œå¯æ˜¯ä¸€ä¸ªMRä»»åŠ¡é‡Œåªæœ‰ä¸€ç§K-Vå¯¹å®šä¹‰ ä¸¤ç§æ–‡ä»¶æ ¼å¼ï¼Œä¸€ç§K-Vå¯¹å®šä¹‰ï¼Œé‚£å¾ˆè‡ªç„¶æˆ‘ä»¬å°±è¦æƒ³æƒ³å¦‚ä½•å°†ä¸¤ç§â€œåˆå¹¶â€æˆä¸€ç§ï¼ŒåŒæ—¶è¿˜èƒ½éšæ—¶å°†è¿™ä¸ªåˆå¹¶çš„äº§ç‰©åˆ†å¼€æˆä¸¤ç§ã€‚å…¶å®ä¹‹å‰çš„æ–‡ç« å·²ç»å¤šæ¬¡æåŠä¸€ç§åœ¨Map-Reduceé‡Œå¸¸ç”¨çš„æ¦‚å¿µâ€”â€”<strong>è‡ªå®šä¹‰JavaBean</strong>ï¼Œä½œä¸ºä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œå®ƒçš„å¤åˆæ€§è´¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬â€œé›†æˆâ€å¾ˆå¤šåŸç”Ÿæ•°æ®ç±»å‹ã€‚åœ¨å½“å‰é—®é¢˜é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª<code>JavaBean</code>ï¼Œ<strong>é›†æˆUserè¡¨ä¸Orderè¡¨çš„æ‰€æœ‰å­—æ®µ</strong>ï¼Œå¹¶é¢å¤–æ·»åŠ ä¸€ä¸ª<code>flag</code>å­—æ®µç”¨ä»¥è¡¨æ˜å®ä¾‹å¯¹è±¡æ˜¯<code>User</code>æ•°æ®è¿˜æ˜¯<code>Order</code>æ•°æ®ã€‚é€šè¿‡è¿™ä¸ª<code>JavaBean</code>å°±å¯ä»¥å®ç°â€œåˆå¹¶ä¸”éšæ—¶å¯åˆ†ç¦»â€çš„éœ€æ±‚äº†ã€‚</p>
<pre><code>JavaBean = {user_id, order_id, user_name, phone, price, date}
</code></pre></li>
</ol>
<ol start="3">
<li><p><strong><em>â€œjoinâ€</em></strong>çš„é€»è¾‘å…·ä½“æ€ä¹ˆå†™ åŸºäºç¬¬2ç‚¹ï¼Œå®ç°äº†ä¸€ä¸ªé›†æˆçš„JavaBeanåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨mapä¸­å°†æ•°æ®å°è£…æˆJavaBeanå®ä¾‹å¯¹è±¡ï¼Œç„¶åç”¨flagå­—æ®µæŒ‡æ˜æ•°æ®ç±»å‹ã€‚ä¸ºäº†å®ç°joinåŠŸèƒ½ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿åŒä¸€ä¸ª<code>User</code>çš„æ‰€æœ‰æ•°æ®éƒ½åˆ°è¾¾åŒä¸€ä¸ªReducerå¤„ï¼Œé‚£æ ·æ‰èƒ½å°†è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ä¸å…¶ç”¨æˆ·ä¿¡æ¯å…³è”èµ·æ¥ï¼Œé¿å…é—æ¼ã€‚ä¸ºäº†è®©åŒä¸€ä¸ªUserçš„æ•°æ®éƒ½åˆ°è¾¾åŒä¸€ä¸ªReducerï¼Œæˆ‘ä»¬è¦è®©Mapç«¯è¾“å‡ºçš„K-Vå¯¹ä¸º<code>&lt;UserID, JavaBean&gt;</code>ï¼Œé‚£ä¹ˆåœ¨Partitionçš„æ—¶å€™ï¼ŒåŒä¸€ä¸ªUserIDçš„æ•°æ®è‡ªç„¶ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªReducerã€‚ å½“Reduceræ‹¿åˆ°ä¸€æ‰¹<code>&lt;UserID, JavaBean&gt;</code>æ•°æ®åï¼Œå°†å…¶æ•´åˆä¸º<code>&lt;UserID, Iterable&lt;JavaBean&gt;&gt;</code>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<code>Iterable&lt;JavaBean&gt;&gt;</code>é‡Œé€šè¿‡åˆ¤æ–­<code>flag</code>çš„å€¼æ‰¾å‡º<code>User</code>çš„JavaBeanï¼Œç§°ä¸º<strong>_U_</strong>ã€‚ç„¶åå¯¹äºæ¯ä¸ª<code>Order</code>çš„JavaBeanï¼ˆç§°ä¸º<strong>_O_</strong>ï¼‰ï¼Œä»<strong>_O_</strong>ä¸­å–å‡º<code>order_id</code>, <code>price</code>, <code>date</code>ï¼Œä»<strong>_U_</strong>ä¸­å–å‡º<code>user_id</code>, <code>user_name</code>, <code>phone</code>ï¼Œç»„æˆç»“æœæ•°æ®<strong>_R_</strong>ã€‚</p>
<pre><code>R = (order_id, price, dateï¼Œuser_id, user_name, phone)
</code></pre></li>
</ol>
<pre><code>Reducerå¾ªç¯å°†å¤šä¸ª`&lt;R, NullWritable&gt;`å†™åˆ°æœ€ç»ˆContextä¸­ï¼Œä¾¿å®Œæˆäº†joiné€»è¾‘ã€‚
</code></pre><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><ol>
<li><p>è‡ªå®šä¹‰JavaBean</p>
<pre><code>/**
 * è‡ªå®šä¹‰JavaBean, å®ç°Writableæ¥å£, å› æœ¬ä»»åŠ¡ä¸å­˜åœ¨&quot;æ¯”è¾ƒ&quot;, æ— éœ€å®ç°WritableComparable
 */
public class JoinBean implements Writable{
    public String userID;
    public String uName;
    public String phone;
    public String orderID;
    public String price;
    public String date;
    public String flag;     // ç”¨äºæ ‡è¯†Userè¿˜æ˜¯Order

    public JoinBean() {

    }

    public JoinBean(String userID, String uName, String phone, String orderID, String price, String date, String flag) {
        this.userID = userID;
        this.uName = uName;
        this.phone = phone;
        this.orderID = orderID;
        this.price = price;
        this.date = date;
        this.flag = flag;
    }

    public void set(String userID, String uName, String phone, String orderID, String price, String date, String flag) {
        this.userID = userID;
        this.uName = uName;
        this.phone = phone;
        this.orderID = orderID;
        this.price = price;
        this.date = date;
        this.flag = flag;
    }

    @Override
    public String toString() {
        return &quot;uName=&apos;&quot; + uName + &apos;\&apos;&apos; +
                &quot;, phone=&apos;&quot; + phone + &apos;\&apos;&apos; +
                &quot;, orderID=&apos;&quot; + orderID + &apos;\&apos;&apos; +
                &quot;, price=&apos;&quot; + price + &apos;\&apos;&apos; +
                &quot;, date=&apos;&quot; + date + &apos;\&apos;&apos;;
    }

    public String getUserID() {
        return userID;
    }

    public void setUserID(String userID) {
        this.userID = userID;
    }

    public String getFlag() {
        return flag;
    }

    public void setFlag(String flag) {
        this.flag = flag;
    }

    public String getuName() {
        return uName;
    }

    public void setuName(String uName) {
        this.uName = uName;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getOrderID() {
        return orderID;
    }

    public void setOrderID(String orderID) {
        this.orderID = orderID;
    }

    public String getPrice() {
        return price;
    }

    public void setPrice(String price) {
        this.price = price;
    }

    public String getDate() {
        return date;
    }

    public void setDate(String date) {
        this.date = date;
    }

    @Override
    public void write(DataOutput dataOutput) throws IOException {
        dataOutput.writeUTF(userID);
        dataOutput.writeUTF(uName);
        dataOutput.writeUTF(phone);
        dataOutput.writeUTF(orderID);
        dataOutput.writeUTF(price);
        dataOutput.writeUTF(date);
        dataOutput.writeUTF(flag);
    }

    @Override
    public void readFields(DataInput dataInput) throws IOException      {
        userID = dataInput.readUTF();
        uName = dataInput.readUTF();
        phone = dataInput.readUTF();
        orderID = dataInput.readUTF();
        price = dataInput.readUTF();
        date = dataInput.readUTF();
        flag = dataInput.readUTF();
    }
}
</code></pre></li>
</ol>
<ol start="2">
<li><p>Mapper</p>
<pre><code>/**
 * Mapperç±»
 */
public class JoinMapper extends Mapper&lt;LongWritable, Text, Text, JoinBean&gt; {

    public static final String USER = &quot;user&quot;;
    public static final String ORDER = &quot;order&quot;;

    public JoinBean info = new JoinBean();
    @Override
    protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException {

        FileSplit fileSplit = (FileSplit)context.getInputSplit();
        String fileName = fileSplit.getPath().getName();    // è·å–æ•°æ®æ‰€å±æ–‡ä»¶å

        String line = value.toString();
        String[] data = line.split(&quot;,&quot;);
        String userID = data[0];

        // é€šè¿‡flagæ ‡è¯†å®ä¾‹å¯¹è±¡æ˜¯Userè¿˜æ˜¯Order
        if(fileName.startsWith(&quot;user&quot;)) {
            info.set(&quot;&quot;, data[1], data[2], &quot;&quot;, &quot;&quot;, &quot;&quot;, USER);
        } else {
            info.set(&quot;&quot;, &quot;&quot;, &quot;&quot;, data[1], data[2], data[3], ORDER);
        }
        context.write(new Text(userID), info);
    }
}
</code></pre></li>
</ol>
<ol start="3">
<li><p>Reducer</p>
<pre><code>/**
 * Reducerç±»
 */
public class JoinReducer extends Reducer&lt;Text, JoinBean, JoinBean, NullWritable&gt; {
    @Override
    protected void reduce(Text key, Iterable&lt;JoinBean&gt; values, Context context) throws IOException, InterruptedException {
        JoinBean userInfo = new JoinBean();
        List&lt;JoinBean&gt; orders = new ArrayList&lt;&gt;();

        for(JoinBean info : values) {
            // åŒä¸€ä¸ªUserIDï¼Œæœ‰ä¸”ä»…æœ‰1ä¸ªUserå¯¹è±¡ï¼Œå…¶ä»–å‡ä¸ºè¯¥Userçš„Orderå¯¹è±¡
            if(info.getFlag().equals(&quot;user&quot;)) {
                try {
                    BeanUtils.copyProperties(userInfo, info);
                } catch (Exception e) {
                    System.out.println(e.toString());
                }
            } else if(info.getFlag().equals(&quot;order&quot;)){
                JoinBean order = new JoinBean();
                try {
                    BeanUtils.copyProperties(order, info);
                } catch (Exception e) {
                    System.out.println(e.toString());
                }
                orders.add(order);
            }
        }

        // æå–æ‰€éœ€å±æ€§, åˆå¹¶, è¾“å‡º
        for(JoinBean order : orders) {
            JoinBean record = new JoinBean();
            record.set(key.toString(), userInfo.getuName(), userInfo.getPhone(), order.getOrderID(), order.getPrice(), order.getDate(), order.getFlag());
            context.write(record, NullWritable.get());
        }
    }
}
</code></pre></li>
</ol>
<ol start="4">
<li><p>Driverï¼ˆç¨‹åºå…¥å£ï¼‰</p>
<pre><code>public class JoinDriver {
    public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException {
        Configuration conf = new Configuration();
        conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://localhost:9000&quot;);
        Job joinJob = Job.getInstance(conf);

        joinJob.setMapperClass(JoinMapper.class);
        joinJob.setReducerClass(JoinReducer.class);

        joinJob.setJarByClass(JoinDriver.class);

        joinJob.setMapOutputKeyClass(Text.class);
        joinJob.setMapOutputValueClass(JoinBean.class);
        joinJob.setOutputKeyClass(JoinBean.class);
        joinJob.setOutputValueClass(NullWritable.class);

        FileInputFormat.setInputPaths(joinJob, new Path(&quot;/join/input&quot;));
        FileOutputFormat.setOutputPath(joinJob, new Path(&quot;/join/output&quot;));

        System.exit(joinJob.waitForCompletion(true) ? 0 : 1);
    }
}
</code></pre></li>
</ol>
<h2 id="æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€"><a href="#æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€" class="headerlink" title="æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€"></a>æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€</h2><p>åœ¨è¿™ä¸ªé—®é¢˜é‡Œï¼Œæˆ‘ä»¬çš„æ•°æ®åˆ†ä¸º<code>User</code>å’Œ<code>Order</code>ä¸¤ç±»ï¼Œå…¶ä¸­æ˜æ˜¾<code>User</code>çš„æ•°æ®ä¼šæ¯”<code>Order</code>å°‘å¾—å¤šã€‚ä¸€ä½ç”¨æˆ·åªå¯èƒ½æœ‰ä¸€è¡Œ<code>User</code>è®°å½•ï¼ˆåœ¨ç³»ç»Ÿä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼‰ï¼Œè€Œä¸€ä½ç”¨æˆ·å´å¯ä»¥æœ‰Nè¡Œ<code>Order</code>è®°å½•ï¼Œå› ä¸ºä»–å¯ä»¥â€œç–¯ç‹‚è´­ç‰©â€äº§ç”Ÿäº†æˆåƒä¸Šä¸‡æ¡çš„è®¢å•æ•°æ®ã€‚ æç«¯æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä½<code>User</code>ï¼š<code>user_1</code>å¯¹åº”äº†<code>1000000</code>æ¡<code>Order</code>æ•°æ®ï¼Œå¦ä¸€ä½<code>User</code>ï¼š<code>user_2</code>å¯¹åº”äº†<code>2</code>æ¡<code>Order</code>æ•°æ®ã€‚é‚£ä¹ˆå¿…ç„¶æœ‰ä¸€ä¸ªè´Ÿè´£å¤„ç†<code>user_1</code>çš„Reducer<code>reducer_1</code>çš„è´Ÿè½½è¿‡é«˜ï¼Œå› ä¸ºè¦å¤„ç†<code>1000000</code>æ¡æ•°æ®ï¼Œå…¶ä»–è´Ÿè½½æå°‘çš„Reducerå¹²å®Œæ´»ä¹‹åå°±å¾—ç™½ç™½æµªè´¹æ—¶é—´ç­‰ç€<code>reducer_1</code>å®Œæˆä»»åŠ¡ï¼ˆ<strong><em>å¾€å¾€è¡¨ç°ä¸ºJobè¿›åº¦å¡åœ¨99%</em></strong>ï¼‰ï¼Œæ‰èƒ½æ±‡æŠ¥æ•´ä¸ªJobå·²å®Œæˆã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/dataIncline.png" alt=""> å¦‚å›¾æ‰€ç¤ºï¼Œå› ä¸ºå¤§é‡çš„æ•°æ®æ¶Œå‘å°‘æ•°çš„èŠ‚ç‚¹ï¼Œåƒæ˜¯ä¸€ä¸ªå€¾æ–œçš„å¤©å¹³ï¼Œä¸€ç«¯é‡ä¸€ç«¯è½»ï¼Œæ‰€ä»¥ä»¥ä¸Šçš„æƒ…å†µä¾¿ç§°ä¸º<code>æ•°æ®å€¾æ–œ</code>ã€‚ ä¸ºäº†è§£å†³å½“å‰é—®é¢˜å¼•èµ·çš„æ•°æ®å€¾æ–œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§<strong>â€mapç«¯joinâ€œ</strong>çš„æ–¹å¼è¿›è¡Œå…³è”æ“ä½œï¼Œä»£æ›¿ä¹‹å‰åœ¨Reducerç«¯æ”¶é›†æ•°æ®è¿›è¡Œjoinçš„é€»è¾‘ã€‚ç›¸æ¯”<code>Order</code>è¡¨ï¼Œ<code>User</code>è¡¨æ— ç–‘å°å¾—å¤šï¼Œç”šè‡³å¯èƒ½æ˜¯å‡ ç™¾å€çš„é‡çº§å·®è·ï¼Œæ‰€ä»¥å®Œå…¨å¯èƒ½æŠŠè¿™ä¸ªå°è¡¨åˆ†å‘ç»™å„ä¸ªMapperï¼Œè®©æ¯ä¸ªMapperéƒ½æ‹¥æœ‰ä¸€ä»½<strong><em>å®Œæ•´çš„Userè¡¨</em></strong>ï¼Œè¿›è€Œå°†å…¶åŠ è½½å…¥å†…å­˜æ„é€ ä¸€ä¸ª<code>&lt;user_id, user_info&gt;</code>çš„å“ˆå¸Œè¡¨ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œåœ¨Mapperå†…åªéœ€è¦å¤„ç†<code>Order</code>çš„æ•°æ®ï¼Œç„¶åæ ¹æ®<code>Order</code>é‡Œçš„<code>user_id</code>æŸ¥åˆ°å“ˆå¸Œè¡¨é‡Œè¯¥idå¯¹åº”çš„<code>user_info</code>ï¼Œè¿æ¥èµ·æ¥ï¼Œå³å¯å®Œæˆjoinæ“ä½œã€‚</p>
<ul>
<li><p>MapJoinMapper</p>
<p>/**</p>
<ul>
<li><p>å®ç°Mapç«¯joinçš„Mapper<br>*/<br>public class MapJoinMapper extends Mapper&lt;LongWritable, Text, MapJoinBean, NullWritable&gt; {</p>
<p> private Map&lt;String, List<string>&gt; userTable = new HashMap&lt;&gt;();<br> private MapJoinBean outputKey = new MapJoinBean();</string></p>
<p> public static final String ORDER_FILE = â€œorder.txtâ€;</p>
<p> /**</p>
<ul>
<li>Mapperä¼šè‡ªè¡Œè°ƒç”¨çš„ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•</li>
<li>@param context Jobä¿¡æ¯</li>
<li>@throws IOException</li>
<li><p>@throws InterruptedException<br>*/<br>@Override<br>protected void setup(Context context) throws IOException, InterruptedException {</p>
<p> // è·å–ç³»ç»Ÿâ€æŠ•æ”¾â€åˆ°æœ¬åœ°çš„cacheæ–‡ä»¶, æœ¬é—®é¢˜ä¸­åªæœ‰1ä¸ªï¼Œå³user.txt<br> URI[] uris = context.getCacheFiles();<br> FileSystem fs = FileSystem.get(context.getConfiguration());<br> FSDataInputStream inputStream = fs.open(new Path(uris[0]));<br> BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));</p>
<p> // é€è¡Œè¯»å–user.txtä¸­çš„æ•°æ®, æ„å»ºuserTable<br> String line = null;<br> while((line = reader.readLine()) != null) {</p>
<pre><code>String[] terms = line.split(&quot;,&quot;);
if(!userTable.containsKey(terms[0])) {
    userTable.put(terms[0], new ArrayList&lt;&gt;());
}
userTable.get(terms[0]).add(terms[1]);
userTable.get(terms[0]).add(terms[2]);
</code></pre><p> }</p>
<p> reader.close();<br>}</p>
<p>@Override<br>protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException {</p>
<p> FileSplit fileSplit = (FileSplit) context.getInputSplit();<br> String fileName = fileSplit.getPath().getName();</p>
<p> // ä¸éœ€è¦å†å¤„ç†Useræ•°æ®æ–‡ä»¶äº†, å› ä¸ºå·²ç»é€šè¿‡setupæŠŠå…¶æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­çš„userTable<br> if(fileName.equals(ORDER_FILE)) {</p>
<pre><code>String line = value.toString();
String[] terms = line.split(&quot;,&quot;);

// ä»æœ¬åœ°çš„&quot;å°è¡¨&quot; â€”â€” userTableå¤„è·å¾—userIDå¯¹åº”çš„æ•°æ®
String userName = userTable.get(terms[0]).get(0);
String phone = userTable.get(terms[0]).get(1);

// ä¸å†éœ€è¦flagå­—æ®µ, ç®€å•ç½®ä¸ºç©ºä¸²
outputKey.set(terms[0], userName, phone, terms[1], terms[2], terms[3], &quot;&quot;);
context.write(outputKey, NullWritable.get());
</code></pre><p> }<br>}<br>}</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>MapJoinReducer</p>
<p>/**</p>
<ul>
<li><p>Mapç«¯Joinçš„Reducer<br>*/<br>public class MapJoinReducer extends Reducer&lt;MapJoinBean, NullWritable, MapJoinBean, NullWritable&gt; {</p>
<p> @Override<br> protected void reduce(MapJoinBean key, Iterable<nullwritable> values, Context context) throws IOException, InterruptedException {</nullwritable></p>
<pre><code>context.write(key, NullWritable.get());
</code></pre><p> }<br>}</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>MapJoinBean</p>
<p>/**</p>
<ul>
<li><p>è‡ªå®šä¹‰JavaBean, å®ç°WritableComparableæ¥å£<br>*/<br>public class MapJoinBean implements WritableComparable<mapjoinbean> {<br> public String userID;<br> public String uName;<br> public String phone;<br> public String orderID;<br> public String price;<br> public String date;<br> public String flag;</mapjoinbean></p>
<p> public MapJoinBean() {</p>
<p> }</p>
<p> public MapJoinBean(String userID, String uName, String phone, String orderID, String price, String date, String flag) {</p>
<pre><code>this.userID = userID;
this.uName = uName;
this.phone = phone;
this.orderID = orderID;
this.price = price;
this.date = date;
this.flag = flag;
</code></pre><p> }</p>
<p> public void set(String userID, String uName, String phone, String orderID, String price, String date, String flag) {</p>
<pre><code>this.userID = userID;
this.uName = uName;
this.phone = phone;
this.orderID = orderID;
this.price = price;
this.date = date;
this.flag = flag;
</code></pre><p> }</p>
<p> @Override<br> public String toString() {</p>
<pre><code>return &quot;uName=&apos;&quot; + uName + &apos;\&apos;&apos; +
        &quot;, phone=&apos;&quot; + phone + &apos;\&apos;&apos; +
        &quot;, orderID=&apos;&quot; + orderID + &apos;\&apos;&apos; +
        &quot;, price=&apos;&quot; + price + &apos;\&apos;&apos; +
        &quot;, date=&apos;&quot; + date + &apos;\&apos;&apos;;
</code></pre><p> }</p>
<p> public String getUserID() {</p>
<pre><code>return userID;
</code></pre><p> }</p>
<p> public void setUserID(String userID) {</p>
<pre><code>this.userID = userID;
</code></pre><p> }</p>
<p> public String getFlag() {</p>
<pre><code>return flag;
</code></pre><p> }</p>
<p> public void setFlag(String flag) {</p>
<pre><code>this.flag = flag;
</code></pre><p> }</p>
<p> public String getuName() {</p>
<pre><code>return uName;
</code></pre><p> }</p>
<p> public void setuName(String uName) {</p>
<pre><code>this.uName = uName;
</code></pre><p> }</p>
<p> public String getPhone() {</p>
<pre><code>return phone;
</code></pre><p> }</p>
<p> public void setPhone(String phone) {</p>
<pre><code>this.phone = phone;
</code></pre><p> }</p>
<p> public String getOrderID() {</p>
<pre><code>return orderID;
</code></pre><p> }</p>
<p> public void setOrderID(String orderID) {</p>
<pre><code>this.orderID = orderID;
</code></pre><p> }</p>
<p> public String getPrice() {</p>
<pre><code>return price;
</code></pre><p> }</p>
<p> public void setPrice(String price) {</p>
<pre><code>this.price = price;
</code></pre><p> }</p>
<p> public String getDate() {</p>
<pre><code>return date;
</code></pre><p> }</p>
<p> public void setDate(String date) {</p>
<pre><code>this.date = date;
</code></pre><p> }</p>
<p> @Override<br> public void write(DataOutput dataOutput) throws IOException {</p>
<pre><code>dataOutput.writeUTF(userID);
dataOutput.writeUTF(uName);
dataOutput.writeUTF(phone);
dataOutput.writeUTF(orderID);
dataOutput.writeUTF(price);
dataOutput.writeUTF(date);
dataOutput.writeUTF(flag);
</code></pre><p> }</p>
<p> @Override<br> public void readFields(DataInput dataInput) throws IOException {</p>
<pre><code>userID = dataInput.readUTF();
uName = dataInput.readUTF();
phone = dataInput.readUTF();
orderID = dataInput.readUTF();
price = dataInput.readUTF();
date = dataInput.readUTF();
flag = dataInput.readUTF();
</code></pre><p> }</p>
<p> @Override<br> public int compareTo(MapJoinBean o) {</p>
<pre><code>if(o == null) {
    throw new RuntimeException();
}
if(userID.compareTo(o.getUserID()) == 0) {
    return orderID.compareTo(o.getOrderID());
}
return userID.compareTo(o.getUserID());
</code></pre><p> }<br>}</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>MapJoinDriver</p>
<p>public class MapJoinDriver {</p>
<pre><code>public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException, URISyntaxException {

    Configuration conf = new Configuration();
    conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://localhost:9000&quot;);
    Job joinJob = Job.getInstance(conf);

    // ä½¿ç”¨Mapç«¯joinçš„Mapperå’ŒReducer
    joinJob.setMapperClass(MapJoinMapper.class);
    joinJob.setReducerClass(MapJoinReducer.class);

    joinJob.setJarByClass(MapJoinDriver.class);

    joinJob.setMapOutputKeyClass(MapJoinBean.class);
    joinJob.setMapOutputValueClass(NullWritable.class);
    joinJob.setOutputKeyClass(MapJoinBean.class);
    joinJob.setOutputValueClass(NullWritable.class);

    // å‘å„èŠ‚ç‚¹&quot;æŠ•æ”¾&quot;Useræ•°æ®æ–‡ä»¶
    joinJob.addCacheFile(new URI(&quot;/join/input/user.txt&quot;));

    FileInputFormat.setInputPaths(joinJob, new Path(&quot;/join/input&quot;));
    FileOutputFormat.setOutputPath(joinJob, new Path(&quot;/join/output&quot;));

    System.exit(joinJob.waitForCompletion(true) ? 0 : 1);
}
</code></pre><p>}</p>
</li>
</ul>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>åˆ©ç”¨Map-Reduceå¯ä»¥å®Œæˆæ•°æ®æ–‡ä»¶çš„joinæ“ä½œã€‚ä¸éœ€è¦å…ˆå°†æ•°æ®ç»“æ„åŒ–ï¼Œå¯¼å…¥MySQLã€‚</li>
<li>è‡ªå®šä¹‰<code>JavaBean</code>ç±»ï¼Œç”¨äºé›†æˆå¤šä¸ªå±æ€§çš„æ€è·¯ä»ç„¶å¾ˆæœ‰ç”¨ã€‚</li>
<li>å½“joinçš„åŒæ–¹æ˜¯ä¸€å¼ <strong>å¤§è¡¨</strong>å’Œä¸€å¼ <strong>å°è¡¨</strong>æ—¶ï¼Œå¯è€ƒè™‘å°†å°è¡¨åˆ†å‘åˆ°æ‰€æœ‰mapç«¯ï¼Œåœ¨æœ¬åœ°å°†å°è¡¨åŠ è½½åˆ°å†…å­˜ï¼Œä»è€Œå®ç°<strong>mapç«¯join</strong>ã€‚</li>
</ol>
<h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>å…·ä½“ä»£ç è¯·ç‚¹å‡» <a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/join" target="_blank" rel="noopener">Joinæ“ä½œä¸Mapç«¯joinæ“ä½œä»£ç </a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/04/join-di/" data-id="cjpg78r7t004fbxuyj9dl9cig" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mapreduce/">mapreduce</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ii-wc" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/25/ii-wc/" class="article-date">
  <time datetime="2018-02-25T23:32:43.000Z" itemprop="datePublished">2018-02-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/25/ii-wc/">è°ˆè°ˆå€’æ’ç´¢å¼•ï¼Œå‡çº§ç‰ˆâ€œWordCountâ€</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯ï¼šAll-About-Search"><a href="#é—®é¢˜èƒŒæ™¯ï¼šAll-About-Search" class="headerlink" title="é—®é¢˜èƒŒæ™¯ï¼šAll About Search"></a>é—®é¢˜èƒŒæ™¯ï¼šAll About Search</h2><p>åœ¨æ•°æ®åº“é¢†åŸŸå’Œæœç´¢å¼•æ“é¢†åŸŸï¼Œ<strong><em>å€’æ’ç´¢å¼•</em></strong>æ˜¯ä¸€ç§å¾ˆé‡è¦çš„æ•°æ®ç»“æ„ã€‚åœ¨å¤§éƒ¨åˆ†çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ–‡æœ¬å‹æ•°æ®ï¼ˆTextï¼‰æ˜¯ä¸»æµï¼Œä¾é <strong><em>å€’æ’ç´¢å¼•</em></strong>è¿™ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ˜¾è‘—æé«˜<strong><em>æ–‡æœ¬æ•°æ®é¡¹ï¼ˆTermï¼‰</em></strong>çš„æœç´¢é€Ÿåº¦ï¼ˆæ— è®ºæ˜¯ç†è®ºè¿˜æ˜¯å®é™…åº”ç”¨ä¸­ï¼‰ã€‚ å‡è®¾ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰ä»¥ä¸‹æ•°æ®ã€‚</p>
<pre><code>// Document A
My name is superman.

// Document B
I love my cat whose name is Kitty!

// Document C
Please name my car.
</code></pre><p>å¦‚æœä¸å¯¹ä»¥ä¸ŠåŸå§‹æ•°æ®ä½œé¢å¤–å¤„ç†ï¼Œå¾„ç›´å°†3ä¸ªæ–‡ä»¶ä¿å­˜è‡³ç£ç›˜çš„åŒä¸€ç›®å½•ä¸‹ï¼Œåˆ†åˆ«å‘½åä¸º<code>Document A</code>ã€<code>Document B</code>ã€<code>Document C</code>ã€‚é‚£ä¹ˆå½“éœ€è¦æŸ¥æ‰¾<code>car</code>è¿™ä¸ªæ•°æ®é¡¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦éå†æ–‡ä»¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰èƒ½è¾“å‡ºæœç´¢ç»“æœï¼š<code>Found in Document C!</code>ã€‚è‹¥å°†æ­¤åœºæ™¯æ‰©å±•è‡³<strong>_N_</strong>ä¸ªæ•°æ®æ–‡ä»¶ï¼Œå¹³å‡æ¯ä¸ªæ•°æ®æ–‡ä»¶çš„Term Countä¸º<strong>_K_</strong>ï¼Œé‚£ä¹ˆæ­¤æœç´¢ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦å°†ä¸º<code>O(N*K)</code>ï¼Œéšç€Nå’ŒKçš„å¢é•¿ï¼Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦æ— ç–‘æ˜¯ç¾éš¾æ€§çš„ã€‚ ä¹Ÿè®¸æœ‰äººä¼šè¯´ï¼Œæ—¢ç„¶æ¯ä¸ªæ–‡ä»¶æ˜¯ç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†ç›®å½•ä¸‹çš„æ•°æ®æ–‡ä»¶è¿›è¡Œ<strong><em>â€œPartitionâ€</em></strong>ï¼Œåˆ†æˆ<code>M</code>å—ï¼Œæ¯ä¸€å—åŒ…å«<code>N/M</code>ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶å¯åŠ¨<code>M</code>ä¸ªçº¿ç¨‹ç‹¬ç«‹è´Ÿè´£æœç´¢è‡ªå·±å—å†…çš„æ–‡ä»¶ï¼Œä¸å°±èƒ½å¤Ÿå¤§å¹…æé«˜é€Ÿåº¦ï¼Œè§£å†³æœç´¢çš„æ€§èƒ½é—®é¢˜äº†å—ï¼Ÿå…ˆæ’‡å¼€ç¡¬ç›˜çš„I/Oæ€§èƒ½ä¸è°ˆï¼Œ<strong>å¯åŠ¨ã€ååŒ<code>M</code>ä¸ªçº¿ç¨‹ï¼Œåˆå¹¶å¤šä¸ªçº¿ç¨‹çš„è®¡ç®—ç»“æœæ‰€éœ€è¦çš„ç³»ç»Ÿå¼€é”€å°†ä¼šæ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—</strong>ï¼Œå¾ˆæœ‰å¯èƒ½å°±å› ä¸ºè¿™ä¸ªæœç´¢ä»»åŠ¡å¯¼è‡´æ•´ä¸ªèŠ‚ç‚¹å´©æºƒã€‚å†è€…ï¼Œå½“ç³»ç»Ÿçš„ç”¨æˆ·æ•°å¿«é€Ÿå¢é•¿ï¼ŒåŒæ—¶æ‰§è¡Œå¤šä¸ªç”¨æˆ·çš„æœç´¢è¯·æ±‚æ—¶æ ¹æœ¬æ— æ³•ä¿è¯æœç´¢çš„åŠæ—¶æ€§ï¼Œéš¾ä»¥å¹¶å‘ã€‚ æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦è½¬å˜æ€è·¯ï¼Œ<strong>ä¸è¦å‚»å‚»åœ°æŠŠçœŸæ­£çš„â€œæœç´¢â€æ”¾åœ¨ç”¨æˆ·å‘é€æœç´¢è¯·æ±‚æ—¶æ‰§è¡Œ</strong>ï¼Œè€Œåº”è¯¥æ—©æ—©åœ°ä¸ºæ•°æ®æ–‡ä»¶é‡Œçš„æ¯ä¸ª<strong><em>æ•°æ®é¡¹ï¼ˆTermï¼‰</em></strong>å»ºç«‹èµ·<strong><em>ç´¢å¼•ï¼ˆTerm Indexï¼‰</em></strong>ï¼Œåˆ°ç”¨æˆ·éœ€è¦æœç´¢æ—¶å°±å¯ä»¥é€šè¿‡å·²å»ºç«‹å¥½çš„ç´¢å¼•å¿«é€Ÿå®šä½å¹¶è¿”å›ç»“æœï¼Œä¸éœ€è¦ä¸€æ¬¡åˆä¸€æ¬¡åœ°æ‰«æç£ç›˜æ–‡ä»¶ã€‚ <strong><em>å€’æ’ç´¢å¼•ï¼ˆInverted Index)</em></strong>è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯åŸºäºä»¥ä¸Šéœ€æ±‚è€Œæ¥åˆ°äº†è¿™ä¸ªä¸–ç•Œä¸Šçš„ã€‚</p>
<pre><code>// æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€ååº”ä¸‹çš„ç´¢å¼•åº”è¯¥æ˜¯ä»¥ä¸‹ç»“æ„
DocumentID          Terms
    A         [My, name, is, superman]
    B         [I, love, my, cat, whose, name, is, Kitty]
    C         [Please, name, my, car]
</code></pre><p>å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä»¥ä¸Šçš„ç»“æ„å»ºç«‹ç´¢å¼•ï¼Œä»éœ€è¦é€ä¸ªIDæ‰«æå…¶å¯¹åº”çš„Termsï¼Œæœç´¢çš„æ—¶é—´å¤æ‚åº¦ä»ç„¶æ˜¯<code>O(N*K)</code>ï¼Œå‹æ ¹æ²¡æœ‰æå‡ä»»ä½•æ€§èƒ½ã€‚</p>
<pre><code>// æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡â€œå€’æ’â€çš„æ–¹å¼æ”¹å˜ç´¢å¼•ç»“æ„
Term        DocumentIDs
My          [A, B, C]
name        [A, B, C]
is          [A, B]
superman    [A]
I           [B]
love        [B]
cat         [B]
whose       [B]
Kitty       [B]
Please      [C]
car         [C]
</code></pre><p>æ‰€è°“â€œå€’æ’â€ï¼Œæ— éå°±æ˜¯å°†åŸæ¥çš„<strong><em>Key</em></strong>ï¼ˆ<code>DocuementID</code>ï¼‰å’Œ<strong><em>Value</em></strong>ï¼ˆ<code>Terms</code>ï¼‰é¢ å€’è¿‡æ¥ï¼Œç”¨<code>Term</code>ä½œä¸º<strong><em>Key</em></strong>ï¼Œ<code>DocumentIDs</code>ä½œä¸º<strong><em>Value</em></strong>ã€‚é€šè¿‡æ„å»ºè¿™æ ·çš„ç´¢å¼•ç»“æ„ï¼Œå½“æˆ‘ä»¬éœ€è¦æœç´¢<code>car</code>è¿™ä¸€æ•°æ®é¡¹æ—¶ï¼Œæˆ‘ä»¬åªéœ€ä»å¤´å¼€å§‹çº¿æ€§æ‰«æ<strong>ä¸€é</strong>ç´¢å¼•è¡¨ï¼Œå®šä½åˆ°<code>car</code>é‚£ä¸€è¡Œå¹¶ç›´æ¥å–å‡ºå…¶å¯¹åº”çš„<code>DocumentIDs</code>ï¼Œå•æ¬¡æœç´¢çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†<code>O(N)</code>ã€‚ å½“ç„¶åœ¨æ•°æ®é‡ç‰¹åˆ«å¤§æ—¶ï¼Œ<code>O(N)</code>ä»ç„¶ä¸æ˜¯ä¸€ä¸ªç†æƒ³çš„æŒ‡æ ‡ï¼Œä»ç„¶æœ‰è¿›æ­¥çš„ç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ª<code>Term</code>è¿›è¡ŒHashå¾—åˆ°<code>h = Hash(Term)</code>ï¼Œç„¶åè®°å½•<code>h</code>ä¸è¡Œå·çš„æ˜ å°„è¡¨<code>H_TABLE</code>ã€‚é‚£ä¹ˆæ¯æ¬¡æœç´¢æ—¶æ ¹æ®æœç´¢é¡¹çš„Hashå¯ä»¥æŸ¥<code>H_TABLE</code>å¿«é€Ÿå®šä½åˆ°å…·ä½“çš„æŸä¸€è¡Œï¼Œç›´æ¥å°±å¯å–å‡ºå…¶å¯¹åº”çš„<code>DocumentIDs</code>ï¼Œæ€»çš„æ—¶é—´å¤æ‚åº¦ç†è®ºä¸Šæ˜¯<code>O(1)</code>ã€‚<strong>ï¼ˆå…³äºHashå†²çªä¸ä¼˜åŒ–çš„é—®é¢˜æœ¬æ–‡æš‚æ—¶ä¸äºˆæ¢è®¨ï¼‰</strong></p>
<h2 id="å®ç°æ–¹æ¡ˆï¼šWordCount-Againï¼Ÿ"><a href="#å®ç°æ–¹æ¡ˆï¼šWordCount-Againï¼Ÿ" class="headerlink" title="å®ç°æ–¹æ¡ˆï¼šWordCount Againï¼Ÿ"></a>å®ç°æ–¹æ¡ˆï¼šWordCount Againï¼Ÿ</h2><p>å½“ç³»ç»Ÿä¸­æœ‰æµ·é‡çš„æ•°æ®æ–‡ä»¶æ—¶ï¼Œç¬¬ä¸€ååº”è‚¯å®šå°±æ˜¯ä½¿ç”¨Hadoopä»¥åŠHadoopç”Ÿæ€ä¸­çš„å·¥å…·å¸®åŠ©æˆ‘ä»¬å¤„ç†æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç”¨Map-Reduceæ¥æ„å»ºå€’æ’ç´¢å¼•è¡¨å‘¢ï¼Ÿ <strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œç¡®å®å¯ä»¥ä½¿ç”¨Map-Reduceã€‚è€Œä¸”ä»”ç»†ä¸€æƒ³ï¼Œè¿™ä¸å°±æ˜¯Hadoopä¸­çš„â€œHelloWorldâ€â€”â€”WordCountçš„ç¿»ç‰ˆå—ï¼Ÿï¼Ÿï¼Ÿ</strong>ç¡®å®ä¹Ÿå¯ä»¥è¿™ä¹ˆè¯´ï¼Œå¤„ç†é€»è¾‘è·ŸWordCountéå¸¸ç±»ä¼¼ï¼Œåªæ˜¯æˆ‘ä»¬éœ€è¦åœ¨Reducerä¸­ç¨å¾®å¤šåšä¸€ç‚¹ç‚¹å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ç§°ä¹‹ä¸º<strong><em>å‡çº§ç‰ˆWordCount</em></strong>å“ˆå“ˆğŸ˜„ğŸ˜„ğŸ˜„ã€‚</p>
<pre><code>// å¦‚æœ100%ç…§æ¬WordCountçš„é€»è¾‘ï¼Œé‚£ä¹ˆæœ€ç»ˆäº§å‡ºçš„ç»“æœæ–‡ä»¶ä¼šæ˜¯
My      A
My      B
My      C
name    A
name    B
name    C
......
</code></pre><p>æ˜¾ç„¶æˆ‘ä»¬æƒ³è¦çš„å€’æ’è¡¨æ ¼å¼æ˜¯éœ€è¦æŠŠåŒä¸€ä¸ª<code>Term</code>ä¸‹çš„æ‰€æœ‰<code>DocumentID</code>åˆå¹¶åˆ°ä¸€è¡Œé‡Œã€‚æ‰€ä»¥ä¸ºäº†æ•°æ®æ ¼å¼çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¾“å‡ºåšç‚¹å°å¤„ç†ã€‚äºæ˜¯æˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>DocumentBean</code>ç±»ï¼Œé€»è¾‘ä¸Šå¯ä»¥ç®€å•çœ‹ä½œ<code>DocumentBean = List&lt;DocumentID&gt;</code>ã€‚<strong>æœ€ç»ˆæˆ‘ä»¬éœ€è¦é€šè¿‡Reducerè¾“å‡º<code>&lt;Term, DocumentBean&gt;</code></strong>ï¼Œé‚£ä¹ˆç»“æœé‡Œçš„æ¯ä¸€è¡Œè‡ªç„¶å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼äº†ã€‚</p>
<pre><code>/**
 * é›†æˆå¤šä¸ªDocumentIDçš„Bean
 */
public class DocumentBean implements Writable {

    private int documentCount;
    private List&lt;String&gt; documentIDs;

    public DocumentBean() {
        documentCount = 0;
        documentIDs = new ArrayList&lt;&gt;();
    }

    public void set(Iterable&lt;Text&gt; documentIDs) {
        this.documentIDs.clear();
        for(Text documentID : documentIDs) {
            this.documentIDs.add(documentID.toString());
        }
        documentCount = this.documentIDs.size();
    }

    @Override
    public void write(DataOutput dataOutput) throws IOException {
        dataOutput.writeInt(documentCount);
        for(String documentID : documentIDs) {
            dataOutput.writeUTF(documentID);
        }
    }

    @Override
    public void readFields(DataInput dataInput) throws IOException {
        documentCount = dataInput.readInt();
        for(int i = 0;i &lt; documentCount;i++) {
            documentIDs.add(dataInput.readUTF());
        }
    }

    @Override
    public String toString() {
        StringBuilder sb = new StringBuilder();
        for(String documentID : documentIDs) {
            sb.append(documentID).append(&quot;, &quot;);
        }
        return sb.substring(0, sb.length() - 2);
    }
}


/**
 * å€’æ’ç´¢å¼•çš„Mapper
 */
public class InvertedMapper extends Mapper&lt;LongWritable, Text, Text, Text&gt; {

    private Text outputKey = new Text();
    private Text outputValue = new Text();

    @Override
    protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException {
        FileSplit split = (FileSplit) context.getInputSplit();
        String fileName = split.getPath().getName();
        outputValue.set(fileName);

        String line = value.toString();
        String[] terms = line.split(&quot; &quot;);
        for(String term : terms) {
            outputKey.set(term);
            context.write(outputKey, outputValue);
        }
    }
}


/**
 * å€’æ’ç´¢å¼•çš„Reducer
 */
public class InvertedReducer extends Reducer&lt;Text, Text, Text, DocumentBean&gt; {

    private DocumentBean outputValue = new DocumentBean();

    @Override
    protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException {
        outputValue.set(values);
        context.write(key, outputValue);
    }
}



/**
 * ç¨‹åºå…¥å£
 */
public class InvertedDriver {

    public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException {
        Configuration conf = new Configuration();
        conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://localhost:9000&quot;);

        Job invertedJob = Job.getInstance(conf);

        invertedJob.setJarByClass(InvertedDriver.class);

        invertedJob.setMapperClass(InvertedMapper.class);
        invertedJob.setReducerClass(InvertedReducer.class);

        invertedJob.setMapOutputKeyClass(Text.class);
        invertedJob.setMapOutputValueClass(Text.class);
        invertedJob.setOutputKeyClass(Text.class);
        invertedJob.setOutputValueClass(DocumentBean.class);

        FileInputFormat.setInputPaths(invertedJob, new Path(&quot;/inverted_index/data/&quot;));
        FileOutputFormat.setOutputPath(invertedJob, new Path(&quot;/inverted_index/output/&quot;));

        System.exit(invertedJob.waitForCompletion(true) ? 1 : 0);
    }
}
</code></pre><h2 id="æ€»ç»“ï¼šWhat-Should-Be-Remembered"><a href="#æ€»ç»“ï¼šWhat-Should-Be-Remembered" class="headerlink" title="æ€»ç»“ï¼šWhat Should Be Remembered"></a>æ€»ç»“ï¼šWhat Should Be Remembered</h2><ol>
<li>åˆ©ç”¨è‡ªå®šä¹‰çš„<strong><code>Bean</code></strong>ç±»æ¥è¾…ä½Map-Reduceï¼Œå®ç°å„ç§å¤æ‚åŠŸèƒ½çš„æ€è·¯å·²ç»å¾ˆæ™®éäº†ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è¾“å‡ºè¾“å‡ºæ ¼å¼ï¼å®ç°ä¸¤è¡¨joinï¼äºŒæ¬¡æ’åºç­‰ç­‰ç­‰ç­‰ã€‚</li>
</ol>
<p><img src="http://p0u4yewt0.bkt.clouddn.com/invertedIndex.png" alt=""> 2. <strong>å€’æ’ç´¢å¼•è¡¨çš„è®¾è®¡ä¸ä¼˜åŒ–å…¶å®å¾ˆå¤æ‚ï¼Œæœ¬æ–‡è°ˆåˆ°çš„å†…å®¹åªæ˜¯ç®¡ä¸­çª¥è±¹</strong>ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨å€’æ’ç´¢å¼•è¡¨ä¸­ç”šè‡³å¯ä»¥å­˜å‚¨æ¯ä¸ªTermåœ¨ä¸åŒæ–‡ä»¶ä¸­çš„å‡ºç°æ¬¡æ•°ï¼æ–‡ä»¶æ›´æ–°ï¼ˆæ’å…¥ï¼‰æ—¶é—´ï¼Termçš„TF-IDFå€¼ç­‰ç­‰ç­‰ç­‰ã€‚é€šè¿‡å­˜å‚¨è¿™äº›æ–‡æœ¬æ•°æ®å¯ä»¥å¸®åŠ©æ­å»ºé«˜æ•ˆçš„æ¨èç³»ç»Ÿï¼Œæˆ–è€…å¯¹æœç´¢æ’åºè¿›è¡Œä¼˜åŒ–ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/25/ii-wc/" data-id="cjpg78r750035bxuy5izwbtj4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mapreduce/">mapreduce</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/æ•°æ®ç»“æ„/">æ•°æ®ç»“æ„</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-customizeinputformat" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/17/customizeinputformat/" class="article-date">
  <time datetime="2018-02-17T17:59:41.000Z" itemprop="datePublished">2018-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/17/customizeinputformat/">æµ·é‡å°æ–‡ä»¶ä¼˜åŒ–ä¹‹è‡ªå®šä¹‰InputFormat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>HDFSä½œä¸ºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œæå…¶é€‚ç”¨äºæµ·é‡å¤§æ–‡ä»¶çš„å­˜å‚¨åœºæ™¯ã€‚æ¯ä¸ªå¤§æ–‡ä»¶åœ¨ç³»ç»Ÿåº•å±‚ä¼šè¢«åˆ‡åˆ†æˆå¤šä¸ª<strong><em>Block</em></strong>ï¼ˆBlock Sizeé»˜è®¤ä¸º128MBï¼‰ï¼Œä¸”æ¯ä¸ªBlockä¼šè‡ªåŠ¨è¢«å†—ä½™å¤„ç†ï¼ˆé»˜è®¤å¤‡ä»½æ•°ä¸º3ä»½ï¼‰ä»¥ä¿è¯ä¸€å®šç¨‹åº¦ä¸Šçš„æ•°æ®å®‰å…¨ã€‚ HDFSå¯¹å¤§æ–‡ä»¶å‹å¥½ï¼Œä½†æ˜¯ä¸–äº‹å¾€å¾€ä¸å°½å¦‚äººæ„ã€‚â€œå­˜å‚¨â€å¯¹äºæ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿè€Œè¨€åªæ˜¯å…¶ä¸­ä¸€ç¯ï¼Œåœ¨å­˜å‚¨ä¹‹å‰å¿…é¡»å…ˆæœ‰æ•°æ®æ”¶é›†çš„æµç¨‹ã€‚å‡å¦‚å‰ç«¯è¿›è¡Œæ•°æ®æ”¶é›†æ—¶raw dataä¸ºæµ·é‡çš„å°æ•°æ®æ–‡ä»¶ï¼ˆä»1KBåˆ°10MBä¸ç­‰ï¼‰ï¼Œä¸”æ²¡æœ‰ç»è¿‡åˆå¹¶å°±ç›´æ¥é€šè¿‡HDFSçš„ä¸Šä¼ APIå†™åˆ°HDFSä¸­ï¼Œé‚£ä¹ˆNameNodeä¸Šå°±ä¼šä¿å­˜å¤§é‡çš„Blockå…ƒæ•°æ®è®°å½•ï¼ˆ<strong>å³ä½¿å•ä¸ªå°æ–‡ä»¶çš„å¤§å°è¿œè¿œä¸åˆ°ä¸€ä¸ªBlockçš„å®¹é‡ï¼Œä½†åœ¨é€»è¾‘ä¸Šä¹Ÿä¼šè¢«åˆ‡åˆ†ä¸ºä¸€ä¸ªBlockï¼Œè™½ç„¶ç‰©ç†ä¸Šå¹¶æ²¡æœ‰å ç”¨ä¸€ä¸ªçœŸæ­£çš„Blockçš„ç‰©ç†å®¹é‡</strong>ï¼‰ã€‚ ç›¸æ¯”NameNodeä¸­å­˜å‚¨å¤§é‡Blockå…ƒæ•°æ®å¸¦æ¥çš„å½±å“ï¼Œæ›´å€¼å¾—å…³æ³¨çš„æ˜¯<strong>æµ·é‡å°æ–‡ä»¶è¾“å…¥å¯¹Map-Reduceä»»åŠ¡çš„å½±å“</strong>ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/normalMap.png" alt="ç†æƒ³æƒ…å†µ"> ç†æƒ³æƒ…å†µä¸‹ï¼Œå‡è®¾Map-Reduceä»»åŠ¡çš„æ–‡ä»¶è¾“å…¥æ˜¯/xx/xx/xx.datï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å‡è®¾xx.datæ–‡ä»¶çš„å¤§å°åˆšå¥½æ˜¯3ä¸ªBlockçš„å¤§å°ï¼ˆ3 * 128MBï¼‰ï¼Œæš‚ä¸”å¿½ç•¥å¤‡ä»½æƒ…å†µã€‚å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ä»¥è¯¥æ–‡ä»¶ä½œä¸ºè¾“å…¥å¯åŠ¨Map-Reduceä»»åŠ¡æ—¶ï¼Œç³»ç»ŸgetSplit()è‡ªç„¶è€Œç„¶åœ°å°†è¯¥æ–‡ä»¶åˆ†æˆ3ä¸ªSplitï¼Œå®šä½åˆ°å„Splitæ‰€åœ¨çš„DataNodeå¹¶åœ¨ä¸Šé¢å¯åŠ¨Mapä»»åŠ¡ã€‚3ä¸ªMapä»»åŠ¡å„è‡ªå¤„ç†Local Dataï¼ˆHadoopæå€¡çš„Data Localityï¼‰ï¼Œç„¶åMapç«¯è¾“å‡ºä¼šè¢«ç›¸åº”çš„Reduceræ‹‰å–è¿›è¡ŒReduceæ“ä½œã€‚åœ¨ä»¥ä¸Šç†æƒ³æƒ…å†µä¸­ï¼Œå„ä¸ªMapä»»åŠ¡è´Ÿè½½åŸºæœ¬å‡è¡¡ï¼Œæ¯ä¸ªMapå¤„ç†çš„éƒ½æ˜¯æœ¬åœ°128MBçš„æ•°æ®ï¼Œç³»ç»Ÿè¿è¡ŒçŠ¶æ€è‰¯å¥½ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/abnormalMap.png" alt="æµ·é‡å°æ–‡ä»¶"> ç„¶è€Œï¼Œå¦‚æœMapç«¯è¾“å…¥ä¸ºæµ·é‡çš„å°æ–‡ä»¶ï¼Œé‚£ä¹ˆé»˜è®¤æ¯ä¸ªå°æ–‡ä»¶æœ¬èº«å°±ä¼šè¢«å½“ä½œä¸€ä¸ªSplitï¼ˆå°åˆ°ä¸å¯å†åˆ’åˆ†äº†ï¼‰ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡å¦‚ç³»ç»Ÿä¸­å°æ–‡ä»¶çš„åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€ï¼Œåœ¨æ¯ä¸ªå­˜æ”¾æœ‰å°æ–‡ä»¶çš„DataNodeä¸Šéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªMapä»»åŠ¡ã€‚ä½†æ˜¯å‡å¦‚å°æ–‡ä»¶çš„æ•°ç›®è¿œè¿œå¤§äºç³»ç»Ÿä¸­DataNodeçš„ä¸ªæ•°ï¼ˆ100ä¸‡ä¸ªå°æ–‡ä»¶ï¼Œ100ä¸ªDataNodeï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªDataNodeä¸Šå¯èƒ½å­˜æ”¾æœ‰Nä¸ªå°æ–‡ä»¶æ—¶ï¼Œé‚£ä¹ˆDataNodeå°±è¦ä¸æ–­å¯åŠ¨ä¸€ä¸ªåˆä¸€ä¸ªçš„Mapä»»åŠ¡ç›´åˆ°Nä¸ªå°æ–‡ä»¶éƒ½è¢«å¤„ç†å®Œã€‚æ›´æç«¯çš„æƒ…å†µæ˜¯<strong>å°æ–‡ä»¶åˆ†å¸ƒä¸å‡åŒ€ï¼Œåœ¨æŸä¸ªç‰¹å®šçš„DataNodeä¸Šå­˜æ”¾äº†80%çš„å°æ–‡ä»¶ï¼Œå‰©ä½™DataNodeä¸Šåªå­˜æ”¾äº†20%çš„å°æ–‡ä»¶</strong>ï¼Œé‚£ä¹ˆå…¶ä»–DataNodeåœ¨ç»“æŸè‡ªå·±æœ¬åœ°çš„è®¡ç®—åï¼Œè¿˜å¾—â€œé»˜é»˜ç­‰å¾…â€é‚£ä¸ªå­˜æ”¾äº†80%å°æ–‡ä»¶çš„DataNodeå®Œæˆå®ƒçš„æ‰€æœ‰mapå·¥ä½œï¼Œä¸¥é‡å½±å“äº†æ•´ä¸ªMap-Reduceä»»åŠ¡çš„æ•ˆç‡ã€‚ æ‰€ä»¥å¯¹äºæµ·é‡å°æ–‡ä»¶æ•°æ®ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨Map-Reduceä»»åŠ¡å‰å¿…é¡»å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œå¸¸è§çš„ä¼˜åŒ–æ€è·¯æœ‰</p>
<ol>
<li>åœ¨ç³»ç»Ÿå‰æ²¿å°±æŠŠå¤šä¸ªå°æ–‡ä»¶åˆå¹¶ï¼Œå°†åˆå¹¶åçš„å¤§æ–‡ä»¶å†™å…¥HDFS</li>
<li>å°æ–‡ä»¶å·²å¤§é‡åˆ†å¸ƒåœ¨HDFSä¸­ï¼Œé€šè¿‡ä¸€å®šæ‰‹æ®µåœ¨HDFSä¸­åˆå¹¶å®ƒä»¬</li>
<li>åœ¨å¯åŠ¨æ­£å¼çš„Map-Reduceä»»åŠ¡å‰ï¼Œå…ˆé¢„å¤„ç†åˆå¹¶å¤§é‡å°æ–‡ä»¶</li>
</ol>
<p>å…¶ä¸­<strong><em>æ€è·¯1</em></strong>çš„é€»è¾‘æ— å…³HDFSï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ã€‚<strong><em>æ€è·¯2ä¸æ€è·¯3æœ¬è´¨ä¸Šä¸€æ ·</em></strong>ï¼Œæ˜¯é€šè¿‡ä¸€å®šçš„æ‰‹æ®µè®©å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶ï¼Œä»¥å¤§æ–‡ä»¶ä½œä¸ºæ­£å¼çš„Map-Reduceä»»åŠ¡çš„æ•°æ®è¾“å…¥ã€‚</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/TextInputFormat.png" alt="Hadoopæºç "> é»˜è®¤æƒ…å†µä¸‹ï¼ŒMap-Reduceä½¿ç”¨çš„é»˜è®¤è¾“å…¥æ ¼å¼ï¼ˆInputFormatï¼‰æ˜¯<strong><em>TextInputFormat</em></strong>ï¼Œé€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥<strong><em>TextInputFormat</em></strong>å®ç°çš„æ³›å‹æ˜¯<strong><em>&lt;LongWritable, Text&gt;</em></strong>ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬Mapä»»åŠ¡çš„è¾“å…¥æ˜¯<strong><em>&lt;LongWritable, Text&gt;</em></strong>ã€‚ è°ƒç”¨getRecordReaderæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªçœŸæ­£çš„<strong><em>RecordReader&lt;LongWritable, Text&gt;</em></strong>å¯¹è±¡ï¼ˆå®ç°äº†å…·ä½“è¯»æ–‡ä»¶çš„é€»è¾‘ï¼‰ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚æ¯æ¬¡æˆ‘ä»¬æŠŠMap-Reduceçš„ä½œä¸šæäº¤ä¹‹åï¼Œç³»ç»Ÿä¼šæ ¹æ®è®¾å®šçš„InputFormatï¼ˆé»˜è®¤/è‡ªå®šä¹‰ï¼‰å»ºç«‹ä¸€ä¸ªRecordReaderå¯¹è±¡æ¥è¯»å–Splitï¼Œå¹¶æŒ‰ç…§ä¸€å®šæ ¼å¼å¯¹Splitè¿›è¡Œé¢„å¤„ç†ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œé»˜è®¤çš„RecordReaderä¸º<strong><em>LineRecordReader</em></strong>ï¼Œä¹Ÿå°±æ˜¯æŒ‰è¡Œè¯»å–Splitä¸­çš„æ•°æ®å†…å®¹ï¼Œæ¯è¯»å–ä¸€è¡Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª<strong><em>&lt;LongWritable, Text&gt;</em></strong>ï¼ˆè¡Œèµ·å§‹åç§»é‡, æ–‡æœ¬å†…å®¹)çš„K-Vå¯¹ã€‚åˆ©ç”¨RecordReaderä¸æ–­åœ°è¯»å–ï¼Œå°±å¯ä»¥å®Œæˆmapç«¯çš„è¾“å…¥ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/mergeProcess.png" alt="åˆå¹¶è¿‡ç¨‹ç¤ºæ„å›¾"> åŸºäºä»¥ä¸ŠåŸç†ï¼Œå®ç°å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶çš„é€»è¾‘å…¶å®å¾ˆç®€å•ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå®šä¹‰InputFormatï¼Œå¯¹æ¯ä¸ªå°æ–‡ä»¶ä¸å†é€è¡Œè¯»å–ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå°æ–‡ä»¶çš„å†…å®¹å…¨éƒ¨è¯»å–ä»¥ç”Ÿæˆ<strong><em>&lt;å°æ–‡ä»¶å, æ–‡ä»¶å…¨éƒ¨å†…å®¹&gt;</em></strong>çš„K-Vå¯¹ï¼Œç„¶åå°†Nä¸ªå°æ–‡ä»¶çš„Nä¸ªK-Vå¯¹é€šè¿‡<strong><em>1ä¸ªReducer</em></strong>æœ€ç»ˆåˆå¹¶æˆä¸€ä¸ªå¤§æ–‡ä»¶(<strong>æœ¬ä¾‹ä½¿ç”¨SequenceFile</strong>)ã€‚ <strong>æ‰€ä»¥ï¼Œå…³é”®å°±åœ¨äºå®ç°è‡ªå®šä¹‰çš„InputFormatç±»ä¸è‡ªå®šä¹‰çš„RecordReaderç±»ã€‚</strong></p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><h4 id="ç®€è¦åŸç†"><a href="#ç®€è¦åŸç†" class="headerlink" title="ç®€è¦åŸç†"></a>ç®€è¦åŸç†</h4><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/relations.png" alt="åˆå¹¶è¿‡ç¨‹ç¤ºæ„å›¾"> ç½‘ä¸Šçš„å„ç§è‡ªå®šä¹‰InputFormatæ•™ç¨‹ä¸­æ€»æ˜¯å…ˆè´´ä¸€å¤§æ®µä»£ç ï¼Œè®©äººå¾ˆéš¾ä¸€ä¸‹å­ææ¸…æ¥šInputFormatã€RecordReaderå’ŒMap-Reduceä»»åŠ¡çš„å…³ç³»ã€‚ç®€å•æ¥è¯´ï¼ŒInputFormatå’ŒRecordReaderçš„åŠŸèƒ½å¦‚ä¸‹</p>
<ul>
<li><strong>è‡ªå®šä¹‰çš„InputFormatä¸ºæœ¬æ¬¡Map-Reduceä»»åŠ¡æä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReader</strong></li>
<li><strong>è‡ªå®šä¹‰çš„RecordReaderå®ç°å…·ä½“çš„å¦‚ä½•ä»Splitä¸­è¯»å–æ•°æ®çš„é€»è¾‘</strong></li>
</ul>
<h4 id="Javaä»£ç "><a href="#Javaä»£ç " class="headerlink" title="Javaä»£ç "></a>Javaä»£ç </h4><p>é¦–å…ˆå®ç°è‡ªå®šä¹‰çš„RecordReaderç±»ã€‚</p>
<pre><code>/**
 * è‡ªå®šä¹‰çš„RecordReader, ç”¨äºå°†Splitä¸­çš„å†…å®¹è½¬æ¢ä¸ºè‡ªå®šä¹‰çš„K-Vå¯¹å½¢å¼
 */
public class MyRecordReader extends RecordReader&lt;Text, BytesWritable&gt; {

    private FileSplit split;        // è¯»å…¥çš„æ–‡ä»¶split
    private boolean isFinished;     // è½¬æ¢æ˜¯å¦å®Œæˆçš„æ ‡å¿—ä½
    private Text key;               // è¾“å‡ºKey
    private BytesWritable value;    // è¾“å‡ºValue
    private JobContext context;     // ä½œä¸šå†…å®¹

    /**
     * åˆå§‹åŒ–RecordReaderæ–¹æ³•
     * @param inputSplit è¯»å…¥çš„æ–‡ä»¶split
     * @param taskAttemptContext ä½œä¸šå†…å®¹
     * @throws IOException
     * @throws InterruptedException
     */
    @Override
    public void initialize(InputSplit inputSplit, TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException {
        this.isFinished = false;
        this.key = new Text();
        this.value = new BytesWritable();
        this.split = (FileSplit) inputSplit;
        this.context = taskAttemptContext;
    }

    /**
     * å‘Šè¯‰è°ƒç”¨è€…æ˜¯å¦è¿˜æœ‰æœªè¯»çš„ä¸‹ä¸€ä¸ªK-Vå¯¹
     * @return true / false
     * @throws IOException
     * @throws InterruptedException
     */
    @Override
    public boolean nextKeyValue() throws IOException, InterruptedException {
        if(!isFinished) {

            String fileName = this.split.getPath().getName();
            this.key.set(fileName);

            int contentLength = (int)split.getLength();
            byte[] content = new byte[contentLength];
            FileSystem fs = FileSystem.get(context.getConfiguration());
            FSDataInputStream inputStream = null;
            try {
                inputStream = fs.open(this.split.getPath());
                IOUtils.readFully(inputStream, content, 0, contentLength);
                value.set(content, 0, contentLength);
            } catch (Exception e) {
                System.out.println(e.toString());
            } finally {
                if(inputStream != null) {
                    try {
                        IOUtils.closeStream(inputStream);
                    } catch (Exception e) {
                        System.out.println(e.toString());
                    }
                }
            }
            isFinished = true;
            return true;
        }
        return false;
    }

    /**
     * è¿”å›å½“å‰è¯»åˆ°çš„Key
     * @return key
     * @throws IOException
     * @throws InterruptedException
     */
    @Override
    public Text getCurrentKey() throws IOException, InterruptedException {
        return this.key;
    }

    /**
     * è¿”å›å½“å‰è¯»åˆ°çš„Value
     * @return
     * @throws IOException
     * @throws InterruptedException
     */
    @Override
    public BytesWritable getCurrentValue() throws IOException, InterruptedException {
        return this.value;
    }

    /**
     * è¿”å›è½¬æ¢è¿‡ç¨‹çš„çŠ¶æ€ (æ˜¯å¦è½¬æ¢å®Œæˆ)
     * @return true / false
     * @throws IOException
     * @throws InterruptedException
     */
    @Override
    public float getProgress() throws IOException, InterruptedException {
        return this.isFinished ? 1.0f : 0.0f;
    }

    @Override
    public void close() throws IOException {

    }
}
</code></pre><p>ç„¶åå®ç°è‡ªå®šä¹‰çš„InputFormatç±»ã€‚</p>
<pre><code>/**
 * è‡ªå®šä¹‰InputFormat, åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReader(ä»¥å®ç°è‡ªå®šä¹‰çš„è¯»å–è¾“å…¥æ–‡ä»¶é€»è¾‘)
 */
public class MyInputFormat extends FileInputFormat&lt;Text, BytesWritable&gt;{
    @Override
    public RecordReader&lt;Text, BytesWritable&gt; createRecordReader(InputSplit inputSplit,
                                                                TaskAttemptContext taskAttemptContext) throws IOException, InterruptedException {
        // åˆå§‹åŒ–ä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReaderå¹¶è¿”å›
        RecordReader&lt;Text, BytesWritable&gt; recordReader = new MyRecordReader();
        recordReader.initialize(inputSplit, taskAttemptContext);
        return recordReader;
    }
}
</code></pre><p>å®ç°äº†è‡ªå®šä¹‰çš„<strong><em>MyInputFormat</em></strong>ç±»å’Œ<strong><em>MyRecordReader</em></strong>ç±»åï¼ŒMapperå’ŒReducerå¹¶æ²¡æœ‰ä»€ä¹ˆå¯åšçš„ï¼Œmapç«¯åªæ˜¯ç®€å•åœ°å°†æ•°æ®è¾“å…¥ç›´æ¥è¾“å‡ºï¼Œreduceç«¯æ”¶é›†åˆ°K-Vå¯¹åå°†å…¶ç›´æ¥è¾“å‡ºã€‚</p>
<pre><code>/**
 * Mapper, è´Ÿè´£å¤„ç†ä»Splitä¸­è¯»å–çš„K-Vå‹æ•°æ®
 */
public class MyMapper extends Mapper&lt;Text, BytesWritable, Text, BytesWritable&gt; {

    @Override
    protected void map(Text key, BytesWritable value, Context context) throws IOException, InterruptedException {
        context.write(key, value);
    }
}


/**
 * Reducer, è´Ÿè´£æ¥æ”¶K-Vå¯¹åè¾“å‡ºä¸ºç»“æœæ–‡ä»¶
 */
public class MyReducer extends Reducer&lt;Text, BytesWritable, Text, BytesWritable&gt; {
    @Override
    protected void reduce(Text key, Iterable&lt;BytesWritable&gt; values, Context context) throws IOException, InterruptedException {
        for(BytesWritable value : values) {
            context.write(key, value);
        }
    }
}
</code></pre><p>æœ€åæŠŠJobä¿¡æ¯è®¾ç½®å¥½åå°±å¯ä»¥æäº¤åˆ°é›†ç¾¤ä¸Šè¿è¡Œã€‚</p>
<pre><code>/**
 * ç¨‹åºå…¥å£
 */
public class Driver {

    private static final String HDFS_HOST = &quot;hdfs://localhost:9000&quot;;
    private static final int NUM_REDUCE_TASKS = 1;
    private static final String FILE_INPUT_PATH = &quot;/small_files/data&quot;;
    private static final String RESULT_OUTPUT_PATH = &quot;/small_files/output&quot;;

    public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException {

        Configuration conf = new Configuration();
        conf.set(&quot;fs.defaultFS&quot;, HDFS_HOST);
        Job myJob = Job.getInstance(conf);

        // é€šè¿‡ç±»åè®¾ç½®è¿è¡Œçš„jaråŒ…
        myJob.setJarByClass(Driver.class);

        // è®¾ç½®Mapper Classä¸Reducer Class
        myJob.setMapperClass(MyMapper.class);
        myJob.setReducerClass(MyReducer.class);

        // è®¾ç½®Mapperä¸Reducerçš„è¾“å‡ºæ•°æ®ç±»å‹
        myJob.setMapOutputKeyClass(Text.class);
        myJob.setMapOutputValueClass(BytesWritable.class);
        myJob.setOutputKeyClass(Text.class);
        myJob.setOutputValueClass(BytesWritable.class);

        // è®¾ç½®InputFormatä¸OutputFormat
        // ä½¿ç”¨è‡ªå®šä¹‰çš„InputFormatä½œä¸ºInputæ ¼å¼, Sequenceæ–‡ä»¶ä½œä¸ºOutputæ ¼å¼
        myJob.setInputFormatClass(MyInputFormat.class);
        myJob.setOutputFormatClass(SequenceFileOutputFormat.class);

        // è‡ªå®šä¹‰Reduce Taskæ•°é‡, å†³å®šæœ€ç»ˆè¾“å‡ºå¤šå°‘ä¸ªç»“æœæ–‡ä»¶
        myJob.setNumReduceTasks(NUM_REDUCE_TASKS);

        // è®¾ç½®æ•°æ®æ‰€åœ¨ç›®å½•, ç»“æœè¾“å‡ºç›®å½•
        FileInputFormat.setInputPaths(myJob, new Path(FILE_INPUT_PATH));
        FileOutputFormat.setOutputPath(myJob, new Path(RESULT_OUTPUT_PATH));

        System.exit(myJob.waitForCompletion(true) ? 1 : 0);

    }
}
</code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å½“HDFSä¸­å­˜å‚¨äº†æµ·é‡å°æ–‡ä»¶æ—¶ï¼Œåˆ©ç”¨è‡ªå®šä¹‰çš„InputFormatå’ŒRecordReaderå¯åŠ¨Map-Reduceä»»åŠ¡å¯å°†å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶ã€‚è¿™ä¸ªåˆå¹¶çš„Jobå¯ä»¥æ”¾åœ¨æ­£å¼çš„Map-Reduceä»»åŠ¡å‰ï¼Œåˆ©ç”¨ControlledJobå¯¹åˆå¹¶Jobä¸æ­£å¼Jobè¿›è¡Œæ§åˆ¶ï¼Œåˆå¹¶ç»“æŸåæ‰å¯åŠ¨æ­£å¼Jobï¼›ä¹Ÿå¯ä»¥å®šæ—¶åœ°å¯¹HDFSä¸Šçš„æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œé¿å…éœ€è¦ç”¨æ—¶æ‰è¿›è¡Œåˆå¹¶ã€‚ <strong>å½“ç„¶ï¼Œæœ€ä¼˜æ–¹æ¡ˆè¿˜æ˜¯åœ¨ç³»ç»Ÿå‰æ²¿å°±æŠŠæ•°æ®åˆå¹¶æˆå°½é‡å¤§çš„æ–‡ä»¶ï¼Œå†æŠŠå¤§æ–‡ä»¶å†™å…¥HDFSã€‚</strong></p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><p>å®Œæ•´ä»£ç è¯·æŸ¥çœ‹ï¼š <a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/inputformat" target="_blank" rel="noopener">æˆ‘çš„Githubç›®å½•</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/17/customizeinputformat/" data-id="cjpg78r6x002pbxuy39ev4sn6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mapreduce/">mapreduce</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-osxmr" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/13/osxmr/" class="article-date">
  <time datetime="2018-02-13T14:58:51.000Z" itemprop="datePublished">2018-02-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/13/osxmr/">OS Xä¸‹MapReduceç¨‹åºè¿è¡Œçš„å‡ ç§æ¨¡å¼</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h1 id="1-MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹"><a href="#1-MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹" class="headerlink" title="1.MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹"></a>1.MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹</h1><ol>
<li>ç¨‹åºè¿è¡Œæ¨¡å¼<ul>
<li>æœ¬åœ°æ¨¡å¼<ul>
<li>åˆ©ç”¨æœ¬åœ°çš„JVMè¿è¡Œï¼Œä½¿ç”¨æœ¬åœ°çš„IDEè¿›è¡Œdebug</li>
</ul>
</li>
<li>è¿œç¨‹æ¨¡å¼<ul>
<li>æäº¤è‡³è¿œç¨‹çš„é›†ç¾¤ä¸Šè¿è¡Œï¼Œä½¿ç”¨æœ¬åœ°çš„IDEè¿›è¡Œdebug</li>
<li>æäº¤è‡³è¿œç¨‹çš„é›†ç¾¤ä¸Šè¿è¡Œï¼Œä¸ä½¿ç”¨æœ¬åœ°IDEè¿›è¡Œdebug</li>
</ul>
</li>
</ul>
</li>
<li>æ•°æ®å­˜æ”¾è·¯å¾„<ul>
<li>è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿï¼ˆhdfs)</li>
<li>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆlocal file system)</li>
</ul>
</li>
</ol>
<h1 id="2-å¼€å‘ç¯å¢ƒç®€ä»‹"><a href="#2-å¼€å‘ç¯å¢ƒç®€ä»‹" class="headerlink" title="2.å¼€å‘ç¯å¢ƒç®€ä»‹"></a>2.å¼€å‘ç¯å¢ƒç®€ä»‹</h1><ul>
<li>æ“ä½œç³»ç»Ÿï¼šmacOS Sierra 10.12.6</li>
<li>Javaç‰ˆæœ¬ï¼š1.8.0_131-b11</li>
<li>Hadoopç‰ˆæœ¬ï¼šhadoop-2.7.4</li>
<li>IDEï¼šIntelliJ IDEA</li>
</ul>
<h1 id="3-MapReduceç¨‹åºè¿è¡Œä¾‹å­"><a href="#3-MapReduceç¨‹åºè¿è¡Œä¾‹å­" class="headerlink" title="3.MapReduceç¨‹åºè¿è¡Œä¾‹å­"></a>3.MapReduceç¨‹åºè¿è¡Œä¾‹å­</h1><h2 id="3-1-ç¨‹åºéœ€æ±‚"><a href="#3-1-ç¨‹åºéœ€æ±‚" class="headerlink" title="3.1 ç¨‹åºéœ€æ±‚"></a>3.1 ç¨‹åºéœ€æ±‚</h2><blockquote>
<p>å­¦æ ¡é‡Œå¼€è®¾äº†å¤šé—¨è¯¾ç¨‹ï¼Œæœ‰è¯­æ–‡ï¼ˆchineseï¼‰ã€æ•°å­¦ï¼ˆmathï¼‰ã€è‹±è¯­ï¼ˆenglishï¼‰ç­‰ã€‚ç»è¿‡äº†ä¸€æ¬¡å¹´çº§ç»Ÿè€ƒåï¼Œæ¯ä¸ªå­¦ç”Ÿçš„æˆç»©éƒ½è¢«è®°å½•åœ¨å¤šä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œæ–‡æœ¬æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ã€‚</p>
</blockquote>
<ul>
<li><p>math.txt</p>
<p>Ben 75<br>Jack 60<br>May 85<br>Tom 91</p>
</li>
</ul>
<ul>
<li><p>english.txt</p>
<p>Jack 72<br>May 60<br>Tom 62<br>Ben 90</p>
</li>
</ul>
<ul>
<li><p>chinese.txt</p>
<p>Ben 79<br>May 88<br>Tom 68<br>Jack 70</p>
</li>
</ul>
<blockquote>
<p>ç°éœ€è¦æ ¹æ®ä»¥ä¸Šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œç®—å‡ºæ¯ä¸ªå­¦ç”Ÿåœ¨æœ¬æ¬¡ç»Ÿè€ƒä¸­çš„å¹³å‡åˆ†ï¼Œå¹¶å°†ç»“æœç”¨ä¸€ä¸ªæ€»çš„æ–‡ä»¶averageScore.txtè¿›è¡Œå­˜å‚¨ã€‚averageScore.txtçš„æ ¼å¼å¦‚ä¸‹ã€‚</p>
</blockquote>
<ul>
<li><p>averageScore.txt</p>
<p>#name #score<br>Ben 0.0<br>May 0.0<br>Tom 0.0<br>Jack 0.0</p>
</li>
</ul>
<h2 id="3-2-ç¨‹åºè®¾è®¡æ€è·¯"><a href="#3-2-ç¨‹åºè®¾è®¡æ€è·¯" class="headerlink" title="3.2 ç¨‹åºè®¾è®¡æ€è·¯"></a>3.2 ç¨‹åºè®¾è®¡æ€è·¯</h2><h3 id="3-2-1-Mapperçš„å¤„ç†é€»è¾‘"><a href="#3-2-1-Mapperçš„å¤„ç†é€»è¾‘" class="headerlink" title="3.2.1 Mapperçš„å¤„ç†é€»è¾‘"></a>3.2.1 Mapperçš„å¤„ç†é€»è¾‘</h3><p>Mapperæ¯æ¬¡ä»æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–<strong>1è¡Œå†…å®¹</strong>ï¼Œå³è°ƒç”¨1æ¬¡mapæ–¹æ³•ã€‚Mapperéœ€è¦æŠŠåŸå§‹æ•°æ®ä¸­ä¸€è¡Œçš„å†…å®¹æ‹†åˆ†æˆå­¦ç”Ÿå§“åï¼ˆstudent nameï¼‰å’Œè¯¥é—¨è¯¾ç¨‹çš„åˆ†æ•°ï¼ˆscoreï¼‰ã€‚æŒ‰ç…§éœ€æ±‚ï¼Œæœ¬ç¨‹åºæœ€ç»ˆè¦ç®—å‡ºæ¯ä¸€ä¸ªå­¦ç”Ÿçš„å¹³å‡åˆ†ï¼Œæ‰€ä»¥å­¦ç”Ÿå§“ååº”ä½œä¸ºä¸€ä¸ªkeyï¼Œå¯¹åº”çš„valueå³ä¸ºè¯¥ç”Ÿçš„å¹³å‡åˆ†<strong><em>ï¼ˆå®é™…ä¸Šæ˜¯ä¸ä¸¥è°¨çš„ï¼Œå› ä¸ºåœ¨å®é™…ç¯å¢ƒä¸­ä¼šå‡ºç°å¤šä¸ªå­¦ç”Ÿé‡åçš„ç°è±¡ï¼Œè‹¥ä¸ä½œç‰¹æ®Šå¤„ç†ï¼Œkeyæ˜¯ä¸å…è®¸é‡å¤çš„ã€‚æœ€æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨å­¦å·ä½œä¸ºkeyï¼Œä½†ä¸ºäº†æ¼”ç¤ºç›´è§‚ï¼Œä»…é‡‡ç”¨å­¦ç”Ÿå§“åä½œä¸ºkeyï¼‰</em></strong>ã€‚ Mapperè¯»å®Œä¸€è¡Œçš„æ•°æ®åï¼ŒæŠŠ<code>{student nameï¼Œscore}</code>è¿™ä¸ª<code>key-value</code>å†™å…¥ä¸­é—´ç»“æœï¼Œå‡†å¤‡ä¼ é€ç»™Reducerä½œä¸‹ä¸€æ­¥çš„è¿ç®—ã€‚</p>
<h3 id="3-2-2-Reducerçš„å¤„ç†é€»è¾‘"><a href="#3-2-2-Reducerçš„å¤„ç†é€»è¾‘" class="headerlink" title="3.2.2 Reducerçš„å¤„ç†é€»è¾‘"></a>3.2.2 Reducerçš„å¤„ç†é€»è¾‘</h3><p>Reduceræ¥æ”¶åˆ°çš„æ•°æ®ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªkeyä¸è¯¥keyå¯¹åº”çš„valueçš„ä¸€ä¸ª<strong>é›†åˆ</strong>ï¼ˆå¹¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªvalueï¼‰ã€‚åœ¨æœ¬éœ€æ±‚ä¸­ï¼Œä¼ å…¥reduceæ–¹æ³•çš„å‚æ•°æ˜¯å­¦ç”Ÿå§“åï¼Œä»¥åŠè¯¥ç”Ÿå¤šé—¨è¯¾ç¨‹åˆ†æ•°çš„é›†åˆï¼Œç±»ä¼¼äº<code>Ben,[60,70,80,...]</code>ã€‚æ‰€ä»¥Reduceréœ€è¦å°†é›†åˆä¸­çš„åˆ†æ•°æ±‚å’Œï¼Œç„¶åæ±‚å‡ºå¹³å‡å€¼ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª<code>{student name, average score}</code>çš„<code>key-value</code>å¯¹ã€‚</p>
<h3 id="3-2-3-å…·ä½“ä»£ç è®¾è®¡"><a href="#3-2-3-å…·ä½“ä»£ç è®¾è®¡" class="headerlink" title="3.2.3 å…·ä½“ä»£ç è®¾è®¡"></a>3.2.3 å…·ä½“ä»£ç è®¾è®¡</h3><ul>
<li><p>AVGMapperç±»<br>ç”¨äºå®ç°mapæ–¹æ³•</p>
<p>package mr;</p>
<p>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.LongWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Mapper;<br>import java.io.IOException;</p>
<p>/**</p>
<ul>
<li>Created by marco on 2017/8/17.<br>*/<br>public class AVGMapper extends Mapper&lt;LongWritable, Text, Text, DoubleWritable&gt;<br>{<br> @Override<br> protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException<br> {<pre><code>String line = value.toString();
if(line.length() == 0)  // æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå‡ºç°ç©ºè¡Œ
    return;
String[] split = line.split(&quot; &quot;);
String stuName = split[0];
String stuScore = split[1];
double score = Double.parseDouble(stuScore);    // è½¬æˆdoubleç±»å‹ï¼Œæ–¹ä¾¿åç»­æ±‚å‡å€¼è®¡ç®—
context.write(new Text(stuName), new DoubleWritable(score));
</code></pre> }<br>}</li>
</ul>
</li>
</ul>
<ul>
<li><p>AVGReducerç±»<br>ç”¨äºå®ç°reduceæ–¹æ³•</p>
<p>package mr;</p>
<p>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Reducer;<br>import java.io.IOException;</p>
<p>/**</p>
<ul>
<li><p>Created by marco on 2017/8/17.<br>*/<br>public class AVGReducer extends Reducer&lt;Text, DoubleWritable, Text, DoubleWritable&gt;<br>{<br> @Override<br> protected void reduce(Text key, Iterable<doublewritable> values, Context context) throws IOException, InterruptedException<br> {</doublewritable></p>
<pre><code>double sum = 0;
int length = 0;
for(DoubleWritable value : values)
{
    sum += value.get();
    length++;
}

double avgScore = sum / (double)length;
context.write(key, new DoubleWritable(avgScore));
</code></pre><p> }<br>}</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>AVGRunnerç±»<br>ç”¨äºå…³è”Mapperä¸Reducerï¼Œå¹¶åˆ›å»ºMapReduceä»»åŠ¡ï¼ˆJobï¼‰æäº¤è¿è¡Œã€‚åŸºæœ¬ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p>package mr;</p>
<p>import org.apache.hadoop.conf.Configuration;<br>import org.apache.hadoop.fs.FileSystem;<br>import org.apache.hadoop.fs.Path;<br>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Job;<br>import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;<br>import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</p>
<p>/**</p>
<ul>
<li><p>Created by marco on 2017/8/17.<br>*/<br>public class AVGRunner<br>{<br> static public void main(String[] args) throws Exception<br> {</p>
<pre><code>// è®¾ç½®hdfsçš„handler
Configuration fsConf = new Configuration();
fsConf.set(&quot;fs.default.name&quot;,&quot;hdfs://localhost:9000/&quot;);
FileSystem fs = FileSystem.get(fsConf);

// MapReduceçš„é…ç½®å‚æ•°
Configuration mrConf = new Configuration();

// æ–°å»ºä¸€ä¸ªæ±‚å¹³å‡å€¼çš„Job
Job avgJob = Job.getInstance(mrConf);
avgJob.setJarByClass(AVGRunner.class);

// è®¾ç½®Mapperç±»ä¸Reducerç±»
avgJob.setMapperClass(AVGMapper.class);
avgJob.setReducerClass(AVGReducer.class);

// è®¾ç½®è¾“å…¥è¾“å‡ºçš„æ•°æ®ç»“æ„
avgJob.setMapOutputKeyClass(Text.class);
avgJob.setMapOutputValueClass(DoubleWritable.class);
avgJob.setOutputKeyClass(Text.class);
avgJob.setOutputValueClass(DoubleWritable.class);

// æ£€æŸ¥ç»“æœè¾“å‡ºç›®å½•ï¼Œè‹¥å·²å­˜åœ¨åˆ™åˆ é™¤è¾“å‡ºç›®å½•
if(fs.exists(new Path(&quot;/avg/output&quot;)))
{
    fs.delete(new Path(&quot;/avg/output&quot;), true);
}

// è®¾ç½®æ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•
FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));
FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));

// æäº¤ä»»åŠ¡ï¼Œç­‰å¾…å®Œæˆ
System.exit(avgJob.waitForCompletion(true)?0:1);
</code></pre><p> }<br>}</p>
</li>
</ul>
</li>
</ul>
<h2 id="3-3-MapReduceç¨‹åºè¿è¡Œ"><a href="#3-3-MapReduceç¨‹åºè¿è¡Œ" class="headerlink" title="3.3 MapReduceç¨‹åºè¿è¡Œ"></a>3.3 MapReduceç¨‹åºè¿è¡Œ</h2><blockquote>
<p>è‹¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ–‡ä»¶ï¼Œä¸”åœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œæ— éœ€é…ç½®hdfsç›¸å…³çš„å‚æ•°ï¼Œæ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•å¡«å†™æœ¬åœ°è·¯å¾„å³å¯ã€‚<strong>ï¼ˆç¡®ä¿ç»“æœè¾“å‡ºæ–‡ä»¶å¤¹æœªè¢«åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ï¼‰</strong></p>
</blockquote>
<pre><code>// å‡å¡«å†™æœ¬åœ°æ–‡ä»¶è·¯å¾„å³å¯
FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));
FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));
</code></pre><blockquote>
<p>è‹¥ä½¿ç”¨hdfsä¸Šçš„æ•°æ®æ–‡ä»¶ï¼Œä¸”åœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œåº”é…ç½®hdfsç›¸å…³å‚æ•°ï¼Œæ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•å‡å¡«å†™hdfsçš„è·¯å¾„ã€‚<strong>ï¼ˆç¡®ä¿ç»“æœè¾“å‡ºæ–‡ä»¶å¤¹æœªè¢«åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ï¼‰</strong></p>
</blockquote>
<pre><code>// è®¾ç½®hdfså‚æ•°ï¼Œå¹¶ç”¨è¯¥é…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„Job
Configuration fsConf = new Configuration();
fsConf.set(&quot;fs.default.name&quot;,&quot;hdfs://localhost:9000/&quot;);
Job avgJob = Job.getInstance(fsConf);


// å‡å¡«å†™hdfsè·¯å¾„å³å¯
FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));
FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));
</code></pre><h3 id="3-3-1-æœ¬åœ°æ¨¡å¼è¿è¡Œ"><a href="#3-3-1-æœ¬åœ°æ¨¡å¼è¿è¡Œ" class="headerlink" title="3.3.1 æœ¬åœ°æ¨¡å¼è¿è¡Œ"></a>3.3.1 æœ¬åœ°æ¨¡å¼è¿è¡Œ</h3><p>æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œç›´æ¥ç¼–è¯‘æ‰§è¡ŒAVGRunnerçš„mainæ–¹æ³•å³å¯ï¼Œç¨‹åºè¿è¡Œç»“æŸåä¼šåœ¨è‡ªè¡Œè®¾ç½®çš„ç»“æœè¾“å‡ºç›®å½•ä¸­ç”Ÿæˆè¿è¡Œç»“æœã€‚</p>
<h3 id="3-3-2-è¿œç¨‹é›†ç¾¤è¿è¡Œ"><a href="#3-3-2-è¿œç¨‹é›†ç¾¤è¿è¡Œ" class="headerlink" title="3.3.2 è¿œç¨‹é›†ç¾¤è¿è¡Œ"></a>3.3.2 è¿œç¨‹é›†ç¾¤è¿è¡Œ</h3><p><strong>é¦–å…ˆä½¿ç”¨IDEå°†ç¨‹åºæ‰“æˆä¸€ä¸ªjaråŒ…ï¼Œæœ¬ä¾‹ä¸­å‘½åä¸ºhadoop.jar</strong> æäº¤åˆ°è¿œç¨‹é›†ç¾¤ä¸Šè¿è¡Œåˆ†ä¸¤ç§æƒ…å†µ</p>
<ul>
<li><p>ä½¿ç”¨æœ¬åœ°IDEï¼ˆIntelliJ IDEAï¼‰è¿è¡Œï¼Œä»»åŠ¡è¢«æäº¤åˆ°é›†ç¾¤è¿è¡Œï¼Œ<strong>ä½†å¯ä½¿ç”¨IDEè¿›è¡Œè·Ÿè¸ªdebug</strong> æ–°å»ºä¸€ä¸ªMapReduceçš„é…ç½®å¯¹è±¡ï¼Œå°†å·²ç»æ‰“åŒ…å¥½çš„jaråŒ…ä¼ å…¥é…ç½®ä¸­</p>
<pre><code>// MapReduceçš„é…ç½®å‚æ•°ï¼Œè¿œç¨‹è¿è¡Œï¼Œæœ¬åœ°debug
Configuration mrConf = new Configuration();
mrConf.set(&quot;mapreduce.job.jar&quot;,&quot;hadoop.jar&quot;);
mrConf.set(&quot;mapreduce.framework.name&quot;,&quot;yarn&quot;);

//åˆ©ç”¨ä»¥ä¸Šé…ç½®æ–°å»ºä¸€ä¸ªJob
Job avgJob = Job.getInstance(mrConf);
avgJob.setJarByClass(AVGRunner.class);
</code></pre></li>
</ul>
<ul>
<li><p>åœ¨ç»ˆç«¯ç›´æ¥ä½¿ç”¨hadoopå‘½ä»¤å°†ä»»åŠ¡æäº¤åˆ°é›†ç¾¤è¿è¡Œï¼Œ<strong>æ— æ³•ä½¿ç”¨IDEè¿›è¡Œè·Ÿè¸ªdebug</strong> ç›´æ¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥hadoopå‘½ä»¤</p>
<pre><code>hadoop jar $jaråŒ…åç§° $å¾…æ‰§è¡Œçš„ç±»çš„åç§°
</code></pre></li>
</ul>
<pre><code>åœ¨æœ¬ä¾‹ä¸­åº”è¾“å…¥

    hadoop jar avg.jar mr.AVGRunner
</code></pre><blockquote>
<p><strong>####################### æ³¨æ„âš ï¸ #######################</strong> åœ¨OS Xä¸­ï¼Œä½¿ç”¨IntelliJ IDEAæ‰“åŒ…jaråŒ…åï¼Œè‹¥åœ¨ç»ˆç«¯ä¸­ç›´æ¥ä½¿ç”¨<code>hadoop jar $jaråŒ…åç§° $å¾…æ‰§è¡Œçš„ç±»çš„åç§°</code>æäº¤MapReduceä»»åŠ¡ï¼Œä¼šæŠ¥å‡ºå¼‚å¸¸ï¼Œå› ä¸ºOS Xç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå¯¹å¤§å°å†™ä¸æ•æ„Ÿ<strong><em>ï¼ˆcase-insensitiveï¼‰</em></strong>ã€‚ ç»è¿‡å¯¹æ­¤å¼‚å¸¸çš„æœç´¢ï¼Œ<strong>æš‚æ—¶çš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡åˆ é™¤jaråŒ…ä¸­çš„LICENSEæ–‡ä»¶</strong>ï¼Œä½¿ä»»åŠ¡é¡ºåˆ©æäº¤ã€‚</p>
<pre><code># åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
  zip -d $jaråŒ…åç§° META-INF/LICENSE
  zip -d $jaråŒ…åç§° LICENSE
</code></pre><p><strong>#####################################################</strong></p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/7445555-d6ff47959f4616b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†hadoopå‘½ä»¤æäº¤ä»»åŠ¡åï¼Œç³»ç»Ÿè°ƒç”¨äº†RPCæ¡†æ¶å’ŒYarnæ¡†æ¶ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œç”¨äºè¿œç¨‹è¿è¡Œï¼Œè€Œéä½¿ç”¨LocalJobSubmitteräºæœ¬åœ°è¿è¡Œã€‚<br><img src="http://upload-images.jianshu.io/upload_images/7445555-4c5e6823f3ec9ade.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">å¹¶ä¸”åœ¨MapReduceä»»åŠ¡ç®¡ç†é¡µé¢å¯çœ‹åˆ°ä»»åŠ¡å·²ç»å®Œæˆçš„å†å²è®°å½•ã€‚</p>
<h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h1><p>MapReduceä»»åŠ¡å¯åœ¨æœ¬åœ°è¿è¡Œï¼Œä¹Ÿå¯æäº¤åˆ°é›†ç¾¤ä¸Šè¿è¡Œã€‚ åœ¨å¼€å‘åˆæœŸï¼Œéœ€è¦ç¼–å†™Demoç¨‹åºæ—¶ï¼Œå¯åœ¨æœ¬åœ°è¿›è¡Œå¼€å‘ä¸æµ‹è¯•ï¼Œå°†æ•°æ®æ–‡ä»¶æ”¾ç½®åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œç›´æ¥ä½¿ç”¨IDEè¿è¡Œä¸»ç±»çš„mainæ–¹æ³•ï¼Œè§‚å¯Ÿè¿è¡Œç»“æœã€‚ ä¸Šçº¿å‰è°ƒè¯•ï¼Œå¯é‡‡ç”¨è¿œç¨‹æ¨¡å¼è¿è¡Œï¼Œä¸ç›´æ¥ä½¿ç”¨hadoopå‘½ä»¤æäº¤ï¼Œè€Œæ˜¯ä½¿ç”¨IDEè¿›è¡Œæäº¤ä¸debugï¼Œè¿™æ ·æ—¢å¯ä»¥ä¿è¯ç¨‹åºè¿è¡Œåœ¨è¿œå¤„é›†ç¾¤ä¸Šï¼ˆç”Ÿäº§ç¯å¢ƒorå¼€å‘ç¯å¢ƒï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨æœ¬åœ°æ–¹ä¾¿è·Ÿè¸ªè°ƒè¯•ã€‚ å¯ä¸Šçº¿æ—¶ï¼Œä½¿ç”¨hadoopå‘½ä»¤ç›´æ¥æäº¤åˆ°è¿œç¨‹é›†ç¾¤ï¼Œå¹¶é€šè¿‡localhost:50070<strong>ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>çš„ä»»åŠ¡ç®¡ç†é¡µé¢è¿›è¡Œè§‚å¯Ÿã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/13/osxmr/" data-id="cjpg78r790038bxuyyckl9irg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ssort" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/13/ssort/" class="article-date">
  <time datetime="2018-02-13T14:54:02.000Z" itemprop="datePublished">2018-02-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/13/ssort/">å¦‚ä½•åœ¨Map-Reduceä¸­å®ç°äºŒæ¬¡æ’åºï¼ˆå¯¹Valueæ’åºï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒMap-Reduceä»»åŠ¡å®Œæˆåï¼Œè¾“å‡ºçš„ç»“æœæ–‡ä»¶æ€»æ˜¯æŒ‰ç…§Keyè¿›è¡Œå‡åºæ’åˆ—ï¼ˆshuffleé˜¶æ®µå®Œæˆï¼‰ã€‚ ä¾‹å¦‚Hadoopé‡Œç»å…¸çš„word countç¨‹åºï¼š</p>
<pre><code>// File1åŸå§‹æ•°æ®
hello
world
hello
apple
apple
apple
baby

// è¾“å‡ºç»“æœæ–‡ä»¶ï¼Œå·²æŒ‰Keyè¿›è¡Œå‡åºæ’åº
apple 3
baby 1
hello 2
world 1
</code></pre><p>æ˜¾ç„¶ï¼Œè¿™ç§é»˜è®¤çš„æ’åºæ–¹å¼å¾ˆå¤šæ—¶å€™èƒ½å¸®å¼€å‘è€…å‡è½»è´Ÿæ‹…ï¼Œå› ä¸ºå¼€å‘è€…ä¸ç”¨å»è‡ªè¡Œå®ç°å¯¹Keyè¿›è¡Œæ’åºçš„ç®—æ³•ï¼Œæ‰€æœ‰çš„æ’åºæ“ä½œå‡ç”±Hadoopå¸®å¼€å‘è€…å®Œæˆï¼ˆè¯¦æƒ…å‚è€ƒMap-Reduceä¸­çš„shuffleåŸç†ï¼Œ<strong><em>å…·ä½“å‚è€ƒmapç«¯çš„partition-&gt;spill-&gt;(spill.sort)-&gt;(combine)è¿‡ç¨‹</em></strong>ï¼‰ã€‚ <strong>ä¸€åˆ‡ä¼¼ä¹å¾ˆç¾å¥½ï¼Œå¯æ˜¯å¦‚æœæˆ‘ä»¬é‡åˆ°äº†è¦å¯¹valueæ’åºçš„éœ€æ±‚å‘¢ï¼Ÿ</strong></p>
<pre><code>// å‡è®¾æœ‰å¦‚ä¸‹ç”µå½±è¯„åˆ†æ•°æ® movies.dat
// ä¸”æˆ‘ä»¬å¸Œæœ›å¯¹ratingè¿›è¡Œé™åºæ’åº, ä»¥ä¾¿åˆ†ææ¯éƒ¨ç”µå½±çš„è¯„åˆ†è¶‹åŠ¿
MovieID, rating
  001,    75.5
  001,    89
  001,    60
  002,    55
  002,    79
  003,    92.5
  003,    92.8
  003,    60
 ......

// æœŸæœ›è¾“å‡ºå€¼ï¼ˆKeyæœ‰åºçš„åŒæ—¶ï¼ŒæŒ‰ratingé™åºæ’åºï¼‰
  001   89.0
  001   75.5
  001   60.0
  002   79.0
  002   55.0
  003   92.8
  003   92.5
  003   60.0
</code></pre><p>åœ¨â€œæ’åºâ€çš„éœ€æ±‚ä¸‹ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°ä¼šæƒ³åˆ°ï¼š</p>
<ul>
<li>åˆ©ç”¨ç³»ç»Ÿé»˜è®¤çš„æ’åºã€‚</li>
<li>é¢„å¤„ç†æ•°æ®ï¼ŒæŠŠratingå½“æˆKeyï¼ŒmovieIDå½“æˆValueã€‚</li>
</ul>
<p>è™½ç„¶æŒ‰ç…§ä»¥ä¸Šçš„æƒ³æ³•ï¼Œç¡®å®æ˜¯å¯¹ä½œä¸ºKeyçš„ratingæ’åºäº†ï¼Œä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯<strong>é™åº</strong>è¾“å‡ºè€Œéé»˜è®¤çš„å‡åºè¾“å‡ºï¼Œä¸”è¾“å‡ºæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼ˆç¬¬ä¸€åˆ—åº”ä¸ºmovieIDï¼‰ã€‚ æ­¤æ—¶ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ç§<strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>çš„æ¦‚å¿µäº†ã€‚æ‰€è°“<strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>å…¶å®å°±æ˜¯äººå·¥åœ°å¯¹æ‰€éœ€å­—æ®µè¿›è¡Œæ’åºï¼Œåœ¨ç³»ç»Ÿçš„é»˜è®¤æ’åºåŸºç¡€ä¸Šåšç¬¬äºŒæ¬¡çš„æ’åºã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p><strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>æ¦‚å¿µä¸Šä¸éš¾ç†è§£ï¼Œæ— éå°±æ˜¯è‡ªè¡Œå¤šåšä¸€æ¬¡ç‰¹å®šçš„æ’åºã€‚å¯æ˜¯è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿæ€ä¹ˆåœ¨map-reduceçš„æµç¨‹æ¡†æ¡†å†…å¯¹Valueè¿›è¡Œäººå·¥æ’åºå‘¢ï¼Ÿ å…¶å®å…³é”®æŠ€å·§å°±æ˜¯åˆ©ç”¨map-reduceä¼šå¯¹Keyæ’åºçš„ç‰¹ç‚¹ï¼Œè®©å®ƒâ€œé¡ºå¸¦â€å¯¹Valueè¿›è¡Œæ’åºã€‚ä¸ºäº†è¾¾åˆ°è¿™ç§â€œé¡ºå¸¦â€çš„æ•ˆæœï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°†åŸå§‹æ•°æ®ä¸­çš„Keyï¼ˆMovieIDï¼‰å’ŒValueï¼ˆratingï¼‰åˆå¹¶åˆ°ä¸€èµ·ä½œä¸ºæ–°çš„Keyï¼ˆMovieBeanï¼‰ï¼ŒåŒæ—¶ä»ç„¶ä¿æŒåŸValueï¼ˆratingï¼‰ä½œä¸ºValueã€‚å½“ç³»ç»Ÿå¯¹è¿™ä¸ªåˆå¹¶çš„Keyï¼ˆMovieBeanï¼‰æŒ‰ç…§æŸç§ç‰¹æ€§è¿›è¡Œæ’åºæ—¶ï¼Œå…¶å¯¹åº”çš„Valueä¹Ÿä¼šè¢«ç›¸åº”åœ°â€œæ’åºâ€ï¼ˆå› ä¸ºmapç«¯è¾“å‡ºæ—¶ï¼ŒKeyå’ŒValueæ˜¯ä¸€ä¸ªæ•´ä½“æ•°æ®ç»“æ„ï¼‰</strong>ï¼Œä¸ºæ­¤æˆ‘ä»¬åº”è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰çš„Beanç±»ã€‚</p>
<pre><code>/**
 * è‡ªå®šä¹‰çš„MovieBeanç±», å°†åŸå§‹æ•°æ®ä¸­çš„Keyå’ŒValueåˆå¹¶åˆ°ä¸€ä¸ªç±»ä¸­ã€‚
 */
public class MovieBean implements WritableComparable&lt;MovieBean&gt;{
    public Text movieID;
    public DoubleWritable score;

    public MovieBean() {

    }

    public MovieBean(Text movieID, DoubleWritable score) {
        this.movieID = movieID;
        this.score = score;
    }

    public void set(Text movieID, DoubleWritable score) {
        this.movieID = movieID;
        this.score = score;
    }

    public Text getMovieID() {
        return movieID;
    }

    public void setMovieID(Text movieID) {
        this.movieID = movieID;
    }

    public DoubleWritable getScore() {
        return score;
    }

    public void setScore(DoubleWritable score) {
        this.score = score;
    }

    @Override
    public String toString() {
        return &quot;movieID=&quot; + movieID +
                &quot;, score=&quot; + score;
    }

    /**
     * é‡ç‚¹! åˆ©ç”¨è‡ªå®šä¹‰çš„compareToæ–¹æ³•å®ç°æ’åºæ•ˆæœ!
     * @param o object of MovieBean
     * @return result of comparison
     */
    @Override
    public int compareTo(MovieBean o) {
        if(o == null) {
            throw new RuntimeException();
        }

        // movieIDç›¸åŒæ—¶, æŒ‰ç…§scoreè¿›è¡Œé™åºæ’åº
        if(this.movieID.compareTo(o.getMovieID()) == 0) {
            return -score.compareTo(o.getScore());
        }

        // movieIDä¸ç›¸åŒæ—¶, ç›´æ¥æŒ‰ç…§MovieIDæ’åº
        return this.movieID.compareTo(o.getMovieID());
    }

    /**
     * @param dataOutput åºåˆ—åŒ–è¾“å‡º
     */
    @Override
    public void write(DataOutput dataOutput) throws IOException {
        dataOutput.writeUTF(movieID.toString());
        dataOutput.writeDouble(score.get());
    }

    /**
     * @param dataInput åºåˆ—åŒ–è¾“å…¥
     */
    @Override
    public void readFields(DataInput dataInput) throws IOException {
        movieID = new Text(dataInput.readUTF());
        score = new DoubleWritable(dataInput.readDouble());
    }
}
</code></pre><p>æœ‰äº†è¿™ä¸ªè‡ªå®šä¹‰çš„<strong><em>MovieBean</em></strong>ç±»ä½œä¸ºæ–°çš„Keyåï¼ŒMapperç«¯çš„è¾“å‡ºå°±ä»åŸæ¥çš„ <strong><em>\&lt;MovieID, Rating&gt;</em></strong>é”®å€¼å¯¹è½¬æ¢æˆäº†<strong><em>\&lt;MovieBean, Rating&gt;</em></strong>é”®å€¼å¯¹ã€‚</p>
<pre><code>&lt;MovieID, Rating&gt;  =&gt;  &lt;(MovieID, Rating), Rating&gt;
</code></pre><p>é‚£ä¹ˆReducerç«¯æ¥æ”¶åˆ°çš„å°†æ˜¯å¤§é‡çš„<strong><em>\&lt;MovieBean, Rating&gt;</em></strong>æ•°æ®ã€‚æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼Œå½“æˆ‘ä»¬çš„Keyæ˜¯<strong>ç®€å•ç±»å‹</strong>æ—¶ï¼ˆå¦‚IntWritableï¼ŒTextï¼ŒDoubleWritableï¼‰ï¼Œå¾ˆè‡ªç„¶å°±èƒ½å°†å¤šä¸ªK-Vå¯¹ä¸­ç›¸åŒçš„Keyæå–å‡ºæ¥ï¼Œä¸”å°†å¤šä¸ªValueåˆå¹¶æˆä¸€ä¸ªé›†åˆï¼Œæ„æˆReducerç«¯çš„è¾“å…¥æ•°æ®ç»“æ„<strong><em>\&lt;Key, List></em></strong>ã€‚ä½†æ˜¯å½“æˆ‘ä»¬çš„Keyæ˜¯å¤åˆç±»å‹ï¼Œä¾‹å¦‚MovieBeanæ˜¯MovieIDå’ŒRatingçš„å¤åˆç»“æ„æ—¶ï¼Œ<strong>å³ä½¿ä¸¤ä¸ªMovieBeanå¯¹è±¡çš„MovieIDç›¸åŒï¼Œä½†è¿™ä¸¤ä¸ªMovieBeanå´æ˜¯ä¸ä¼šè¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„ã€‚</strong></p>
<pre><code>// 1å·K-Vå¯¹
&lt;(&quot;0001&quot;, 85.0), 85.0&gt;

// 2å·K-Vå¯¹
&lt;(&quot;0001&quot;, 68.0), 68.0&gt;

// Reduceræ¥æ”¶åˆ°ä»¥ä¸Šä¸¤ä¸ªK-Vå¯¹åï¼Œå¹¶ä¸ä¼šæŠŠå®ƒä»¬åˆå¹¶æˆ&lt;MovieBean, List&lt;Value&gt;&gt;çš„æ•°æ®ç»“æ„
// å› ä¸ºä¸¤ä¸ªK-Vå¯¹çš„Keyï¼ˆMovieBeanï¼‰å¹¶ä¸ç›¸åŒ
</code></pre><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©ReduceræŠŠç›¸åŒMovieIDçš„MovieBeanå½“æˆæ˜¯ä¸€æ ·çš„Keyï¼Œç»§è€ŒæŠŠç›¸åŒMovieIDæ‰€å¯¹åº”çš„Ratingsåˆå¹¶æˆ<strong><em>\&lt;MovieBean, List></em></strong>ç»“æ„ï¼Œ<strong>æˆ‘ä»¬éœ€è¦é€šè¿‡å®ç°è‡ªå®šä¹‰çš„GroupingComparatoræ¥ _æ¬ºéª—_ Reducerã€‚</strong></p>
<pre><code>/**
 * è‡ªå®šä¹‰çš„GroupingComparator
 */
public class MovieGroupingComparator extends WritableComparator {

    /**
     * æ„é€ å‡½æ•°, å‘ŠçŸ¥è‡ªå®šä¹‰Beanç±»
     */
    protected MovieGroupingComparator() {
        super(MovieBean.class, true);
    }

    /**
     * é‡å†™WritableComparatoræ¥å£çš„compareæ–¹æ³•(ç±»ä¼¼äºæ™®é€šComparatoræ¥å£)
     * @param a movieA
     * @param b movieB
     * @return result of comparison
     */
    @Override
    public int compare(WritableComparable a, WritableComparable b) {
        MovieBean movieA = (MovieBean) a;
        MovieBean movieB = (MovieBean) b;

        // åªæ¯”è¾ƒä¸¤ä¸ªMovieBeançš„MovieID, å¿½ç•¥å…¶ä»–å±æ€§
        return movieA.getMovieID().compareTo(movieB.getMovieID());
    }
}
</code></pre><p>å®ç°ä»¥ä¸Šçš„è‡ªå®šä¹‰GroupingComparatoræ—¶ï¼Œæˆ‘ä»¬åœ¨compareæ–¹æ³•ä¸­åªè€ƒè™‘<strong><em>MovieID</em></strong>è¿™ä¸€ä¸ªå±æ€§ï¼Œç­‰åŒäº<strong>_æ¬ºéª—_</strong>äº†Reducerã€‚Reduceråˆ¤æ–­ä¸¤ä¸ªKeyæ˜¯å¦ç›¸åŒæ—¶<strong>åªè€ƒè™‘MovieIDæ˜¯å¦ç›¸åŒ</strong>ï¼Œä»è€Œå°†ä¸åŒçš„MovieBeanå¯¹è±¡æŠ½å–æˆä¸€ä¸ªç»Ÿä¸€çš„MovieBeanä½œä¸ºReducerçš„è¾“å…¥Keyï¼Œå³å¯é¡ºåˆ©åˆå¹¶å‡º<strong><em>\&lt;MovieBean, List></em></strong>è¿™æ ·çš„æ•°æ®ç»“æ„ã€‚</p>
<pre><code>// example
// å‡è®¾Reducer0æ¥æ”¶åˆ°äº†ä»¥ä¸‹K-Vå¯¹
&lt;(&quot;0001&quot;, 89.0), 89.0&gt;
&lt;(&quot;0001&quot;, 76.8), 76.8&gt;
&lt;(&quot;0001&quot;, 69.5), 69.5&gt;
&lt;(&quot;0001&quot;, 69.3), 69.3&gt;


// ç”±äºcompareæ–¹æ³•åªæ¯”è¾ƒMovieBeanä¸­çš„MovieIDå±æ€§, å®Œå…¨å¿½ç•¥Rating, æ‰€ä»¥
// ä»¥ä¸Š4ä¸ªK-Vå¯¹ä¸­çš„MovieBeanå‡ä¼šè¢«è§†ä½œä¸€æ ·çš„Keyï¼Œæœ€ç»ˆåˆå¹¶æˆçš„æ•°æ®ç»“æ„å¦‚ä¸‹
// (ä¸ºä»€ä¹ˆæ˜¯æœ‰åºçš„, å› ä¸ºåœ¨mapç«¯çš„spillè¿‡ç¨‹ä¸­å·²ç»ä¾ç…§ratingé™åºæ’åˆ—äº†,å‚è€ƒMovieBean
// ç±»ä¸­é‡å†™çš„compareToæ–¹æ³•)

&lt; Key, List&lt;Value&gt;&gt;
&lt;(&quot;0001&quot;, 89.0), [89.0, 76.8, 69.5, 69.3]&gt;
</code></pre><h2 id="ä½œä¸šæäº¤"><a href="#ä½œä¸šæäº¤" class="headerlink" title="ä½œä¸šæäº¤"></a>ä½œä¸šæäº¤</h2><p>è‡³æ­¤ï¼ŒäºŒæ¬¡æ’åºä¸­æ‰€æœ‰è‡ªå®šä¹‰çš„å·¥ä½œå·²ç»å®Œæˆã€‚<strong>ä½†æ˜¯åƒä¸‡ä¸è¦å¿˜è®°åœ¨æäº¤Jobä¹‹å‰ï¼Œç»™Jobè®¾ç½®ä»¥ä¸Šè‡ªå®šä¹‰GroupingComparator</strong>ï¼Œå¦åˆ™Jobä¼šä½¿ç”¨å†…ç½®é»˜è®¤çš„GroupingComparatorï¼Œé‚£æˆ‘ä»¬çš„äºŒæ¬¡æ’åºå°±æ— æ³•ç”Ÿæ•ˆäº†ã€‚</p>
<pre><code>movieJob.setGroupingComparatorClass(MovieGroupingComparator.class);
</code></pre><p>å¦å¤–ï¼Œ<strong>å¦‚æœéœ€è¦è‡ªå®šä¹‰Reduceræ•°é‡</strong>ï¼ˆä¾‹å¦‚æœ‰æ—¶å¸Œæœ›è¾“å‡ºNä¸ªç»“æœæ–‡ä»¶ï¼Œåˆ™éœ€è¦Nä¸ªReducerï¼‰ï¼Œè¿˜è¦è‡ªå®šä¹‰Partitionerã€‚Partitionerçš„ä½œç”¨ç®€å•æ¥è¯´å°±æ˜¯ç»™Mapperç«¯äº§ç”Ÿçš„K-Vå¯¹æ‰“ä¸Šä¸€ä¸ª<strong><em>partition id</em></strong>çƒ™å°ï¼Œè®©ç³»ç»ŸçŸ¥é“è¿™ä¸ªK-Vå¯¹åº”è¯¥è¢«å“ªä¸ªReducerå–èµ°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ<strong>å¦‚æœ‰éœ€è¦ï¼ˆä¸æ˜¯å¿…é¡»ï¼‰</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§MovieIDè¿›è¡Œåˆ’åˆ†ï¼Œä¸åŒMovieIDçš„K-Vå¯¹åˆ’åˆ†åˆ°ä¸åŒçš„Reducerä¸Šè¿›è¡Œå¤„ç†ã€‚</p>
<pre><code>/**
 * è‡ªå®šä¹‰Partitioner, ç”¨äºåˆ’åˆ†K-Vå¯¹è¢«å“ªä¸ªReducerå–èµ°
 */
public class MoviePartitioner extends Partitioner&lt;MovieBean, DoubleWritable&gt; {

    @Override
    public int getPartition(MovieBean movieBean, DoubleWritable doubleWritable, int numReducers) {
        // ç›¸åŒMovieIDçš„å¿…å®šä¼šåˆ°åŒä¸€ä¸ªReducerä¸Š
        return movieBean.getMovieID().hashCode() % numReducers;
    }
}
</code></pre><p>æœ€åç»™Jobè®¾å®šè‡ªå®šä¹‰çš„Reduceræ•°ï¼Œå³å¯å¯åŠ¨Nä¸ªReducerè¿›è¡Œæ•°æ®å¤„ç†ã€‚</p>
<pre><code>final int NUM_REDUCE_TASK = 5;
movieJob.setNumReduceTasks(NUM_REDUCE_TASK);
</code></pre><p><img src="/Users/marco/Desktop/ss.png" alt=""></p>
<p>å•Reducerè¿è¡Œç»“æœ</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½¿ç”¨SecondarySortå¯ä»¥ä½¿æˆ‘ä»¬åœ¨Map-Reduceæ¡†æ¶å†…å®Œæˆè‡ªå®šä¹‰æ’åºã€‚ä¾æ‰˜Map-Reduceä¼šå¯¹Keyè¿›è¡Œæ’åºçš„ç‰¹æ€§ï¼Œå¯ä»¥å°†éœ€è¦æ’åºçš„å­—æ®µï¼ˆValueï¼‰ä¸åŸå§‹Keyåˆæˆä¸ºè‡ªå®šä¹‰çš„Beanä½œä¸ºæ–°çš„Keyï¼ŒåŸValueä¿æŒä¸åŠ¨ã€‚æœ‰äº†SecondarySortï¼Œæˆ‘ä»¬å°±ä¸å¿…åœ¨æ¡†æ¶å¤–åšé¢å¤–çš„å·¥ä½œè¿›è¡Œæ’åºï¼Œå¹²æ‰°ç¨‹åºçš„å¯è¯»æ€§ï¼›ä¹Ÿä¸å¿…å°†åŸå§‹Keyå’ŒValueå¯¹æ¢ï¼Œå½±å“è¾“å‡ºæ ¼å¼ã€‚</p>
<h2 id="ä»£ç åœ°å€"><a href="#ä»£ç åœ°å€" class="headerlink" title="ä»£ç åœ°å€"></a>ä»£ç åœ°å€</h2><p><a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/sort" target="_blank" rel="noopener">Github-Secondary Sort</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/13/ssort/" data-id="cjpg78r7g003jbxuyz7f21l7t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mapreduce/">mapreduce</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zkserver" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/13/zkserver/" class="article-date">
  <time datetime="2018-02-13T13:32:52.000Z" itemprop="datePublished">2018-02-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/13/zkserver/">åˆ©ç”¨ZooKeeperå¼€å‘æœåŠ¡å™¨ä¸Šä¸‹çº¿æ„ŸçŸ¥ç¨‹åº</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2 id="What-is-ZooKeeper"><a href="#What-is-ZooKeeper" class="headerlink" title="What is ZooKeeper"></a>What is ZooKeeper</h2><p>ZooKeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ã€‚ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯ç”¨äºåè°ƒç®¡ç†å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå·¥å…·ï¼Œæ‰®æ¼”ç€ä¸€ä¸ªç¬¬ä¸‰æ–¹ç®¡ç†è€…çš„è§’è‰²ã€‚</p>
<h2 id="é—®é¢˜èƒŒæ™¯åˆ†æ"><a href="#é—®é¢˜èƒŒæ™¯åˆ†æ" class="headerlink" title="é—®é¢˜èƒŒæ™¯åˆ†æ"></a>é—®é¢˜èƒŒæ™¯åˆ†æ</h2><p>å‡è®¾ç°åœ¨æœ‰<strong>10</strong>ä¸ªåº”ç”¨ç¨‹åº(App#0 - App#9)ï¼Œè¿è¡Œåœ¨ç”±<strong>10</strong>å°æœåŠ¡å™¨(Server#0 - Server#9)ç»„æˆçš„é›†ç¾¤ä¸Šï¼ˆå‡è®¾å¹³å‡åˆ†é…ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œä¸€ä¸ªç¨‹åºï¼‰ã€‚æ­¤æ—¶ç”±äºæŸä¸ªçƒ­é—¨çº¿ä¸Šæ´»åŠ¨çš„å¼€å§‹ï¼ˆå¦‚æŠ¢ç¥¨orä½ä»·ç§’æ€ç­‰ï¼‰ï¼Œçªç„¶é—´æœ‰æ•°ä»¥ç™¾ä¸‡è®¡çš„ç”¨æˆ·è®¿é—®æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œç­‰å¾…æœåŠ¡å™¨å¤„ç†å¹¶åº”ç­”ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/server.png" alt=""> å¾ˆä¸å¹¸<strong>10</strong>å°æœåŠ¡å™¨ä¸­æœ‰<strong>K</strong>å°å—ä¸ä½è´Ÿè½½å‹åŠ›ï¼Œå¯¼è‡´æœåŠ¡å™¨å´©æºƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯æ— æ³•æ„ŸçŸ¥æœåŠ¡å™¨çš„çŠ¶æ€ï¼ˆåœ¨çº¿ï¼ç¦»çº¿ï¼‰ï¼Œéƒ¨åˆ†å‘å·²ç»å´©æºƒçš„æœåŠ¡å™¨å‘é€è¯·æ±‚çš„å®¢æˆ·ç«¯å°†ä¼šæœ‰é•¿æ—¶é—´æ— æ³•è·å¾—åº”ç­”ï¼Œå®ƒä»¬åªèƒ½ä¸€ç›´é‡å¤åœ°å‘å·²ç»å´©æºƒçš„æœåŠ¡å™¨åœ°å€é‡å‘è¯·æ±‚ï¼Œæ— æ³•åˆ‡æ¢è‡³å¦å¤–<strong>ï¼ˆ10-Kï¼‰</strong>å°å®Œå¥½çš„æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/breakdown.png" alt=""> å…¶å®åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯èƒ½å¤ŸåŠæ—¶åœ°æ„ŸçŸ¥åˆ°é›†ç¾¤ä¸­å“ªäº›èŠ‚ç‚¹å·²ç»å´©æºƒï¼Œå“ªäº›èŠ‚ç‚¹ä»ç„¶å®Œå¥½ï¼Œæ˜¯å¯ä»¥åˆ‡æ¢è‡³å®Œå¥½çš„èŠ‚ç‚¹å¹¶å‘å…¶å‘é€è¯·æ±‚çš„ã€‚ç†è®ºä¸Šåªè¦é›†ç¾¤ä¸­ä»æœ‰1ä¸ªèŠ‚ç‚¹æ˜¯å®Œå¥½çš„ï¼Œå®ƒå³èƒ½å‘å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚ <strong><em>æ‰€ä»¥æ•´ä¸ªé—®é¢˜çš„ç—‡ç»“å°±åœ¨äºï¼Œå¦‚ä½•è®©å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°æœåŠ¡å™¨ä¸Šä¸‹çº¿çŠ¶æ€ï¼Œä»¥ä¾¿åˆ‡æ¢è¯·æ±‚å‘é€çš„åœ°å€ã€‚</em></strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/zk.png" alt=""> é‡æ–°å‚è€ƒZooKeeperçš„åŠŸèƒ½æè¿°ï¼ŒZooKeeperå¯ä»¥ç”¨æ¥åè°ƒç®¡ç†å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œé‚£å…¶å®å¯ä»¥ç”¨äºç®¡ç†æˆ‘ä»¬çš„åˆ†å¸ƒå¼æœºå™¨é›†ç¾¤ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<strong>åœ¨ç”¨æˆ·å’ŒæœåŠ¡å™¨é›†ç¾¤ä¸­é—´å¯è®¾ç½®ZooKeeperå±‚</strong>ï¼Œè®©ZooKeeperå®æ—¶æ„ŸçŸ¥æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç„¶åå®¢æˆ·ç«¯å¹¶ä¸ç›´æ¥å‘å…·ä½“èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œè€Œåº”å…ˆå‘ZooKeeperè¯¢é—®å½“å‰ä»ç„¶å­˜æ´»çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œç„¶åå†ä»ä¸­æŒ‘é€‰ä¸€ä¸ªè´Ÿè½½è¾ƒä½çš„æœåŠ¡å™¨èŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚ç”±äºZooKeeperæœ¬èº«çš„é«˜å¯ç”¨æ€§ï¼ˆæœ¬èº«ä¹Ÿå¯æ‹“å±•ä¸ºåˆ†å¸ƒå¼æ¶æ„ï¼‰ï¼Œæ‰€ä»¥å°±èƒ½å¤§å¤§åœ°æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p>
<h2 id="ZooKeeperæ•°æ®ç»“æ„"><a href="#ZooKeeperæ•°æ®ç»“æ„" class="headerlink" title="ZooKeeperæ•°æ®ç»“æ„"></a>ZooKeeperæ•°æ®ç»“æ„</h2><p>ZooKeeperæ•°æ®ç»“æ„é‡‡ç”¨äº†æ ‘çŠ¶ç»“æ„ï¼ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼‰ï¼Œä¸”ä¸æ˜¯ç®€å•çš„äºŒå‰æ ‘ï¼Œè€Œæ˜¯å¤šå‰æ ‘ã€‚åœ¨ZooKeeperçš„æ ‘ç»“æ„ä¸­ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹è¢«ç§°ä¸ºznodeï¼Œå¯é€šè¿‡æ§åˆ¶å°å‘½ä»¤æˆ–è€…Javaçš„SDKå¯¹å†…éƒ¨æ•°æ®è¿›è¡Œç®¡ç†ã€‚ znodeçš„ç±»å‹æœ‰<code>2*2=4</code>ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>PERSISTENT</li>
<li>PERSISTENT_SEQUENTIAL</li>
<li>EPHEMERAL</li>
<li>EPHEMERAL_SEQUENTIAL</li>
</ul>
<p>å…¶ä¸­<strong><em>PERSISTENT</em></strong>å’Œ<strong><em>EPHEMERAL</em></strong>çš„åŒºåˆ«æ­£å¦‚å…¶åï¼Œåœ¨æ— å¤–åŠ›å½±å“ä¸‹<strong><em>PERSISTENT</em></strong>èŠ‚ç‚¹ä¸ä¼šè¢«æ”¹å˜å’Œåˆ é™¤ï¼Œè€Œ<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹åœ¨åˆ›å»ºèŠ‚ç‚¹çš„sessionç»“æŸåä¼šè‡ªåŠ¨ä»æ ‘ä¸­åˆ é™¤ã€‚è‡³äº<strong><em>SEQUENTIAL</em></strong>ä¸<strong><em>éSEQUENTIAL</em></strong>åˆ™å½±å“äº†èŠ‚ç‚¹idè‡ªå¢ï¼Œ<strong><em>SEQUENTIAL</em></strong>èŠ‚ç‚¹çš„idä¼šè‡ªåŠ¨éµå¾ªçˆ¶èŠ‚ç‚¹ä¸‹çš„è‡ªå¢è§„åˆ™è¿›è¡Œå‘½åã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/zkds.png" alt=""> å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨æœ¬é—®é¢˜ä¸­æˆ‘ä»¬å¯ä»¥æŠŠä¸€å°æœåŠ¡å™¨çœ‹ä½œæ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹çš„è¿™ä¸€ç‰¹æ€§è¿›è¡ŒæœåŠ¡å™¨çŠ¶æ€çš„ç›‘å¬ã€‚æœåŠ¡å™¨ä¸Šçº¿æ—¶åˆ›å»ºä¸zkä¹‹é—´çš„sessionå¹¶å‘zkæ³¨å†ŒèŠ‚ç‚¹ï¼Œåªè¦æœåŠ¡å™¨ä¸å´©æºƒï¼Œsessionä¾¿ä¸ä¼šç»“æŸï¼Œå³<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¯è¢«å®¢æˆ·ç«¯æ„ŸçŸ¥ï¼›å½“æœåŠ¡å™¨å´©æºƒæ—¶ï¼Œå…¶ä¸zkä¹‹é—´ä¿æŒçš„sessionè‡ªç„¶ä¹Ÿä¼šç»“æŸï¼Œ<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹ä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œå®¢æˆ·ç«¯æŸ¥è¯¢æœåŠ¡å™¨åˆ—è¡¨æ—¶ç»å¯¹æ— æ³•è·å¾—å·²åˆ é™¤çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚</p>
<h2 id="Demoç¨‹åº"><a href="#Demoç¨‹åº" class="headerlink" title="Demoç¨‹åº"></a>Demoç¨‹åº</h2><ul>
<li><p><strong><em>Server.java (æœåŠ¡å™¨ç«¯ä»£ç )</em></strong></p>
<p>package my.bigdata.zk;</p>
<p>import org.apache.zookeeper.*;</p>
<p>public class Server {</p>
<pre><code>private static final String HOST_ADDRESS = &quot;localhost:2181&quot;;
private static final int DEFAULT_TIMEOUT = 2000;
private static final String DEFAULT_SERVER_PARENT = &quot;/servers&quot;;

private ZooKeeper zkConnect = null;

/**
 * è¿æ¥è‡³ZooKeeper
 * @throws Exception
 */
public void connect() throws Exception{
    zkConnect = new ZooKeeper(HOST_ADDRESS, DEFAULT_TIMEOUT, new Watcher() {
        @Override
        public void process(WatchedEvent watchedEvent) {
            System.out.println(&quot;Type:&quot; + watchedEvent.getType()
                    + &quot; Path:&quot; + watchedEvent.getPath());
        }
    });
}

/**
 * å‘ZooKeeperæ³¨å†Œæœ¬æœåŠ¡å™¨èŠ‚ç‚¹
 * @param data æœåŠ¡å™¨ä¿¡æ¯
 * @throws Exception
 */
public void register(String data) throws Exception{
    String create = zkConnect.create(DEFAULT_SERVER_PARENT + &quot;/server&quot;,
                                        data.getBytes(),
                                        ZooDefs.Ids.OPEN_ACL_UNSAFE,
                                        CreateMode.EPHEMERAL_SEQUENTIAL);   // æ³¨å†ŒæˆephemeralèŠ‚ç‚¹ä»¥ä¾¿è‡ªåŠ¨åœ¨zkä¸Šæ³¨é”€
    System.out.println(create + &quot; is registered!&quot;);
}

/**
 * é€šè¿‡sleepæ¨¡æ‹ŸæœåŠ¡å™¨åœ¨çº¿
 */
public void sleep() {
    try {
        Thread.sleep(20000);
    } catch (Exception e) {
        System.out.println(e.toString());
    }
}
</code></pre></li>
</ul>
<pre><code>    public static void main(String[] args) throws Exception {

        //è¿æ¥è‡³zk
        Server server = new Server();
        server.connect();

        //å‘zkæ³¨å†ŒæœåŠ¡å™¨ä¿¡æ¯
        String data = args[0];
        server.register(data);

        server.sleep();
    }
}
</code></pre><p>æœåŠ¡å™¨ç«¯çš„é‡ç‚¹åœ¨äºï¼Œç¨‹åºå¯åŠ¨æ—¶å‘ZooKeeperçš„æŒ‡å®šèŠ‚ç‚¹ä¸‹æ³¨å†ŒæœåŠ¡å™¨ä¿¡æ¯ï¼Œç›¸å½“äºé€šçŸ¥ZooKeeperè¿™ä¸ªç¬¬ä¸‰æ–¹ï¼šâ€œæœåŠ¡å™¨å·²ä¸Šçº¿â€ã€‚å…¶æ¬¡ï¼Œæ³¨å†Œçš„èŠ‚ç‚¹ç±»å‹å¿…é¡»æ˜¯<strong>ephemeral</strong>èŠ‚ç‚¹ï¼Œä¸ºäº†å®ç°èŠ‚ç‚¹idè‡ªå¢(auto-increment)è¿˜å¯ä»¥ä½¿ç”¨<strong>ephemeral_sequential</strong>èŠ‚ç‚¹ã€‚</p>
<ul>
<li><p><strong><em>Client.java (å®¢æˆ·ç«¯ä»£ç )</em></strong></p>
<p>package my.bigdata.zk;</p>
<p>import org.apache.zookeeper.WatchedEvent;<br>import org.apache.zookeeper.Watcher;<br>import org.apache.zookeeper.ZooKeeper;</p>
<p>import java.util.ArrayList;<br>import java.util.Arrays;<br>import java.util.List;</p>
<p>public class Client {</p>
<pre><code>private static final String HOST_ADDRESS = &quot;localhost:2181&quot;;
private static final int DEFAULT_TIMEOUT = 2000;
private static final String DEFAULT_SERVER_PARENT = &quot;/servers&quot;;

private ZooKeeper zkConnect = null;
private List&lt;String&gt; availableServers;

/**
 * è¿æ¥è‡³ZooKeeper
 * @throws Exception
 */
public void connect() throws Exception {
    zkConnect = new ZooKeeper(HOST_ADDRESS, DEFAULT_TIMEOUT, new Watcher() {
        @Override
        public void process(WatchedEvent watchedEvent) {
            try {
                updateServerCondition();    // é‡å¤æ³¨å†Œ
            } catch (Exception e) {
                System.out.println(e.toString());
            }
        }
    });
}

/**
 * å‘zkæŸ¥è¯¢æœåŠ¡å™¨æƒ…å†µ, å¹¶updateæœ¬åœ°æœåŠ¡å™¨åˆ—è¡¨
 * @throws Exception
 */
public void updateServerCondition() throws Exception {
    List&lt;String&gt; children = zkConnect.getChildren(DEFAULT_SERVER_PARENT, true);
    List&lt;String&gt; servers = new ArrayList&lt;&gt;();
    for(String child : children) {
        byte[] data = zkConnect.getData(DEFAULT_SERVER_PARENT + &quot;/&quot; + child,
                                    false,
                                    null);
        servers.add(new String(data));
    }
    availableServers = servers;
    System.out.println(Arrays.toString(servers.toArray(new String[0])));
}

/**
 * é€šè¿‡sleepè®©å®¢æˆ·ç«¯æŒç»­è¿è¡Œï¼Œæ¨¡æ‹Ÿ&quot;ç›‘å¬&quot;
 */
public void sleep() throws Exception{
    System.out.println(&quot;client is working&quot;);
    Thread.sleep(Long.MAX_VALUE);
}

public static void main(String[] args) throws Exception {

    // è¿æ¥zk
    Client client = new Client();
    client.connect();

    // è·å–serversèŠ‚ç‚¹ä¿¡æ¯ï¼ˆå¹¶ç›‘å¬ï¼‰ï¼Œä»ä¸­è·å–æœåŠ¡å™¨ä¿¡æ¯åˆ—è¡¨
    client.updateServerCondition();

    client.sleep();
}
</code></pre><p>}</p>
</li>
</ul>
<p>å®¢æˆ·ç«¯çš„é‡ç‚¹åœ¨äºï¼Œå®ƒä¸æ–­åœ°å‘ZooKeeperæŸä¸ªç‰¹å®šèŠ‚ç‚¹ï¼ˆæ­¤å¤„æ˜¯serversèŠ‚ç‚¹ï¼‰æ³¨å†Œäº†ä¸€ä¸ª<strong>Watcher</strong>ï¼Œé‚£ä¹ˆä¸€æ—¦è¯¥èŠ‚ç‚¹ä¸‹çš„ç»“æ„å‘ç”Ÿæ”¹å˜ï¼ŒZooKeeperä¼šå‘æ³¨å†Œäº†<strong>Watcher</strong>çš„å®¢æˆ·ç«¯å‘é€â€œçŠ¶æ€å˜åŒ–â€çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å³å¯åŠ¨æ€åœ°ä»ZooKeeperä¸­è·å–æœ€æ–°çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”šè‡³æ— éœ€â€œä¸»åŠ¨â€è¯¢é—®ã€‚ å½“ç„¶ï¼ŒZooKeeperçš„åº”ç”¨åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œè€ƒè™‘åˆ°å®ƒæœ¬èº«ä¹Ÿå¯æ‹“å±•ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨ï¼Œåœ¨è¿™ç§é«˜å¯ç”¨æ€§ä¿è¯ä¸‹å®ƒç®€ç›´å°±æ˜¯å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨çš„ä¸‡èƒ½ç®¡å®¶å’Œåè°ƒè€…ğŸ˜Šã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/13/zkserver/" data-id="cjpg78r7h003mbxuy21yadxtf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/BigData/">BigData</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/ç®—æ³•/">ç®—æ³•</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/ç®—æ³•/">ç®—æ³•</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ¨èç³»ç»Ÿ/">æ¨èç³»ç»Ÿ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœªåˆ†ç±»/">æœªåˆ†ç±»</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç®—æ³•/">ç®—æ³•</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/">Leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mapreduce/">mapreduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ¨è/">æ¨è</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ•°æ®ç»“æ„/">æ•°æ®ç»“æ„</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æºç /">æºç </a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ç¬”è®°/">ç¬”è®°</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ç®—æ³•/">ç®—æ³•</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Go/" style="font-size: 18.33px;">Go</a> <a href="/tags/Java/" style="font-size: 16.67px;">Java</a> <a href="/tags/Leetcode/" style="font-size: 11.67px;">Leetcode</a> <a href="/tags/bigdata/" style="font-size: 15px;">bigdata</a> <a href="/tags/hadoop/" style="font-size: 16.67px;">hadoop</a> <a href="/tags/mapreduce/" style="font-size: 15px;">mapreduce</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/åˆ†å¸ƒå¼/" style="font-size: 13.33px;">åˆ†å¸ƒå¼</a> <a href="/tags/æ¨è/" style="font-size: 15px;">æ¨è</a> <a href="/tags/æ•°æ®ç»“æ„/" style="font-size: 18.33px;">æ•°æ®ç»“æ„</a> <a href="/tags/æºç /" style="font-size: 11.67px;">æºç </a> <a href="/tags/ç¬”è®°/" style="font-size: 20px;">ç¬”è®°</a> <a href="/tags/ç®—æ³•/" style="font-size: 18.33px;">ç®—æ³•</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/12/09/raft-leader-election-trashed/">[Raft]Leader Election(é€‰ä¸»)ç¬”è®°</a>
          </li>
        
          <li>
            <a href="/2018/12/09/trashed/">__trashed</a>
          </li>
        
          <li>
            <a href="/2018/12/09/trashed-2/">[Raft]</a>
          </li>
        
          <li>
            <a href="/2018/12/09/raft-leader-election/">[Raft]Leader Election(é€‰ä¸»)ç¬”è®°</a>
          </li>
        
          <li>
            <a href="/2018/12/08/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>