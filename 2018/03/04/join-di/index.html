<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="浅谈join与数据倾斜解决方案 本文100%为本人（Haoxiang Ma）原创内容，如需转载请注明出处。  问题背景join操作在传统的关系型数据库中特别常见，往往用来连接两张或多张在某些键上有关联的表。但当我们的数据并没有被结构化存储到数据库中，手上仅有大量的raw data —— 成千上万个磁盘数据文件（如.dat或.txt）时，又或者当大量的数据文件存放在分布式的文件系统（HDFS）里，难">
<meta name="keywords" content="hadoop,mapreduce">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈join与数据倾斜解决方案">
<meta property="og:url" content="http://yoursite.com/2018/03/04/join-di/index.html">
<meta property="og:site_name" content="Haoxiang Ma&#39;s Tech Blog">
<meta property="og:description" content="浅谈join与数据倾斜解决方案 本文100%为本人（Haoxiang Ma）原创内容，如需转载请注明出处。  问题背景join操作在传统的关系型数据库中特别常见，往往用来连接两张或多张在某些键上有关联的表。但当我们的数据并没有被结构化存储到数据库中，手上仅有大量的raw data —— 成千上万个磁盘数据文件（如.dat或.txt）时，又或者当大量的数据文件存放在分布式的文件系统（HDFS）里，难">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/dataIncline.png">
<meta property="og:updated_time" content="2018-12-09T23:03:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅谈join与数据倾斜解决方案">
<meta name="twitter:description" content="浅谈join与数据倾斜解决方案 本文100%为本人（Haoxiang Ma）原创内容，如需转载请注明出处。  问题背景join操作在传统的关系型数据库中特别常见，往往用来连接两张或多张在某些键上有关联的表。但当我们的数据并没有被结构化存储到数据库中，手上仅有大量的raw data —— 成千上万个磁盘数据文件（如.dat或.txt）时，又或者当大量的数据文件存放在分布式的文件系统（HDFS）里，难">
<meta name="twitter:image" content="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/dataIncline.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>浅谈join与数据倾斜解决方案</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/03/17/consistent-hash/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/02/25/ii-wc/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/03/04/join-di/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/03/04/join-di/&text=浅谈join与数据倾斜解决方案"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/03/04/join-di/&is_video=false&description=浅谈join与数据倾斜解决方案"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浅谈join与数据倾斜解决方案&body=Check out this article: http://yoursite.com/2018/03/04/join-di/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/03/04/join-di/&name=浅谈join与数据倾斜解决方案&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#浅谈join与数据倾斜解决方案"><span class="toc-number">1.</span> <span class="toc-text">浅谈join与数据倾斜解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题背景"><span class="toc-number">1.1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题分析"><span class="toc-number">1.2.</span> <span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实现"><span class="toc-number">1.3.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极端情况——“数据倾斜”"><span class="toc-number">1.4.</span> <span class="toc-text">极端情况——“数据倾斜”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码"><span class="toc-number">1.6.</span> <span class="toc-text">代码</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        浅谈join与数据倾斜解决方案
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Haoxiang Ma's Tech Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-03-04T07:08:53.000Z" itemprop="datePublished">2018-03-04</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/hadoop/">hadoop</a>, <a class="tag-link" href="/tags/mapreduce/">mapreduce</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="浅谈join与数据倾斜解决方案"><a href="#浅谈join与数据倾斜解决方案" class="headerlink" title="浅谈join与数据倾斜解决方案"></a>浅谈join与数据倾斜解决方案</h1><blockquote>
<p>本文100%为本人（Haoxiang Ma）原创内容，如需转载请注明出处。</p>
</blockquote>
<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p><code>join</code>操作在传统的关系型数据库中特别常见，往往用来连接两张或多张在某些键上有关联的表。但当我们的数据并没有被结构化存储到数据库中，手上仅有大量的<strong><em>raw data</em></strong> —— 成千上万个磁盘数据文件（如.dat或.txt）时，又或者当大量的数据文件存放在分布式的文件系统（HDFS）里，难以将其高效导入MySQL中时，我们很自然地就会思考：<strong>有没有不需要依靠关系型数据库而实现的join呢？对于海量文件能不能用Map-Reduce实现join操作呢？</strong></p>
<p>假设现在系统中有两类数据文件：</p>
<ol>
<li><strong><em>用户数据文件（User）</em></strong></li>
<li><strong><em>订单数据文件（Order）</em></strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// user文件结构</span><br><span class="line">user_id, user_name, phone</span><br><span class="line">	1,		aa,		10086</span><br><span class="line">	2,		bb,		10010</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">// order文件结构</span><br><span class="line">order_id, user_id, 	price, 	date</span><br><span class="line">	1,		1,		15.5	2018-01-01</span><br><span class="line">	2,		1,		3.9		2018-01-01</span><br><span class="line">	3,		1,		26.0	2018-01-03</span><br><span class="line">	4,		2,		2.2		2018-01-04</span><br><span class="line">	......</span><br></pre></td></tr></table></figure>
<p>需求是将<strong><em>用户数据文件（User）</em></strong>和<strong><em>订单数据文件（Order）</em></strong>通过<code>user_id</code>键相关联，得到总的用户信息+用户订单信息的总“表”（一个数据文件的内容可看作表的一部分）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 期望得到的总表结构</span><br><span class="line">user_id, user_name, phone, order_id, price, date</span><br><span class="line">	1,		aa,		10086,		1,	  15.5,	2018-01-01</span><br><span class="line">	......</span><br></pre></td></tr></table></figure>
<p>本文将基于以上需求，对Map-Reduce实现两表关联（join）进行探讨。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>要利用Map-Reduce实现两表关联，关键点有以下几个：</p>
<ol>
<li><p>如何辨别当前处理的数据来自于<strong><em>User表</em></strong>还是<strong><em>Order表</em></strong></p>
<p> 因为两种文件有不同的数据格式，我们在Mapper里对数据逐行进行处理时，必须要知道当前这行数据来自于<strong><em>User表</em></strong>还是<strong><em>Order表</em></strong>， 不然根本没有办法编写进一步的处理逻辑。其实看过我之前文章的同学应该见过在Mapper里获取当前数据所属文件名的方法。简单来说，就是<strong><em>map方法</em></strong>的<code>Context</code>参数其实带有了很多本次Job的运行信息，其中就包括了当前数据来自于哪个<code>FileSplit</code>，进一步可以获得该<code>FileSplit</code>所属的文件名。</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FileSplit fileSplit = (FileSplit)context.getInputSplit();</span><br><span class="line">String fileName = fileSplit.getPath().getName();</span><br></pre></td></tr></table></figure>
</li>
<li><p>有两种不同的数据文件，可是一个MR任务里只有一种K-V对定义</p>
<p> 两种文件格式，一种K-V对定义，那很自然我们就要想想如何将两种“合并”成一种，同时还能随时将这个合并的产物分开成两种。其实之前的文章已经多次提及一种在Map-Reduce里常用的概念——<strong>自定义JavaBean</strong>，作为一个自定义类，它的复合性质可以帮助我们“集成”很多原生数据类型。在当前问题里，我们可以定义一个<code>JavaBean</code>，<strong>集成User表与Order表的所有字段</strong>，并额外添加一个<code>flag</code>字段用以表明实例对象是<code>User</code>数据还是<code>Order</code>数据。通过这个<code>JavaBean</code>就可以实现“合并且随时可分离”的需求了。</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JavaBean = &#123;user_id, order_id, user_name, phone, price, date&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><em>“join”</em></strong>的逻辑具体怎么写</p>
<p> 基于第2点，实现了一个集成的JavaBean后，我们可以在map中将数据封装成JavaBean实例对象，然后用flag字段指明数据类型。为了实现join功能，我们必须确保同一个<code>User</code>的所有数据都到达同一个Reducer处，那样才能将该用户的所有订单与其用户信息关联起来，避免遗漏。为了让同一个User的数据都到达同一个Reducer，我们要让Map端输出的K-V对为<code>&lt;UserID, JavaBean&gt;</code>，那么在Partition的时候，同一个UserID的数据自然会被分配到同一个Reducer。</p>
<p> 当Reducer拿到一批<code>&lt;UserID, JavaBean&gt;</code>数据后，将其整合为<code>&lt;UserID, Iterable&lt;JavaBean&gt;&gt;</code>。我们可以在<code>Iterable&lt;JavaBean&gt;&gt;</code>里通过判断<code>flag</code>的值找出<code>User</code>的JavaBean，称为<strong><em>U</em></strong>。然后对于每个<code>Order</code>的JavaBean（称为<strong><em>O</em></strong>），从<strong><em>O</em></strong>中取出<code>order_id</code>, <code>price</code>, <code>date</code>，从<strong><em>U</em></strong>中取出<code>user_id</code>, <code>user_name</code>, <code>phone</code>，组成结果数据<strong><em>R</em></strong>。</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R = (order_id, price, date，user_id, user_name, phone)</span><br></pre></td></tr></table></figure>
<p> Reducer循环将多个<code>&lt;R, NullWritable&gt;</code>写到最终Context中，便完成了join逻辑。</p>
</li>
</ol>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><ol>
<li><p>自定义JavaBean</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义JavaBean, 实现Writable接口, 因本任务不存在"比较", 无需实现WritableComparable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinBean</span> <span class="keyword">implements</span> <span class="title">Writable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> String userID;</span><br><span class="line">	<span class="keyword">public</span> String uName;</span><br><span class="line">	<span class="keyword">public</span> String phone;</span><br><span class="line">	<span class="keyword">public</span> String orderID;</span><br><span class="line">	<span class="keyword">public</span> String price;</span><br><span class="line">	<span class="keyword">public</span> String date;</span><br><span class="line">	<span class="keyword">public</span> String flag;		<span class="comment">// 用于标识User还是Order</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JoinBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JoinBean</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"uName='"</span> + uName + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", phone='"</span> + phone + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", orderID='"</span> + orderID + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", price='"</span> + price + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", date='"</span> + date + <span class="string">'\''</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUserID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserID</span><span class="params">(String userID)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getuName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> uName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setuName</span><span class="params">(String uName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> phone;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getOrderID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> orderID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderID</span><span class="params">(String orderID)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(String price)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		dataOutput.writeUTF(userID);</span><br><span class="line">		dataOutput.writeUTF(uName);</span><br><span class="line">		dataOutput.writeUTF(phone);</span><br><span class="line">		dataOutput.writeUTF(orderID);</span><br><span class="line">		dataOutput.writeUTF(price);</span><br><span class="line">		dataOutput.writeUTF(date);</span><br><span class="line">		dataOutput.writeUTF(flag);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException 		</span>&#123;</span><br><span class="line">		userID = dataInput.readUTF();</span><br><span class="line">		uName = dataInput.readUTF();</span><br><span class="line">		phone = dataInput.readUTF();</span><br><span class="line">		orderID = dataInput.readUTF();</span><br><span class="line">		price = dataInput.readUTF();</span><br><span class="line">		date = dataInput.readUTF();</span><br><span class="line">		flag = dataInput.readUTF();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Mapper</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapper类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">JoinBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"user"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ORDER = <span class="string">"order"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> JoinBean info = <span class="keyword">new</span> JoinBean();</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">		FileSplit fileSplit = (FileSplit)context.getInputSplit();</span><br><span class="line">		String fileName = fileSplit.getPath().getName();	<span class="comment">// 获取数据所属文件名</span></span><br><span class="line"></span><br><span class="line">		String line = value.toString();</span><br><span class="line">		String[] data = line.split(<span class="string">","</span>);</span><br><span class="line">		String userID = data[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 通过flag标识实例对象是User还是Order</span></span><br><span class="line">		<span class="keyword">if</span>(fileName.startsWith(<span class="string">"user"</span>)) &#123;</span><br><span class="line">			info.set(<span class="string">""</span>, data[<span class="number">1</span>], data[<span class="number">2</span>], <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, USER);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			info.set(<span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, data[<span class="number">1</span>], data[<span class="number">2</span>], data[<span class="number">3</span>], ORDER);</span><br><span class="line">		&#125;</span><br><span class="line">		context.write(<span class="keyword">new</span> Text(userID), info);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Reducer</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reducer类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">JoinBean</span>, <span class="title">JoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;JoinBean&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">		JoinBean userInfo = <span class="keyword">new</span> JoinBean();</span><br><span class="line">		List&lt;JoinBean&gt; orders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(JoinBean info : values) &#123;</span><br><span class="line">			<span class="comment">// 同一个UserID，有且仅有1个User对象，其他均为该User的Order对象</span></span><br><span class="line">			<span class="keyword">if</span>(info.getFlag().equals(<span class="string">"user"</span>)) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					BeanUtils.copyProperties(userInfo, info);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					System.out.println(e.toString());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(info.getFlag().equals(<span class="string">"order"</span>))&#123;</span><br><span class="line">				JoinBean order = <span class="keyword">new</span> JoinBean();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					BeanUtils.copyProperties(order, info);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					System.out.println(e.toString());</span><br><span class="line">				&#125;</span><br><span class="line">				orders.add(order);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 提取所需属性, 合并, 输出</span></span><br><span class="line">		<span class="keyword">for</span>(JoinBean order : orders) &#123;</span><br><span class="line">			JoinBean record = <span class="keyword">new</span> JoinBean();</span><br><span class="line">			record.set(key.toString(), userInfo.getuName(), userInfo.getPhone(), order.getOrderID(), order.getPrice(), order.getDate(), order.getFlag());</span><br><span class="line">			context.write(record, NullWritable.get());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Driver（程序入口）</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinDriver</span> </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">			Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">			conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://localhost:9000"</span>);</span><br><span class="line">			Job joinJob = Job.getInstance(conf);</span><br><span class="line">	</span><br><span class="line">			joinJob.setMapperClass(JoinMapper.class);</span><br><span class="line">			joinJob.setReducerClass(JoinReducer.class);</span><br><span class="line">	</span><br><span class="line">			joinJob.setJarByClass(JoinDriver.class);</span><br><span class="line">	</span><br><span class="line">			joinJob.setMapOutputKeyClass(Text.class);</span><br><span class="line">			joinJob.setMapOutputValueClass(JoinBean.class);</span><br><span class="line">			joinJob.setOutputKeyClass(JoinBean.class);</span><br><span class="line">			joinJob.setOutputValueClass(NullWritable.class);</span><br><span class="line">	</span><br><span class="line">			FileInputFormat.setInputPaths(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/input"</span>));</span><br><span class="line">			FileOutputFormat.setOutputPath(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/output"</span>));</span><br><span class="line">	</span><br><span class="line">			System.exit(joinJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="极端情况——“数据倾斜”"><a href="#极端情况——“数据倾斜”" class="headerlink" title="极端情况——“数据倾斜”"></a>极端情况——“数据倾斜”</h2><p>在这个问题里，我们的数据分为<code>User</code>和<code>Order</code>两类，其中明显<code>User</code>的数据会比<code>Order</code>少得多。一位用户只可能有一行<code>User</code>记录（在系统不出错的情况下），而一位用户却可以有N行<code>Order</code>记录，因为他可以“疯狂购物”产生了成千上万条的订单数据。</p>
<p>极端情况下，有一位<code>User</code>：<code>user_1</code>对应了<code>1000000</code>条<code>Order</code>数据，另一位<code>User</code>：<code>user_2</code>对应了<code>2</code>条<code>Order</code>数据。那么必然有一个负责处理<code>user_1</code>的Reducer<code>reducer_1</code>的负载过高，因为要处理<code>1000000</code>条数据，其他负载极少的Reducer干完活之后就得白白浪费时间等着<code>reducer_1</code>完成任务（<strong><em>往往表现为Job进度卡在99%</em></strong>），才能汇报整个Job已完成。</p>
<p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/dataIncline.png" alt=""></p>
<p>如图所示，因为大量的数据涌向少数的节点，像是一个倾斜的天平，一端重一端轻，所以以上的情况便称为<code>数据倾斜</code>。</p>
<p>为了解决当前问题引起的数据倾斜，我们可以采用一种<strong>”map端join“</strong>的方式进行关联操作，代替之前在Reducer端收集数据进行join的逻辑。相比<code>Order</code>表，<code>User</code>表无疑小得多，甚至可能是几百倍的量级差距，所以完全可能把这个小表分发给各个Mapper，让每个Mapper都拥有一份<strong><em>完整的User表</em></strong>，进而将其加载入内存构造一个<code>&lt;user_id, user_info&gt;</code>的哈希表。这么一来，在Mapper内只需要处理<code>Order</code>的数据，然后根据<code>Order</code>里的<code>user_id</code>查到哈希表里该id对应的<code>user_info</code>，连接起来，即可完成join操作。</p>
<ul>
<li>MapJoinMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现Map端join的Mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; userTable = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> MapJoinBean outputKey = <span class="keyword">new</span> MapJoinBean();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ORDER_FILE = <span class="string">"order.txt"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Mapper会自行调用的一个初始化方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> context Job信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取系统"投放"到本地的cache文件, 本问题中只有1个，即user.txt</span></span><br><span class="line">		URI[] uris = context.getCacheFiles();</span><br><span class="line">		FileSystem fs = FileSystem.get(context.getConfiguration());</span><br><span class="line">		FSDataInputStream inputStream = fs.open(<span class="keyword">new</span> Path(uris[<span class="number">0</span>]));</span><br><span class="line">		BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 逐行读取user.txt中的数据, 构建userTable</span></span><br><span class="line">		String line = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">			String[] terms = line.split(<span class="string">","</span>);</span><br><span class="line">			<span class="keyword">if</span>(!userTable.containsKey(terms[<span class="number">0</span>])) &#123;</span><br><span class="line">				userTable.put(terms[<span class="number">0</span>], <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">			&#125;</span><br><span class="line">			userTable.get(terms[<span class="number">0</span>]).add(terms[<span class="number">1</span>]);</span><br><span class="line">			userTable.get(terms[<span class="number">0</span>]).add(terms[<span class="number">2</span>]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		reader.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">		FileSplit fileSplit = (FileSplit) context.getInputSplit();</span><br><span class="line">		String fileName = fileSplit.getPath().getName();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 不需要再处理User数据文件了, 因为已经通过setup把其数据加载到内存中的userTable</span></span><br><span class="line">		<span class="keyword">if</span>(fileName.equals(ORDER_FILE)) &#123;</span><br><span class="line">			String line = value.toString();</span><br><span class="line">			String[] terms = line.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 从本地的"小表" —— userTable处获得userID对应的数据</span></span><br><span class="line">			String userName = userTable.get(terms[<span class="number">0</span>]).get(<span class="number">0</span>);</span><br><span class="line">			String phone = userTable.get(terms[<span class="number">0</span>]).get(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 不再需要flag字段, 简单置为空串</span></span><br><span class="line">			outputKey.set(terms[<span class="number">0</span>], userName, phone, terms[<span class="number">1</span>], terms[<span class="number">2</span>], terms[<span class="number">3</span>], <span class="string">""</span>);</span><br><span class="line">			context.write(outputKey, NullWritable.get());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MapJoinReducer</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Map端Join的Reducer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>, <span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(MapJoinBean key, Iterable&lt;NullWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">		context.write(key, NullWritable.get());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">+ MapJoinBean</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义JavaBean, 实现WritableComparable接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinBean</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">MapJoinBean</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> String userID;</span><br><span class="line">	<span class="keyword">public</span> String uName;</span><br><span class="line">	<span class="keyword">public</span> String phone;</span><br><span class="line">	<span class="keyword">public</span> String orderID;</span><br><span class="line">	<span class="keyword">public</span> String price;</span><br><span class="line">	<span class="keyword">public</span> String date;</span><br><span class="line">	<span class="keyword">public</span> String flag;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MapJoinBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MapJoinBean</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"uName='"</span> + uName + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", phone='"</span> + phone + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", orderID='"</span> + orderID + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", price='"</span> + price + <span class="string">'\''</span> +</span><br><span class="line">				<span class="string">", date='"</span> + date + <span class="string">'\''</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUserID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserID</span><span class="params">(String userID)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userID = userID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(String flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getuName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> uName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setuName</span><span class="params">(String uName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.uName = uName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> phone;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.phone = phone;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getOrderID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> orderID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderID</span><span class="params">(String orderID)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(String price)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.date = date;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		dataOutput.writeUTF(userID);</span><br><span class="line">		dataOutput.writeUTF(uName);</span><br><span class="line">		dataOutput.writeUTF(phone);</span><br><span class="line">		dataOutput.writeUTF(orderID);</span><br><span class="line">		dataOutput.writeUTF(price);</span><br><span class="line">		dataOutput.writeUTF(date);</span><br><span class="line">		dataOutput.writeUTF(flag);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		userID = dataInput.readUTF();</span><br><span class="line">		uName = dataInput.readUTF();</span><br><span class="line">		phone = dataInput.readUTF();</span><br><span class="line">		orderID = dataInput.readUTF();</span><br><span class="line">		price = dataInput.readUTF();</span><br><span class="line">		date = dataInput.readUTF();</span><br><span class="line">		flag = dataInput.readUTF();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(MapJoinBean o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(o == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(userID.compareTo(o.getUserID()) == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> orderID.compareTo(o.getOrderID());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> userID.compareTo(o.getUserID());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MapJoinDriver</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinDriver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException, URISyntaxException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://localhost:9000"</span>);</span><br><span class="line">		Job joinJob = Job.getInstance(conf);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用Map端join的Mapper和Reducer</span></span><br><span class="line">		joinJob.setMapperClass(MapJoinMapper.class);</span><br><span class="line">		joinJob.setReducerClass(MapJoinReducer.class);</span><br><span class="line"></span><br><span class="line">		joinJob.setJarByClass(MapJoinDriver.class);</span><br><span class="line"></span><br><span class="line">		joinJob.setMapOutputKeyClass(MapJoinBean.class);</span><br><span class="line">		joinJob.setMapOutputValueClass(NullWritable.class);</span><br><span class="line">		joinJob.setOutputKeyClass(MapJoinBean.class);</span><br><span class="line">		joinJob.setOutputValueClass(NullWritable.class);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 向各节点"投放"User数据文件</span></span><br><span class="line">		joinJob.addCacheFile(<span class="keyword">new</span> URI(<span class="string">"/join/input/user.txt"</span>));</span><br><span class="line"></span><br><span class="line">		FileInputFormat.setInputPaths(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/input"</span>));</span><br><span class="line">		FileOutputFormat.setOutputPath(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/output"</span>));</span><br><span class="line"></span><br><span class="line">		System.exit(joinJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>利用Map-Reduce可以完成数据文件的join操作。不需要先将数据结构化，导入MySQL。</li>
<li>自定义<code>JavaBean</code>类，用于集成多个属性的思路仍然很有用。</li>
<li>当join的双方是一张<strong>大表</strong>和一张<strong>小表</strong>时，可考虑将小表分发到所有map端，在本地将小表加载到内存，从而实现<strong>map端join</strong>。</li>
</ol>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>具体代码请点击<br><a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/join" target="_blank" rel="noopener">Join操作与Map端join操作代码</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        
        
        <div class="vcomment"></div>
        
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#浅谈join与数据倾斜解决方案"><span class="toc-number">1.</span> <span class="toc-text">浅谈join与数据倾斜解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题背景"><span class="toc-number">1.1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题分析"><span class="toc-number">1.2.</span> <span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实现"><span class="toc-number">1.3.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#极端情况——“数据倾斜”"><span class="toc-number">1.4.</span> <span class="toc-text">极端情况——“数据倾斜”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码"><span class="toc-number">1.6.</span> <span class="toc-text">代码</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/03/04/join-di/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/03/04/join-di/&text=浅谈join与数据倾斜解决方案"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/03/04/join-di/&is_video=false&description=浅谈join与数据倾斜解决方案"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浅谈join与数据倾斜解决方案&body=Check out this article: http://yoursite.com/2018/03/04/join-di/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/03/04/join-di/&title=浅谈join与数据倾斜解决方案"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/03/04/join-di/&name=浅谈join与数据倾斜解决方案&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Haoxiang Ma
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


<!-- Valine Comments -->

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<script type="text/javascript">
    var notify = 'false' == true ? true : false;
    var verify = 'false' == true ? true : false;
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail'.split(',').filter(function(item){
      return GUEST_INFO.indexOf(item) > -1
    });
    guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "1mYS96DR4e28MDXJxW1ByUA6-gzGzoHsz",
        appKey: "IMF92wd7jJxCXanv65MdkiBn",
        avatar:"",
        placeholder: "Say something...",
        guest_info:guest_info,
        pageSize:"10"
    })
</script>


</body>
</html>
