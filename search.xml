<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>[MIT 6.824]Lab1ç¬”è®°</title>
      <link href="/2019/01/03/mit6824-lab1/"/>
      <url>/2019/01/03/mit6824-lab1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%å†…å®¹ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>å‰å‡ å¤©å¼€å§‹è‡ªå­¦<code>MIT</code>çš„åˆ†å¸ƒå¼ç¥è¯¾ï¼Œå¤§åé¼é¼çš„<code>MIT 6.824</code>ã€‚ç”±äºç½‘ä¸Šåªæœå¾—åˆ°2015 Springçš„è¯¾ç¨‹è§†é¢‘ï¼ˆyoutubeï¼‰ï¼Œæ„Ÿè§‰æ—¶é—´æœ‰ç‚¹ä¹…è¿œï¼Œå°±ä¸çœ‹è§†é¢‘ç›´æ¥çœ‹materialsäº†ã€‚</p><p>ï¼ˆå¦‚æœæ‰¾å¾—åˆ°2017æˆ–è€…2018çš„å°±å¥½äº†ï¼Œ<strong>ç„¶è€Œäººå®¶MITä¹Ÿæ²¡æœ‰ä»»ä½•ä¹‰åŠ¡æŠŠè‡ªå·±çš„æ ¸å¿ƒè¯¾å…è´¹å…¬å¼€= =</strong>ï¼Œèƒ½æŠŠmaterialså…¨éƒ¨å…è´¹å…¬å¼€å°±çœŸçš„å·²ç»å¾ˆæ…·æ…¨äº†ï¼‰</p><p>åœ¨Day 1ï¼Œä¸»è¦çš„å†…å®¹è¿˜æ˜¯çƒ­çƒ­èº«ï¼Œå…ˆå…¥åˆ†å¸ƒå¼è®¡ç®—çš„é—¨æ§›ã€‚æ‰€ä»¥è¦æ±‚è¯»<code>map-reduce</code>çš„è®ºæ–‡ï¼ˆ<a href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf" target="_blank" rel="noopener">MapReduce: Simplified Data Processing on Large Clusters</a>ï¼‰ï¼Œç„¶ååŸºäºå·²æœ‰çš„ä»£ç å’Œåœ¨paperä¸­è¯»åˆ°çš„ç†è®ºæ¥è§£å†³ä»¥ä¸‹5ä¸ªå­é—®é¢˜</p><ol><li>å®ç°<code>doMap()</code>å’Œ<code>doReduce()</code></li><li>å®ç°<code>wordcount</code></li><li>å®ç°å¤šworkerå¹¶å‘çš„map reduce</li><li>mrè¿‡ç¨‹ä¸­rpcå¤±è´¥å¤„ç†</li><li>åˆ©ç”¨mrå®ç°å€’æ’ç´¢å¼•</li></ol><h3 id="Sub-problems"><a href="#Sub-problems" class="headerlink" title="Sub-problems"></a>Sub-problems</h3><ol><li><p>å®ç°<code>doMap()</code>å’Œ<code>doReduce()</code></p><p> <code>doMap()</code>å’Œ<code>doReduce()</code>å…¶å®å°±æ˜¯map jobå’Œreduce jobçš„é«˜å±‚å°è£…ã€‚</p><p> å…ˆæ¥çœ‹çœ‹<code>doMap()</code>ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doMap</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">jobName <span class="keyword">string</span>, // mr jobåç§°</span></span></span><br><span class="line"><span class="function"><span class="params">mapTask <span class="keyword">int</span>, // <span class="keyword">map</span>ä»»åŠ¡id</span></span></span><br><span class="line"><span class="function"><span class="params">inFile <span class="keyword">string</span>,// è¯¥<span class="keyword">map</span>ä»»åŠ¡å¯¹åº”çš„è¾“å…¥æ–‡ä»¶å</span></span></span><br><span class="line"><span class="function"><span class="params">nReduce <span class="keyword">int</span>,// reduceræ•°é‡</span></span></span><br><span class="line"><span class="function"><span class="params">mapF <span class="keyword">func</span>(filename <span class="keyword">string</span>, contents <span class="keyword">string</span>)</span> []<span class="title">KeyValue</span>,// <span class="title">map</span>å‡½æ•°</span></span><br><span class="line"><span class="function">)</span> &#123;</span><br><span class="line"><span class="comment">// æŠŠè¯¥mapä»»åŠ¡å¯¹åº”çš„æ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å‡ºæ¥</span></span><br><span class="line">contents, err := ioutil.ReadFile(inFile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºä¸€ä¸ªmap, è®°å½•file nameå’Œè¦å†™å…¥è¯¥fileçš„æ‰€æœ‰k-vå¯¹</span></span><br><span class="line">intermediateMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*list.List)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨mapå‡½æ•°, å¾—åˆ°æ–‡ä»¶å†…å®¹ä¸­çš„æ‰€æœ‰k-vå¯¹</span></span><br><span class="line">kvs := mapF(inFile, <span class="keyword">string</span>(contents))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºæ¯ä¸ªk-vå¯¹ç®—å‡ºå®ƒå¯¹åº”çš„reducer id, ç”¨mapè®°å½•ä¸€ä¸‹</span></span><br><span class="line"><span class="keyword">for</span> _, kv := <span class="keyword">range</span> kvs &#123;</span><br><span class="line">reducer := ihash(kv.Key) % nReduce</span><br><span class="line">intermediateFileName := reduceName(jobName, mapTask, reducer)</span><br><span class="line"><span class="keyword">if</span> currentList, ok := intermediateMap[intermediateFileName]; ok &#123;</span><br><span class="line">currentList.PushBack(kv)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">currentList = list.New()</span><br><span class="line">currentList.PushBack(kv)</span><br><span class="line">intermediateMap[intermediateFileName] = currentList</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™ä¸­é—´æ–‡ä»¶ï¼ŒæŠŠæ–‡ä»¶å¯¹åº”çš„æ‰€æœ‰k-vå¯¹éƒ½å†™åˆ°è¯¥æ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="keyword">for</span> fileName, kvList := <span class="keyword">range</span> intermediateMap &#123;</span><br><span class="line">file, err := os.OpenFile(fileName, os.O_CREATE | os.O_WRONLY, <span class="number">0777</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">encoder := json.NewEncoder(file)</span><br><span class="line"><span class="keyword">for</span> element := kvList.Front(); element != <span class="literal">nil</span>; element = element.Next() &#123;</span><br><span class="line">encoder.Encode(element.Value)</span><br><span class="line">&#125;</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ç”¨Javaè£¸å†™è¿‡Hadoop mrç¨‹åºçš„è¦å®ç°<code>doMap()</code>åº”è¯¥å¾ˆè½»æ¾ï¼Œä½†æ˜¯åœ¨å®ç°çš„æ—¶å€™ä¼°è®¡éƒ½ä¼šæœ‰ç‚¹åˆ«æ‰­ã€‚å› ä¸ºåœ¨å†™Hadoop mrçš„æ—¶å€™ï¼Œåªéœ€è¦è‡ªå·±å®ç°mapå‡½æ•°ï¼Œè€Œä¸”mapå‡½æ•°æ¥æ”¶çš„å‚æ•°é»˜è®¤å°±æ˜¯ä¸€è¡Œå†…å®¹ï¼ˆæˆ–è€…æŸç§InputFormatçš„ä¸€ä¸ªå•ä½ï¼‰ã€‚</p><p> è€Œåœ¨è¿™é‡Œæˆ‘ä»¬è¦å®ç°æ›´é«˜å±‚çš„æŠ½è±¡ï¼Œè¦æŠŠmapå‡½æ•°çš„å¤–å±‚é€»è¾‘éƒ½å®ç°å¥½ï¼Œè°ƒç”¨mapå‡½æ•°åªæ˜¯æ•´ä¸ªé€»è¾‘ä¸­çš„ä¸€å°æ­¥ã€‚</p><p> ä¸‹é¢å†æ¥çœ‹çœ‹<code>doReduce()</code>ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doReduce</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">jobName <span class="keyword">string</span>, // ä»»åŠ¡åç§°</span></span></span><br><span class="line"><span class="function"><span class="params">reduceTask <span class="keyword">int</span>, // reduceä»»åŠ¡id</span></span></span><br><span class="line"><span class="function"><span class="params">outFile <span class="keyword">string</span>, // è¾“å‡ºåˆ°å“ªä¸ªæ–‡ä»¶</span></span></span><br><span class="line"><span class="function"><span class="params">nMap <span class="keyword">int</span>, // <span class="keyword">map</span>ä»»åŠ¡æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">reduceF <span class="keyword">func</span>(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span>,// <span class="title">reduce</span>å‡½æ•°</span></span><br><span class="line"><span class="function">)</span> &#123;</span><br><span class="line">reduceMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆä»å„ä¸ªmapperè¾“å‡ºçš„ä¸­é—´æ–‡ä»¶ä¸­è¯»å‡ºå±äºæœ¬reducerçš„k-vå¯¹</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>;i &lt; nMap;i++ &#123;</span><br><span class="line">fileName := reduceName(jobName, i, reduceTask)</span><br><span class="line">file, err := os.Open(fileName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">reader := bufio.NewReader(file)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// é€è¡Œè¯»å–, ä¸€è¡Œä¸€ä¸ªk-vå¯¹</span></span><br><span class="line">line, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">kv := KeyValue&#123;&#125;</span><br><span class="line">json.Unmarshal([]<span class="keyword">byte</span>(line), &amp;kv)</span><br><span class="line">key := kv.Key</span><br><span class="line">value := kv.Value</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡keyæ¥èšé›†, group by key</span></span><br><span class="line"><span class="keyword">if</span> values, ok := reduceMap[key]; ok &#123;</span><br><span class="line">reduceMap[key] = <span class="built_in">append</span>(values, value)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">reduceMap[key] = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">reduceMap[key] = <span class="built_in">append</span>(reduceMap[key], value)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®keyæ¥å‡åºæ’åº</span></span><br><span class="line">keys := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(reduceMap))</span><br><span class="line"><span class="keyword">for</span> k := <span class="keyword">range</span> reduceMap &#123;</span><br><span class="line">keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">&#125;</span><br><span class="line">sort.Slice(keys, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> keys[i] &lt; keys[j]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äºæ¯ä¸ªkey, è°ƒç”¨reduceå‡½æ•°å¾—åˆ°reduceåçš„ç»“æœ, å†™å…¥ç»“æœæ–‡ä»¶</span></span><br><span class="line">out, err := os.OpenFile(outFile, os.O_CREATE | os.O_RDWR, <span class="number">0777</span>)</span><br><span class="line"><span class="keyword">defer</span> out.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">encoder := json.NewEncoder(out)</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">reduceResult := reduceF(key, reduceMap[key])</span><br><span class="line">encoder.Encode(KeyValue&#123;Key: key, Value:reduceResult&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> çœ‹ä¸Šè¿°ä»£ç ï¼Œ<code>doReduce()</code>é‡Œçš„é€»è¾‘ä¹Ÿéå¸¸æ¸…æ™°ã€‚ä¸»è¦çš„ç‚¹åœ¨äºmræ¨¡å‹ä¸­çš„keyçš„æœ‰åºæ€§ï¼Œ<strong><em>æœ¬æ¥åœ¨mapå’Œreduceä¹‹é—´ä¼šå­˜åœ¨shuffleè¿‡ç¨‹ï¼Œåœ¨shuffleä¸­ä¼šå…ˆå¯¹keyè¿›è¡Œæ’åºï¼Œå†broadcaståˆ°reducerç«¯ã€‚</em></strong>ä½†æ˜¯åœ¨lab 1ä¸­æ²¡æœ‰ä¸¥æ ¼å®šä¹‰ä¸€ä¸ª<code>shuffle</code>è¿‡ç¨‹ï¼Œæ‰€ä»¥è¦åœ¨reducerç«¯å¯¹keyè¿›è¡Œæ’åºï¼Œå†reduceï¼Œæœ€åæ‰æ ¹æ®keyçš„å‡åºæ¥å¤„ç†+è¾“å‡ºã€‚</p></li><li><p>å®ç°<code>wordcount</code></p><p> å®ç°äº†<code>doMap()</code>å’Œ<code>doReduce()</code>åï¼Œè¯´æ˜æ¡†æ¶æ€§çš„mapå’Œreduceçš„å…¥å£å·²ç»å†™å¥½äº†ï¼Œé‚£ä¹ˆå°±æ¥å®ç°ç¬¬ä¸€ä¸ªæœ€ç®€å•çš„mråº”ç”¨ï¼š<code>wordcount</code>ã€‚</p><p> æ ¹æ®lab 1çš„mapå‡½æ•°å®šä¹‰ï¼Œmapå‡½æ•°çš„å…¥å‚æ˜¯ä¸€ä¸ªæ–‡ä»¶çš„<strong><em>#å…¨éƒ¨å†…å®¹#</em></strong>ï¼Œè€Œä¸æ˜¯Hadoop mrä¸­mapå‡½æ•°çš„<strong><em>#ä¸€è¡Œå†…å®¹#</em></strong>ï¼Œæ‰€ä»¥è°ƒç”¨ä¸€æ¬¡mapå‡½æ•°ï¼Œå°±å¾—æŠŠæŸæ–‡ä»¶ä¸­çš„å…¨éƒ¨<code>k-v</code>å¯¹éƒ½ç”Ÿæˆå¹¶è¿”å›ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span><span class="params">(filename <span class="keyword">string</span>, contents <span class="keyword">string</span>)</span> []<span class="title">mapreduce</span>.<span class="title">KeyValue</span></span> &#123;</span><br><span class="line">kvs := <span class="built_in">make</span>([]mapreduce.KeyValue, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨FieldsFuncæ¥è¿›è¡Œåˆ†è¯, å‰”é™¤életterçš„å†…å®¹</span></span><br><span class="line">terms := strings.FieldsFunc(contents, <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> !unicode.IsLetter(r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦å®ç°wordcount, æ¯ä¸ªè¯è¦mapæˆä¸€ä¸ª&lt;word, 1&gt;çš„äºŒå…ƒç»„</span></span><br><span class="line"><span class="keyword">for</span> _, term := <span class="keyword">range</span> terms &#123;</span><br><span class="line">kvs = <span class="built_in">append</span>(kvs, mapreduce.KeyValue&#123;Key: term, Value: <span class="string">"1"</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> kvs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> åœ¨<code>mapF()</code>é‡Œï¼Œä¸€å¼€å§‹æˆ‘æ˜¯å‚»ä¹ä¹åœ°ç”¨<code>strings.Split()</code>æ¥åˆ†è¯çš„ï¼Œåæ¥å‘ç°Splitåˆ†è¯çš„é€»è¾‘å¤ªæ­»æ¿ï¼Œåªèƒ½æ ¹æ®æŸä¸ªç‰¹å®šçš„å­—ç¬¦ä¸²æ¥åˆ†å‰²ï¼Œä¸å¤ªç¬¦åˆéœ€æ±‚ã€‚ä¸€ç•ªæŸ¥é˜…æ‰å‘ç°äº†<code>strings.FieldsFunc()</code>ä¹Ÿå¯ä»¥å®ç°åˆ†è¯ï¼Œåªéœ€è¦ä¼ å…¥ä¸€ä¸ªåŒ¿ååˆ¤æ–­æ–¹æ³•ï¼Œå‘Šè¯‰å®ƒè¦è¿‡æ»¤å“ªäº›ç±»å‹çš„å­—ç¬¦å°±è¡Œäº†ã€‚</p><p> è‡³äºreduceï¼Œé€»è¾‘æ›´ç®€å•ï¼Œå…¥å‚æ˜¯ä¸€ä¸ªkeyå’Œè¯¥keyå¯¹åº”çš„æ‰€æœ‰valueç»„æˆçš„sliceã€‚ä¸ºäº†å®ç°wordcountï¼Œåªéœ€è¦ç®€å•åœ°è¾“å‡ºæŸkeyæœ‰å¤šå°‘ä¸ªå¯¹åº”çš„valueså°±è¡Œï¼Œä¹Ÿå°±æ˜¯<code>len(values)</code>ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> strconv.Itoa(<span class="built_in">len</span>(values))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®ç°å¤šworkerå¹¶å‘çš„map reduce</p><p> lab 1é‡Œmrçš„è¿è¡Œæ¨¡å¼æœ‰ä¸¤ç§</p><ul><li>Sequentialï¼ˆä¸²è¡Œï¼Œå¤šä¸ªmapä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œç„¶åå¤šä¸ªreduceä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼‰</li><li><p>Distributedï¼ˆå¹¶å‘ï¼Œå¤šä¸ªmapä»»åŠ¡å¹¶å‘ï¼Œç„¶åå¤šä¸ªreduceä»»åŠ¡å¹¶å‘ï¼‰</p><p>ä¸ºäº†å®ç°å¹¶å‘æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆ<code>schedule.go</code>é‡Œçš„<code>schedule()</code>æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ¡†æ¶é‡Œï¼Œæ‰€è°“çš„å¹¶å‘æ‰§è¡Œï¼ˆDistributedï¼‰ï¼Œå°±æ˜¯å‡è®¾ä½ æœ‰ä¸€ä¸ªé›†ç¾¤ï¼Œé‡Œé¢æœ‰å¤šå°workerï¼Œä½œä¸ºè°ƒåº¦è€…ä¸éœ€è¦äº²è‡ªå»é€ä¸ªä¸²è¡Œæ‰§è¡Œmapæˆ–è€…reduceä»»åŠ¡ï¼Œåªéœ€è¦å¹¶å‘åœ°æŠŠä»»åŠ¡â€œæ‰”â€ç»™ç©ºé—²çš„workerï¼Œè®©workerå»å¹²æ´»ï¼Œå®ƒå®Œæˆåä¼šé€šçŸ¥è°ƒåº¦è€…ã€‚</p><p>è¿™ä¹ˆå¹¶å‘æ‰§è¡Œçš„å¥½å¤„å°±æ˜¯<strong><em>ç±»å¼‚æ­¥æœºåˆ¶</em></strong>ï¼Œè°ƒåº¦è€…ä¸ç”¨ä¸²è¡Œç­‰å¾…ï¼Œåªç®¡åˆ†é…ã€‚å½“è°ƒåº¦è€…æ”¶åˆ°äº†Nä¸ªworkerçš„å®Œæˆå›å¤ï¼Œä»£è¡¨æœ¬æ¬¡ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œå³å¯ç»“æŸã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹æè¿°æ­¤é€»è¾‘çš„ä¼ªä»£ç ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// assign tasks to workers</span></span><br><span class="line">foreach task &#123;</span><br><span class="line">t = <span class="built_in">new</span> thread</span><br><span class="line">worker = t.get_available_worker()</span><br><span class="line">t.call_rpc_to_assign_task(worker, task)</span><br><span class="line">t.notify_master_success_or_fail()</span><br><span class="line">&#125;</span><br><span class="line">master.wait_for_all_task_completion()</span><br></pre></td></tr></table></figure><p>*åœ¨<code>golang</code>ä¸­ï¼Œ<code>thread</code>çš„ä½œç”¨å¯ä»¥ç”¨<code>goroutine</code>æ›¿ä»£ã€‚</p></li></ul></li><li><p>å¹¶å‘mrè¿‡ç¨‹ä¸­rpcå¤±è´¥å¤„ç†</p><p> åœ¨å¹¶å‘mrè¿‡ç¨‹ä¸­ï¼Œç”±äºé‡‡ç”¨äº†<code>master - worker</code>è¿™æ ·çš„æ¶æ„ï¼Œæ‰€ä»¥masterå¿…ç„¶æ˜¯é€šè¿‡<code>rpc</code>æ¥ç»™workeråˆ†é…ä»»åŠ¡ã€‚ä½†æ˜¯ç”±äº</p><ul><li>ç½‘ç»œå¼‚å¸¸å¯¼è‡´å¤±è´¥</li><li>workerå®•æœº</li><li>workerèµ„æºä¸è¶³å¯¼è‡´è¶…æ—¶</li><li><p>workerä»£ç é€»è¾‘å‡ºé”™</p><p>ç­‰ç§ç§åŸå› ï¼Œåœ¨åˆ†é…ä»»åŠ¡æ—¶å¾€å¾€ä¸æ˜¯ä¸€æ¬¡<code>rpc</code>å°±èƒ½é¡ºåˆ©å®Œæˆçš„ï¼Œæ‰€ä»¥å°±éœ€è¦å¯¹<code>rpc</code>çš„ç»“æœè¿›è¡Œå¤±è´¥å¤„ç†ã€‚åœ¨æˆ‘çš„å®ç°ä¸­ç­–ç•¥æ˜¯<strong><em>æ— é™é‡å¤ï¼Œå½“<code>rpc</code>å¤±è´¥åï¼Œå†å°è¯•ä»å·²æ³¨å†Œçš„workeré˜Ÿåˆ—ä¸­å–å‡ºå¦ä¸€ä¸ªworkerï¼Œè¿›è¡Œé‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚</em></strong></p><p>å½“ç„¶è¿˜å¯ä»¥è®¾è®¡æ›´å¤æ‚çš„ç­–ç•¥ï¼Œä¾‹å¦‚ä¸“é—¨å®‰æ’ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹æ¥å‡ºé”™å¤„ç†ï¼Œå½“æŸä¸ª<code>rpc</code>å¤±è´¥æ¬¡æ•°è¶…è¿‡<code>M</code>æ¬¡åï¼Œç”±ç‰¹å®šè®¡ç®—èŠ‚ç‚¹æ¥æ‰‹ï¼Œæ‰§è¡Œä»»åŠ¡ï¼›æˆ–è€…masterè®°å½•å“ªäº›èŠ‚ç‚¹æˆåŠŸæ¬¡æ•°å¤šï¼Œå½“æŸä¸ª<code>rpc</code>å¤±è´¥æ¬¡æ•°è¶…è¿‡<code>M</code>æ¬¡åå°±æŠŠä»»åŠ¡åˆ†å‘åˆ°é«˜é¢‘èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p><p>ç›´æ¥çœ‹æˆ‘å®ç°çš„ä»£ç ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">(jobName <span class="keyword">string</span>, mapFiles []<span class="keyword">string</span>, nReduce <span class="keyword">int</span>, phase jobPhase, registerChan <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> ntasks <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> n_other <span class="keyword">int</span> <span class="comment">// number of inputs (for reduce) or outputs (for map)</span></span><br><span class="line"><span class="keyword">switch</span> phase &#123;</span><br><span class="line"><span class="keyword">case</span> mapPhase:</span><br><span class="line">ntasks = <span class="built_in">len</span>(mapFiles)</span><br><span class="line">n_other = nReduce</span><br><span class="line"><span class="keyword">case</span> reducePhase:</span><br><span class="line">ntasks = nReduce</span><br><span class="line">n_other = <span class="built_in">len</span>(mapFiles)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"Schedule: %v %v tasks (%d I/Os)\n"</span>, ntasks, phase, n_other)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨WaitGroupè®©ä¸»çº¿ç¨‹åœ¨æœ€åé˜»å¡, wait_for_all_tasks_completion</span></span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(ntasks)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠæ¯ä¸€ä¸ªtask, éƒ½åˆ†å‘ç»™ä¸€ä¸ªç©ºé—²çš„worker</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>;i &lt; ntasks;i++ &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨goroutineå¹¶å‘</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(taskId <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®taskå‚æ•°</span></span><br><span class="line">args := DoTaskArgs&#123;JobName: jobName, Phase: phase, TaskNumber: taskId, NumOtherPhase: n_other&#125;</span><br><span class="line"><span class="keyword">if</span> phase == mapPhase &#123;</span><br><span class="line">args.File = mapFiles[taskId]</span><br><span class="line">&#125;</span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— é™å¾ªç¯, ç›´åˆ°æœ¬taskè¢«workerå›å¤å®Œæˆ</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// å°è¯•ä»å·²æ³¨å†Œçš„workeré˜Ÿåˆ—ä¸­å–worker</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> workerAddr := &lt;- registerChan:</span><br><span class="line"><span class="keyword">if</span> call(workerAddr, <span class="string">"Worker.DoTask"</span>, args, <span class="literal">nil</span>) == <span class="literal">true</span> &#123;</span><br><span class="line">wg.Done()</span><br><span class="line">done &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">registerChan &lt;- workerAddr<span class="comment">// æŠŠworkerå½’è¿˜é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;- done:</span><br><span class="line"><span class="keyword">return</span><span class="comment">// ç›´åˆ°æœ¬taskè¢«å›å¤å®Œæˆæ‰ç¦»å¼€å¾ªç¯</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Printf(<span class="string">"waiting for the task-%d being done\n"</span>, taskId)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wg.Wait()<span class="comment">// æ­¤å¤„å‘ç”Ÿé˜»å¡, åªæœ‰Nä¸ªgoroutineå…¨éƒ¨å®Œæˆæ‰è§£é™¤é˜»å¡</span></span><br><span class="line">fmt.Printf(<span class="string">"Schedule: %v done\n"</span>, phase)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæ— é™<code>for loop</code> + <code>select case</code>è¯­å¥åœ¨è¯»å†™<code>channel</code>çš„åœºæ™¯ä¸­<strong><em>ååˆ†å¸¸è§ï¼</em></strong>åœ¨ç¬¬ä¸€ä¸ª<code>select case</code>ä¸­ï¼Œå¦‚æœèƒ½å¤Ÿä»workeré˜Ÿåˆ—é‡ŒæˆåŠŸå–å‡ºworkerå°±å‘<code>rpc</code>ï¼Œå¦‚æœå–ä¸å‡ºï¼Œå°±æ— é™å¾ªç¯å°è¯•å»å–ã€‚</p><p>è‡³äºç¬¬äºŒä¸ª<code>select case</code>ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯åˆ¤æ–­<code>rpc</code>æ˜¯å¦æˆåŠŸï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦è·³å‡ºæ— é™å¾ªç¯ã€‚å¦‚æœ<code>rpc</code>æˆåŠŸï¼Œ<code>done</code>é‡Œå°±ä¼šæœ‰ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œ<code>select case</code>è¯­å¥è‡ªç„¶å°±èƒ½æ‰§è¡Œåˆ°<code>return</code>è·³å‡ºå¾ªç¯ï¼›å¦‚æœ<code>rpc</code>ä¸æˆåŠŸï¼Œåªä¼šæ‰“å°ä¸€å¥logï¼Œç„¶åç»§ç»­æ— é™å¾ªç¯ã€‚</p><p>åœ¨è§£å†³å‡ºé”™å¤„ç†çš„é—®é¢˜æ—¶ï¼Œ<strong><em>å‘ç°æœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„åœ°æ–¹ï¼Œå¦‚æœ<code>rpc</code>è¿”å›falseï¼Œå°±æŠŠworkerå½’è¿˜åˆ°é˜Ÿåˆ—é‡Œå»ï¼ŒæŸä¸ªä»»åŠ¡ä¼šå¡æ­»åœ¨è¿™ä¸ªåœ°æ–¹ã€‚</em></strong>åæ¥æ£€æŸ¥è°ƒç”¨<code>schedule()</code>çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯<code>Distributed()</code>é‡Œï¼Œå‘ç°workeré˜Ÿåˆ—æ˜¯ä¸€ä¸ª<strong><em>#é˜»å¡ï¼ˆéç¼“å†²ï¼‰channel#ï¼Œ<code>ch := make(chan string)</code></em></strong>ã€‚âš ï¸å½“æŸä¸ªgoroutineå°è¯•æŠŠworkerå½’è¿˜ï¼Œå´æ²¡æœ‰åˆ«çš„goroutineä»channelå–è¯¥workerçš„æ—¶å€™ï¼Œå°è¯•å½’è¿˜çš„goroutineä¼šå¡æ­»ã€‚è¿™æ ·çš„è®¾è®¡æ„Ÿè§‰ä¹Ÿæ˜¯ä¸åˆç†çš„ï¼Œå­˜æ”¾workerçš„é˜Ÿåˆ—<strong><em>ä¸åº”è¯¥</em></strong>æ˜¯éç¼“å†²çš„ï¼Œé‚£æ ·æœ€åä¸€ä¸ªå½’è¿˜workerçš„goroutineæ°¸è¿œéƒ½ä¼šè¢«å¡æ­»ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘å†³å®šä¿®æ”¹<code>Distributed()</code>é‡Œçš„channelçš„å®šä¹‰ï¼ŒæŠŠéç¼“å†²channelæ”¹æˆç¼“å†²channelï¼Œä»¥è§£å†³æ­¤é—®é¢˜ã€‚</p></li></ul></li><li><p>åˆ©ç”¨mrå®ç°å€’æ’ç´¢å¼•</p><p> æœ€åä¸€ä¸ªå°é¢˜ï¼Œç”¨mrå®ç°å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰ï¼Œä¸»è¦å°±æ˜¯è‡ªè¡Œå®ç°<code>mapF()</code>å’Œ<code>reduceF()</code>é‡Œçš„é€»è¾‘ï¼Œç”Ÿæˆä¸€ä¸ªå€’æ’ç´¢å¼•çš„outputæ–‡ä»¶ã€‚</p><p> ï¼ˆè‡³äºHadoop mrå®ç°çš„å€’æ’ç´¢å¼•ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« <a href="http://marcoma.xyz/2018/02/25/ii-wc/" target="_blank" rel="noopener">ã€Šè°ˆè°ˆå€’æ’ç´¢å¼•ï¼Œå‡çº§ç‰ˆâ€œWordCountâ€ã€‹</a>ï¼‰</p><p> å…·ä½“çš„é€»è¾‘å°±æ˜¯ï¼šä»æ–‡ä»¶ä¸­è¯»å‡ºå…¨éƒ¨å†…å®¹ï¼Œè¿›è¡Œåˆ†è¯å¾—åˆ°Nä¸ªç‹¬ç«‹çš„<code>word</code>ï¼›ç„¶åæŠŠæ¯ä¸ªç‹¬ç«‹çš„<code>word</code>mapæˆ<code>&lt;word, file_name&gt;</code>çš„k-vå¯¹ï¼›åœ¨reducerä¸­æŠŠåŒä¸€ä¸ª<code>word</code>çš„å¤šä¸ª<code>file_name</code>é›†åˆ°ä¸€èµ·ï¼Œè¾“å‡ºï¼Œæå®š~</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sliceå»é‡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeDuplicate</span><span class="params">(terms []<span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">dict := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">result := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(terms))</span><br><span class="line"><span class="keyword">for</span> _, term := <span class="keyword">range</span> terms &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := dict[term]; !ok &#123;</span><br><span class="line">dict[term] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">result = <span class="built_in">append</span>(result, term)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span><span class="params">(document <span class="keyword">string</span>, value <span class="keyword">string</span>)</span> <span class="params">(res []mapreduce.KeyValue)</span></span> &#123;</span><br><span class="line">terms := strings.FieldsFunc(value, <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> !unicode.IsLetter(r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// *å…³é”®, å¯¹å•è¯è¿›è¡Œå»é‡</span></span><br><span class="line">terms = removeDuplicate(terms)</span><br><span class="line"></span><br><span class="line">result := <span class="built_in">make</span>([]mapreduce.KeyValue, <span class="number">0</span>, <span class="built_in">len</span>(terms))</span><br><span class="line"><span class="keyword">for</span> _, term := <span class="keyword">range</span> terms &#123;</span><br><span class="line">result = <span class="built_in">append</span>(result, mapreduce.KeyValue&#123;Key: term, Value: document&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reduceå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="comment">// *å…³é”®, å¯¹å•è¯è¿›è¡Œå»é‡</span></span><br><span class="line">values = removeDuplicate(values)</span><br><span class="line">numDoc := <span class="built_in">len</span>(values)</span><br><span class="line">docs := <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">docs += fmt.Sprintf(<span class="string">"%s,"</span>, value)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">"%d %s"</span>, numDoc, docs[:<span class="built_in">len</span>(docs) - <span class="number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æ­¤å¤„å€¼å¾—ä¸€æçš„å°±æ˜¯è¦å¯¹å•è¯è¿›è¡Œå»é‡æ“ä½œï¼ŒåŒä¸€ç¯‡æ–‡ç« é‡Œçš„å¤šä¸ªç›¸åŒçš„å•è¯ï¼Œåªåº”è¯¥ç”Ÿæˆä¸€ä¸ª<code>&lt;word, file_name&gt;</code>çš„k-vå¯¹ï¼Œä¸ç„¶å°±ä¼šé€ æˆå†—ä½™è®¡æ•°ã€‚</p><p> è€Œ<code>golang</code>é‡Œè²Œä¼¼åˆæ²¡æœ‰æä¾›å¯¹sliceå»é‡çš„æ ‡å‡†åº“æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±å®ç°ä¸€ä¸ªå»é‡å‡½æ•°ï¼Œåˆ©ç”¨<code>map</code>çš„keyçš„ä¸å¯é‡å¤æ€§è¿›è¡Œå»é‡ï¼Œ<strong><em>ä½¿ç”¨<code>map[string]struct{}</code>æ˜¯å› ä¸ºç©ºstructä¸å ä»»ä½•å­—èŠ‚ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€‚</em></strong></p></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¯èƒ½å› ä¸ºä¹‹å‰æœ‰æ·±å…¥ç ”ç©¶è¿‡map reduceçš„æ¨¡å‹ï¼Œæ‰€ä»¥Lab 1æ„Ÿè§‰æ²¡æœ‰å¤ªå¤§çš„éš¾ç‚¹ï¼Œçœ‹æ¥é˜…è¯»åŸç‰ˆçš„map reduceè®ºæ–‡è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ä¸ºæ•°ä¸å¤šçš„é—®é¢˜ä¸»è¦å‡ºç°åœ¨<code>golang</code>çš„ä¸€äº›ç‰¹æ€§ä¸Šï¼Œä¾‹å¦‚</p><ul><li>sliceå»é‡</li><li>æŒ‡é’ˆå’Œå€¼çš„åŒºåˆ«</li><li>éç¼“å†²ï¼ˆé˜»å¡ï¼‰channelçš„ä½¿ç”¨</li></ul><p>å¦å¤–å°±æ˜¯å…ˆè¦å¤§è‡´çœ‹æ‡‚å·²æä¾›çš„ä»£ç é‡Œçš„æ¡†æ¶é€»è¾‘ï¼Œå†ä½œä¿®æ”¹ï¼Œé‚£æ ·debugèµ·æ¥ä¹Ÿæ¯”è¾ƒå¿«ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
            <tag> bigdata </tag>
            
            <tag> hadoop </tag>
            
            <tag> mapreduce </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ä¸º2019å¹´ç«‹ä¸‹çš„flag</title>
      <link href="/2018/12/31/2019-flags/"/>
      <url>/2018/12/31/2019-flags/</url>
      
        <content type="html"><![CDATA[<h3 id="2018"><a href="#2018" class="headerlink" title="2018"></a>2018</h3><p>é¥æƒ³2017/12/31æ™šä¸Šï¼Œå½“æ—¶è¿˜æ˜¯æˆ‘å®¤å‹å–Šæˆ‘å»äº†<strong><em>Kerry Park</em></strong>è·¨å¹´çœ‹çƒŸèŠ±ä»€ä¹ˆçš„ã€‚åœ¨è§ç‘Ÿçš„å¯’é£ä¸­ï¼Œä¸¤ä¸‰åº¦çš„æ¸©åº¦ä¸‹ï¼ŒğŸ†ğŸ†ğŸ†ç»½æ”¾çš„ä¸€ç¬é—´ï¼Œé»˜é»˜åœ°è®¸äº†ä¸€ä¸ªæ„¿ï¼Œå¸Œæœ›è‡ªå·±çš„flag(s)éƒ½èƒ½ä¸è¾±ä½¿å‘½åœ°å®Œæˆã€‚</p><p>ç°åœ¨2018é©¬ä¸Šå°±è¿‡å»äº†ï¼Œæƒ³æƒ³2017å¹´ç»™è‡ªå·±ç«‹ä¸‹çš„flag(s)ï¼Œå¥½åƒä¹Ÿå¤§æ¦‚å®Œæˆäº†ä¸ª80%ï¼Œæ„Ÿè§‰è‡ªå·±çš„è‡ªé©±åŠ›ç¡®å®è¿˜å‡‘åˆï¼Œæˆ–è€…è¯´å…´è¶£ or æˆå°±æ„Ÿé©±åŠ¨ç¡®å®æ˜¯æœ‰ç”¨çš„ã€‚</p><p>å½“ç„¶ä¸»è¦æ˜¯åœ¨ğŸ†ğŸ†ğŸ†ä¸­è®¸æ„¿èµ·çš„ä½œç”¨å§ï¼ï¼ï¼</p><h3 id="2019â€”â€”ä¹Ÿæ˜¯ä¸€æ¡æœ‰æ¢¦æƒ³çš„å’¸é±¼ğŸŸ"><a href="#2019â€”â€”ä¹Ÿæ˜¯ä¸€æ¡æœ‰æ¢¦æƒ³çš„å’¸é±¼ğŸŸ" class="headerlink" title="2019â€”â€”ä¹Ÿæ˜¯ä¸€æ¡æœ‰æ¢¦æƒ³çš„å’¸é±¼ğŸŸ"></a>2019â€”â€”ä¹Ÿæ˜¯ä¸€æ¡æœ‰æ¢¦æƒ³çš„å’¸é±¼ğŸŸ</h3><p>è‡³äºå³å°†åˆ°æ¥çš„2019å¹´ï¼Œæ—¢ç„¶ä»2018å¼€å§‹ç”¨å¿ƒç»´æŠ¤æˆ‘è¿™ä¸ªæ²¡æœ‰äººçœ‹çš„åšå®¢ï¼Œé‚£å°±æ¬ä¸çŸ¥è€»åœ°ç›´æ¥æŠŠflag(s)ä»¥blog postçš„å½¢å¼å…¬è¯¸äºä¸–å¥½äº†ã€‚ä¸ºäº†</p><ol><li>ç»™è‡ªå·±æ›´å¼ºçƒˆçš„å¿ƒç†åŠ©æ¨ï¼Œéƒ½å…¬å¼€äº†å¿…é¡»è¦å°½å…¨åŠ›åšåˆ°å§ï¼Œä¸ç„¶è¦è¢«ç¬‘æ­»äº†ğŸ¤£</li><li>ä¸‡ä¸€æ—¥åæŸå¤©æœ‰å¹¸æˆä¸ºäº†ä¸€å<code>ä¼ªå¤§ä½¬</code>ï¼Œçœ‹çœ‹å½“å¹´ç«‹ä¸‹çš„flag(s)åº”è¯¥ä¼šå¾ˆæœ‰æ„æ€ğŸ¤£</li><li>æˆ–è€…æ—¥åæŸå¤©å½»åº•ggæˆä¸ºäº†ä¸€åæ²¹è…»+æ„¤ä¸–å«‰ä¿—+ç¢Œç¢Œæ— ä¸ºçš„loserï¼Œä¹Ÿèƒ½æ„Ÿæ…¨ä¸€ä¸‹è‡ªå·±å½“å¹´ä¹Ÿæ˜¯ä¸ªæœ‰æ¢¦æƒ³çš„å’¸é±¼ğŸ¤£</li></ol><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/jjfr.jpg" alt=""></p><p>ç«‹ä¸‹flags</p><ul><li>æŠ€æœ¯ç¯‡<ul><li>ç§¯æfollowå‡ å¤§computer systemé¢†åŸŸçš„é¡¶ä¼šï¼Œäº‰å–è®¤çœŸç ”è¯»+æ€»ç»“<code>&gt;=4ç¯‡</code>æ ¸å¿ƒpaper</li><li>è¯»å®Œ<code>ã€Šcephè®¾è®¡åŸç†ä¸å®ç°ã€‹</code></li><li>è¯»å®Œ<code>ã€ŠLinux Kernel Developmentã€‹</code></li><li>é‡è¯»ä¸€é<code>ã€ŠMySQL InnoDBå­˜å‚¨å¼•æ“ã€‹</code></li><li>äº§å‡ºåŸåˆ›æŠ€æœ¯åšå®¢<code>&gt;=18</code>ç¯‡</li><li>ç®€å•ç²—æš´ï¼Œ<code>&gt;=70%</code>çš„å¤©æ•°æœ‰ä»£ç æäº¤è®°å½•</li><li>å…¨å¹´è‡ªå­¦æ—¶é—´<code>&gt;=365h</code></li></ul></li><li>çˆ±å¥½ç¯‡<ul><li>ä¹°ä¸€å°å•å or å¾®å•</li><li>äº§å‡º<code>&gt;=50å¼ </code>è‡ªå·±æ»¡æ„çš„é™æ€ç…§ç‰‡</li><li>äº§å‡º<code>&gt;=3ä¸ª</code>è‡ªå·±æ»¡æ„çš„vlog</li><li>å»<code>&gt;=2ä¸ª</code>ä»æ¥æ²¡æœ‰å»è¿‡çš„åŸå¸‚æ—…æ¸¸</li><li>å­¦ä¼š<code>final cut pro</code>æˆ–è€…<code>pr</code>çš„ç®€å•æ“ä½œï¼Œå­¦ä¼šè‡ªå·±å‰ªç®€å•çš„è§†é¢‘</li></ul></li></ul><p>ç­‰åˆ°2019/12/31å†æ¥æŒ–åŸğŸ¤£ï¼Œçœ‹çœ‹èƒ½ç»™è‡ªå·±æ‰“å¤šå°‘åˆ†ï¼Œå¸Œæœ›èµ·ç åŠæ ¼ï¼ˆ60%ï¼‰å§ğŸ¤£ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç›®æ ‡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›®æ ‡ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Raft]Log Replicationç¬”è®°</title>
      <link href="/2018/12/17/raft-log-replication/"/>
      <url>/2018/12/17/raft-log-replication/</url>
      
        <content type="html"><![CDATA[<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><code>Raft</code>ä¸­çš„æ ¸å¿ƒæ­¥éª¤æ˜¯</p><ol><li>é€‰ä¸»</li><li>æ—¥å¿—å¤åˆ¶</li></ol><p>åœ¨ä¸Šä¸€ç¯‡<a href="http://marcoma.xyz/2018/12/09/raft-leader-election/" target="_blank" rel="noopener">ã€ŠRafté€‰ä¸»ç¬”è®°ã€‹</a>ä¸­ï¼Œç›¸ä¿¡å·²ç»æ¸…æ™°è¯´æ˜äº†<code>Raft</code>ä¸­é€‰ä¸»çš„å¤šä¸ªé™åˆ¶ã€‚é€šè¿‡ä¸€ç³»åˆ—ä¸¥æ ¼çš„ç­›é€‰åï¼Œè¢«é€‰å‡ºæ¥çš„<code>Raft Leader</code>å°±èƒ½æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè¿›è¡Œå„ç§æ•°æ®å¤„ç†ã€‚</p><p>åœ¨æœ¬ç¯‡ç¬”è®°ä¸­ï¼Œä¸»è¦æ‰“ç®—è®°å½•<strong>æ—¥å¿—å¤åˆ¶ï¼ˆLog Replicationï¼‰</strong>ä¸­çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚</p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>æ—¢ç„¶è¯´åˆ°äº†â€œæ—¥å¿—å¤åˆ¶â€ï¼Œé‚£ä¹ˆå…ˆæ¥çœ‹çœ‹å¤åˆ¶è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å„ç§æ•°æ®ç»“æ„ã€‚</p><p>åœ¨åŸºç¡€çš„<code>Raft</code>ä¸­ï¼Œåªæœ‰ä¸¤ç§RPCè¯·æ±‚ï¼š</p><ul><li><code>RequestVote RPC</code> â€”â€” ç”±Candidateä¸»åŠ¨å‘å‡ºï¼Œè¯·æ±‚å¤§å®¶è¿›è¡ŒæŠ•ç¥¨</li><li><code>AppendEntries RPC</code> â€”â€” ç”±Leaderä¸»åŠ¨å‘å‡ºï¼Œè¯·æ±‚Followersè¿›è¡Œæ—¥å¿—å¤åˆ¶</li></ul><p>æ ¹æ®<code>Raft</code>è®ºæ–‡é‡Œçš„åŸå›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹çš„æ•°æ®ç»“æ„ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RequestVote RPC</span></span><br><span class="line"><span class="keyword">type</span> RequestVote <span class="keyword">struct</span> &#123;</span><br><span class="line">TermId <span class="keyword">int64</span><span class="comment">// candidateçš„term id</span></span><br><span class="line">LeaderId <span class="keyword">int64</span><span class="comment">// candidateçš„leader id</span></span><br><span class="line">LastLogIndex <span class="keyword">int64</span><span class="comment">// candidateå­˜çš„æœ€åä¸€æ¡log entryçš„ä¸‹æ ‡</span></span><br><span class="line">LastLogTerm <span class="keyword">int64</span><span class="comment">// candidateå­˜çš„æœ€åä¸€æ¡log entryçš„term id</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AppendEntries RPC</span></span><br><span class="line"><span class="keyword">type</span> AppendEntries <span class="keyword">struct</span> &#123;</span><br><span class="line">TermId <span class="keyword">int64</span><span class="comment">// leaderçš„term id</span></span><br><span class="line">LeaderId <span class="keyword">int64</span><span class="comment">// leader id</span></span><br><span class="line">PrevLogIndex <span class="keyword">int64</span><span class="comment">// å½“å‰å‘é€entriesçš„å‰ä¸€æ¡entryçš„ä¸‹æ ‡</span></span><br><span class="line">PrevLogTerm <span class="keyword">int64</span><span class="comment">// å½“å‰å‘é€entriesçš„å‰ä¸€æ¡entryçš„term</span></span><br><span class="line">LastCommittedIndex <span class="keyword">int64</span><span class="comment">// leaderä¸Šæœ€åä¸€æ¡commitçš„entryçš„ä¸‹æ ‡</span></span><br><span class="line">Entries []LogEntry<span class="comment">// å½“å‰è¦å‘é€çš„1æˆ–Næ¡log entry</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸¤ç§RPCè¯·æ±‚å¤–ï¼Œæ¯å°serverï¼ˆæ— è®ºæ˜¯Leaderè¿˜æ˜¯Followerè¿˜æ˜¯Candidateï¼‰ä¸Šéƒ½è‚¯å®šè¦å­˜ä¸€äº›<strong>ç³»ç»Ÿå˜é‡</strong>ï¼Œç”¨æ¥è®°å½•è‡ªå·±æˆ–è€…ç³»ç»Ÿçš„çŠ¶æ€ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> ServerState <span class="keyword">struct</span> &#123;</span><br><span class="line">CurrentTerm <span class="keyword">int64</span><span class="comment">// æœ¬æœºä¸Šçš„å½“å‰term id</span></span><br><span class="line">VoteFor <span class="keyword">int64</span><span class="comment">// æœ¬è½®æŠ•ç¥¨æŠ•ç»™äº†è°ï¼ˆè¯¥æœºå™¨çš„idï¼‰</span></span><br><span class="line">LogEntries []LogEntry<span class="comment">// æœ¬æœºä¸Šå­˜çš„log entries</span></span><br><span class="line"></span><br><span class="line">LastCommittedIndex <span class="keyword">int64</span><span class="comment">// æœ¬æœºæœ€åä¸€æ¡commitçš„log entryçš„ä¸‹æ ‡</span></span><br><span class="line">LastAppliedIndex <span class="keyword">int64</span><span class="comment">// æœ¬æœºæœ€åä¸€æ¡è¢«çŠ¶æ€æœºæ‰§è¡Œçš„log entryçš„ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">NextIndex []<span class="keyword">int64</span><span class="comment">// *leaderç‰¹æœ‰ï¼Œä¸ºæ¯ä¸€å°followerç»´æŠ¤ä¸€ä¸ªä¸‹æ¬¡è¦å‘é€çš„log entryçš„ä¸‹æ ‡</span></span><br><span class="line">MatchIndex []<span class="keyword">int64</span><span class="comment">// *leaderç‰¹æœ‰ï¼Œä¸ºæ¯ä¸€å°followerç»´æŠ¤ä¸€ä¸ªå·²ç»æˆåŠŸåŒ¹é…ä¸Šçš„log entryçš„ä¸‹æ ‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Log-Replicationè¿‡ç¨‹"><a href="#Log-Replicationè¿‡ç¨‹" class="headerlink" title="Log Replicationè¿‡ç¨‹"></a>Log Replicationè¿‡ç¨‹</h2><ol><li><p>å½“é›†ç¾¤æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„å­˜å‚¨è¯·æ±‚</p><ul><li>å®¢æˆ·ç«¯å‘ç»™Followerï¼ŒFollowerè½¬å‘ç»™Leaderï¼Ÿæˆ–è€…å‘Šè¯‰å®¢æˆ·ç«¯è¯·å®ƒå‘ç»™Leaderï¼Ÿ</li><li>å®¢æˆ·ç«¯ç›´æ¥å‘ç»™Leaderï¼ŒLeaderæ¥æ”¶è¯·æ±‚</li></ul></li><li><p>Leaderè‡ªå·±å…ˆæŠŠè¯·æ±‚é‡Œçš„æ•°æ®è½ç›˜ï¼Œå­˜åœ¨æœ¬åœ°ï¼Œæ›´æ–°è‡ªèº«çš„meta data</p></li><li><p>Leaderå‘èµ·<code>AppendEntries RPC</code>ï¼Œè¯·æ±‚é›†ç¾¤ä¸­çš„å…¶ä»–Followerè¿›è¡Œæ—¥å¿—å¤åˆ¶</p></li><li><p>æ¯å°Followeréƒ½æ¥æ”¶åˆ°<code>AppendEntries RPC</code>ï¼Œæ£€æŸ¥RPCè¯·æ±‚é‡Œçš„å„é¡¹å‚æ•°ï¼Œä»¥ç¡®å®šæ˜¯å¦æ¥å—è¯¥è¯·æ±‚</p><ul><li><p>æ¯”è¾ƒ<code>AppendEntriesRPC.TermId</code>ä¸<code>Follower.CurrentTerm</code></p>  <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åªæœ‰å½“RPCè¯·æ±‚é‡Œçš„Term*ä¸å°äº*å½“å‰Followerçš„Termï¼Œæ‰èƒ½æ¥å—</span></span><br><span class="line"><span class="keyword">if</span> AppendEntriesRPC.TermId &lt; Follower.CurrentTerm &#123;</span><br><span class="line">IgnoreRPC()</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> AppendEntriesRPC.TermId &gt; Follower.CurrentTerm &#123;</span><br><span class="line">UpdateCurrentTerm()</span><br><span class="line">&#125;</span><br><span class="line">AcceptRPC()</span><br></pre></td></tr></table></figure></li><li><p>æ¯”è¾ƒå®ŒTermåï¼Œè‹¥æˆåŠŸæ¥å—ï¼Œåˆ™è¦å¤„ç†<code>PrevLogIndex</code>å’Œ<code>PrevLogTerm</code>äº†ã€‚ä¸ºä»€ä¹ˆè¦å¤„ç†è¿™ä¸¤ä¸ªå‚æ•°å‘¢ï¼Ÿ<strong>å› ä¸ºè¦é€šè¿‡å®ƒä»¬æ¥ä¿è¯ï¼šåœ¨æœ¬æ¬¡<code>AppendEntries</code>ä¹‹å‰çš„æ‰€æœ‰log entryéƒ½æ˜¯ä¸»ä»ä¹‹é—´æ­£ç¡®åŒæ­¥çš„ã€‚</strong></p>  <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">index := AppendEntriesRPC.PrevLogIndex</span><br><span class="line">term := AppendEntriesRPC.PrevLogTerm</span><br><span class="line"><span class="keyword">if</span> Follower.LogEntries[index].Term != term &#123;</span><br><span class="line">StopAndNotifyLeader()<span class="comment">// å‘ŠçŸ¥LeaderåŒæ–¹è¾¾æˆä¸€è‡´çš„ä½ç½®</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">AcceptLogEntries()<span class="comment">// å·²ç»è¾¾æˆä¸€è‡´ï¼Œæ¥å—æ‰€æœ‰log entry</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  å¯ä»¥çœ‹å‡ºï¼Œå½“Leaderçš„å†å²log entryå’ŒFollowerçš„å†å²log entryå‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œæ˜¯ä¸èƒ½è¿›è¡Œæ—¥å¿—å¤åˆ¶çš„ï¼Œ<strong>å®Œæˆä¸€æ¬¡æ—¥å¿—å¤åˆ¶çš„å‰ææ˜¯ï¼šåœ¨æœ¬æ¬¡æ—¥å¿—å¤åˆ¶ä¹‹å‰çš„æ‰€æœ‰log entryéƒ½å¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚</strong></p><p>  æ‰€ä»¥å½“å‘ç”Ÿäº†ä¸ä¸€è‡´æ—¶ï¼Œåº”è¯¥åœæ­¢æ—¥å¿—å¤åˆ¶ï¼Œå¹¶æŠŠæœ¬æœºä¸Šæœ€åä¸€ä¸ª<code>term == AppendEntriesRPC.PrevLogTerm</code>çš„log entry indexå‘ŠçŸ¥Leaderï¼Œå¥½è®©Leaderä¸‹æ¬¡é‡æ–°å‘èµ·<code>AppendEntriesRPC</code>æ—¶èƒ½å¤Ÿå®šä½åˆ°å¤§å®¶éƒ½å…±åŒä¸€è‡´çš„ä½ç½®ã€‚</p></li></ul></li><li><p>Leaderé‡æ–°å®šä½PrevLogIndexå’ŒPrevLogTermå / æˆ–è€…æ— éœ€è°ƒæ•´æœ¬èº«å°±æ˜¯ä¸€è‡´çš„æƒ…å†µä¸‹ï¼ŒFollowerå°±æ¥å—è¯¥<code>AppendEntriesRPC</code>ï¼ŒæŠŠ<code>AppendEntriesRPC.Entries</code>è½ç›˜åˆ°æœ¬æœºä¸Šï¼Œå›å¤Leaderå·²æˆåŠŸè½ç›˜</p></li><li><p>Leaderä¸ºæ¯ä¸ªFollowerç»´æŠ¤ä¸€äº›è½ç›˜æˆåŠŸä¸å¦çš„å˜é‡ï¼Œå½“Leaderé€šè¿‡Followerçš„å›å¤ç›‘æµ‹åˆ°æŸæ¡log entryå·²è¢«è¿‡åŠçš„Followerè½ç›˜ï¼Œå³å¯æ›´æ–°Leaderè‡ªèº«çš„<code>LastCommittedIndex</code>ï¼Œå¾…ä¸‹æ¬¡<code>AppendEntriesRPC</code>å‘é€æ—¶å‘Šè¯‰å„ä¸ªFollowerè¦commitå“ªä¸€æ¡log entry</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¾‹å¦‚å¯ä»¥ç”¨ä¸€ä¸ªmapç±»å®¹å™¨å®ç°è¿™ä¸ªé€»è¾‘</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">SERVER_COUNT = <span class="number">5</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> committedMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">int64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">followerId := AppendEntrisResponse.FollowerId</span><br><span class="line">savedLogIndices := AppendEntrisResponse.savedIndices</span><br><span class="line"><span class="keyword">for</span> _, savedIndex := <span class="keyword">range</span> savedLogIndices &#123;</span><br><span class="line">committedMap[savedIndex] += <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> committedMap[savedIndex] &gt;= SERVER_COUNT / <span class="number">2</span> &#123;</span><br><span class="line">Leader.LastCommittedIndex = savedIndex</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°NextIndexå’ŒMatchIndexæ•°ç»„</span></span><br><span class="line">Leader.NextIndex[followerId] = savedIndex + <span class="number">1</span></span><br><span class="line">Leader.MatchIndex[followerId] = savedIndex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¾…ä¸‹æ¬¡<code>AppendEntriesRPC</code>æ—¶ï¼ŒLeaderæŠŠæœ€æ–°çš„<code>LastCommittedIndex</code>å‘ŠçŸ¥Followerï¼ŒFollowerå°±å¯ä»¥åœ¨æœ¬åœ°çš„çŠ¶æ€æœºä¸Šæ‰§è¡Œ<code>LastCommittedIndex</code>ä¹‹å‰çš„log entryï¼Œç„¶åå›å¤Leaderå“ªäº›log entryå·²è¢«æˆåŠŸæ‰§è¡Œï¼ŒLeaderå¯¹åº”æ›´æ–°MatchIndexæ•°ç»„</p></li></ol><h2 id="NextIndex-amp-MatchIndex"><a href="#NextIndex-amp-MatchIndex" class="headerlink" title="NextIndex &amp; MatchIndex"></a>NextIndex &amp; MatchIndex</h2><p>åœ¨<code>ServerState</code>ä¸­å¤§éƒ¨åˆ†å˜é‡éƒ½å¾ˆå¥½ç†è§£ï¼Œåªæœ‰2ä¸ªå˜é‡â€”â€”<code>NextIndex</code>å’Œ<code>MatchIndex</code>æ˜¯æ¯”è¾ƒå¥‡æ€ªçš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯æ•°ç»„ç±»å‹çš„å˜é‡ï¼Œ<strong>è€Œä¸”æ˜¯Leaderç‰¹æœ‰çš„å˜é‡</strong>ã€‚</p><ul><li><code>NextIndex</code>ï¼šä¸ºæ¯ä¸ªFollowerè®°å½•äº†å°†è¦å‘ç»™è¯¥Followerçš„ä¸‹ä¸€æ¡log entryçš„indexï¼ˆåˆå§‹å€¼ä¸º<code>Leader.LastLogIndex + 1</code>ï¼‰</li><li><code>MatchIndex</code>ï¼šä¸ºæ¯ä¸ªFollowerè®°å½•äº†è¯¥Followerä¸Šå·²ç»æˆåŠŸåŒ¹é…çš„log entryçš„indexï¼ˆåˆå§‹å€¼ä¸º<code>0</code>ï¼‰</li></ul><p>ä¹ä¸€çœ‹ä¸Šå»ï¼Œæ­£å¸¸æƒ…å†µä¸‹<code>MatchIndex[i]</code>è²Œä¼¼ä¸€ç›´ç­‰äº<code>NextIndex[i] - 1</code>ã€‚ä½†æ€»æ˜¯ä¼šæœ‰ç‰¹æ®Šæƒ…å†µçš„ï¼Œå‡å¦‚æŸå°Followerçš„æœºå­åœ¨æŸä¸€æ—¶åˆ»å®•æœºäº†å‡ åç§’ï¼Œåœ¨è¿™å‡ åç§’é‡Œä¹Ÿç»å†äº†Leaderçš„æ›´è¿­ï¼Œé‚£ä¹ˆ<code>MatchIndex[i]</code>å°±å¾ˆæœ‰å¯èƒ½ä¸ç­‰äº<code>NextIndex[i] - 1</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒLeaderè¦å…ˆæ ¹æ®<code>MatchIndex[i]</code>ç¡®å®šæœ€åä¸€ä¸ªæ­£ç¡®åŒæ­¥çš„ä½ç½®ï¼Œç„¶åé‡æ–°è®¾ç½®<code>NextIndex[i] = MatchIndex[i] + 1</code>ï¼Œé‡æ–°è¿›è¡Œå†å²log entryçš„åŒæ­¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Raft]Leader Election(é€‰ä¸»)ç¬”è®°</title>
      <link href="/2018/12/09/raft-leader-election/"/>
      <url>/2018/12/09/raft-leader-election/</url>
      
        <content type="html"><![CDATA[<ol><li><p>Rafté‡‡ç”¨Leader - Followerçš„æ¶æ„ï¼Œä¸»è¦çš„å·¥ä½œéƒ½ç”±Leaderæ¥ä¸»åŠ¨è°ƒåº¦å’Œå®Œæˆï¼Œæ‰€ä»¥é€‰å‡ºä¸€ä¸ªåˆæ³•çš„Leaderæ˜¯é¦–è¦ä»»åŠ¡ã€‚</p></li><li><p>ä¸ºäº†ä¿è¯ä¸ä¸¢æ•°æ®ï¼ˆ<strong>ç‰¹æŒ‡å·²ç»commitä¸”æˆåŠŸé€šçŸ¥clientçš„æ•°æ®</strong>ï¼‰ï¼ŒRaftå¯¹Leaderæœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼Œä¸æ˜¯é›†ç¾¤é‡Œéšä¾¿ä¸€å°æœåŠ¡å™¨éƒ½èƒ½å¤Ÿå½“ä¸ŠLeaderï¼Œè¿™ç§â€œä¸¥æ ¼çš„è¦æ±‚â€å¤§å¤šä½“ç°åœ¨é€‰ä¸»è¿‡ç¨‹ä¸­ã€‚</p></li><li><p>é€‰ä¸»è¿‡ç¨‹æœ€é‡è¦çš„é™åˆ¶æ˜¯ï¼š</p><p><strong><em>Leaderå¿…é¡»å­˜æœ‰æ‰€æœ‰å·²ç»commitè¿‡çš„log entryï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚</em></strong></p><p><strong>åœ¨å¤–éƒ¨ç”¨æˆ·çœ‹æ¥ï¼Œå·²ç»commitæˆåŠŸçš„å°±å¿…ç„¶æ˜¯100%æ­£å¸¸å­˜å‚¨å¥½äº†çš„ã€‚</strong>å¦‚æœé€‰å‡ºä¸€ä¸ªLeaderï¼Œç»“æœå®ƒä¸Šé¢ç¼ºäº†å‡ æ¡å·²ç»commitè¿‡çš„æ•°æ®ï¼Œé‚£è¿™ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†ã€‚å‡ åˆ†é’Ÿå‰è·Ÿç”¨æˆ·è¯´â€œæˆ‘å·²ç»commitäº†ï¼Œä½ æ”¾å¿ƒå§â€ï¼Œè¿‡ä¸€ä¼šç”¨æˆ·æƒ³æŸ¥ä¸€æŸ¥æ•°æ®å´å‘ç°â€œå°¼ç›ï¼Œæ€ä¹ˆä¸¢æ•°æ®äº†ï¼Œè¯´å¥½çš„å·²ç»commitäº†å‘¢ï¼Ÿï¼â€</p></li><li><p>ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼ˆLeaderä¸Šå¿…é¡»å­˜æœ‰æ‰€æœ‰å·²ç»commitè¿‡çš„æ•°æ®ï¼‰ï¼ŒRaftä¸­æå‡ºäº†ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ï¼Œ<strong>å¦‚æœä¸¥æ ¼éµå®ˆä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼Œæ˜¯èƒ½ä¿è¯é€‰å‡ºåˆæ³•Leaderçš„</strong>ã€‚</p><ul><li>åœ¨é€‰ä¸»è¿‡ç¨‹ä¸­ï¼Œæ¯å°æœåŠ¡å™¨åªä¼šæŠ•ç¥¨ç»™æ‹¥æœ‰æ¯”è‡ªå·±æ›´æ–°çš„log entryçš„æœåŠ¡å™¨ã€‚</li><li>Leaderåœ¨commit log entryçš„æ—¶å€™ï¼Œåªå…è®¸<strong>ç›´æ¥</strong>commitå½“å‰termï¼ˆä»»æœŸï¼‰çš„log entryï¼Œå†³ä¸å…è®¸<strong>ç›´æ¥</strong>commitâ€œå†å²â€log entryã€‚ï¼ˆå†å²log entryåªèƒ½<strong>é—´æ¥è¢«åŠ¨</strong>commitï¼‰</li></ul><p>ï¼ˆ1ï¼‰å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼šæ¯å°serveråªä¼šæŠ•ç¥¨ç»™æ‹¥æœ‰æ¯”è‡ªå·±æ›´æ–°çš„log entryçš„serverã€‚è¿™å¥è¯é‡Œæœ€å…³é”®çš„æ˜¯å¦‚ä½•å®šä¹‰<strong>â€œæ›´æ–°çš„log entryâ€</strong>ã€‚æŒ‰ç…§Raftè®ºæ–‡é‡Œç»™å‡ºçš„å®šä¹‰ï¼š</p><blockquote><p>Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs. If the logs have last entries with different terms, then the log with the later term is more up-to-date. If the logs end with the same term, then whichever log is longer is more up-to-date.</p></blockquote><ul><li>ä¸¤å°æœåŠ¡å™¨ä¸Šçš„<strong>æœ€åä¸€æ¡</strong>log entryï¼Œå¦‚æœå®ƒä»¬çš„termä¸åŒï¼Œåˆ™termæ›´å¤§è€…æ˜¯â€œæ›´æ–°â€çš„ã€‚</li><li>ä¸¤å°æœåŠ¡å™¨ä¸Šçš„<strong>æœ€åä¸€æ¡</strong>log entryï¼Œå¦‚æœå®ƒä»¬çš„termç›¸åŒï¼Œåˆ™indexæ›´å¤§è€…æ˜¯â€œæ›´æ–°â€çš„ã€‚</li></ul><p>ï¼ˆè¿™é‡Œæˆ‘è§‰å¾—è®ºæ–‡é‡Œæ¼äº†ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå¦‚æœä¸¤æ¡log entryçš„termå’Œindexéƒ½ç›¸åŒï¼Œ<strong>åº”è¯¥ä¼šé»˜è®¤æŠŠå‘èµ·æŠ•ç¥¨çš„æœåŠ¡å™¨å½“æˆæ›´æ–°çš„</strong>ï¼Œtermå’Œindexéƒ½ä¸€æ ·çš„æƒ…å†µä¸‹ä¸å­˜åœ¨æ‰€è°“çš„â€œæ›´æ–°â€ï¼Œä¸€åˆ‡ä¸ºäº†é€‰ä¸»çš„é¡ºåˆ©è¿›è¡Œï¼Œèƒ½å¿«é€Ÿæœ‰æ•ˆé€‰å‡ºleaderæ‰æ˜¯æœ€é‡è¦çš„ã€‚ï¼‰ </p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/raft_latest_1.png" alt=""> </p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®Raftçš„åˆ¤æ–­æ ‡å‡†ï¼Œ<strong>ä¸‹è€…çš„è®°å½•æ¯”ä¸Šè€…æ›´æ–°ï¼Œå› ä¸ºä¸‹è€…æœ€åä¸€æ¡log entryçš„termä¸º5ï¼Œ5æ¯”4å¤§</strong>ã€‚ </p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/raft_latest_2.png" alt=""> </p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®Raftçš„åˆ¤æ–­æ ‡å‡†ï¼Œ<strong>ä¸Šè€…çš„è®°å½•æ¯”ä¸Šè€…æ›´æ–°ï¼Œå› ä¸ºä¸Šè€…æœ€åä¸€æ¡log entryçš„indexä¸º4ï¼Œä¸‹è€…æœ€åä¸€æ¡log entryçš„indexä¸º3ï¼Œ4æ¯”3å¤§</strong>ã€‚ </p><p>ï¼ˆ2ï¼‰å†ç ”ç©¶ç¬¬äºŒä¸ªæ¡ä»¶ï¼šLeaderåªå…è®¸<strong>ç›´æ¥</strong>commitå½“å‰termï¼ˆä»»æœŸï¼‰çš„log entryï¼Œå†³ä¸å…è®¸<strong>ç›´æ¥</strong>commitâ€œå†å²â€log entryã€‚è¿™æ¡å‰æä¸€çœ‹ä¸Šå»æœ‰ç‚¹äº‘é‡Œé›¾é‡Œçš„ï¼Œæ„Ÿè§‰å¹¶æ²¡æœ‰ä»€ä¹ˆå¿…è¦æ€§ã€‚<strong>å®åˆ™ä¸ç„¶ï¼Œè¿™æ¡å‰æéå¸¸é‡è¦ï¼Œæ˜¯ç”¨æ¥é¿å…å¼‚å¸¸æƒ…å†µä¸‹é¢‘ç¹æ¢Leaderå¯èƒ½é€ æˆçš„commited log entryè¢«è¦†ç›–çš„é—®é¢˜ã€‚</strong> </p><p>RaftåŸç‰ˆè®ºæ–‡é‡Œä¹Ÿç»™å‡ºäº†ä¸€ä¸ªç»å…¸åœºæ™¯ï¼š </p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/raft_election.png" alt=""></p><ul><li>åœ¨(a)é˜¶æ®µï¼Œå·²ç»å¤„äº<code>term:2</code>äº†ï¼Œ<code>S1</code>æ˜¯æœ¬è½®ï¼ˆ<code>term:2</code>ï¼‰çš„leaderã€‚åœ¨<code>S1</code>ä¸Šä»»åæ²¡å¤šä¹…ï¼Œæ”¶åˆ°äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå†™å…¥ä¸€æ¡<code>{term:2, index:2}</code>çš„logï¼Œå¹¶å°†æ­¤logæˆåŠŸå¤åˆ¶åˆ°<code>S2</code>è¿™ä¸ªå°å…„å¼Ÿä¸Šã€‚<strong>ç»“æœå¤©ä¸å¦‚äººæ„¿ï¼Œè¿˜æ²¡æ¥å¾—åŠæŠŠlogå¤åˆ¶åˆ°å…¶ä»–å°å…„å¼Ÿä¸Šï¼Œ<code>S1</code>è‡ªå·±å°±å®•æœºäº†ã€‚</strong></li><li>åˆ°äº†(b)é˜¶æ®µï¼Œ<code>S1</code>å®•æœºåï¼Œæ•´ä¸ªé›†ç¾¤å¤„äºæ— é¢†å¯¼çŠ¶æ€ã€‚ç»è¿‡äº†ä¸€å°ä¼šï¼Œ<code>S5</code>å¾ˆå¹¸è¿ç‡å…ˆç»“æŸtimeoutï¼Œè‡ªå¢termå·ï¼ˆä»<code>term:2</code>è‡ªå¢åˆ°<code>term:3</code>ï¼‰ï¼Œå‘èµ·äº†é€‰ä¸»ã€‚ç”±äºæ­¤æ—¶<code>S3</code>å’Œ<code>S4</code>ä¸Šçš„è®°å½•éƒ½å’Œ<code>S5</code>ä¸€æ ·æ–°ï¼Œæ‰€ä»¥éƒ½æ„¿æ„æŠ•ç¥¨ç»™<code>S5</code>ï¼Œ<code>S5</code>æˆåŠŸå½“é€‰ï¼Œæˆä¸ºleaderã€‚<code>S5</code>æˆä¸ºleaderåé©¬ä¸Šåˆæ”¶åˆ°äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œäºæ˜¯åœ¨æœ¬æœºä¸Šå†™å…¥ä¸€æ¡<code>{term:3, index:2}</code>çš„logã€‚<strong>ç„¶è€Œ<code>S5</code>çš„å‘½è¿æ¯”<code>S1</code>æ›´æƒ¨ï¼Œåªæ¥å¾—åŠå­˜åœ¨æœ¬åœ°ï¼Œæ¥ä¸åŠæŠŠlog entryå¤åˆ¶ç»™ä»»ä½•ä¸€ä¸ªå°å…„å¼Ÿï¼Œç›´æ¥å°±æŒ‚äº†ã€‚</strong></li><li>æ­¤æ—¶æ¥åˆ°äº†(c)çŠ¶æ€ï¼Œ<code>S5</code>æŒ‚äº†ä¹‹åï¼Œ<code>S1</code>æˆåŠŸé‡å¯æ¢å¤è¿è½¬ã€‚<code>S1</code>è‡ªå‘Šå¥‹å‹‡ï¼Œè‡ªå¢å…¨å±€termå·ï¼ˆä»<code>term:3</code>è‡ªå¢åˆ°<code>term:4</code>ï¼‰ï¼Œè¯·æ±‚å¤§å®¶é€‰ä¸»ã€‚<code>S2 ~ S4</code>éƒ½ä¼šæŠ•ç»™<code>S1</code>ï¼Œ<code>S1</code>é¡ºåˆ©å½“é€‰leaderã€‚<code>S1</code>æˆäº†leaderååšäº†ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå‘ç°ä¹‹å‰<code>{term:2, index:2}</code>çš„logè¿˜æ²¡æœ‰æˆåŠŸå¤åˆ¶ç»™å¤§éƒ¨åˆ†å…„å¼Ÿï¼Œäºæ˜¯å¼€å§‹å¤åˆ¶å·¥ä½œï¼ŒæŠŠlogå¤åˆ¶åˆ°äº†<code>S3</code>ä¸Šã€‚çªç„¶<code>S1</code>åˆæ”¶åˆ°äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå†™å…¥ä¸€æ¡<code>{term:4, index:3}</code>çš„logåˆ°æœ¬æœºã€‚</li></ul><p>ä»¥ä¸Š3æ­¥éƒ½éå¸¸ç†æ‰€å½“ç„¶ï¼Œæ²¡æœ‰ä»»ä½•çš„äº‰è®®ç‚¹ï¼Œæœ€å¤§çš„äº‰è®®ç‚¹å°±å‡ºç°åœ¨äº†(d)å’Œ(e)ä¸Šã€‚<strong>(d)å’Œ(e)å®é™…ä¸Šæ˜¯(c)å‘ç”Ÿä¹‹åçš„ä¸¤ç§äº’æ–¥çš„å¯èƒ½æƒ…å†µï¼Œ(d)æ˜¯å¿½è§†ç¬¬äºŒæ¡å‰æä¼šå‘ç”Ÿçš„æƒ…å†µï¼Œ(e)æ˜¯æ»¡è¶³ç¬¬äºŒæ¡å‰æä¼šå‘ç”Ÿçš„æƒ…å†µã€‚</strong></p><ul><li>å…ˆçœ‹(d)ã€‚<strong>å‡è®¾æˆ‘ä»¬å¿½ç•¥ç¬¬äºŒæ¡å‰æï¼Œä¹Ÿå°±æ˜¯è¯´leaderå¯ä»¥éšæ„commitä»»ä½•termçš„log entryã€‚</strong>é‚£ä¹ˆåœ¨(c)ç»“æŸä¹‹åï¼Œä½œä¸º<code>term:4</code>çš„leaderçš„<code>S1</code><strong>å¯ä»¥commitæ‰<code>{term:2, index:2}</code>çš„logï¼Œå¹¶ä¸”æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</strong>ç»“æœåˆšå®Œæˆä»¥ä¸Šæ­¥éª¤ï¼Œ<code>S1</code>åˆå€’éœ‰åœ°å®•æœºäº†ï¼Œ<code>{term:4, index:3}</code>çš„logæ²¡æ¥å¾—åŠå¤åˆ¶ç»™ä»»ä½•ä¸€ä¸ªå°å…„å¼Ÿã€‚è¿‡äº†ä¸€ä¼šï¼Œ<code>S5</code>æ¢å¤æ­£å¸¸ï¼Œè‡ªå¢å…¨å±€termå·ï¼ˆä»<code>term:4</code>è‡ªå¢åˆ°<code>term:5</code>ï¼‰ï¼Œè¦æ±‚é€‰ä¸»ã€‚ç”±äºæ­¤æ—¶<code>S5</code>ä¸Šçš„æœ€åä¸€æ¡logæ˜¯<code>{term:3, index:2}</code>ï¼Œæ¯”<code>S2 ~ S4</code>çš„éƒ½æ›´æ–°ï¼Œå¤§å®¶éƒ½ä¼šæŠ•ç¥¨ç»™<code>S5</code>ï¼Œ<code>S5</code>æˆåŠŸå½“ä¸Š<code>term:5</code>çš„leaderã€‚å½“ä¸Šleaderåï¼Œ<code>S5</code>çš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŠŠå®ƒè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶ç»™å¤šä¸ªå°å…„å¼Ÿçš„logå¤åˆ¶å‡ºå»ï¼Œæ‰€ä»¥å°±é€ æˆäº†(d)çŠ¶æ€ï¼Œæ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„logè®°å½•éƒ½è¢«<code>S5</code>è‡ªå·±çš„logè®°å½•è¦†ç›–äº†ã€‚<strong>ä¹‹å‰å·²ç»æˆåŠŸcommitçš„<code>{term:2, index:2}</code>çš„logç›´æ¥è¢«è¦†ç›–ï¼Œæ¶ˆå¤±æ— è¸ªâš ï¸ï¼</strong></li><li>å†çœ‹(e)ã€‚<strong>å‡è®¾æˆ‘ä»¬ä¸€å®šè¦åšå®ˆç¬¬äºŒæ¡å‰æï¼Œä¹Ÿå°±æ˜¯è¯´leaderåªèƒ½ç›´æ¥commitå½“å‰termçš„log entryï¼Œä¸èƒ½ç›´æ¥commitå†å²log entryã€‚</strong>é‚£ä¹ˆåœ¨(c)ç»“æŸåï¼Œ<code>S1</code>ä¹Ÿä¸èƒ½commit<code>{term:2, index:2}</code>çš„logï¼Œå› ä¸º<code>S1</code>æ­¤æ—¶æ˜¯<code>term:4</code>çš„leaderï¼Œè€Œä¸æ˜¯<code>term:2</code>çš„leaderã€‚åªæœ‰å¦‚(e)æ‰€ç¤ºï¼Œä¹‹å<code>S1</code>æœ‰æœºä¼šcommitå±äºå½“å‰termçš„log entryï¼ˆ<code>{term:4, index:3}</code>ï¼‰æ—¶ï¼Œæ‰æœ‰æœºä¼š<strong>é—´æ¥åœ°</strong>æŠŠä¹‹å‰<code>term:2</code>çš„å†å²è®°å½•ä¹Ÿcommitæ‰ã€‚å³ä½¿æ­¤æ—¶<code>S1</code>å®•æœºï¼Œ<code>S5</code>ä¹Ÿç»å¯¹ä¸å¯èƒ½é€‰ä¸Šä¸‹ä¸€è½®çš„leaderï¼Œå› ä¸º<code>S5</code>ä¸Šæœ€æ–°çš„log<code>{term:3, index:2}</code>å·²ç»ä¸å¦‚<code>S1 ~ S3</code>çš„æ–°äº†ï¼Œä»–æ‹¿ä¸åˆ°è¿‡åŠçš„é€‰ç¥¨ï¼Œåšä¸äº†leaderï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿå·²ç»commitçš„è®°å½•è¢«è¦†ç›–çš„é”™è¯¯äº†ã€‚</li></ul><p>ç»è¿‡è¿™ä¸€è½®ä¾‹å­åˆ†æï¼Œå¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ°ç¬¬äºŒæ¡å‰æçš„é‡è¦æ€§äº†ã€‚å¦‚æœå…è®¸leaderéšä¾¿ç›´æ¥commitå†å²è®°å½•çš„è¯ï¼Œæç«¯æƒ…å†µä¸‹å¾ˆå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±çš„ç³»ç»Ÿé”™è¯¯ï¼ˆå®¢æˆ·ç«¯çŸ¥é“ä½ commitæˆåŠŸäº†ï¼Œä»–å°±åº”è¯¥èƒ½æ”¾å¿ƒäº†ï¼Œç»“æœè¿‡äº†ä¸€ä¼šä½ è·Ÿå®¢æˆ·è¯´commitä¹Ÿä¸ç®—æ•°ï¼Œæˆ‘æä¸¢äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ï¼‰<strong>æ‰€ä»¥ï¼Œå¯¹äºå†å²è®°å½•çš„commitåªèƒ½è¢«åŠ¨è§¦å‘ï¼ï¼ï¼åœ¨commitå½“å‰termçš„log entryæ—¶é¡ºä¾¿æŠŠä¹‹å‰æœªå¤„ç†çš„log entryç»™commitæ‰ã€‚</strong></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ </category>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]groupcacheé¡¹ç›®è§£æâ€”â€”Part2</title>
      <link href="/2018/12/06/groupcache-part2/"/>
      <url>/2018/12/06/groupcache-part2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/12/05ï¼ŒåŸºäº<code>Go 1.11</code>ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>æœ¬æ–‡æ˜¯ã€ŠGroupCacheé¡¹ç›®è§£æã€‹ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œåœ¨ä¸Šä¸€ç¯‡(<a href="http://www.marcoma.xyz/index.php/2018/11/30/groupcache_part1/" target="_blank" rel="noopener">[Golang]groupcacheé¡¹ç›®è§£æâ€”â€”Part1</a>)ä¸­å·²ç»å¯¹<code>GroupCache</code>çš„èƒŒæ™¯ã€æ¶æ„ã€ä»£ç ç»“æ„ä½œäº†ä»‹ç»ï¼Œä¹Ÿæä¾›äº†ä¸€ä¸ªç®€å•çš„ç”¨ä¾‹ã€‚ç°åœ¨æ¥åˆ°äº†ç¬¬äºŒç¯‡ï¼Œä¸»è¦æ˜¯å¯¹<code>GroupCache</code>ä¸­çš„å‡ ä¸ªè¾…åŠ©æ€§çš„æ¨¡å—ä½œè¯¦ç»†çš„è®²è§£ä¸åˆ†æï¼Œå…¶ä¸­åŒ…æ‹¬</p><ul><li>Consistent Hashæ¨¡å—</li><li>LRUæ¨¡å—</li><li>SingleFlightæ¨¡å—</li></ul><h4 id="Consistent-Hashï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰"><a href="#Consistent-Hashï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰" class="headerlink" title="Consistent Hashï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰"></a>Consistent Hashï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰</h4><p>æ‰€è°“çš„<code>ä¸€è‡´æ€§å“ˆå¸Œ</code>ï¼Œæ ¹æœ¬ç›®çš„å°±æ˜¯å°†æ•°æ®æ‰“æ•£ï¼Œå‡åŒ€åœ°åˆ†å¸ƒåˆ°é›†ç¾¤ä¸Šå¤šä¸ªä¸åŒçš„èŠ‚ç‚¹ã€‚å®ƒå’Œæ™®é€šå“ˆå¸Œæœ€ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œ<strong>é™¤äº†æ•°æ®å¤–ï¼Œå®ƒæŠŠèŠ‚ç‚¹æœ¬èº«ï¼ˆipåœ°å€æˆ–è€…èŠ‚ç‚¹idï¼‰ä¹Ÿè¿›è¡Œäº†å“ˆå¸Œï¼Œæ”¾åˆ°å’Œæ•°æ®åŒä¸€ä¸ªå“ˆå¸Œç©ºé—´å†…ã€‚</strong>ï¼ˆå…·ä½“å¯å‚è€ƒæœ¬äººä¹‹å‰çš„æ–‡ç« <a href="http://www.marcoma.xyz/index.php/2018/03/17/consistent_hash/" target="_blank" rel="noopener">ã€Šä¸€è‡´æ€§Hashç®—æ³•â€”â€”åˆ†æä¸æ¨¡æ‹Ÿã€‹</a>ï¼‰</p><p>æ¥ä¸‹æ¥çœ‹çœ‹<code>groupcache</code>é‡Œé¢çš„å…·ä½“ä»£ç ã€‚</p><p>å…ˆçœ‹æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Hashå°±æ˜¯ä¸€ä¸ªè¿”å›unit32çš„å“ˆå¸Œæ–¹æ³•</span></span><br><span class="line"><span class="keyword">type</span> Hash <span class="function"><span class="keyword">func</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">uint32</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Map</span>å°±æ˜¯ä¸€è‡´æ€§å“ˆå¸Œçš„é«˜çº§å°è£…</span></span><br><span class="line"><span class="function"><span class="title">type</span> <span class="title">Map</span> <span class="title">struct</span></span> &#123;</span><br><span class="line">hash     Hash<span class="comment">// å“ˆå¸Œç®—æ³•</span></span><br><span class="line">replicas <span class="keyword">int</span><span class="comment">// replicaå‚æ•°ï¼Œè¡¨æ˜äº†ä¸€ä»½æ•°æ®è¦å†—ä½™å­˜å‚¨å¤šå°‘ä»½</span></span><br><span class="line">keys     []<span class="keyword">int</span><span class="comment">// å­˜å‚¨hashå€¼ï¼ŒæŒ‰hashå€¼å‡åºæ’åˆ—ï¼ˆæ¨¡æ‹Ÿä¸€è‡´æ€§å“ˆå¸Œç¯ç©ºé—´ï¼‰</span></span><br><span class="line">hashMap  <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span><span class="comment">// è®°å½•hashå€¼ -&gt; èŠ‚ç‚¹ipåœ°å€çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹çœ‹å·¥å‚æ–¹æ³•ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œçš„å·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(replicas <span class="keyword">int</span>, fn Hash)</span> *<span class="title">Map</span></span> &#123;</span><br><span class="line">m := &amp;Map&#123;</span><br><span class="line">replicas: replicas,</span><br><span class="line">hash:     fn,</span><br><span class="line">hashMap:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> m.hash == <span class="literal">nil</span> &#123;</span><br><span class="line">m.hash = crc32.ChecksumIEEE<span class="comment">// ä¸æŒ‡å®šè‡ªå®šä¹‰Hashæ–¹æ³•çš„è¯ï¼Œé»˜è®¤ç”¨ChecksumIEEE</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååˆ†ææœ€å…³é”®çš„<code>Add</code>å’Œ<code>Get</code>æ–¹æ³•ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Addæ–¹æ³•ï¼Œå‚æ•°ä¸º...stringï¼Œä¸€èˆ¬å°±æ˜¯å¤šä¸ªèŠ‚ç‚¹çš„ipåœ°å€ï¼ˆæˆ–è€…èŠ‚ç‚¹idï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Add</span><span class="params">(keys ...<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line"><span class="comment">// æ¯ä¸€ä¸ªkeyéƒ½ä¼šå†—ä½™å¤šä»½ï¼ˆæ¯ä»½å†—ä½™å°±æ˜¯ä¸€è‡´æ€§å“ˆå¸Œé‡Œçš„è™šæ‹ŸèŠ‚ç‚¹ v-nodeï¼‰</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; m.replicas; i++ &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å…ˆç®—å‡ºå½“å‰å†—ä½™çš„hashå€¼</span></span><br><span class="line"><span class="comment">// 2. æŠŠhashå€¼å¡è¿›å“ˆå¸Œç¯é‡Œ</span></span><br><span class="line"><span class="comment">// 3. è®°å½•ä¸‹hashå€¼ -&gt; èŠ‚ç‚¹ipåœ°å€çš„æ˜ å°„ï¼Œä¹‹åå¯ä»¥å‡­å€Ÿhashå€¼æ‰¾åˆ°å…·ä½“æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">hash := <span class="keyword">int</span>(m.hash([]<span class="keyword">byte</span>(strconv.Itoa(i) + key)))</span><br><span class="line">m.keys = <span class="built_in">append</span>(m.keys, hash) </span><br><span class="line">m.hashMap[hash] = key</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">sort.Ints(m.keys)<span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œè¦æ±‚å“ˆå¸Œç¯æ˜¯å‡åºçš„ï¼Œæœ€åæ‰§è¡Œä¸€æ¬¡æ’åºæ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Getæ–¹æ³•ï¼Œè¾“å…¥ä¸€ä¸ªkeyï¼Œæ‰¾åˆ°è¯¥keyåº”è¯¥å­˜äºå“ªä¸ªèŠ‚ç‚¹ï¼Œè¿”å›è¯¥èŠ‚ç‚¹çš„åœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> m.IsEmpty() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. ç®—å‡ºkeyçš„hashå€¼</span></span><br><span class="line"><span class="comment">// 2. äºŒåˆ†æŸ¥æ‰¾å¤§äºç­‰äºè¯¥keyçš„ç¬¬ä¸€ä¸ªhashå€¼çš„ä¸‹æ ‡ï¼ˆå“ˆå¸Œç¯æ˜¯å‡åºæœ‰åºçš„ï¼Œæ‰€ä»¥å¯ä»¥äºŒåˆ†æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">hash := <span class="keyword">int</span>(m.hash([]<span class="keyword">byte</span>(key)))</span><br><span class="line">idx := sort.Search(<span class="built_in">len</span>(m.keys), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> m.keys[i] &gt;= hash &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹æ ‡è¶Šç•Œï¼Œå¾ªç¯æ‰¾åˆ°åˆ°0å·ä¸‹æ ‡</span></span><br><span class="line"><span class="keyword">if</span> idx == <span class="built_in">len</span>(m.keys) &#123;</span><br><span class="line">idx = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡æŸ¥è¯¢è®°å½•äº†hash -&gt; èŠ‚ç‚¹åœ°å€çš„hashMapï¼Œå¾—åˆ°èŠ‚ç‚¹åœ°å€ï¼Œè¿”å›</span></span><br><span class="line"><span class="keyword">return</span> m.hashMap[m.keys[idx]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<code>groupcache</code>ä¸­çš„ä¸€è‡´æ€§å“ˆå¸Œéå¸¸ç®€å•æ¸…æ™°ã€‚åœ¨<code>groupcache</code>é‡Œç”¨åˆ°ä¸€è‡´æ€§å“ˆå¸Œçš„åœ°æ–¹ï¼Œå°±æ˜¯å¤šèŠ‚ç‚¹éƒ¨ç½²æ—¶ï¼Œè¦æŠŠå¤šä¸ªèŠ‚ç‚¹åœ°å€ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®¡ç†èµ·æ¥ï¼Œä»è€Œè®©ç¼“å­˜æ•°æ®èƒ½å¤Ÿå‡åŒ€åˆ†æ•£ï¼Œé™ä½å•å°æœåŠ¡å™¨çš„å‹åŠ›ã€‚</p><p><strong>ä½†æ˜¯è¿™é‡Œå®ç°çš„ä¸€è‡´æ€§å“ˆå¸Œè¿˜æ¯”è¾ƒç²—ç³™ï¼Œæ²¡æœ‰å®ç°åŠ¨æ€åˆ é™¤èŠ‚ç‚¹ï¼Œè¿˜ä¸æ”¯æŒèŠ‚ç‚¹å®•æœºåè‡ªåŠ¨æ•°æ®è¿ç§»ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½æ˜¯ä¸€è‡´æ€§å“ˆå¸Œçš„å¦ä¸€å¤§ç²¾é«“ã€‚ï¼ˆæ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼‰</strong></p><h4 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h4><p>ç¬¬äºŒä¸ªæ¨¡å—æˆ‘ä»¬æ¥ç ”ç©¶ä¸‹<code>LRU</code>ã€‚æ‰€è°“<code>LRU</code>å…¶å®å°±æ˜¯æ“ä½œç³»ç»Ÿé‡Œé‚£ä¸ªå†…å­˜é¡µç®¡ç†çš„ç»å…¸ç®—æ³•â€”â€”æœ€è¿‘æœ€å°‘è¢«ä½¿ç”¨ï¼ˆLeast Recently Used Algorithmï¼‰ã€‚<strong>å…¶å®é™¤äº†æ“ä½œç³»ç»Ÿåº•å±‚ï¼Œå¾ˆå¤šæ•°æ®åº“æˆ–è€…ç¼“å­˜äº§å“é‡Œéƒ½å®ç°äº†<code>LRU</code>ï¼Œä¾‹å¦‚<code>Innodb</code>å­˜å‚¨å¼•æ“çš„<code>buffer pool</code>é‡Œçš„LRU Listå°±æ˜¯ä¸€ä¸ªå…³é”®æ•°æ®ç»“æ„ã€‚</strong></p><p><code>LRU</code>çš„æ€æƒ³éå¸¸æœ´ç´ ï¼ŒåŸºæœ¬éƒ½æ˜¯åŸºäºä¸€æ¡åŒå‘é“¾è¡¨ï¼Œæ— éå°±æ˜¯çƒ­é—¨çš„ã€ç»å¸¸è¢«è®¿é—®çš„æ•°æ®å°±æ”¾åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œä¹…è€Œä¹…ä¹‹å†·é—¨æ•°æ®å°±ä¼šè¢«â€œæ’æŒ¤â€åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œå½“å†…å­˜ä¸å¤Ÿæ—¶æŠŠå°¾éƒ¨çš„æ•°æ®ç§»é™¤ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´æ¥å­˜æ–°çš„æ•°æ®ã€‚</p><p>åœ¨<code>groupcache</code>é‡Œï¼Œ<code>LRU</code>ç”¨æ¥å­˜æœ€åº•å±‚çš„K-Væ•°æ®ï¼Œå…ˆæ¥çœ‹çœ‹æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Keyæ˜¯ä»»æ„å¯æ¯”è¾ƒï¼ˆComparableï¼‰ç±»å‹</span></span><br><span class="line"><span class="keyword">type</span> Key <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// entryæ˜¯ä¸€ä¸ªK-Vå¯¹ï¼Œvalueä¹Ÿæ˜¯ä»»æ„ç±»å‹ï¼ˆä¸å¿…Comparableï¼‰</span></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">key   Key</span><br><span class="line">value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LRUçš„é«˜å±‚å°è£…ï¼ˆéå¹¶å‘å®‰å…¨ï¼ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">MaxEntries <span class="keyword">int</span><span class="comment">// æœ€å¤šå…è®¸å­˜å¤šå°‘ä¸ªK-V entry</span></span><br><span class="line">OnEvicted <span class="function"><span class="keyword">func</span><span class="params">(key Key, value <span class="keyword">interface</span>&#123;&#125;)</span>// å›è°ƒå‡½æ•°ï¼Œå½“ä¸€ä¸ª<span class="title">entry</span>è¢«ç§»é™¤åå›è°ƒ</span></span><br><span class="line"><span class="function"><span class="title">ll</span>    *<span class="title">list</span>.<span class="title">List</span>// <span class="title">LRU</span>é“¾è¡¨</span></span><br><span class="line"><span class="function"><span class="title">cache</span> <span class="title">map</span>[<span class="title">interface</span></span>&#123;&#125;]*list.Element<span class="comment">// è®°å½•Key -&gt; entryçš„æ˜ å°„å…³ç³»ï¼ŒO(1)æ—¶é—´å¾—åˆ°entry</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹çœ‹å…³é”®çš„<code>Add</code>å’Œ<code>Get</code>æ–¹æ³•ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Addæ–¹æ³•ï¼Œæ’å…¥ä¸€ä¸ªK-Vå¯¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Add</span><span class="params">(key Key, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line">c.cache = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*list.Element)</span><br><span class="line">c.ll = list.New()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¯¥keyå·²å­˜åœ¨ï¼Œæ›´æ–°entryé‡Œçš„valueå€¼ï¼Œå¹¶å°†entryæŒªåˆ°é“¾è¡¨å¤´éƒ¨</span></span><br><span class="line"><span class="keyword">if</span> ee, ok := c.cache[key]; ok &#123;</span><br><span class="line">c.ll.MoveToFront(ee)</span><br><span class="line">ee.Value.(*entry).value = value</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¯¥keyä¸å­˜åœ¨ï¼Œæ–°å»ºä¸€ä¸ªentryï¼Œæ’åˆ°é“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">ele := c.ll.PushFront(&amp;entry&#123;key, value&#125;)</span><br><span class="line">c.cache[key] = ele</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¶…å‡ºé“¾è¡¨å…è®¸é•¿åº¦ï¼Œç§»é™¤é“¾è¡¨å°¾éƒ¨çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">if</span> c.MaxEntries != <span class="number">0</span> &amp;&amp; c.ll.Len() &gt; c.MaxEntries &#123;</span><br><span class="line">c.RemoveOldest()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Getæ–¹æ³•ï¼Œé€šè¿‡Keyæ¥æ‹¿å¯¹åº”çš„value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Get</span><span class="params">(key Key)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœè¯¥keyå­˜åœ¨ï¼Œè·å–å¯¹åº”entryçš„valueï¼Œå°†è¯¥entryæŒªåˆ°é“¾è¡¨å¤´éƒ¨ï¼Œè¿”å›</span></span><br><span class="line"><span class="keyword">if</span> ele, hit := c.cache[key]; hit &#123;</span><br><span class="line">c.ll.MoveToFront(ele)</span><br><span class="line"><span class="keyword">return</span> ele.Value.(*entry).value, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SingleFlight"><a href="#SingleFlight" class="headerlink" title="SingleFlight"></a>SingleFlight</h4><p><code>SingleFlight</code>æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ï¼Œçœ‹å®ƒçš„åå­—é‡Œæœ‰ä¸€ä¸ª<code>Single</code>æœ‰ä¸€ä¸ª<code>Flight</code>ï¼Œå…¶å®<code>Single</code>æŒ‡çš„æ˜¯Næ¡å¯¹åŒä¸€ä¸ªkeyçš„æŸ¥è¯¢å‘½ä»¤ä¸­<strong>åªæœ‰1æ¡è¢«çœŸæ­£æ‰§è¡Œ</strong>ï¼Œè€Œ<code>Flight</code>å¤§å®¶å°±æŠŠå®ƒç­‰ä»·äº<code>Execution</code>å°±è¡Œäº†ã€‚</p><p>å…ˆæ¥çœ‹çœ‹<code>SingleFlight</code>é‡Œçš„æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// callç­‰ä»·äºä¸€æ¡è¢«çœŸæ­£æ‰§è¡Œçš„å¯¹æŸä¸ªkeyçš„æŸ¥è¯¢æ“ä½œ</span></span><br><span class="line"><span class="keyword">type</span> call <span class="keyword">struct</span> &#123;</span><br><span class="line">wg  sync.WaitGroup<span class="comment">// ç”¨äºé˜»å¡å¯¹æŸä¸ªkeyçš„å¤šæ¡æŸ¥è¯¢å‘½ä»¤ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰1æ¡çœŸæ­£æ‰§è¡Œçš„æŸ¥è¯¢å‘½ä»¤</span></span><br><span class="line">val <span class="keyword">interface</span>&#123;&#125;<span class="comment">// æŸ¥è¯¢ç»“æœï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜ä¸­æŸä¸ªkeyå¯¹åº”çš„valueå€¼</span></span><br><span class="line">err error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Groupç›¸å½“äºä¸€ä¸ªç®¡ç†æ¯ä¸ªkeyçš„callè¯·æ±‚çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">type</span> Group <span class="keyword">struct</span> &#123;</span><br><span class="line">mu sync.Mutex       <span class="comment">// å¹¶å‘æƒ…å†µä¸‹ï¼Œä¿è¯mè¿™ä¸ªæ™®é€šmapä¸ä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜</span></span><br><span class="line">m  <span class="keyword">map</span>[<span class="keyword">string</span>]*call <span class="comment">// keyä¸ºæ•°æ®çš„keyï¼Œvalueä¸ºä¸€æ¡callå‘½ä»¤ï¼Œè®°å½•ä¸‹æŸä¸ªkeyå½“å‰æ—¶åˆ»æœ‰æ²¡æœ‰å®¢æˆ·ç«¯åœ¨æŸ¥è¯¢</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹çœ‹<code>SingleFlight</code>é‡Œé¢å”¯ä¸€ä¸€ä¸ªï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³•â€”â€”<code>Do()</code></p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Doé‡Œé¢æ˜¯æŸ¥è¯¢å‘½ä»¤æ‰§è¡Œçš„é€»è¾‘ã€‚</span></span><br><span class="line"><span class="comment">// å½“å®¢æˆ·ç«¯æƒ³æŸ¥è¯¢æŸä¸ªkeyå¯¹åº”çš„å€¼æ—¶ä¼šè°ƒç”¨Doæ–¹æ³•æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment">// å‚æ•°ä¼ å…¥ä¸€ä¸ªå¾…æŸ¥è¯¢çš„keyï¼Œè¿˜æœ‰ä¸€ä¸ªå¯¹åº”çš„æŸ¥è¯¢æ–¹æ³•ï¼Œè¿”å›keyå¯¹åº”çš„valueå€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *Group)</span> <span class="title">Do</span><span class="params">(key <span class="keyword">string</span>, fn <span class="keyword">func</span>()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span>) <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºäº†ä¿è¯æ™®é€šmapçš„å¹¶å‘å®‰å…¨ï¼Œè¦å…ˆä¸Šé”</span></span><br><span class="line">g.mu.Lock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥mapæœ‰æ— åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">if</span> g.m == <span class="literal">nil</span> &#123;</span><br><span class="line">g.m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*call)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å½“å‰æ—¶åˆ»ï¼Œè¯¥keyæ˜¯å¦å·²ç»æœ‰åˆ«çš„å®¢æˆ·ç«¯åœ¨æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">// å¦‚æœæœ‰åˆ«çš„å®¢æˆ·ç«¯ä¹Ÿæ­£åœ¨æŸ¥è¯¢ï¼Œmapé‡Œè‚¯å®šå­˜æœ‰è¯¥keyï¼Œä»¥åŠä¸€æ¡å¯¹åº”çš„callå‘½ä»¤</span></span><br><span class="line"><span class="keyword">if</span> c, ok := g.m[key]; ok &#123;</span><br><span class="line">g.mu.Unlock()<span class="comment">// è§£é”ï¼Œè‡ªå·±å‡†å¤‡é˜»å¡ï¼Œæ­¤æ—¶å·²ä¸å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œå…è®¸åˆ«äººè¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">c.wg.Wait()<span class="comment">// é˜»å¡ï¼Œç­‰å¾…åˆ«çš„å®¢æˆ·ç«¯å®ŒæˆæŸ¥è¯¢å°±å¥½ï¼Œä¸ç”¨è‡ªå·±å†å»è€—è´¹èµ„æºæŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">return</span> c.val, c.err<span class="comment">// é˜»å¡ç»“æŸï¼Œè¯´æ˜åˆ«äººå·²ç»æŸ¥è¯¢å®Œæˆï¼Œæ‹¿æ¥ä¸»ä¹‰ç›´æ¥è¿”å›</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœèƒ½æ‰§è¡Œåˆ°æ­¤æ­¥ï¼Œè¯´æ˜å½“å‰æ—¶åˆ»æ²¡æœ‰åˆ«äººåœ¨æŸ¥è¯¢è¯¥keyï¼Œå½“å‰å®¢æˆ·ç«¯æ˜¯</span></span><br><span class="line"><span class="comment">// å½“å‰æ—¶åˆ»ç¬¬ä¸€ä¸ªæƒ³è¦æŸ¥è¯¢è¯¥keyçš„äººï¼Œå°±æ’å…¥ä¸€æ¡key -&gt; callè®°å½•</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œæ­¤æ—¶çš„mapä»ç„¶æ˜¯ä¸Šé”çŠ¶æ€ï¼Œå› ä¸ºè¿˜è¦å¯¹mapè¿›è¡Œæ’å…¥ï¼Œæœ‰å¹¶å‘å®‰å…¨é—®é¢˜</span></span><br><span class="line">c := <span class="built_in">new</span>(call)</span><br><span class="line">c.wg.Add(<span class="number">1</span>)</span><br><span class="line">g.m[key] = c</span><br><span class="line">g.mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œä½œä¸ºå‚æ•°ä¼ å…¥çš„æŸ¥è¯¢æ–¹æ³•</span></span><br><span class="line"><span class="comment">// **åŒä¸€æ—¶åˆ»å¯¹äºåŒä¸€ä¸ªkeyåªå¯èƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œåˆ°æ­¤å¤„**</span></span><br><span class="line">c.val, c.err = fn()</span><br><span class="line">c.wg.Done()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå®ŒæŸ¥è¯¢æ–¹æ³•ï¼ŒæŠŠmapä¸­çš„key -&gt; callåˆ æ‰</span></span><br><span class="line">g.mu.Lock()</span><br><span class="line"><span class="built_in">delete</span>(g.m, key)</span><br><span class="line">g.mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c.val, c.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šè¿°ä»£ç æ³¨é‡Šé‡Œçš„åˆ†æï¼Œ<code>SingleFlight</code>çš„é€»è¾‘åº”è¯¥å¾ˆæ¸…æ¥šäº†ã€‚ç‰¹åˆ«æä¸€æé‡Œé¢çš„å‡ ä¸ªæ€ç»´äº®ç‚¹ï¼š</p><ul><li>æ—¶åˆ»è°¨è®°goé‡Œé¢çš„æ™®é€šmapä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œè¦åœ¨æœ‰å¹¶å‘å®‰å…¨éšæ‚£çš„åœ°æ–¹æ‰‹åŠ¨ä¸Šé”å’Œè§£é”ã€‚</li><li>ç”¨ä¸€ä¸ªmapæ¥è®°å½•keyä¸æŸ¥è¯¢è¯·æ±‚ï¼Œå¯ä»¥è¿…é€Ÿå¾—çŸ¥ï¼ˆç†æƒ³æƒ…å†µä¸‹O(1)ï¼‰å½“å‰æ—¶åˆ»æŸä¸ªkeyæ˜¯å¦æœ‰äººåœ¨æ‰§è¡ŒæŸ¥è¯¢ã€‚</li><li>æœ¬æ¥ç”¨<code>set</code>ç±»å®¹å™¨æ¥å­˜å½“å‰æ­£è¢«äººæŸ¥è¯¢çš„keyä¹Ÿå¯ä»¥å®Œæˆä»¥ä¸Šéœ€æ±‚ã€‚ä½†æ˜¯ç¬¬äºŒä¸ªäº®ç‚¹å°±æ˜¯<code>call</code>ç»“æ„ï¼Œ<code>call</code>é‡Œé¢å°è£…äº†ä¸€ä¸ª<code>WaitGroup</code>å’Œä¸€ä¸ª<code>val</code>ã€‚å½“æŸä¸€æ—¶åˆ»æœ‰Nä¸ªå¯¹æŸä¸ªkeyçš„æŸ¥è¯¢è¯·æ±‚ï¼Œé€šè¿‡<code>WaitGroup</code>æ¥é˜»å¡å…¶ä¸­çš„N-1ä¸ªï¼Œåªæ‰§è¡Œ1æ¬¡æŸ¥è¯¢æ–¹æ³•ï¼Œç„¶åæŠŠæŸ¥è¯¢ç»“æœå¡åˆ°<code>call.val</code>ä¸­ï¼Œé€šçŸ¥<code>WaitGroup</code>å®Œæˆä»»åŠ¡ã€‚è¿™æ ·åšï¼Œä¸ä»…æ‰§è¡ŒæŸ¥è¯¢çš„é‚£ä¸€ä¸ªâ€œå¤©é€‰ä¹‹å­â€å¯ä»¥è¿”å›è¯¥å€¼ï¼Œè€Œä¸”é‚£N-1ä¸ªè¢«é˜»å¡çš„ä¹Ÿå¯ä»¥ç›´æ¥å–<code>call.val</code>ä½œä¸ºç»“æœè¿”å›ã€‚</li></ul><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>groupcache</code>è¿™ä¸ªé¡¹ç›®çš„ä»£ç é‡è™½ä¸å¤šï¼Œä½†æœ‰å¾ˆå¤šç²¾åçš„åœ°æ–¹ã€‚å¦‚</p><ul><li>å®ç°<strong>ä¸€è‡´æ€§å“ˆå¸Œ</strong>æ¥ç®¡ç†å¤šèŠ‚ç‚¹</li><li>å®ç°<code>LRU</code>ç®—æ³•æ¥ç®¡ç†åº•å±‚K-Væ•°æ®</li><li>å®ç°<code>SingleFlight</code>æ¥æé«˜å¹¶å‘æŸ¥è¯¢æ•ˆç‡</li></ul><p>å…¶ä¸­ï¼Œ<code>SingleFlight</code>çš„é€»è¾‘æœ€è®©æˆ‘å¼€äº†çœ¼ç•Œã€‚ä¹‹å‰å¯¹äºâ€œå¹¶å‘æŸ¥è¯¢â€çš„ä¼˜åŒ–æ–¹é¢ï¼Œæˆ‘è€ƒè™‘çš„å¯èƒ½ä¹Ÿå°±æ˜¯å¦‚ä½•ä¼˜åŒ–å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œæˆ–è€…ç±»ä¼¼äºæŠŠè¯·æ±‚åˆ†å‘åˆ°å¤šå°æœºå™¨ä¸Šå¤„ç†ï¼Œç”¨å¤šæœºçš„è®¡ç®—èƒ½åŠ›æ¥æŠ—ã€‚ä½†æ˜¯è¿™äº›éƒ½ä¸å¦‚<code>SingleFlight</code>é‡Œçš„é€»è¾‘è¿™ä¹ˆç²—æš´æ˜äº†ï¼ŒåŒæ—¶åˆé«˜æ•ˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]groupcacheé¡¹ç›®è§£æâ€”â€”Part1</title>
      <link href="/2018/11/30/groupcache-part1/"/>
      <url>/2018/11/30/groupcache-part1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/11/29ï¼ŒåŸºäº<code>Go 1.11</code>ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>æœ¬æ–‡æ˜¯ã€Šgroupcacheé¡¹ç›®è§£æã€‹ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œåœ¨æœ¬æ–‡ä¸­ä¸»è¦æ˜¯å¯¹<code>groupcache</code>è¿™ä¸ªé¡¹ç›®ä½œç®€å•çš„ä»‹ç»ï¼ŒåŒ…æ‹¬å…¶</p><ul><li>æ¶æ„</li><li>ä»£ç æ–‡ä»¶ç»“æ„</li><li>ç®€å•ç”¨ä¾‹</li></ul><h4 id="groupcacheç®€ä»‹"><a href="#groupcacheç®€ä»‹" class="headerlink" title="groupcacheç®€ä»‹"></a>groupcacheç®€ä»‹</h4><p><code>groupcache</code>(<a href="https://github.com/golang/groupcache" target="_blank" rel="noopener">on Github</a>)æ˜¯ä¸€ä¸ªç”¨<code>Go</code>å®ç°çš„K-V cacheçš„åº“ï¼Œå¯ä»¥èµ·åˆ°<code>memcached</code>çš„<strong>éƒ¨åˆ†åŠŸèƒ½</strong>ã€‚å®ƒæ”¯æŒå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œä¹Ÿæ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²ã€‚</p><p>å…¶ä¸­æœ€å€¼å¾—ä¸€æçš„ä¸¤ä¸ªç‰¹æ€§æ˜¯ï¼š</p><ul><li>ä¸æ”¯æŒupdateå’Œdeleteï¼ˆåŸºæœ¬åªèƒ½ç”¨äºé™æ€èµ„æºç¼“å­˜ï¼‰</li><li>çƒ­é—¨ç¼“å­˜è‡ªåŠ¨é•œåƒï¼ˆauto mirroringï¼‰</li></ul><p><strong>âš ï¸æ³¨æ„ï¼Œ<code>groupcache</code>å¹¶ä¸æ˜¯ä¸€ä¸ªå¯ç›´æ¥è¿è¡Œçš„å­˜å‚¨ç»„ä»¶ï¼Œä¸åƒMySQLæˆ–è€…Redisä¹‹ç±»é‚£æ ·æä¾›ç¼–è¯‘åçš„å¯è¿è¡Œç¨‹åºã€‚<code>groupcache</code>åªæ˜¯ä¸€ä¸ªK-V cacheçš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŸºäºå®ƒçš„ä»£ç å¯ä»¥è‡ªå·±å†™ä»£ç å®ç°ä¸€ä¸ªcacheå±‚ã€‚</strong></p><h4 id="groupcacheæ¶æ„"><a href="#groupcacheæ¶æ„" class="headerlink" title="groupcacheæ¶æ„"></a>groupcacheæ¶æ„</h4><ol><li><p>èŠ‚ç‚¹ç®¡ç†</p><p> ä»¥ä¸Šæåˆ°ï¼Œ<code>groupcache</code>æ˜¯ä¸€ä¸ªæ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²çš„K-V cacheã€‚å½“æœ‰å¤šä¸ªå­˜å‚¨èŠ‚ç‚¹æ—¶ï¼Œå†…éƒ¨ä¼šä»¥<code>consistent hash</code>ï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰çš„æ–¹å¼ç®¡ç†å¤šä¸ªèŠ‚ç‚¹ã€‚å…³äºä¸€è‡´æ€§å“ˆå¸Œçš„è§£æï¼Œè¯¦æƒ…å¯å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« <a href="http://www.marcoma.xyz/index.php/2018/03/17/consistent_hash/" target="_blank" rel="noopener">ã€Šä¸€è‡´æ€§Hashç®—æ³•â€”â€”åˆ†æä¸æ¨¡æ‹Ÿã€‹</a>ã€‚</p><p> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/hash.png" alt=""></p><p> é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†å¤šä¸ªèŠ‚ç‚¹ã€‚å¦‚æœå“ˆå¸Œç®—æ³•è®¾è®¡å¾—æ¯”è¾ƒå¥½ï¼Œå¯ä»¥æŠŠå¤§é‡K-Væ•°æ®å‡åŒ€æ‰“æ•£ï¼Œå­˜å‚¨åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚</p></li><li><p>groupï¼ˆå­˜å‚¨ç»„ï¼‰</p><p> åœ¨<code>groupcache</code>é‡Œï¼Œ<code>group</code>æ˜¯ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„å­˜å‚¨å®¹å™¨ï¼Œæ¯ä¸ª<code>group</code>éƒ½æœ‰è‡ªå·±çš„åå­—ï¼Œå¤šä¸ª<code>group</code>ä¹‹é—´ä¸å…±äº«æ•°æ®ã€‚ç„¶è€Œ<code>group</code>åªæ˜¯ä¸€ä¸ª<strong>é€»è¾‘æ¦‚å¿µ</strong>ï¼Œä¸€ä¸ª<code>group</code>é‡Œå­˜çš„K-Væ•°æ®æ˜¯å¯ä»¥å­˜åœ¨å¤šä¸ªåˆ†æ•£çš„ç‰©ç†èŠ‚ç‚¹ä¸Šçš„ï¼ˆ<strong>åˆ†æ•£çš„ç­–ç•¥ä¾èµ–äºä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</strong>ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šå®é™…ä¸Šå­˜äº†å¤šä¸ª<code>group</code>çš„K-Væ•°æ®ï¼Œç»„ä¸ç»„ä¹‹é—´çš„è®¿é—®éš”ç¦»å…¨é <code>groupcache</code>çš„ä»£ç é€»è¾‘æ¥å®ç°ã€‚</p><p> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/group.png" alt=""></p></li><li><p>ç¼“å­˜ç³»ç»Ÿ</p><ul><li><p>LRU</p><p>  åœ¨ç¼“å­˜ç³»ç»Ÿçš„åº•å±‚ï¼Œæ¯ä¸ªK-V Entryéƒ½æ˜¯é€šè¿‡ä¸€æ¡LRUé“¾è¡¨æ¥ç®¡ç†çš„ã€‚ç»å¸¸è¢«è®¿é—®çš„æ•°æ®ä¼šè¢«æ”¾ç½®åœ¨LRUé“¾è¡¨çš„å‰ç«¯ï¼Œä¹…è€Œä¹…ä¹‹å†·æ•°æ®ä¼šä¸‹æ²‰åˆ°é“¾è¡¨å°¾ç«¯ï¼Œç”šè‡³ç›´æ¥è¢«ç§»å‡ºé“¾è¡¨ã€‚</p></li><li><p>å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–</p><p>  åœ¨<code>groupcache</code>ä¸­ï¼Œå¦‚æœæŸèŠ‚ç‚¹åŒæ—¶æ”¶åˆ°Nä¸ªå¯¹äºåŒä¸€ä¸ªkeyçš„æŸ¥è¯¢è¯·æ±‚ï¼Œä½†æ˜¯è¯·æ±‚çš„keyä¸åœ¨å½“å‰èŠ‚ç‚¹ä¸Šï¼Œ<code>groupcache</code>ä¼šè‡ªåŠ¨<strong>é˜»å¡</strong>N-1ä¸ªè¯·æ±‚ï¼Œåªæ‰§è¡Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚ï¼Œå»å…¶ä»–èŠ‚ç‚¹æˆ–è€…æ•°æ®åº“ä¸­fetchæ•°æ®ã€‚æœ€åæ‰æ¢å¤Nä¸ªè¯·æ±‚ï¼ŒæŠŠæ•°æ®æ”¾åˆ°Nä¸ªè¯·æ±‚ä¸­è¿”å›ã€‚å› ä¸ºæ— è®ºå¤šå°‘ä¸ªå¯¹åŒä¸€ä¸ªkeyçš„æŸ¥è¯¢è¯·æ±‚å¹¶å‘åˆ°è¾¾ï¼Œåªæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œæ‰€ä»¥å¹¶å‘æŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ã€‚</p></li><li><p>çƒ­é—¨ç¼“å­˜è‡ªåŠ¨é•œåƒ</p><p>  æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸¤ç±»ç¼“å­˜ï¼š<code>main cache</code>ï¼ˆå±äºæœ¬èŠ‚ç‚¹çš„æ•°æ®ï¼‰å’Œ<code>hot cache</code>ï¼ˆä¸å±äºæœ¬èŠ‚ç‚¹ä½†æ˜¯å…¨å±€çƒ­é—¨çš„æ•°æ®ï¼‰ã€‚å½“èŠ‚ç‚¹æ”¶åˆ°äº†å¯¹æŸä¸ªkeyçš„æŸ¥è¯¢è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¼šæ£€æŸ¥æœ¬åœ°<code>hot cache</code>ä¸­æœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰å°±å†çœ‹çœ‹è¯¥keyæ˜¯ä¸æ˜¯å±äºæœ¬èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¦‚æœä¸æ˜¯å°±å‘å…„å¼ŸèŠ‚ç‚¹è¯·æ±‚ã€‚æ‰€è°“çš„<strong>è‡ªåŠ¨é•œåƒ</strong>ï¼ŒæŒ‡çš„æ˜¯ä»å…„å¼ŸèŠ‚ç‚¹å¤„è¿”å›çš„æ•°æ®å¯ä»¥ç¼“å­˜åœ¨æœ¬èŠ‚ç‚¹çš„<code>hot cache</code>é‡Œï¼Œè™½ç„¶è‡ªèº«<strong>æ²¡æœ‰é‚£ä¸ªæ•°æ®çš„å­˜å‚¨æƒé™</strong>ï¼Œä½†æ˜¯å¯ä»¥å­˜å‚¨æˆä¸€ä»½çƒ­é—¨æ•°æ®çš„é•œåƒï¼Œä»¥åå†æ”¶åˆ°å¯¹è¯¥keyçš„è¯·æ±‚ï¼Œæ— éœ€å†å‘å…„å¼ŸèŠ‚ç‚¹è¯·æ±‚ï¼Œæµªè´¹ç½‘ç»œèµ„æºã€‚</p></li></ul></li></ol><h4 id="groupcacheä»£ç æ¨¡å—"><a href="#groupcacheä»£ç æ¨¡å—" class="headerlink" title="groupcacheä»£ç æ¨¡å—"></a>groupcacheä»£ç æ¨¡å—</h4><ul><li><p><code>consistenthash</code></p><p>  <code>consistenthash</code>æ¨¡å—å®ç°äº†ç®€å•çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯èŠ‚ç‚¹åœ°å€ï¼‰è¿›å…¥ä¸€è‡´æ€§å“ˆå¸Œåï¼Œä¼šè¢«è‡ªåŠ¨å†—ä½™å¾—åˆ°å¤šä¸ªå¤‡ä»½ï¼ˆå–å†³äº<code>replica</code>çš„è®¾å®šå€¼ï¼‰ï¼Œç„¶åæ’åˆ°ä¸€è‡´æ€§å“ˆå¸Œç¯ä¸Šã€‚</p></li><li><p><code>groupcachepb</code></p><p>  <code>groupcachepb</code>æ¨¡å—é‡Œï¼Œç”¨äº†ç¬¬ä¸‰æ–¹åº“<code>protobuf</code>ç”Ÿæˆäº†ç»Ÿä¸€çš„<code>Request</code>å’Œ<code>Response</code>ç»“æ„ï¼Œä¾›èŠ‚ç‚¹é—´ç½‘ç»œé€šä¿¡ä½¿ç”¨ã€‚</p></li><li><p><code>lru</code></p><p>  <code>lru</code>æ¨¡å—å®ç°äº†ç»å…¸çš„LRUç®—æ³•ï¼Œç”¨<code>container/list</code>é‡Œçš„é“¾è¡¨å®ç°ã€‚</p></li><li><p><code>singleflight</code></p><p>  <code>singleflight</code>æ¨¡å—éå¸¸é‡è¦ã€‚æ­£å¦‚å®ƒåå­—é‡Œçš„<code>single</code>ï¼Œå®ƒæ˜¯ç”¨æ¥ä¿è¯å¤šä¸ªå¯¹åŒä¸€ä¸ªkeyçš„è¯·æ±‚ä¸è¢«å¤šæ¬¡æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯ä¸Šé¢ç®€ä»‹æ‰€è¯´çš„<strong>å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–</strong>ã€‚</p></li><li><p><code>testpb</code></p><p>  <code>testpb</code>ï¼Œæµ‹è¯•<code>protobuf</code>ç»“æ„ã€‚</p></li><li><p><code>byteview</code></p><p>  <code>byteview</code>æ˜¯ä¸€ä¸ªå¯¹byteæ•°ç»„æˆ–è€…å­—ç¬¦ä¸²çš„å°è£…ï¼Œåœ¨å¤–éƒ¨çœ‹æ¥ï¼Œ<code>groupcache</code>é‡Œçš„æ‰€æœ‰K-Væ•°æ®æœ€ç»ˆéƒ½æ˜¯è½ç›˜åˆ°byteä¸Šï¼Œéƒ½æ˜¯å¯¹<code>byteview</code>çš„è¯»å†™æ“ä½œã€‚</p></li><li><p><code>groupcache</code></p><p>  æ ¸å¿ƒä»£ç æ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†<code>Group</code>ã€<code>GetterFunc</code>ã€<code>Stats</code>ç­‰å¤šä¸ªå…³é”®æ•°æ®ç»“æ„ï¼Œä»¥åŠå¯¹åº”çš„æ–¹æ³•ã€‚</p></li><li><p><code>http</code></p><p>  æ ¸å¿ƒä»£ç æ–‡ä»¶ï¼Œå®šä¹‰äº†<code>HTTPPool</code>ä»¥åŠå¯¹åº”çš„æ–¹æ³•ï¼ŒåŒ…å«äº†å„ç§ç½‘ç»œé€šä¿¡çš„é€»è¾‘ã€‚</p></li><li><p><code>peers</code></p><p>  å®šä¹‰äº†èŠ‚ç‚¹çš„ç›¸å…³æ“ä½œã€‚</p></li><li><p><code>sinks</code></p><p>  <code>sinks</code>é‡Œå®šä¹‰äº†<code>Sink</code>æ¥å£ä»¥åŠå¤šç§ä¸åŒçš„sinkã€‚å…¶å®sinkå¯ä»¥ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šå®¹å™¨ï¼Œå½“èŠ‚ç‚¹æ”¶åˆ°å¯¹æŸä¸ªkeyçš„æŸ¥è¯¢è¯·æ±‚ï¼Œä½†æ˜¯æœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦åˆ°è¿œç¨‹æ•°æ®åº“é‡Œè¯»å–æ—¶ï¼Œä¼šæŠŠè¯»å–å›æ¥çš„æ•°æ®ä¸‹æ²‰åˆ°sinkå®¹å™¨é‡Œé¢ï¼Œæœ€åå†æŠŠæ•°æ®è½¬æˆbyteviewå¡åˆ°æœ¬åœ°ç¼“å­˜é‡Œã€‚</p></li></ul><h4 id="Quick-Start-Example"><a href="#Quick-Start-Example" class="headerlink" title="Quick Start Example"></a>Quick Start Example</h4><p>ä»¥ä¸‹æä¾›ä¸€ä¸ªç®€å•çš„<code>groupcache</code>ä½¿ç”¨ä¾‹å­ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/golang/groupcache"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line"><span class="comment">// ç®€å•èµ·è§ï¼Œhardcodeä¸€æ®µå…„å¼ŸèŠ‚ç‚¹çš„åœ°å€</span></span><br><span class="line">peers = []<span class="keyword">string</span>&#123;<span class="string">"http://127.0.0.1:8001"</span>, <span class="string">"http://127.0.0.1:8002"</span>, <span class="string">"http://127.0.0.1:8003"</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆå»ºå¥½httpè¿æ¥æ± ï¼Œè¡¨æ˜å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹æœ‰å“ªäº›</span></span><br><span class="line">host := os.Args[<span class="number">1</span>]</span><br><span class="line">localAddr:= <span class="string">"http://"</span> + host</span><br><span class="line">localHttpPool := groupcache.NewHTTPPool(localAddr)</span><br><span class="line">localHttpPool.Set(peers...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªé€»è¾‘ä¸Šçš„åˆ†ç»„ï¼Œå«fileCacheGroupï¼Œç”¨æ¥ç¼“å­˜æ–‡ä»¶å†…å®¹ï¼Œç¼“å­˜å¤§å°ä¸º64MB</span></span><br><span class="line"><span class="comment">// å½“æœ¬åœ°ç¼“å­˜missæ—¶ï¼Œç›´æ¥è¯»å–ç£ç›˜ä¸Šçš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">var</span> fileCacheGroup = groupcache.NewGroup(<span class="string">"file"</span>, <span class="number">64</span>&lt;&lt;<span class="number">20</span>, groupcache.GetterFunc(</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(ctx groupcache.Context, key <span class="keyword">string</span>, dest groupcache.Sink)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">result, err := ioutil.ReadFile(key)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"Get file error."</span>)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">"Trying to get %s\n"</span>, key)</span><br><span class="line">dest.SetBytes([]<span class="keyword">byte</span>(result))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºäº†æµ‹è¯•ï¼Œå»ºç«‹ä¸€ä¸ªå¯¹å¤–çš„httpæœåŠ¡ï¼Œè·¯ç”±æ˜¯host:port/file_cache?fname=&#123;&#125;</span></span><br><span class="line">http.HandleFunc(<span class="string">"/file_cache"</span>, <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> value []<span class="keyword">byte</span></span><br><span class="line">key := r.URL.Query().Get(<span class="string">"fname"</span>)</span><br><span class="line">fileCacheGroup.Get(<span class="literal">nil</span>, key, groupcache.AllocatingByteSliceSink(&amp;value))</span><br><span class="line">rw.Write([]<span class="keyword">byte</span>(value))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨httpæœåŠ¡</span></span><br><span class="line">log.Fatal(http.ListenAndServe(host, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚éœ€æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œå¯ç¼–è¯‘åç›´æ¥å‘½ä»¤è¡Œæ‰§è¡Œï¼ˆè®°å¾—å¸¦ä¸Šhostå‚æ•°å¦‚<code>127.0.0.1:8001</code>ï¼‰ã€‚ç”±äºcache missçš„é€»è¾‘æ˜¯åœ¨æœ¬åœ°ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥å…ˆåœ¨ç›®å½•ä¸‹æ–°å»ºå‡ ä¸ªåƒåœ¾æ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢éšä¾¿å¡«å……ä¸€äº›å†…å®¹ï¼Œè¿›è¡Œæµ‹è¯•ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/groupcache_test.png" alt=""></p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/postman_cache.png" alt=""></p><p>æµ‹è¯•ç»“æœå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><ol><li>å…ˆåœ¨æœ¬åœ°éšä¾¿æ–°å»ºä¸€ä¸ª<code>hh.txt</code>æ–‡ä»¶ï¼Œé‡Œé¢å†™ä¸Š<code>This is hh.txt!</code>ã€‚</li><li>ç„¶åç¼–è¯‘å®Œä¸Šè¿°ä¾‹å­ç¨‹åºåï¼Œç›´æ¥ä¼ å…¥å‚æ•°<code>127.0.0.1:8001</code>ä»¥å‘½ä»¤è¡Œå¯åŠ¨ç¨‹åºã€‚</li><li>ç”¨postmanè®¿é—®ä»£ç ä¸­å®šä¹‰å¥½çš„æœåŠ¡è·¯ç”±ï¼ˆ<code>host:port/file_cache?fname={}</code>ï¼‰ï¼Œæµ‹è¯•ç¼“å­˜æœåŠ¡ï¼Œå¾—åˆ°responseç»“æœä¸º<code>hh.txt</code>çš„æ–‡ä»¶å†…å®¹ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]æµ…æå‡ ç§å¹¶å‘æ¨¡å¼</title>
      <link href="/2018/11/25/go-concurrency-pattern/"/>
      <url>/2018/11/25/go-concurrency-pattern/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/11/24ï¼ŒåŸºäºGo 1.11ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>æœ€è¿‘è¯»å®Œäº†æ•´æœ¬ã€ŠGo in Actionã€‹ï¼Œç»™æˆ‘å°è±¡æœ€æ·±çš„å‡ ç« æ˜¯è®²</p><ul><li>å¤šæ€</li><li>é«˜çº§å¹¶å‘æ¨¡å¼</li><li>å¸¸ç”¨å·¥å…·åŒ…ï¼ˆ<code>http</code>, <code>json</code>, <code>log</code>â€¦â€¦ï¼‰</li></ul><p>æœ¬æ–‡åŸºäºã€ŠGo in Actionã€‹é‡Œä»‹ç»çš„3ç§é«˜çº§å¹¶å‘æ¨¡å¼è¿›è¡Œæµ…æï¼Œä¸»è¦èµ·åˆ°è§£é‡Šå’Œç¬”è®°çš„ä½œç”¨ï¼Œä¹Ÿä¼šç®€å•åœ°è®²è®²æˆ‘ä¸ªäººå¯¹è¿™å‡ ç§æ¨¡å¼çš„ç†è§£ã€‚</p><h4 id="å¹¶å‘æ¨¡å¼"><a href="#å¹¶å‘æ¨¡å¼" class="headerlink" title="å¹¶å‘æ¨¡å¼"></a>å¹¶å‘æ¨¡å¼</h4><ol><li><p>ä»»åŠ¡è®¡æ—¶å™¨</p><p> ä½•è°“â€œä»»åŠ¡è®¡æ—¶å™¨â€ï¼Ÿ<strong>å…¶å®å°±æ˜¯ä¸€ä¸ªåŒ…è£…äº†å¤šä¸ªè¦æ‰§è¡Œçš„<code>Task</code>å’Œä¸€ä¸ª<code>Timer</code>çš„å®¹å™¨</strong>ã€‚è¯¥å®¹å™¨å¯åŠ¨åï¼Œåªæœ‰3ç§æƒ…å†µèƒ½å¤Ÿè®©å…¶é€€å‡ºï¼š</p><ul><li>æ‰€æœ‰<code>Task</code>æ‰§è¡Œå®Œæ¯•ï¼Œæ­£å¸¸é€€å‡º</li><li>æ”¶åˆ°å¤–éƒ¨ä¸­æ–­ä¿¡å·ï¼ˆinterruptï¼‰ï¼Œé€€å‡º</li><li><p><code>Timer</code>è¶…è¿‡è®¾å®šçš„æ—¶é•¿ï¼Œé€€å‡º</p><p>å…ˆæ¥ç›´æ¥çœ‹çœ‹ã€ŠGo in Actionã€‹ä¸­ç»™å‡ºçš„å®ç°ä»£ç ã€‚</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> runner</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"errors"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»»åŠ¡è®¡æ—¶å™¨</span></span><br><span class="line"><span class="keyword">type</span> Runner <span class="keyword">struct</span> &#123;</span><br><span class="line">interrupt <span class="keyword">chan</span> os.Signal<span class="comment">// æ¥æ”¶ä¸­æ–­ä¿¡å·çš„channel</span></span><br><span class="line">complete <span class="keyword">chan</span> error<span class="comment">// æ¥æ”¶ä»»åŠ¡å®Œæˆä¿¡å·çš„channel</span></span><br><span class="line">timeout &lt;-<span class="keyword">chan</span> time.Time<span class="comment">// æ¥æ”¶è¶…æ—¶ä¿¡å·çš„channel</span></span><br><span class="line">tasks []<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span>// å­˜æ”¾è¦æ‰§è¡Œçš„å¤šä¸ªä»»åŠ¡çš„åˆ‡ç‰‡</span></span><br><span class="line"><span class="function">// å…¶ä¸­æ¯ä¸ªä»»åŠ¡æ˜¯ä¸€ä¸ªä»¥<span class="title">int</span>ä¸ºå½¢å‚çš„æ–¹æ³•</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// å®šä¹‰äº†ä¸¤ç§å¼‚å¸¸é€€å‡ºçš„é”™è¯¯</span></span><br><span class="line">var ErrTimeout = errors.New("received timeout")</span><br><span class="line"><span class="keyword">var</span> ErrInterrupt = errors.New(<span class="string">"received interrupt"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨å·¥å‚ï¼Œé€šè¿‡newç›´æ¥å¾—åˆ°ä¸€ä¸ªå®¹å™¨å®ä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(d time.Duration)</span> *<span class="title">Runner</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Runner&#123;</span><br><span class="line">interrupt: <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>),</span><br><span class="line">complete:  <span class="built_in">make</span>(<span class="keyword">chan</span> error),</span><br><span class="line">timeout:   time.After(d),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾€å®¹å™¨é‡Œæ·»åŠ ä»»åŠ¡çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Add</span><span class="params">(tasks ...<span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span> &#123;</span><br><span class="line">r.tasks = <span class="built_in">append</span>(r.tasks, tasks...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨å¯åŠ¨çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// We want to receive all interrupt based signals.</span></span><br><span class="line">signal.Notify(r.interrupt, os.Interrupt)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run the different tasks on a different goroutine.</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">r.complete &lt;- r.run()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="comment">// Signaled when processing is done.</span></span><br><span class="line"><span class="keyword">case</span> err := &lt;-r.complete:</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line"></span><br><span class="line"><span class="comment">// Signaled when we run out of time.</span></span><br><span class="line"><span class="keyword">case</span> &lt;-r.timeout:</span><br><span class="line"><span class="keyword">return</span> ErrTimeout</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨å†…éƒ¨æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> id, task := <span class="keyword">range</span> r.tasks &#123;</span><br><span class="line"><span class="comment">// Check for an interrupt signal from the OS.</span></span><br><span class="line"><span class="keyword">if</span> r.gotInterrupt() &#123;</span><br><span class="line"><span class="keyword">return</span> ErrInterrupt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute the registered task.</span></span><br><span class="line">task(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦å‘ç”Ÿä¸­æ–­ä¿¡å·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">gotInterrupt</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-r.interrupt:</span><br><span class="line"><span class="comment">// Stop receiving any further signals.</span></span><br><span class="line">signal.Stop(r.interrupt)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„é€»è¾‘å¾ˆæ¸…æ™°ï¼Œä½†ä»æœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦ç‰¹åˆ«å¼ºè°ƒä¸€ä¸‹ã€‚</p></li><li><p>åœ¨å®¹å™¨<code>Runner</code>é‡Œï¼Œ<code>timeout</code>æ˜¯ä¸€ä¸ªæ¥æ”¶è¶…æ—¶ä¿¡å·ï¼ˆ<code>time.Time</code>ï¼‰çš„channelï¼Œä¸€æ—¦è¯¥channelæ¥æ”¶åˆ°<strong>ä¸€ä¸ª</strong>è¶…æ—¶ä¿¡å·ï¼Œå°†é€šçŸ¥<code>Runner</code>é€€å‡ºã€‚è€Œåœ¨newä¸€ä¸ªæ–°çš„<code>Runner</code>æ—¶ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯<code>time.After(duration)</code>æ¥ç”Ÿæˆä¸€ä¸ª<code>timeout</code>ç®¡é“ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥<code>make(chan time.Time)</code>å‘¢ï¼Ÿå› ä¸ºç”¨<code>time.After(duration)</code>ç”Ÿæˆç®¡é“æ—¶ï¼Œä¼šæ½œåœ¨è‡ªåŠ¨è§¦å‘ä¸€ä¸ªæœºåˆ¶ï¼šç»è¿‡<code>duration</code>åè¯¥ç®¡é“ä¼šæ”¶åˆ°ä¸€ä¸ª<code>time.Time</code>ä¿¡å·ï¼Œä¸éœ€è¦è‡ªå·±é¢å¤–å»åšå‘é€è¶…æ—¶ä¿¡å·è¿™ä¸€å¥—é€»è¾‘ã€‚</p></li><li>ä½¿ç”¨<code>select</code>è¯­å¥ã€‚å¯ä»¥çœ‹åˆ°åœ¨<code>Start()</code>ä¸­ï¼Œå¼€äº†ä¸€ä¸ªgoroutineå»æ‰§è¡Œä»»åŠ¡åï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª<code>select</code>è¯­å¥ï¼Œå…¶ä¸­ä¸¤ä¸ªåˆ†æ”¯åˆ†åˆ«æ˜¯æ‰€æœ‰ä»»åŠ¡æ­£å¸¸å®Œæˆä¸”æ”¶åˆ°completeä¿¡å·ï¼Œè¿˜æœ‰ä»»åŠ¡è¶…æ—¶æ”¶åˆ°è¶…æ—¶ä¿¡å·ã€‚<strong>å…¶å®<code>select</code>è¯­å¥å¯ä»¥ç®€å•åœ°çœ‹æˆæ˜¯ä¸€ä¸ªå®šåˆ¶ç‰ˆçš„<code>epoll</code>æœºåˆ¶</strong>ï¼Œå®ƒå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ª<code>case</code>ã€‚å¦‚æœæ‰€æœ‰çš„<code>case</code>åˆ†æ”¯éƒ½ä¸èƒ½æ‰§è¡Œï¼Œå°†é˜»å¡åœ¨æ­¤ï¼›å¦‚æœæœ‰ä¸€ä¸ª<code>case</code>å¯ä»¥æ‰§è¡Œï¼Œä¸€å®šä¼šæ‰§è¡Œè¯¥<code>case</code>ï¼›å’Œ<code>epoll</code>å”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œå¦‚æœåŒæ—¶æœ‰å¤šä¸ª<code>case</code>å¯ä»¥æ‰§è¡Œï¼Œ<code>select</code>ä¼š<strong>éšæœº</strong>æ‰§è¡Œå…¶ä¸­ä¸€ä¸ª<code>case</code>ã€‚åŒç†ï¼Œåœ¨<code>gotInterrupt()</code>é‡Œï¼Œæˆ‘ä»¬ä¹Ÿç”¨äº†<code>select</code>è¯­å¥ç›‘å¬æœ‰æ²¡æœ‰ä¸­æ–­ä¿¡å·ï¼Œå¦‚æœåœ¨æ‰§è¡Œ<code>gotInterrupt()</code>çš„é‚£ä¸ªæ—¶åˆ»æ²¡æœ‰æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œé‚£ç»å¯¹ä¼šç›´æ¥æ‰§è¡Œ<code>default</code>åˆ†æ”¯ï¼ˆæ°¸è¿œéƒ½èƒ½æ‰§è¡Œçš„åˆ†æ”¯ï¼‰ï¼Œè¿”å›<code>false</code>å‘ŠçŸ¥è°ƒç”¨è€…æ²¡æœ‰æ”¶åˆ°ä¸­æ–­ä¿¡å·ã€‚</li><li>åœ¨å®¹å™¨<code>Runner</code>é‡Œï¼Œ<code>tasks</code>æ˜¯ä¸€ä¸ªè£…äº†å¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡çš„åˆ‡ç‰‡ï¼Œå®šä¹‰é‡Œè¯´æ˜äº†æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ª<code>func(int)</code>ã€‚<strong>ä½†æ˜¯è¿™å¹¶ä¸å…·æœ‰æ™®é€‚æ€§ï¼Œè¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œè®¾è®¡è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šä¹‰æ¯ä¸ªä»»åŠ¡æ˜¯ä»€ä¹ˆæ ·çš„æ–¹æ³•ã€‚</strong>å¯ä»¥æ˜¯<code>func(interfact{}) interface{}</code>ï¼Œå¯ä»¥æ˜¯ä»»æ„çš„æ–¹æ³•ã€‚</li><li><p><code>run()</code>æ–¹æ³•ç”¨äºåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚æœ€å¥‡æ€ªçš„æ˜¯ï¼Œåœ¨<code>run()</code>é‡Œé¢å…¶å®æ˜¯<strong>éå†äº†<code>tasks</code>ï¼Œé€ä¸ªé€ä¸ªä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡ï¼Œåªæœ‰ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆäº†ä¸‹ä¸€ä¸ªä»»åŠ¡æ‰ä¼šå¼€å§‹ã€‚</strong>ä¸ªäººè®¤ä¸ºï¼Œä¹Ÿè®¸è¿™ç§è®¾è®¡è¿åˆäº†ä¸€å®šçš„åœºæ™¯éœ€æ±‚ï¼ˆä¸Šä¸‹æ¸¸ä»»åŠ¡é—´å­˜åœ¨ä¾èµ–ï¼‰ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬ç¡®å®æ˜¯éœ€è¦å¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚<strong>å»ºè®®æ”¹æˆå¤šä¸ª<code>goroutine</code>å¹¶å‘æ‰§è¡Œ<code>tasks</code>ä¸­çš„ä»»åŠ¡ï¼Œç„¶åç”¨<code>WaitGroup</code>æ¥é˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚</strong></p>  <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(<span class="built_in">len</span>(r.tasks))</span><br><span class="line"><span class="keyword">for</span> id, task := <span class="keyword">range</span> r.tasks &#123;</span><br><span class="line"><span class="keyword">if</span> r.gotInterrupt() &#123;</span><br><span class="line"><span class="keyword">return</span> ErrInterrupt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å¤šä¸ªgoroutineå¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œç”¨WaitGroupæ¥ç»Ÿä¸€</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">task(id)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>èµ„æºæ± </p><p> ä»€ä¹ˆæ˜¯<strong>èµ„æºæ± </strong>ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªæ”¾æ»¡äº†å„ç§èµ„æºçš„æ± å­ã€‚è®²å¾—â€œä¸“ä¸šâ€ä¸€ç‚¹ï¼Œå°±æ˜¯ä¸€ä¸ªç®¡ç†ç€å¤šä¸ªå¯ç”¨èµ„æºçš„å®¹å™¨ï¼Œå¤–éƒ¨çš„çº¿ç¨‹/åç¨‹å¯å‘èµ„æºæ± ç”³è¯·èµ„æºï¼Œä½¿ç”¨å®Œåå¯ä»¥æŠŠèµ„æºæ”¾å›èµ„æºæ± ï¼Œé‡å¤åˆ©ç”¨ã€‚</p><p> ç›´æ¥æ¥çœ‹çœ‹ã€ŠGo in Actionã€‹ä¸­çš„ä»£ç ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"errors"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµ„æºæ± </span></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">m         sync.Mutex<span class="comment">// mutexç”¨äºæ§åˆ¶åŒæ­¥</span></span><br><span class="line">resources <span class="keyword">chan</span> io.Closer<span class="comment">// å­˜æ”¾èµ„æºçš„ç®¡é“</span></span><br><span class="line">factory   <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(io.Closer, error)</span> // æ–°å»ºèµ„æºçš„å·¥å‚</span></span><br><span class="line"><span class="function"><span class="title">closed</span>    <span class="title">bool</span>// èµ„æºæ± æ˜¯å¦å…³é—­çš„æ ‡å¿—</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// é”™è¯¯ä¿¡å·</span></span><br><span class="line">var ErrPoolClosed = errors.New("Pool has been closed.")</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµ„æºæ± å·¥å‚ï¼Œç”¨äºæ–°å»ºèµ„æºæ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(fn <span class="keyword">func</span>()</span> <span class="params">(io.Closer, error)</span>, <span class="title">size</span> <span class="title">uint</span>) <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"Size value too small."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;Pool&#123;</span><br><span class="line">factory:   fn,</span><br><span class="line">resources: <span class="built_in">make</span>(<span class="keyword">chan</span> io.Closer, size),</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»èµ„æºæ± ä¸­æ‹¿èµ„æº</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Acquire</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> r, ok := &lt;-p.resources:</span><br><span class="line">log.Println(<span class="string">"Acquire:"</span>, <span class="string">"Shared Resource"</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrPoolClosed</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">log.Println(<span class="string">"Acquire:"</span>, <span class="string">"New Resource"</span>)</span><br><span class="line"><span class="keyword">return</span> p.factory()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠèµ„æºæ”¾å›èµ„æºæ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Release</span><span class="params">(r io.Closer)</span></span> &#123;</span><br><span class="line">p.m.Lock()</span><br><span class="line"><span class="keyword">defer</span> p.m.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p.closed &#123;</span><br><span class="line">r.Close()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> p.resources &lt;- r:</span><br><span class="line">log.Println(<span class="string">"Release:"</span>, <span class="string">"In Queue"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">log.Println(<span class="string">"Release:"</span>, <span class="string">"Closing"</span>)</span><br><span class="line">r.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­èµ„æºæ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</span><br><span class="line">p.m.Lock()</span><br><span class="line"><span class="keyword">defer</span> p.m.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p.closed &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.closed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(p.resources)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> r := <span class="keyword">range</span> p.resources &#123;</span><br><span class="line">r.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä»¥ä¸‹è®²è®²å‡ ä¸ªèµ„æºæ± è®¾è®¡ä¸­çš„ç»†èŠ‚ã€‚</p><ul><li>å…³äº<code>factory</code>ã€‚<code>factory</code>æ˜¯ä¸€ä¸ªç”¨æ¥æ–°å»ºèµ„æºçš„å·¥å‚ï¼Œå½“èµ„æºæ± å†…æ²¡æœ‰èµ„æºæ—¶ï¼Œä¸Šè¿°ä»£ç çš„é€»è¾‘æ˜¯é€šè¿‡äº‹å…ˆå®šä¹‰å¥½çš„<code>factory</code>æ¥æ–°å»ºèµ„æºã€‚<strong>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸è¿™ä¹ˆå¹²ã€‚æ ¹æ®ä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œå½“èµ„æºæ± å†…æ²¡æœ‰èµ„æºæ—¶å¯ä»¥é€‰æ‹©é˜»å¡ï¼Œè€Œéæ–°å»ºèµ„æºã€‚</strong></li><li>ç”¨<code>mutex</code>æ¥åŒæ­¥<code>Release()</code>å’Œ<code>Close()</code>ã€‚åœ¨åŒä¸€æ—¶åˆ»ï¼Œä¸èƒ½åŒæ—¶æœ‰å¤šä¸ªåç¨‹è¿›å…¥<code>Release()</code>å’Œè¿›å…¥<code>Close()</code>ã€‚ä¹Ÿå°±æ˜¯è¯´æœ‰åç¨‹åœ¨å…³é—­èµ„æºæ± æ—¶ï¼Œä¸å…è®¸åˆ«çš„åç¨‹æ”¾å›èµ„æºï¼›æœ‰åç¨‹åœ¨æ”¾å›èµ„æºæ—¶ï¼Œä¸å…è®¸åˆ«çš„åç¨‹å…³é—­èµ„æºæ± ã€‚å¦‚æœä¸ç”¨<code>mutex</code>è¿›è¡ŒåŒæ­¥ï¼Œå‡è®¾åŒæ—¶æœ‰åç¨‹Aè¿›å…¥äº†<code>Release()</code>ï¼Œåç¨‹Bè¿›å…¥äº†<code>Close()</code>ã€‚ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå½“åç¨‹Aè¿è¡Œåˆ°selectè¯­å¥å‰å¤±å»äº†cpuèµ„æºï¼Œåç¨‹Bæ­£å¸¸è¿è¡Œå…³é—­äº†<code>resources</code>ç®¡é“ï¼Œåç¨‹Aå†æƒ³å¾€ä¸€ä¸ªå·²å…³é—­äº†çš„<code>resources</code>ç®¡é“é‡Œæ’æ•°æ®ï¼Œä¼šç›´æ¥å¼•èµ·é”™è¯¯ã€‚</li><li><code>resources</code>ç®¡é“æ˜¯ä¸€ä¸ª<code>ç¼“å†²ç®¡é“</code>ã€‚é€šè¿‡å·¥å‚newä¸€ä¸ªèµ„æºæ± æ—¶ï¼Œ<code>resources</code>è¢«å®šä¹‰æˆäº†ä¸€ä¸ªå¤§å°ä¸º<code>size</code>çš„<code>ç¼“å†²ç®¡é“</code>ã€‚ç”¨<code>ç¼“å†²ç®¡é“</code>çš„å¥½å¤„æ˜¯ï¼Œåªæœ‰å½“ç®¡é“<strong>å…¨ç©º</strong>æˆ–è€…<strong>å…¨æ»¡</strong>æ—¶æ‰ä¼šå¯¹ç”Ÿäº§è€…/æ¶ˆè´¹è€…è¿›è¡Œé˜»å¡ï¼Œå…¶ä»–æƒ…å†µä¸‹æ­£å¸¸ç”Ÿäº§/æ¶ˆè´¹èµ„æºã€‚</li></ul></li><li><p>å¹¶å‘æ± </p><p> æ‰€è°“<strong>å¹¶å‘æ± </strong>ï¼Œå°±æ˜¯ä¸€ä¸ªæ”¾äº†Nä¸ªå¾…æ‰§è¡Œä»»åŠ¡çš„æ± å­ï¼Œæˆ–è€…å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ª<strong>å¯å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œå´ä¸å¸¦æœ‰å®šæ—¶åŠŸèƒ½çš„ä»»åŠ¡è®¡æ—¶å™¨ã€‚</strong></p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> work</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»»åŠ¡æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> Worker <span class="keyword">interface</span> &#123;</span><br><span class="line">Task()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶å‘æ± </span></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">work <span class="keyword">chan</span> Worker</span><br><span class="line">wg   sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶å‘æ± å·¥å‚ï¼Œç”¨äºæ–°å»ºå¹¶å‘æ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(maxGoroutines <span class="keyword">int</span>)</span> *<span class="title">Pool</span></span> &#123;</span><br><span class="line">p := Pool&#123;</span><br><span class="line">work: <span class="built_in">make</span>(<span class="keyword">chan</span> Worker),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.wg.Add(maxGoroutines)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; maxGoroutines; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> w := <span class="keyword">range</span> p.work &#123;</span><br><span class="line">w.Task()</span><br><span class="line">&#125;</span><br><span class="line">p.wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤ä»»åŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Run</span><span class="params">(w Worker)</span></span> &#123;</span><br><span class="line">p.work &lt;- w</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­å¹¶å‘æ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Shutdown</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="built_in">close</span>(p.work)</span><br><span class="line">p.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> åŸºæœ¬ä¸Šå®ç°çš„åŠŸèƒ½è·Ÿ<strong>ä¼˜åŒ–å</strong>çš„ä»»åŠ¡è®¡æ—¶å™¨ä¸€æ ·ï¼ˆé™¤äº†ä¸æ”¯æŒå®šæ—¶ï¼‰ï¼Œæ”¯æŒå¤š<code>goroutine</code>å¹¶å‘æ‰§è¡Œã€‚</p></li></ol><h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><ol><li>ä»»åŠ¡è®¡æ—¶å™¨é€‚ç”¨äºå„ç§ç›‘æ§ä»»åŠ¡ï¼Œæˆ–è€…å¯¹æ‰§è¡Œæ—¶é—´æœ‰é™åˆ¶çš„ä»»åŠ¡ã€‚</li><li>èµ„æºæ± å¤šç”¨äºç®¡ç†å„ç§è¿æ¥ï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥ï¼Œæé«˜è¿æ¥çš„å¤ç”¨æ€§ã€‚</li><li>å¹¶å‘æ± å¤šç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œéœ€è¦å¤šä¸ª<code>goroutine</code>å¹¶å‘æ‰§è¡Œå¤šä¸ªå°ä»»åŠ¡ã€‚</li></ol><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ã€ŠGo in Actionã€‹ä¸­ä»‹ç»çš„3ç§å¹¶å‘æ¨¡å¼éƒ½éå¸¸å®ç”¨ï¼Œä¹Ÿæœ‰å¾ˆå¼ºçš„æ™®é€‚æ€§ã€‚ä½†æ˜¯åœ¨å®é™…é¡¹ç›®ä¸­è¿˜æ˜¯éœ€è¦ææ¸…æ¥šå…·ä½“çš„éœ€æ±‚ï¼Œè¦æ¸…æ¥šå®ƒä»¬çš„assumptionå’Œå®ƒä»¬çš„ç¼ºç‚¹ï¼Œå¹¶ä¸æ˜¯100%åœ°é€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼Œè¦åŸºäºè¿™å‡ ç§åŸºæœ¬çš„æ¨¡å¼ä½œæ›´æ·±å±‚æ¬¡çš„è‡ªå®šä¹‰å¼€å‘ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]æ›´æ­£â€œç¥è´´â€ã€Šå¦‚ä½•ä¼˜é›…åœ°å…³é—­Go Channelã€‹</title>
      <link href="/2018/11/20/close-channel/"/>
      <url>/2018/11/20/close-channel/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/11/19ï¼ŒåŸºäº<code>Go 1.11</code>ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>ç°åœ¨åœ¨ç½‘ä¸Šæœç´¢<code>Go</code>ï¼Œ<code>Channel</code>ï¼Œ<code>å…³é—­</code>ç­‰å…³é”®è¯æ—¶ï¼Œä¸€å®šä¼šæœåˆ°ä¸€ç¯‡å¥½å‡ å¹´å‰çš„â€œç¥è´´â€<strong>ã€ŠHow To Gracefully Close Channelsã€‹</strong>ï¼ˆ<a href="https://go101.org/article/channel-closing.html" target="_blank" rel="noopener">åŸæ–‡é“¾æ¥è¯·ç‚¹å‡»</a>ï¼‰ï¼Œæˆ–è€…å„ç§å›½äººæ‰§ç¬”çš„ä¸­æ–‡ç›´è¯‘ç‰ˆ<strong>ã€Šå¦‚ä½•ä¼˜é›…åœ°å…³é—­Go Channelã€‹</strong>ã€‚</p><p>åŸºäº<code>Go</code>æœ¬èº«å¯¹å¹¶å‘çš„å¼ºæ”¯æŒï¼Œä¸æ–­åœ°æœ‰å¼€å‘è€…éœ€è¦å­¦ä¹ <code>Channel</code>è¿™ä¸ªè¢«è®¾è®¡ä¸ºå¤šä¸ª<code>goroutine</code>é—´<strong>å®‰å…¨</strong>ä¼ é€’æ•°æ®çš„å†…ç½®æ•°æ®ç»“æ„ï¼Œè‡ªç„¶ä¹Ÿæœ‰å¾ˆå¤šäººå­¦ä¹ è¿‡ä»¥ä¸Šè¿™ç¯‡æ–‡ç« ã€‚<strong>ç„¶è€Œä¸çŸ¥é“æ˜¯å—å½“æ—¶å†™ä½œçš„æ—¶é—´èƒŒæ™¯é™åˆ¶ï¼Œè¿˜æ˜¯å…¶ä»–åŸå› ï¼Œå®é™…ä¸Šè¿™ç¯‡æ–‡ç« é‡Œæœ‰ä¸€äº›æ¯”è¾ƒä¸¥é‡çš„ç¼ºé™·ï¼Œå¿…é¡»å¾—åˆ°çº æ­£ã€‚</strong></p><p>æˆ‘è¿™ä¹ˆä¸€ä¸ª<code>Go</code>çš„åˆå­¦è€…ï¼Œç ”ç©¶è¿‡åæš‚æ—¶<strong>æ²¡æœ‰</strong>å‘ç°ç½‘ä¸Šå¯¹åŸè´´è¿›è¡Œä¼˜åŒ–æˆ–è€…æ›´æ­£çš„åšå®¢ï¼Œæ‰€ä»¥æˆ‘å†³å®šå†™ä¸‹è¿™ç¯‡æ›´æ­£â€œç¥è´´â€çš„åšå®¢ï¼Œå¹¶æä¾›ä¸€äº›æˆ‘çš„å…³é—­<code>Go Channel</code>çš„è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="é©³æ–¥ç†ç”±"><a href="#é©³æ–¥ç†ç”±" class="headerlink" title="é©³æ–¥ç†ç”±"></a>é©³æ–¥ç†ç”±</h4><ul><li>åŸæ–‡æ ‡é¢˜çš„æ ¸å¿ƒæ˜¯<code>Close Channels</code>ï¼Œç„¶è€Œé™¤äº†ç¬¬ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼ˆM receiversï¼Œone senderï¼‰é‡Œæœ‰å…³é—­æ•°æ®channelçš„é€»è¾‘å¤–ï¼Œå…¶ä»–å‡ ä¸ªå¤æ‚ä¾‹å­ä¸­<strong>å‹æ ¹æ²¡æœ‰close channelï¼Œä»…ä»…åªæ˜¯é€€å‡ºsender</strong></li><li>å³ä½¿æˆ‘ä»¬æŠŠâ€œé€€å‡ºsenderâ€ç­‰ä»·äºâ€œclose channelâ€ã€‚ä½†æ˜¯åŒæ ·é™¤äº†ç¬¬ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼ˆM receiversï¼Œone senderï¼‰é‡Œæ˜¯senderä¸»åŠ¨å…³é—­å¤–ï¼Œå…¶ä»–å‡ ä¸ªä¾‹å­ä¸­é€€å‡ºsenderéƒ½æ˜¯ç”±receiverè§¦å‘çš„ï¼Œç±»ä¼¼receiverè¯»åˆ°ä¸€ä¸ªä»€ä¹ˆç‰¹æ®Šå€¼å°±æç¤ºsenderåœæ­¢ç”Ÿäº§ã€‚<strong>æˆ‘ä¸å¦è®¤åœ¨æŸäº›åœºæ™¯é‡Œç¡®å®éœ€è¦receiveræç¤ºsenderä½•æ—¶ç»“æŸ</strong>ï¼ˆä¾‹å¦‚receiverå‘ç”Ÿäº†å¼‚å¸¸ï¼Œæ— æ³•ç»§ç»­å¤„ç†ï¼Œå¯é€šçŸ¥senderèµ¶ç´§ç»“æŸï¼‰ã€‚<strong>ä½†æ˜¯åœ¨å¾ˆå¤šåœºæ™¯é‡Œæ˜¯éœ€è¦senderè‡ªå·±è§¦å‘åœæ­¢ç”Ÿäº§çš„ï¼Œè€Œä¸æ˜¯è®©receiverå‘ŠçŸ¥æ‰åœæ­¢</strong>ï¼ˆä¾‹å¦‚100ä¸ªsenderåˆ†åˆ«è¯»100å°æœºå™¨ä¸Šçš„æ–‡ä»¶ï¼Œç„¶åæŠŠæ–‡ä»¶æ•°æ®æ€¼åˆ°ä¸€ä¸ªchannelé‡Œï¼Œæ­¤æ—¶è‚¯å®šä¸å¯èƒ½è®©receiveræ¥ä¸»å¯¼senderçš„æ•°æ®è¯»å–ä½•æ—¶åœæ­¢ï¼Œå¯¹å§ï¼‰ã€‚</li><li>æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒåŸè´´ä¾‹å­é‡Œreceiverè¯»åˆ°ä¸€ä¸ªç‰¹æ®Šå€¼å¯¼è‡´é€€å‡ºåï¼Œå¹¶æ²¡æœ‰å®‰æ’åˆ«çš„<code>goroutine</code>å»è¯»å®Œchannelä¸­å¯èƒ½å‰©ä¸‹çš„æ•°æ®ï¼Œç›´æ¥å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ï¼ˆå½“ç„¶ä½œè€…ä¹Ÿæ„è¯†åˆ°è¿™ä¸€ç‚¹äº†ï¼Œæ‰€ä»¥åœ¨æœ€åæäº†ä¸€ä¸‹ï¼Œè¯´è¯»å®Œå‰©ä¸‹çš„æ•°æ®å¾ˆç®€å•blablaï¼Œæˆ‘å°±ä¸å†™äº†ä½ ä»¬è‡ªå·±å»å®ç°å°±å¥½äº†ï¼‰</li></ul><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>å…¶å®å¾ˆæ˜æ˜¾ï¼Œå…³é—­channelæœ€ä¸»è¦çš„éº»çƒ¦åœ¨äºsenderç«¯å¦‚ä½•æ§åˆ¶ï¼Œæ—¢ä¸èƒ½ä¸å»å…³é—­ï¼Œä¹Ÿä¸èƒ½é‡å¤å…³é—­ï¼ˆ<code>panic</code>ï¼‰ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å°±è®¨è®ºä¸¤ç§åœ¨senderç«¯å…³é—­channelçš„è§£å†³æ–¹æ¡ˆï¼šå•ä¸ªsenderå’Œå¤šä¸ªsenderçš„åº”ç”¨åœºæ™¯ã€‚</p><ul><li><p>å•ä¸ªsender</p>  <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€ä¸ªsenderï¼Œä¸€ä¸ªreceiver</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dataChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">go</span> sender(dataChannel)</span><br><span class="line"><span class="keyword">go</span> receiver(dataChannel, done)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜»å¡ç›´åˆ°receiverå®Œæˆï¼Œé¿å…ä¸»çº¿ç¨‹é©¬ä¸Šé€€å‡º</span></span><br><span class="line">&lt;-done</span><br><span class="line">fmt.Println(<span class="string">"Done."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sender</span><span class="params">(dataChannel <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(dataChannel)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>;i &lt; <span class="number">1000</span>;i++ &#123;</span><br><span class="line">dataChannel &lt;- i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">receiver</span><span class="params">(dataChannel <span class="keyword">chan</span> <span class="keyword">int</span>, done <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> data := <span class="keyword">range</span> dataChannel &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Receive data %d\n"</span>, data)</span><br><span class="line">&#125;</span><br><span class="line">done &lt;- <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  åœ¨å•ä¸ªsenderçš„åœºæ™¯ä¸‹ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ã€‚å…¶å®å°±æ˜¯å½“senderæŠŠæ‰€æœ‰æ•°æ®éƒ½å¡åˆ°channelä¹‹åä¸»åŠ¨å…³é—­è¯¥channelã€‚**æ˜¾å¼close channelçš„å¥½å¤„æ˜¯ï¼Œå½“receiverç«¯ä½¿ç”¨<figure class="highlight plain"><figcaption><span>range```ä»channelä¸­è¯»æ•°æ®ï¼Œè¯»åˆ°closeæ ‡è¯†åä¼šè‡ªåŠ¨ç»“æŸå¾ªç¯ã€‚ï¼ˆæˆ–è€…æ˜¯æ™®é€šå¾ªç¯é‡Œçš„okæ ‡è¯†ä¸ºfalseï¼Œç”¨æ¥ç»“æŸå¾ªç¯ï¼‰**</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ å¤šä¸ªsender</span><br><span class="line"></span><br><span class="line">```golang</span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// å¤šä¸ªsenderï¼Œä¸€ä¸ªreceiver</span><br><span class="line">const (</span><br><span class="line">SENDER_COUNT = 5</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func sender(id int, dataChannel chan string, wg *sync.WaitGroup) &#123;</span><br><span class="line">defer wg.Done()</span><br><span class="line">for i := 0;i &lt; 100;i++ &#123;</span><br><span class="line">dataChannel &lt;- fmt.Sprintf(&quot;Sender %d is sending %d&quot;, id, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func receiver(dataChannel chan string, done chan interface&#123;&#125;) &#123;</span><br><span class="line">for data := range dataChannel &#123;</span><br><span class="line">fmt.Printf(&quot;Receive data: %s\n&quot;, data)</span><br><span class="line">&#125;</span><br><span class="line">done &lt;- nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func monitor(dataChannel chan string, wg *sync.WaitGroup) &#123;</span><br><span class="line">wg.Wait()</span><br><span class="line">close(dataChannel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">dataChannel := make(chan string, 100)</span><br><span class="line">done := make(chan interface&#123;&#125;)</span><br><span class="line">wg := &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(SENDER_COUNT)</span><br><span class="line"></span><br><span class="line">go monitor(dataChannel, wg)</span><br><span class="line">for i := 0;i &lt; SENDER_COUNT;i++ &#123;</span><br><span class="line">go sender(i, dataChannel, wg)</span><br><span class="line">&#125;</span><br><span class="line">go receiver(dataChannel, done)</span><br><span class="line"></span><br><span class="line">&lt;-done</span><br><span class="line">fmt.Println(&quot;Done.&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>  å‚ç…§ä»¥ä¸Šä»£ç ï¼Œæ ¸å¿ƒçš„æ€æƒ³æ˜¯åˆ©ç”¨<code>sync</code>åŒ…è‡ªå¸¦çš„<code>WaitGroup</code>ï¼ˆç±»ä¼¼äº<code>Java</code>é‡Œ<code>J.U.C</code>åŒ…çš„<code>CountdownLatch</code>ï¼‰ï¼Œç”¨æ¥ç»Ÿè®¡å·²å®Œæˆå·¥ä½œçš„senderæ•°ã€‚é™¤äº†senderå’Œreceiverå¤–ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªmonitoråç¨‹ï¼Œç”¨æ¥å…³é—­channelã€‚</p><p>  å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰äº†1ä¸ªmonitorï¼Œ1ä¸ªreceiverï¼Œ5ä¸ªsenderï¼Œå¹¶ä¸”åœ¨å¯åŠ¨senderä¹‹å‰å…ˆå¯åŠ¨äº†monitorï¼Œä¼ å…¥<code>waitGroup</code>ï¼Œè®©å…¶ç­‰å¾…æ‰€æœ‰senderåç¨‹å®Œæˆå·¥ä½œã€‚åœ¨senderé‡Œï¼Œé€šè¿‡<code>defer</code>æ¥ä¿è¯senderåœ¨å®Œæˆä½œä¸šï¼ˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸ï¼‰ä¹‹åèƒ½å¤Ÿé€šçŸ¥<code>waitGroup</code>ã€‚å½“æ‰€æœ‰senderéƒ½å®Œæˆå·¥ä½œåï¼Œ<code>waitGroup</code>è®¡æ•°è‡ªç„¶å‡ä¸º0ï¼Œmonitoråç¨‹ä¸»åŠ¨å…³é—­äº†æ•°æ®channelï¼Œæ‰€ä»¥receiverç«¯çš„<code>for range</code>å¾ªç¯åœ¨è¯»å®Œæ‰€æœ‰æ•°æ®åå°±èƒ½æ­£å¸¸é€€å‡ºã€‚</p></li></ul><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ¬æ–‡æ˜¯å¯¹ã€ŠHow To Gracefully Close Channelsã€‹çš„æ ¸å¿ƒå†…å®¹è¡¨ç¤ºè´¨ç–‘ï¼Œå¹¶ä¸”æå‡ºäº†æˆ‘è‡ªå·±çš„è§£å†³æ–¹æ¡ˆã€‚<strong>å…¶å®åŸæ–‡é‡Œä½œè€…æä¾›çš„è§£å†³æ–¹æ¡ˆå¹¶ä¸æ˜¯é”™è¯¯çš„ï¼Œé‡Œé¢çš„æ–¹æ¡ˆå¯¹éƒ¨åˆ†åœºæ™¯è‚¯å®šæ˜¯é€‚ç”¨çš„ã€‚åªæ˜¯å¯¹senderç«¯ä¸»åŠ¨å…³é—­çš„åœºæ™¯è€Œè¨€æœ‰ä¸€å®šçš„çº°æ¼ã€‚</strong></p><p>å¸Œæœ›è¯»è€…èƒ½ç†è§£ä¸åŒåœºæ™¯ä¸‹åº”è¯¥æœ‰ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼Œå…·ä½“è¿˜æ˜¯è¦ç»“åˆå®é™…é¡¹ç›®æ¥åˆ†æã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]å¥‡æ€ªçš„â€œç±»â€å’Œå¤šæ€ï¼ˆPolymorphismï¼‰</title>
      <link href="/2018/11/15/polymorphism/"/>
      <url>/2018/11/15/polymorphism/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/11/14ï¼ŒåŸºäº<code>Go 1.11</code>ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p><code>å¤šæ€</code>è¿™ä¸ªè¯è¯­æ¯ä¸ªå¼€å‘è€…éƒ½ä¸€å®šä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿã€‚å› ä¸ºåœ¨å¾ˆå¤šä¸åŒçš„ç¼–ç¨‹è¯­è¨€é‡Œé¢ï¼Œå¤šæ€éƒ½æ˜¯æœ‰å…·ä½“å®ç°çš„ã€‚ä¾‹å¦‚åœ¨C++é‡Œé¢æˆ‘ä»¬å¯èƒ½ä¼šè¯´çˆ¶ç±»çš„æŒ‡é’ˆå¯ä»¥æŒ‡å‘å­ç±»çš„å¯¹è±¡ï¼Œåœ¨Javaé‡Œé¢è™½ç„¶æ²¡æœ‰æŒ‡é’ˆè¿™æ ·çš„æ¦‚å¿µï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¼šè¯´ï¼Œå¦‚æœæŸä¸ªå­ç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£çš„å¼•ç”¨å°±å¯ä»¥å¼•ç”¨è¿™ä¸ªå­ç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p><p>ä½†æ˜¯ç±»ä¼¼äºC++å’ŒJavaé‡Œé¢çš„å®ç°åŸºæœ¬ä¸Šéƒ½æ˜¯åŸºäºæ¥å£å’Œç±»çš„ç›¸äº’åˆä½œå»æ„å»ºçš„ã€‚è€Œåœ¨Goé‡Œé¢ï¼Œæ˜¯æœ‰æ¥å£çš„å®šä¹‰ï¼Œä½†æ˜¯å¹¶ä¸å­˜åœ¨ä¸¥æ ¼æ„ä¹‰ä¸Šçš„ç±»ï¼ˆClassï¼‰ï¼Œåªæ˜¯å•çº¯çš„ç»“æ„ä½“ï¼ˆStructï¼‰ï¼Œè€Œä¸”å®ç°æ–¹æ³•æ—¶è¿˜æœ‰ç•¥æ˜¾å¥‡è‘©çš„<code>Receiver</code>æœºåˆ¶ã€‚æ‰€ä»¥æœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯æ¥æ¢ç´¢ä¸€ä¸‹åœ¨Goè¯­è¨€é‡Œé¢å¤šæ€æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä»¥åŠåœ¨Goè¯­è¨€æ—¶å®ç°å¤šæ€çš„è¿‡ç¨‹ä¸­æœ‰å“ªäº›å¥‡å¥‡æ€ªæ€ªçš„å‘ã€‚</p><h4 id="ç±»ã€æ–¹æ³•ã€å¤šæ€"><a href="#ç±»ã€æ–¹æ³•ã€å¤šæ€" class="headerlink" title="ç±»ã€æ–¹æ³•ã€å¤šæ€"></a>ç±»ã€æ–¹æ³•ã€å¤šæ€</h4><ol><li><p>åŸºæœ¬æ¥å£å®ç°</p><p> é¦–å…ˆçœ‹çœ‹ä¸€ä¸‹åœ¨Goè¯­è¨€é‡Œé¢å¦‚ä½•å»å®ç°ä¸€ä¸ªæ¥å£ï¼Œå…¶å®å°±æ˜¯è®©ä¸€ä¸ªç»“æ„ä½“å»å®ç°æ¥å£é‡Œå®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½†æ˜¯åœ¨Goé‡Œé¢ç»“æ„ä½“ï¼ˆStructï¼‰å¹¶ä¸æ˜¯æˆ‘ä»¬åœ¨Javaä¸­è®¤çŸ¥çš„ç±»ï¼ˆClassï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰€è°“çš„å®ç°ä¸€ä¸ªæ–¹æ³•æ˜¯è¦å†™åœ¨ç»“æ„ä½“çš„å¤–éƒ¨ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªæ–¹æ³•å®šä¹‰ä¸€ä¸ªæ¥æ”¶è€…ï¼ˆReceiverï¼‰ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Humanæ¥å£ï¼Œå†…å«breathe()æ–¹æ³•ï¼Œå› ä¸ºæ‰€æœ‰äººç±»éƒ½èƒ½å‘¼å¸</span></span><br><span class="line"><span class="keyword">type</span> Human <span class="keyword">interface</span> &#123;</span><br><span class="line">breathe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ç”Ÿç»“æ„ä½“ï¼Œå†…å«å§“åå’Œå¹´é¾„</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Studentç±»çš„breatheæ–¹æ³•ï¼Œå®ç°äº†Humanæ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Student)</span> <span class="title">breathe</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I can breathe."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Receiverçš„é€‰æ‹©</p><p> åœ¨ä¸ºæ¯ä¸ªæ–¹æ³•å®šä¹‰Receiverçš„æ—¶å€™ï¼Œä¸ä»…å¯ä»¥æŠŠReceiverå®šä¹‰ä¸ºä¸€ä¸ªç»“æ„ä½“çš„å¯¹è±¡ï¼ˆå€¼ï¼‰ï¼Œè¿˜å¯ä»¥å®šä¹‰ä¸ºè¯¥ç»“æ„ä½“çš„ä¸€ä¸ªæŒ‡é’ˆã€‚å½“ä½ éœ€è¦å¯¹æŸä¸ªå¯¹è±¡ï¼ˆå€¼ï¼‰é‡Œé¢çš„å±æ€§åšä¿®æ”¹çš„æ—¶å€™ï¼Œä¾‹å¦‚æ›´æ–°æˆ–è€…åˆ é™¤åŸå€¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šæŠŠReceiverå®šä¹‰ä¸ºç»“æ„ä½“çš„<strong>æŒ‡é’ˆ</strong>ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Driveræ¥å£ï¼Œå†…å«updateLicense()æ–¹æ³•ï¼Œå› ä¸ºå¸æœºæœ‰æ—¶éœ€è¦æ›´æ–°é©¾ç…§ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">type</span> Driver <span class="keyword">interface</span> &#123;</span><br><span class="line">updateLicense()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Manç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Man <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">license <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Mançš„updateLicenseæ–¹æ³•ï¼Œå®ç°äº†Driveræ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Man)</span> <span class="title">updateLicense</span><span class="params">()</span></span> &#123;</span><br><span class="line">m.license = <span class="string">"new license"</span></span><br><span class="line">fmt.Println(<span class="string">"License is updated."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•è°ƒç”¨</p><p> æ— è®ºä½ æ˜¯ç”¨æŒ‡é’ˆè¿˜æ˜¯ç”¨æŸä¸ªç»“æ„ä½“å…·ä½“çš„å€¼ï¼Œéƒ½å¯ä»¥ç›´æ¥å¯¹è¯¥ç»“æ„ä½“æ‰€å®ç°çš„æ–¹æ³•è¿›è¡Œç›´æ¥çš„è°ƒç”¨ã€‚å½“ä½ ä½¿ç”¨æŒ‡é’ˆè°ƒç”¨æŸä¸ªæ¥æ”¶è€…æ˜¯å€¼çš„æ–¹æ³•æ—¶ï¼ŒGoè¯­è¨€çš„å†…éƒ¨ä¼šå¸®ä½ æŠŠæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ˆå€¼ï¼‰æ‰¾å‡ºæ¥ï¼Œç„¶åå†è¿›è¡Œè°ƒç”¨ã€‚å¦‚æœæŸä¸ªæ–¹æ³•çš„æ¥æ”¶è€…æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ç”¨å¯¹è±¡ï¼ˆå€¼ï¼‰æ¥è¿›è¡Œè°ƒç”¨ã€‚è¿™æ˜¯å› ä¸ºgoè¯­è¨€å†…éƒ¨ä¼šè‡ªåŠ¨æŠŠå¯¹è±¡ï¼ˆå€¼ï¼‰çš„åœ°å€æ‰¾åˆ°ï¼Œç„¶åæ„å»ºå‡ºæŒ‡å‘è¯¥å¯¹è±¡ï¼ˆå€¼ï¼‰çš„æŒ‡é’ˆï¼Œå°±å¯ä»¥é¡ºåˆ©è¿›è¡Œè°ƒç”¨ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å­¦ç”Ÿç»“æ„ä½“ï¼Œå†…å«å§“åå’Œå¹´é¾„</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Student)</span> <span class="title">breathe</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I can breathe."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receiverä¸ºæŒ‡é’ˆçš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Student)</span> <span class="title">grow</span><span class="params">()</span></span> &#123;</span><br><span class="line">s.age += <span class="number">1</span></span><br><span class="line">fmt.Println(<span class="string">"Grow older."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">student := Student&#123;name: <span class="string">"hh"</span>, age: <span class="number">18</span>&#125; <span class="comment">//å­¦ç”Ÿå¯¹è±¡ï¼ˆå€¼ï¼‰</span></span><br><span class="line">pointer := &amp;student <span class="comment">//æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">student.breathe() <span class="comment">//ç›´æ¥è°ƒç”¨æ­£å¸¸ï¼Œæ‰“å°å‡ºI can breathe.</span></span><br><span class="line">pointer.breathe() <span class="comment">//é€šè¿‡æŒ‡é’ˆè°ƒç”¨ä¹Ÿæ­£å¸¸ï¼Œä¹Ÿæ‰“å°å‡ºI can breathe.</span></span><br><span class="line"></span><br><span class="line">student.grow() <span class="comment">//ç›´æ¥è°ƒç”¨æ­£å¸¸ï¼Œæ‰“å°å‡ºGrow older</span></span><br><span class="line">pointer.grow() <span class="comment">//é€šè¿‡æŒ‡é’ˆè°ƒç”¨ä¹Ÿæ­£å¸¸ï¼Œä¹Ÿæ‰“å°å‡ºGrow older</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºæŸä¸ªæ–¹æ³•çš„Receiveræ˜¯å¯¹è±¡ï¼ˆå€¼ï¼‰è¿˜æ˜¯æŒ‡é’ˆï¼Œéƒ½å¯ä»¥é€šè¿‡å¯¹è±¡ï¼ˆå€¼ï¼‰æˆ–è€…æŒ‡é’ˆæ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨ã€‚</strong>å†ä»”ç»†æƒ³ä¸€æƒ³ä¹Ÿæ˜¯éå¸¸åˆç†çš„ï¼Œå› ä¸ºGoå†…éƒ¨å¯ä»¥è½»æ¾åœ°æ‰¾åˆ°ä¸€ä¸ªå¯¹è±¡ï¼ˆå€¼ï¼‰çš„åœ°å€ï¼Œè‡ªç„¶å°±èƒ½æ„å»ºå‡ºæŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼ˆ<code>&amp;obj</code>ï¼‰ï¼Œè°ƒç”¨Receiverä¸ºæŒ‡é’ˆçš„æ–¹æ³•ï¼›å¦å¤–ä¹Ÿå¾ˆå®¹æ˜“é€šè¿‡æŒ‡é’ˆæ‰¾åˆ°å…¶æŒ‡å‘çš„å¯¹è±¡ï¼ˆå€¼ï¼‰ï¼ˆ<code>*p</code>ï¼‰ï¼Œè‡ªç„¶ä¹Ÿèƒ½è½»æ¾è°ƒç”¨Receiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰çš„æ–¹æ³•ã€‚</p></li><li><p>æœ€ç®€å•çš„å¤šæ€ç¤ºä¾‹</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Humanæ¥å£ï¼Œå†…å«breathe()æ–¹æ³•ï¼Œå› ä¸ºæ‰€æœ‰äººç±»éƒ½èƒ½å‘¼å¸</span></span><br><span class="line"><span class="keyword">type</span> Human <span class="keyword">interface</span> &#123;</span><br><span class="line">breathe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ç”Ÿç»“æ„ä½“ï¼Œå†…å«å§“åå’Œå¹´é¾„</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Studentç±»çš„breatheæ–¹æ³•ï¼Œå®ç°äº†Humanæ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Student)</span> <span class="title">breathe</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I can breathe."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å¤šæ€çš„Testæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(h Human)</span></span> &#123;</span><br><span class="line">h.breathe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">student := Student&#123;name: <span class="string">"hh"</span>, age: <span class="number">18</span>&#125;</span><br><span class="line">Test(student) <span class="comment">//æ‰“å°å‡ºI can breathe.</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä¸Šè¿°æ˜¯æœ€ç®€å•ç›´æ¥æè¿°<code>å¤šæ€</code>çš„ä»£ç ä¾‹å­ï¼Œ<code>Test</code>æ–¹æ³•çš„å…¥å‚æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼ˆ<code>Human</code>ï¼‰ï¼Œ<strong>åªè¦å®ç°äº†<code>Human</code>æ¥å£çš„ä»»ä¸€ç±»å‹çš„å¯¹è±¡éƒ½å¯ä»¥ä¼ è¿›å»ï¼Œå¯ä»¥æ˜¯è¿™é‡Œçš„<code>Student</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>Driver</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>Teacher</code>ã€‚æ— æ‰€è°“ï¼Œåªè¦å®ç°äº†<code>Human</code>æ¥å£å°±æ²¡é—®é¢˜ã€‚</strong></p></li><li><p>å®ç°å¤šæ€æ—¶è¯¡å¼‚çš„æŠ¥é”™</p><p> åœ¨ä¸Šé¢æœ€ç®€å•çš„å¤šæ€ä¾‹å­é‡Œï¼Œ<code>Student</code>å®ç°äº†<code>Human</code>æ¥å£ï¼Œå®ç°äº†ä¸€ä¸ªä»¥å€¼ä¸ºReceiverçš„<code>breathe()</code>æ–¹æ³•ï¼Œä¾¿å¯æˆåŠŸä¼ å…¥<code>Test</code>æ–¹æ³•é‡Œã€‚<strong>é‚£å‡å¦‚æ¥å£ä¸­å£°æ˜äº†ä¸æ­¢ä¸€ä¸ªæ–¹æ³•ï¼Œä¸”å®ç°æ—¶Receiverä¸ä¸€å®šæ˜¯å€¼ï¼Œè¿˜å¯èƒ½æ˜¯æŒ‡é’ˆå‘¢ï¼Ÿé‚£æ ·å¯ä»¥å—ï¼Ÿ</strong></p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Humanæ¥å£ï¼Œå†…å«breathe()å’Œgrow()</span></span><br><span class="line"><span class="keyword">type</span> Human <span class="keyword">interface</span> &#123;</span><br><span class="line">breathe()</span><br><span class="line">grow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ç”Ÿç»“æ„ä½“ï¼Œå†…å«å§“åå’Œå¹´é¾„</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Humanæ¥å£ä¸­çš„breathe()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Student)</span> <span class="title">breathe</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I can breathe."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Humanæ¥å£ä¸­çš„grow()ï¼Œå› ä¸ºè¦æ”¹å˜ageå±æ€§ï¼Œæ‰€ä»¥Receiverä¸ºæŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Student)</span> <span class="title">grow</span><span class="params">()</span></span> &#123;</span><br><span class="line">s.age += <span class="number">1</span></span><br><span class="line">fmt.Println(<span class="string">"I can grow."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å¤šæ€çš„Testæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(h Human)</span></span> &#123;</span><br><span class="line">h.breathe()</span><br><span class="line">h.grow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">student := Student&#123;name: <span class="string">"hh"</span>, age: <span class="number">18</span>&#125;</span><br><span class="line">Test(student) <span class="comment">// æ­¤å¤„æŠ¥é”™ï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// cannot use student (type Student) as type Human in argument to Test:</span></span><br><span class="line"><span class="comment">// Student does not implement Human (grow method has pointer receiver)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä»ä¸Šè¿°ä»£ç çš„æŠ¥é”™ä¸­çœ‹åˆ°ï¼Œ<code>Student</code>æ²¡æœ‰å®ç°<code>Human</code>æ¥å£ï¼Œå› ä¸º<code>grow</code>æ–¹æ³•çš„Receiveræ˜¯æŒ‡é’ˆï¼Ÿï¼Ÿï¼Ÿ<strong>å¯æ˜¯æˆ‘æ˜æ˜å®ç°äº†<code>grow</code>æ–¹æ³•å•Šï¼Œåªæ˜¯å®ƒçš„Receiveræ˜¯æŒ‡é’ˆè€Œå·²ï¼éš¾é“<code>*Student</code>å’Œ<code>Student</code>å±…ç„¶è¢«è®¤ä¸ºæ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼Ÿï¼Ÿï¼Ÿ</strong></p><p> <strong>æ²¡é”™ï¼åœ¨Goçš„è®¾è®¡ç†å¿µä¸­ï¼Œ<code>type pointer</code>å’Œ<code>type value</code>ç¡®å®å°±æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼</strong></p><p> <strong>æ‰€ä»¥å¦‚æœæƒ³è®©æŸä¸ªç»“æ„ä½“å®ç°ä¸€ä¸ªæ¥å£ï¼Œå¿…é¡»è¦åˆ†ç¦»å¼€æ¥æ€è€ƒï¼Œä½ åˆ°åº•æ˜¯æƒ³è®©<code>type pointer</code>å®ç°è¿˜æ˜¯æƒ³è®©<code>type value</code>å®ç°ï¼Ÿ</strong></p><p> è¿™ä¸ªæ—¶å€™ï¼Œæ­£å¸¸äººéƒ½ä¼šæƒ³ï¼šæˆ‘è¦å®ç°ä¸€äº›éœ€è¦æ”¹å˜å¯¹è±¡å±æ€§å€¼çš„æ–¹æ³•ï¼ˆåƒä¸Šé¢çš„<code>grow()</code>ï¼‰ï¼Œå½“ç„¶éœ€è¦è®©è¿™äº›æ–¹æ³•çš„Receiverä¸ºæŒ‡é’ˆï¼Œä¸ç„¶æ€ä¹ˆæ”¹å˜å¯¹è±¡å†…éƒ¨çš„å±æ€§å€¼å•Šï¼Ÿè€Œå¯¹äºé‚£äº›ä¸éœ€è¦æ”¹å˜å¯¹è±¡å±æ€§å€¼çš„æ–¹æ³•ï¼ŒReceiverä¸ºæŒ‡é’ˆä¹Ÿä¸ä¼šå‡ºé”™ï¼Œé¡¶å¤šå°±æ˜¯çœ‹ç€ä¸è§„èŒƒè€Œå·²ã€‚<strong>å¥½ï¼Œé‚£å°±æŠŠæ‰€æœ‰å®ç°çš„æ–¹æ³•çš„Receiveréƒ½æ”¹æˆæŒ‡é’ˆï¼Œè‚¯å®šèƒ½æ­£å¸¸å®ç°é‚£ä¸ªæ¥å£~</strong> äºæ˜¯ä¾¿æœ‰äº†ä¸‹é¢çš„ä»£ç ğŸ‘‡</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Humanæ¥å£ï¼Œå†…å«breathe()å’Œgrow()</span></span><br><span class="line"><span class="keyword">type</span> Human <span class="keyword">interface</span> &#123;</span><br><span class="line">breathe()</span><br><span class="line">grow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ç”Ÿç»“æ„ä½“ï¼Œå†…å«å§“åå’Œå¹´é¾„</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨æ”¹æˆæŒ‡é’ˆReceiverï¼Œç¾æ»‹æ»‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Student)</span> <span class="title">breathe</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I can breathe."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨æ”¹æˆæŒ‡é’ˆReceiverï¼Œç¾æ»‹æ»‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Student)</span> <span class="title">grow</span><span class="params">()</span></span> &#123;</span><br><span class="line">s.age += <span class="number">1</span></span><br><span class="line">fmt.Println(<span class="string">"I can grow."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å¤šæ€çš„Testæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(h Human)</span></span> &#123;</span><br><span class="line">h.breathe()</span><br><span class="line">h.grow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">student := Student&#123;name: <span class="string">"hh"</span>, age: <span class="number">18</span>&#125;</span><br><span class="line">Test(student) <span class="comment">// æ­¤å¤„è¿˜æ˜¯æŠ¥é”™ï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// Cannot use 'student' (type Student) as type Human </span></span><br><span class="line"><span class="comment">// Type does not implement 'Human' as 'breathe' method has a pointer receiver less... (âŒ˜F1) </span></span><br><span class="line"><span class="comment">//Inspection info: Reports incompatible types.</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>åˆå‡ºé”™äº†ï¼Ÿï¼ç”šè‡³éƒ½ä¸ç”¨runï¼ŒIDEç›´æ¥æŠ¥é”™ï¼Ÿï¼</strong> <strong>ä¹‹å‰è¯´å¥½çš„æŒ‡é’ˆå’Œå¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯ä»¥éšä¾¿äº’æ¢ä½¿ç”¨å‘¢ï¼Ÿï¼Ÿï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œä¸è¡Œäº†ï¼Ÿï¼Ÿï¼Ÿ</strong></p><p> æ­¤æ—¶å°±è¦æ¬å‡º<code>Go specification</code>é‡Œçš„ç»å…¸è¡¨æ ¼æ¥è§£é‡Šè¿™ä¸ªè¡¨å±‚ç°è±¡äº†ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€‚</p><p> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/gospec.png" alt=""></p><p> æ³¨æ„çœ‹ç¬¬äºŒä¸ªè¡¨æ ¼ã€‚ç¬¬ä¸€è¡Œï¼šå½“<code>Methods Receivers</code>ä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰ï¼ˆ<code>t T</code>ï¼‰çš„æ—¶å€™ï¼Œå¯ç”¨å¯¹è±¡ï¼ˆå€¼ï¼‰æˆ–è€…æŒ‡é’ˆä½œä¸ºå¤šæ€æ–¹æ³•çš„æ¥å£å‚æ•°ï¼›ç¬¬äºŒè¡Œï¼šå½“<code>Methods Receivers</code>ä¸ºæŒ‡é’ˆæ—¶ï¼Œåªèƒ½ç”¨æŒ‡é’ˆä½œä¸ºå¤šæ€æ–¹æ³•çš„æ¥å£å‚æ•°ã€‚æˆ‘ä»¬å®ç°çš„æ–¹æ³•çš„Receiverå…¨éƒ½æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ ä¸€ä¸ªå¯¹è±¡ï¼ˆå€¼ï¼‰è¿›å»ï¼Œåƒ<code>Test(student)</code>å°±ä¼šæŠ¥é”™ã€‚<strong>å¦‚æœæˆ‘ä»¬æŠŠmainä¸­çš„ä»£ç æ”¹æˆ<code>Test(&amp;student)</code>ï¼Œç”¨æŒ‡é’ˆä½œä¸ºæ–¹æ³•çš„å¤šæ€æ¥å£å‚æ•°ï¼Œè‡ªç„¶å°±ä¸ä¼šæŠ¥é”™äº†ã€‚</strong></p><p> <strong>ä½†è¿™äº›åªæ˜¯è¡¨å±‚ç°è±¡ï¼Œå†ç ”ç©¶å¾—æ·±å…¥ä¸€ç‚¹ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼ŸåŸæ¥æˆ‘ä»¬ä¸€ç›´è®¤ä¸ºâ€œæœ‰äº†å¯¹è±¡ï¼ˆå€¼ï¼‰å°±ä¸€å®šèƒ½æ‰¾åˆ°å®ƒçš„åœ°å€ï¼Œä»è€Œæ„å»ºå‡ºæŒ‡å‘å®ƒè‡ªå·±çš„æŒ‡é’ˆâ€ï¼Œå…¶å®è¿™ç§æƒ³æ³•åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ˜¯æœ‰é—®é¢˜çš„ã€‚</strong>åœ¨<code>Go In Action</code>ä¸€ä¹¦ä¸­ç»™å‡ºäº†ä¸€æ®µç¤ºæ„ä»£ç ï¼Œå±•ç¤ºäº†ä¸ºä»€ä¹ˆæœ‰çš„æ—¶å€™æ˜¯æ‰¾ä¸åˆ°å¯¹è±¡ï¼ˆå€¼ï¼‰çš„åœ°å€çš„ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€‚</p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="number">01</span> <span class="comment">// Sample program to show how you can't always get the</span><span class="number">02</span> <span class="comment">// address of a value.</span><span class="number">03</span> <span class="keyword">package</span> main<span class="number">04</span><span class="number">05</span> <span class="keyword">import</span> <span class="string">"fmt"</span><span class="number">06</span><span class="number">07</span> <span class="comment">// duration is a type with a base type of int.</span><span class="number">08</span> <span class="keyword">type</span> duration <span class="keyword">int</span><span class="number">09</span><span class="number">10</span> <span class="comment">// format pretty-prints the duration value.</span><span class="number">11</span> <span class="function"><span class="keyword">func</span> <span class="params">(d *duration)</span> <span class="title">pretty</span><span class="params">()</span> <span class="title">string</span></span> &#123;<span class="number">12</span>     <span class="keyword">return</span> fmt.Sprintf(<span class="string">"Duration: %d"</span>, *d)<span class="number">13</span> &#125;<span class="number">14</span><span class="number">15</span> <span class="comment">// main is the entry point for the application.</span><span class="number">16</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;<span class="number">17</span>     duration(<span class="number">42</span>).pretty()<span class="number">18</span><span class="number">19</span>     <span class="comment">// cannot call pointer method on duration(42)</span><span class="number">20</span>     <span class="comment">// cannot take the address of duration(42)</span><span class="number">21</span> &#125;</span><br></pre></td></tr></table></figure><p> <strong>å½“ä½ æ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡ï¼ˆå€¼ï¼‰ï¼Œä½ æœ‰å¯èƒ½æ‹¿ä¸åˆ°å®ƒçš„åœ°å€ï¼Œé‚£å°±æ²¡æœ‰åŠæ³•æ„å»ºå‡ºæŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰åŠæ³•è®¿é—®åˆ°Receiverä¸ºæŒ‡é’ˆçš„é‚£äº›æ–¹æ³•ã€‚æ‰€ä»¥è¯¥å¯¹è±¡æ‰€æ‹¥æœ‰çš„æ–¹æ³•é›†åˆï¼ˆ<code>Method Set</code>ï¼‰ä¸­åªåŒ…å«Receiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰çš„é‚£éƒ¨åˆ†æ–¹æ³•</strong></p><p> <strong>è€Œå½“ä½ æ‹¥æœ‰ä¸€ä¸ªæŒ‡é’ˆçš„æ—¶å€™ï¼Œä½ è‚¯å®šã€å¿…ç„¶ã€100%èƒ½æ‹¿åˆ°å®ƒæŒ‡å‘çš„å¯¹è±¡ï¼ˆå€¼ï¼‰ã€‚é‚£ä½ æ—¢èƒ½è®¿é—®åˆ°Receiverä¸ºæŒ‡é’ˆçš„æ–¹æ³•ï¼Œä¹Ÿèƒ½è®¿é—®åˆ°Receiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰çš„æ–¹æ³•ã€‚æ‰€ä»¥è¯¥æŒ‡é’ˆæ‰€æ‹¥æœ‰çš„æ–¹æ³•é›†åˆï¼ˆ<code>Method Set</code>ï¼‰ä¸­åŒ…å«äº†Receiverä¸ºæŒ‡é’ˆå’ŒReceiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰çš„æ‰€æœ‰æ–¹æ³•</strong></p><p> <strong>è¿™ä¹Ÿå°±æ˜¯ä¸Šé¢ç¬¬ä¸€ä¸ªè¡¨æ ¼çš„å«ä¹‰ã€‚ç„¶åæˆ‘ä»¬è¯•ç€æŠŠç¬¬ä¸€ä¸ªè¡¨æ ¼è½¬ç½®ä¸€ä¸‹ï¼Œä¹Ÿå°±èƒ½å¾—åˆ°ç¬¬äºŒä¸ªè¡¨æ ¼ã€‚</strong>è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬æŠŠ<code>Test(student)</code>æ”¹æˆ<code>Test(&amp;student)</code>å°±èƒ½é€šè¿‡çš„åŸå› ã€‚å¦å¤–å¦‚æœæŠŠé‚£ä¸¤ä¸ªæ–¹æ³•æ”¹æˆ<code>func (s Student) breathe()</code>å’Œ<code>func (s Student) grow()</code>ï¼Œé‚£æ— è®ºæ˜¯<code>Test(student)</code>è¿˜æ˜¯<code>Test(&amp;student)</code>éƒ½å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå› ä¸ºå‚ç…§ç¬¬äºŒä¸ªè¡¨æ ¼ï¼Œå½“å®ç°æ¥å£ä¸­çš„æ–¹æ³•çš„Receiverä¸ºå¯¹è±¡ï¼ˆå€¼ï¼‰æ—¶ï¼Œä»¥æ¥å£ç±»å‹ä½œä¸ºå‚æ•°çš„å¤šæ€æ–¹æ³•å¯ä»¥æ¥æ”¶å¯¹è±¡ï¼ˆå€¼ï¼‰ä¹Ÿå¯ä»¥æ¥æ”¶æŒ‡é’ˆï¼Œæ— æ‰€è°“ã€‚</p></li></ol><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ¬äººæ–‡ç¬”æ°´å¹³æœ‰é™ï¼Œåœ¨æ–‡å­—è§£é‡Šéƒ¨åˆ†å¯èƒ½ç¨æ˜¾æ··ä¹±ï¼Œå¦‚æœ‰ç–‘é—®è¯·åå¤å‚ç…§ç¤ºæ„ä»£ç ã€è¡¨æ ¼ã€å›¾ç‰‡ï¼Œä¹Ÿæ¬¢è¿ç•™è¨€è®¨è®ºã€‚</p><p>åœ¨Goå®ç°å¤šæ€è¿™ä¸€éƒ¨åˆ†ï¼Œæœ€éº»çƒ¦çš„è«è¿‡äºåŒä¸€ä¸ªç»“æ„ä½“çš„<code>æŒ‡é’ˆç±»å‹</code>å’Œ<code>å€¼ç±»å‹</code>ï¼Œåœ¨å®ç°æ¥å£æ—¶è¢«è®¤ä¸ºæ˜¯ä¸ä¸€æ ·çš„ç±»å‹ã€‚å½“æŸä¸ªç»“æ„ä½“æƒ³å®ç°ä¸€ä¸ªæ¥å£ï¼Œç»Ÿä¸€äº†æ‰€æœ‰æ–¹æ³•çš„Receiveråï¼Œåœ¨ä¼ å‚ç»™æ¥å£å‚æ•°æ—¶åˆå‡ºç°äº†ç±»å‹ä¸åŒ¹é…æ–¹é¢çš„å°å‘ã€‚è¡¨é¢ä¸Šfixæ‰æŠ¥é”™å¾ˆå®¹æ˜“ï¼Œä½†å…¶åº•å±‚çš„åŸç†æ°å¼€æ¥è¿˜æ˜¯æœ‰ç‚¹å°å¤æ‚çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Golang]å¥‡è‘©æ•°æ®ç»“æ„ä¹‹Sliceï¼ˆåˆ‡ç‰‡ï¼‰</title>
      <link href="/2018/11/10/go-slice/"/>
      <url>/2018/11/10/go-slice/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p>æœ¬æ–‡å†™äº2018/11/09ï¼ŒåŸºäº<code>Go 1.11</code>ã€‚<br>è‡³äºå…¶ä»–ç‰ˆæœ¬çš„Go SDKï¼Œå¦‚æœ‰å‡ºå…¥è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ä»–èµ„æ–™ã€‚</p></blockquote><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>æœ€è¿‘æ–°æ¥è§¦<code>Golang</code>ï¼Œä¸ªäººæœ‰ä¸€ç§ä¹ æƒ¯ï¼Œåœ¨ç²—ç•¥è¿‡å®ŒåŸºç¡€è¯­æ³•åå°±å¼€å§‹æ·±å…¥ç ”ç©¶ä¸€ç•ªè¯­è¨€å†…éƒ¨built-inçš„æ•°æ®ç»“æ„ã€‚æƒ³å½“å¹´å­¦<code>Java</code>æ—¶ï¼Œå°±æŠ äº†ä¸å°‘<code>JDK7</code>å’Œ<code>JDK8</code>é‡Œé¢çš„é›†åˆç±»æºç ï¼ˆ<strong>ç‰¹åˆ«æ˜¯Mapç›¸å…³å’ŒListç›¸å…³çš„å®ç°</strong>ï¼‰ã€‚</p><p>ç±»ä¼¼çš„ï¼Œåœ¨<code>Golang</code>é‡Œé¢ï¼Œbuilt-inç±»å‹çš„å‡ ç§ç»å…¸æ•°æ®ç»“æ„ï¼ˆæˆ–è€…è¯´æ˜¯å®¹å™¨ï¼é›†åˆï¼‰æœ‰</p><ul><li><code>channel</code></li><li><code>map</code></li><li><code>slice</code></li><li><code>array</code></li></ul><p>å¯¹äº<code>array</code>ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå„è¯­è¨€ä¸­éƒ½ä¸€æ ·ï¼Œå°±æ˜¯ä¸€ç‰‡</p><ul><li>è¿ç»­çš„</li><li>å¯é€šè¿‡indexå¿«é€Ÿå®šä½çš„</li><li>å­˜å‚¨ç›¸åŒæ•°æ®ç±»å‹</li></ul><p>çš„å†…å­˜åŒºåŸŸã€‚</p><p><strong><code>array</code>ç›¸å½“çš„æ–¹ä¾¿ç®€å•å¥½ç”¨ï¼Œä½†æ˜¯æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸¥é‡ç¼ºä¹åŠ¨æ€æ€§ï¼Œåœ¨<code>array</code>çš„é¢†åŸŸé‡Œä½ å¾ˆéš¾çœ‹åˆ°éšæ„æ‰©å®¹æˆ–è€…éšæ„ç¼©å‡</strong>ã€‚</p><p>äºæ˜¯ï¼Œåœ¨å…¶ä»–éƒ¨åˆ†è¯­è¨€é‡Œï¼ˆå¦‚<code>Java</code>ï¼‰ï¼Œå°±æä¾›äº†å¾ˆå¤šåŸºäº<code>LinkedList</code>æ„å»ºçš„å®¹å™¨ï¼Œæ ¹æ®éœ€æ±‚éšæ„åŠ¨æ€æ‰©å®¹ç¼©å‡ã€å¤´æ’å…¥å°¾æ’å…¥ã€éšæ„åˆ é™¤ä¸­é—´å…ƒç´ ï¼Œè¿™ç§<strong>åŠ¨æ€æ€§</strong>ç”¨èµ·æ¥éå¸¸çˆ½ã€‚<strong>ä½†æ˜¯å´åˆå¤±å»äº†æ•°ç»„é‚£ç§è¿ç»­ç©ºé—´æ‰€æ”¯æŒçš„æœ€çˆ½çš„ä¸€ç‚¹ â€”â€” ç”¨indexç›´æ¥å®šä½åˆ°å…·ä½“çš„å…ƒç´ ï¼ˆAPIä¸Šæ”¯æŒï¼Œä½†å®é™…ä¸Šè¿˜æ˜¯ä¸€è·¯éå†è¿‡å»ï¼‰ã€‚</strong></p><p>æ‰€ä»¥ï¼ŒåŸºäºè¿™äº›é—®é¢˜å’ŒèƒŒæ™¯ï¼Œåœ¨<code>Golang</code>ä¸­æˆ‘ä»¬å°±è§åˆ°äº†ä¸€ä¸ªâ€œå¥‡è‘©â€çš„æ•°æ®ç»“æ„ â€”â€” <code>slice</code>ï¼ˆåˆ‡ç‰‡ï¼‰ã€‚</p><h4 id="åº•å±‚å®ç°"><a href="#åº•å±‚å®ç°" class="headerlink" title="åº•å±‚å®ç°"></a>åº•å±‚å®ç°</h4><ul><li><p>ä»£ç å±‚é¢</p><p>  æ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œæˆ–è€…å¾ˆå¤šGoå¼€å‘è€…çš„è¯´æ³•ï¼Œ<code>slice</code>æœ€ç›´æ¥çš„å®šä¹‰å°±æ˜¯<code>dynamic array</code>ã€‚<strong>æ‰€ä»¥å…¶å®å®ƒçš„åº•å±‚çœŸçš„æ˜¯åŸºäº<code>array</code>å®ç°çš„ã€‚</strong>åŒæ—¶å®ƒè¿˜èƒ½æ”¯æŒ<strong>ä¸€å®šç¨‹åº¦ä¸Šæ¯”è¾ƒè‰¯å¥½çš„</strong>åŠ¨æ€æ€§ã€‚</p><p>  å…ˆæ¥çœ‹çœ‹<code>Go 1.11</code>ä¸­çš„<code>slice</code>æºç ã€‚</p>  <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">array unsafe.Pointer</span><br><span class="line"><span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line"><span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  <strong>çœ‹åˆ°äº†è¿™ä¸ªæ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œç¬é—´è®©æˆ‘æƒ³èµ·äº†<code>Redis</code>é‡Œé¢çš„<code>Simple Dynamic String(SDS)</code>çš„å®ç°ã€‚</strong>åŒæ ·æ˜¯å°è£…äº†ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼ˆæ­¤å¤„<code>array</code>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ç‰‡è¿ç»­å†…å­˜åŒºåŸŸï¼‰ï¼ŒåŒæ ·æ˜¯ç»´æŠ¤äº†ä¸€ä¸ª<code>len</code>å±æ€§ï¼ŒåŒæ ·æœ‰ä¸€ä¸ª<code>cap</code>ï¼ˆ<code>free</code>ï¼‰å±æ€§æ¥æŒ‡æ˜å®¹å™¨çš„ä½¿ç”¨æƒ…å†µã€‚ï¼ˆ<strong>æ„Ÿå…´è¶£çš„å¯ä»¥å»æŸ¥é˜…ä¸€ä¸‹<code>Redis</code>é‡Œçš„å­—ç¬¦ä¸²ï¼ˆ<code>SDS</code>ï¼‰å®ç°</strong>ï¼‰</p><p>  è§£é‡Šä¸€ä¸‹ç»“æ„ä½“é‡Œå„æˆå‘˜çš„å«ä¹‰ï¼š</p><ul><li><code>array unsafe.Pointer</code>ï¼šä¸€ä¸ªæŒ‡å‘è¿ç»­å†…å­˜åŒºåŸŸï¼ˆæ•°ç»„ï¼‰çš„æŒ‡é’ˆ</li><li><code>len   int</code>ï¼šæ­¤<code>slice</code>ä¸­å·²å­˜äº†å¤šå°‘ä¸ªå…ƒç´ </li><li><code>cap   int</code>ï¼šæ­¤<code>slice</code>ä¸­æœ€å¤šèƒ½å­˜å¤šå°‘ä¸ªå…ƒç´ ï¼ˆæœ€å¤§å®¹é‡ï¼‰</li></ul></li><li><p>é€»è¾‘å±‚é¢</p><p>  å‡è®¾æˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ª<code>slice</code></p><ul><li><code>slice := make([]string, 4, 4)</code>ï¼Œç„¶åèµ‹å€¼</li><li><p>æˆ–è€…<code>slice := []string{&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;}</code></p><p>å°†ä¼šå¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„é€»è¾‘ç»“æ„ï¼Œ<code>len = 4</code>ï¼Œ<code>cap = 4</code>ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/basic.png" alt=""></p><p>è‹¥æˆ‘ä»¬ä¸æ˜¯ä»å¤´æ–°å»ºï¼Œè€Œæ˜¯ä»æŸä¸ªå·²æœ‰çš„<code>array</code>ä¸­å»ºå‡ºä¸€ä¸ª<code>slice</code></p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">strs := [<span class="number">4</span>]<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>&#125;</span><br><span class="line">slice := strs[<span class="number">0</span>:<span class="number">2</span>] <span class="comment">// å–strsä¸‹æ ‡ä¸º[0,2)çš„å…ƒç´ æ„é€ ä¸€ä¸ªslice</span></span><br></pre></td></tr></table></figure><p>å°†ä¼šå¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„é€»è¾‘ç»“æ„ï¼Œ<code>len = 2</code>ï¼Œ<code>cap = 4</code>ï¼ˆå› ä¸ºåŸæ•°ç»„çš„æœ€å¤§ç©ºé—´ä¸º4ï¼Œæ‰€ä»¥è¿™ä¸ª<code>slice</code>ä»<code>index0</code>å¼€å§‹ï¼Œæœ€å¤§å¯ç”¨åŒºåŸŸä¹Ÿå¯ä»¥åˆ°è¾¾<code>index3</code>ï¼Œåªä¸è¿‡ç°åœ¨è¿˜æ²¡ç”¨åˆ°<code>index3</code>ç½¢äº†ï¼‰ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/basic2.png" alt=""></p></li></ul></li></ul><p><strong>æ‰€ä»¥ï¼ŒåŸºäºåº•å±‚çš„æ•°ç»„ï¼Œæœ¬è´¨ä¸Š<code>slice</code>ä¸è¿‡æ˜¯ä¸€ä¸ªæ•°ç»„çš„<code>wrapper</code>ï¼ˆåŒ…è£…ç±»ï¼‰ï¼Œå¹¶æä¾›ä¸€äº›åŠ¨æ€æ€§çš„æ“ä½œï¼ˆ<code>append()</code>ï¼‰ï¼Œè®©ä½¿ç”¨è€…æ„Ÿå—ä¸åˆ°å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ç½¢äº†ã€‚</strong></p><h4 id="å¯¹sliceçš„æ“ä½œï¼Œä»¥åŠå…¶ä¸­çš„å‘"><a href="#å¯¹sliceçš„æ“ä½œï¼Œä»¥åŠå…¶ä¸­çš„å‘" class="headerlink" title="å¯¹sliceçš„æ“ä½œï¼Œä»¥åŠå…¶ä¸­çš„å‘"></a>å¯¹sliceçš„æ“ä½œï¼Œä»¥åŠå…¶ä¸­çš„å‘</h4><p>å¯¹<code>slice</code>æ“ä½œï¼Œæ— éå°±5ç§ï¼š</p><ul><li>æ–°å»ºï¼ˆæ— éœ€å¤šè®²ï¼‰<ul><li>ç›´æ¥æ–°å»º</li><li>ä»å·²æœ‰çš„æ•°ç»„ä¸­æˆªå–</li></ul></li><li>æ’å…¥</li><li>æˆªæ–­ï¼ˆæ‰€è°“çš„åˆ é™¤ï¼‰-&gt; ç”¨indexæˆªå–</li><li>æ›´æ–°ï¼ˆæ— éœ€å¤šè®²ï¼‰</li><li>è¯»å–ï¼ˆæ— é¡»å¤šè®²ï¼‰</li></ul><p><strong>é¦–å…ˆæ˜ç¡®ç¬¬ä¸€ä¸ªå‘ï¼Œåœ¨åŒä¸€ä¸ªæ•°ç»„ä¸Šæ„é€ å‡ºæ¥çš„å¤šä¸ª<code>slice</code>éƒ½æ˜¯å…±äº«åŒä¸€ä¸ªåº•å±‚æ•°ç»„çš„ã€‚æ‰€ä»¥ä½ å¯¹æŸä¸€ä¸ª<code>slice</code>è¿›è¡Œå†™æˆ–è€…æ›´æ–°æ“ä½œåï¼Œå¾ˆæœ‰å¯èƒ½å°±ä¼šå½±å“åˆ°åŸºäºåŒä¸€ä¸ªåº•å±‚æ•°ç»„çš„å…¶ä»–<code>slice</code>ã€‚</strong>è¯¦è§ä¸‹è¿°ä»£ç ä¸ç¤ºæ„å›¾ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/basic3.png" alt=""></p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">strs := [<span class="number">4</span>]<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>&#125;</span><br><span class="line">slice1 := strs[<span class="number">0</span>:<span class="number">2</span>] <span class="comment">// å–strsä¸‹æ ‡ä¸º[0,2)çš„å…ƒç´ æ„é€ ä¸€ä¸ªslice1</span></span><br><span class="line">slice2 := strs[<span class="number">0</span>:<span class="number">3</span>] <span class="comment">// å–strsä¸‹æ ‡ä¸º[0,3)çš„å…ƒç´ æ„é€ ä¸€ä¸ªslice2</span></span><br><span class="line"></span><br><span class="line">slice2[<span class="number">0</span>] = <span class="string">"hhhhh"</span></span><br><span class="line">fmt.Println(slice1) <span class="comment">// [hhhhh, b] slice1è¢«æ”¹å˜äº†</span></span><br></pre></td></tr></table></figure><p><strong>ç”±æ­¤å¯è§ï¼Œå½“ä½ çš„ä»£ç é‡Œæœ‰å¤šä¸ª<code>slice</code>éƒ½æ˜¯åŸºäºåŒä¸€ä¸ªæ•°ç»„æ„å»ºå‡ºæ¥æ—¶ï¼ŒåŠ¡å¿…å°å¿ƒæ“ä½œï¼Œå¾ˆå®¹æ˜“äº’ç›¸å½±å“é€ æˆè„æ•°æ®ï¼</strong></p><p>æ¥ä¸‹æ¥ç€é‡è®²è®²<strong>æ’å…¥ï¼ˆappend()ï¼‰</strong>æ“ä½œï¼Œä»¥åŠå…¶ä¸­å¥‡è‘©çš„å‡ ä¸ªç‚¹ã€‚</p><p>ä¸€èˆ¬æ‰§è¡Œ<code>append(slice, value)</code>æ—¶ä¼šæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µ</p><ul><li><code>slice</code>çš„<code>len</code>å°äº<code>cap</code>ï¼Œé¡ºç†æˆç« å¯ä»¥ç›´æ¥æ’å…¥ï¼ˆ<strong>æ³¨æ„ä¼šç›´æ¥æ”¹å˜åº•å±‚æ•°ç»„!</strong>ï¼‰</li><li><code>slice</code>çš„<code>len</code>ç­‰äº<code>cap</code>ï¼Œå½“å‰å¯ç”¨ç©ºé—´ä¸è¶³</li></ul><ol><li><p><code>len</code>å°äº<code>cap</code></p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">strs := [<span class="number">4</span>]<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>&#125;</span><br><span class="line">slice1 := strs[<span class="number">0</span>:<span class="number">2</span>] <span class="comment">// å–strsä¸‹æ ‡ä¸º[0,2)çš„å…ƒç´ æ„é€ ä¸€ä¸ªslice1, len=2, cap=4</span></span><br><span class="line">slice1 = <span class="built_in">append</span>(slice1, <span class="string">"hh"</span>) <span class="comment">// appendålen=3, cap=4</span></span><br></pre></td></tr></table></figure><p> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/basic4.png" alt=""></p><p> å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨appendäº†<code>&quot;hh&quot;</code>ä¹‹åï¼Œ<strong>åº•å±‚æ•°ç»„</strong>ä¸­<code>index2</code>å¤„ç›´æ¥è¢«æ›´æ–°ä¸ºäº†<code>&quot;hh&quot;</code>ã€‚</p></li><li><p><code>len</code>ç­‰äº<code>cap</code></p> <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">strs := [<span class="number">4</span>]<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>&#125;</span><br><span class="line">slice1 := strs[<span class="number">0</span>:<span class="number">1</span>:<span class="number">1</span>] <span class="comment">// å–strsä¸‹æ ‡ä¸º[0,1)çš„å…ƒç´ æ„é€ ä¸€ä¸ªslice1, len=1, cap=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºäº†è¯´æ˜é—®é¢˜, æ­¤å¤„ç”¨ç‰¹æ®Šçš„å†™æ³•</span></span><br><span class="line">slice2 := <span class="built_in">append</span>(slice1, <span class="string">"hh"</span>)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(slice2), <span class="built_in">cap</span>(slice2)) <span class="comment">// len=2, cap=2</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(slice1), <span class="built_in">cap</span>(slice1)) <span class="comment">// len=1, cap=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é”®ç‚¹åœ¨æ­¤</span></span><br><span class="line">slice2[<span class="number">0</span>] = <span class="string">"hello"</span></span><br><span class="line">fmt.Println(slice1) <span class="comment">// [a]</span></span><br></pre></td></tr></table></figure><p> å½“æ‰§è¡Œäº†<code>slice2[0] = &quot;hello&quot;</code>åï¼Œ<code>slice1</code>å±…ç„¶è¿˜æ˜¯<code>[a]</code>è€Œä¸æ˜¯<code>[hello]</code>ï¼Œè¯´å¥½çš„<strong>åŸºäºåŒä¸€ä¸ªåº•å±‚æ•°ç»„çš„å¤šä¸ªsliceä¼šå…±äº«è¯¥æ•°ç»„å‘¢ï¼Ÿï¼Ÿï¼Ÿ</strong>åœ¨è¿™é‡Œæ€ä¹ˆå‡ºé—®é¢˜äº†ï¼Ÿï¼Ÿï¼Ÿ</p><p> <strong>å…¶å®å…³é”®å°±åœ¨äºæˆ‘ä»¬appendæ—¶ï¼Œ<code>slice1</code>çš„<code>len</code> == <code>cap</code></strong>ï¼Œåœ¨åŸ<code>slice1</code>ä¸­æ²¡æœ‰ç©ºé—´å¯ä»¥å…è®¸æ’å…¥æ–°å…ƒç´ äº†ã€‚<strong>æ­¤æ—¶å°±ä¼šè§¦å‘sliceæ‰©å®¹ï¼Œç„¶è€Œæ­¤æ‰©å®¹å¹¶ä¸æ˜¯å¯¹åŸåº•å±‚æ•°ç»„è¿›è¡Œæ“ä½œï¼Œè€Œæ˜¯æ–°å¼€è¾Ÿä¸€æ®µæ›´é•¿çš„æ•°ç»„ç©ºé—´ï¼ŒæŠŠåŸæ•°ç»„çš„å€¼copyè¿‡æ¥ï¼Œå†è®©sliceä¸­çš„æŒ‡é’ˆæŒ‡å‘æ–°å¼€è¾Ÿçš„é•¿æ•°ç»„ï¼</strong>è¯¦ç»†æµç¨‹è¯·å‚è€ƒä¸‹å›¾ã€‚</p><p> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/basic5.png" alt=""></p><p> ç”±å›¾å¯è§ï¼ŒåŸæœ¬<code>slice1</code>é‡Œçš„æŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„æ˜¯ä½äº<code>0x34</code>å¤„çš„ã€‚å½“å°è¯•<code>append()</code>å¹¶è§¦å‘æ‰©å®¹æ—¶ï¼Œ<strong>åº•å±‚ç›´æ¥åœ¨å¦å¤–çš„åœ°å€(<code>0x88</code>ï¼‰å¤„å¼€è¾Ÿäº†ï¼ˆæˆ–è€…ç§°ä¹‹ä¸º<code>deep clone</code>å§ï¼‰ä¸€æ®µå…¨æ–°çš„æ•°ç»„ã€‚</strong>å¹¶æŠŠå€¼éƒ½copyè¿‡å»ï¼Œç„¶åæ‰çœŸæ­£æŠŠéœ€è¦appendçš„<code>&quot;hh&quot;</code>å¡è¿›å»ã€‚</p><p> å¾ˆè‡ªç„¶ï¼Œ<strong>ä¹‹åæˆ‘ä»¬æ‰§è¡Œçš„<code>slice2[0] = &quot;hello&quot;</code>ï¼Œåªæ˜¯å¯¹<code>0x88</code>èµ·å§‹çš„é‚£ä¸ªæ•°ç»„è¿›è¡Œäº†ä¿®æ”¹ï¼Œå®Œå…¨æ²¡æœ‰å½±å“åˆ°<code>slice1</code>æŒ‡å‘çš„é‚£ä¸ªä»<code>0x34</code>èµ·å§‹çš„æ•°ç»„ã€‚</strong>æŠŠ<code>slice1</code>æ‰“å°å‡ºæ¥ï¼Œè‡ªç„¶ä¹Ÿå°±è¿˜æ˜¯<code>[a]</code>äº†ã€‚</p><p> æ‰€ä»¥åœ¨å¾ˆå¤šGoé¡¹ç›®çš„ä»£ç é‡Œï¼Œæˆ–è€…å®˜æ–¹æ•™ç¨‹é‡Œï¼Œ<strong>æœ€å¸¸è§çš„appendç”¨æ³•éƒ½æ˜¯<code>slice = append(slice, value)</code>ï¼Œè€Œä¸æ˜¯<code>newSlice := append(slice, value)</code>ã€‚</strong>å½“æŠŠappendå®Œæˆåçš„ç»“æœå†ä¸€æ¬¡èµ‹ç»™åŸsliceï¼Œæ— è®ºå‘ç”Ÿäº†ä»€ä¹ˆ(æ— è®º<code>len</code>å’Œ<code>cap</code>æ˜¯ä»€ä¹ˆå…³ç³»éƒ½æ— æ‰€è°“ï¼‰ï¼Œæ€»ä¸ä¼šé€ æˆruntimeæ—¶çš„æ­§ä¹‰ã€‚</p><p> å¦‚æœåœ¨ä¸€äº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œå¿…é¡»è¦ä½¿ç”¨<code>newSlice := append(slice, value)</code>çš„å†™æ³•ï¼Œé‚£å°±è¦æ ¼å¤–å°å¿ƒï¼<strong>å¦‚æœåœ¨appendè¿‡ç¨‹ä¸­è§¦å‘äº†æ‰©å®¹ï¼Œ<code>newSlice</code>å’ŒåŸ<code>slice</code>å°†ä¸å†æŒ‡å‘åŒä¸€æ®µæ•°ç»„ç©ºé—´ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¯¹<code>newSlice</code>çš„ä¿®æ”¹ä¹Ÿä¸æ¯«ä¸ä¼šå½±å“<code>slice</code></strong>ï¼ˆä¹Ÿæœ‰å¯èƒ½è¿™æ°å¥½å°±æ˜¯ä½ çš„é€»è¾‘éœ€è¦çš„ï¼‰ã€‚</p></li></ol><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>Golang</code>ä¸­çš„<code>slice</code>å…¼é¡¾äº†ä¼ ç»Ÿæ•°ç»„çš„ä¼˜ç‚¹ï¼ˆè¿ç»­å†…å­˜ç©ºé—´ï¼‰ï¼Œä¹Ÿæ”¯æŒåŠ¨æ€æ‰©å®¹ï¼æˆªæ–­ï¼Œç¡®å®æ˜¯åœ¨å®é™…å¼€å‘ä¸­éå¸¸æœ‰ç”¨çš„å®¹å™¨ã€‚<strong>ä½†å»ºè®®æ¯ä¸ªGoå¼€å‘è€…éƒ½è¯¦ç»†äº†è§£å…¶åº•å±‚å®ç°ï¼Œå› ä¸ºä¸ºäº†æ”¯æŒå…¶åŠ¨æ€æ€§ï¼Œappendå’Œappendç›¸å…³çš„æ“ä½œä¼šå¸¦æ¥å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„å‘</strong></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Google]è®°ä¸€é“ä¸é”™çš„ç”µé¢é¢˜</title>
      <link href="/2018/09/28/google-interview0/"/>
      <url>/2018/09/28/google-interview0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘ä¸€ä½æœ‹å‹è·Ÿæˆ‘åˆ†äº«äº†ä¸€é“Taåœ¨googleç”µé¢ä¸­è¢«é—®åˆ°çš„ç®—æ³•é¢˜ï¼Œä¸€é˜µç ”ç©¶åè§‰å¾—é¢˜ç›®å‡ºå¾—å¾ˆä¸é”™ï¼Œä¸æ˜¯é‚£ç§å‚»Xçš„trickyé¢˜ç›®ï¼Œæ•…åˆ†äº«ä¹‹ï¼Œå¹¶é™„ä¸Šæˆ‘å®ç°çš„Javaä»£ç ã€‚</p></blockquote><h3 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h3><p>æ ¹æ®è¾“å…¥çš„æœ‰åºå­—ç¬¦ä¸²ï¼Œæ„é€ å‡ºç›®æ ‡å­—ç¬¦ä¸²ï¼Œä¿è¯æ¯ä¸ªè¾“å…¥çš„ä¸²å‡æœä»ç›®æ ‡ä¸²çš„åŸé¡ºåºã€‚</p><ul><li>target: <code>3-5-7-1-9</code></li><li>input: <code>3-5-7, 5-1-9, 7-1, 1-9, 5-7</code></li></ul><p>å¯ä»¥çœ‹åˆ°è¾“å…¥çš„æ¯ä¸ªå­—ç¬¦ä¸²å‡æœä»ç›®æ ‡ä¸²çš„é¡ºåºï¼Œåªä¸è¿‡æ¯ä¸ªè¾“å…¥ä¸²éƒ½ç¼ºå¤±äº†ä¸€äº›å…ƒç´ ã€‚<br>æœ¬é¢˜çš„å‰ææ¡ä»¶ï¼š</p><ul><li>ä¿è¯æ ¹æ®<code>input</code>èƒ½å¤Ÿç”Ÿæˆå”¯ä¸€çš„ç›®æ ‡ä¸²</li><li><code>target</code>ä¸­çš„å…ƒç´ å–å€¼èŒƒå›´æ˜¯<code>[1, 9]</code>ï¼Œä¸”ä¸é‡å¤</li></ul><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æ‹¿åˆ°é¢˜ç›®åï¼Œæœ€ç›´è§‚çš„æ€è·¯æ˜¯ï¼šæ¯å¤„ç†ä¸€ä¸ªè¾“å…¥ä¸²ï¼ŒæŠŠé‡Œé¢çš„æ•°å­—æŠ½å–å‡ºæ¥ï¼Œå»ºç«‹ä¸€ä¸ª<code>ListNode</code>ï¼Œç„¶åæ ¹æ®è¯¥ä¸²ä¸­çš„å…ˆåé¡ºåºæŠŠå¤šä¸ª<code>ListNode</code>è¿æ¥èµ·æ¥ã€‚åŒæ—¶ç»´æŠ¤ä¸€ä¸ª<code>Map</code>è®°å½•å·²ç»é‡åˆ°è¿‡çš„<code>ListNode</code>ï¼Œä¹‹åå†é‡åˆ°è¯¥æ•°å­—å°±ä¸ç”¨æ–°å»ºï¼Œè€Œæ˜¯ç›´æ¥ä»<code>Map</code>ä¸­å–å‡ºæ•°å­—å¯¹åº”çš„<code>ListNode</code>ã€‚</p><p>ä¾‹å¦‚ï¼Œå…ˆå»ºç«‹ä¸€ä¸ª<code>Map&lt;Integer, ListNode&gt;</code>ï¼Œç„¶åå¼€å§‹å¤„ç†ç¬¬ä¸€ä¸ªè¾“å…¥ä¸²<code>3-5-7</code>ï¼Œ</p><ul><li>å…ˆé‡åˆ°<code>3</code>ï¼Œ<code>Map</code>ä¸­æ²¡æœ‰<code>Node3</code>ï¼Œå»ºç«‹<code>Node3</code></li><li>ç„¶åé‡åˆ°<code>5</code>ï¼Œ<code>Map</code>ä¸­æ²¡æœ‰<code>Node5</code>ï¼Œå»ºç«‹<code>Node5</code>ï¼Œç„¶åè®©<code>Node3</code>çš„<code>next</code>æŒ‡å‘<code>Node5</code></li><li>æœ€åé‡åˆ°<code>7</code>ï¼Œ<code>Map</code>ä¸­æ²¡æœ‰<code>Node7</code>ï¼Œå»ºç«‹<code>Node7</code>ï¼Œç„¶åè®©<code>Node5</code>çš„<code>next</code>æŒ‡å‘<code>Node7</code></li><li>æ¥ç€å¤„ç†ä¸‹ä¸€ä¸ªè¾“å…¥ä¸²ï¼Œå¾ªç¯</li></ul><p>å¤§å¤šæ•°äººç¬¬ä¸€ååº”éƒ½ä¼šæƒ³åˆ°è¿™æ ·çš„å¤„ç†é€»è¾‘ï¼Œéå¸¸ç›´è§‚ã€‚<strong>ä½†æ˜¯è¿™æ ·çš„é€»è¾‘å­˜åœ¨ç»†èŠ‚é—®é¢˜ã€‚</strong>å› ä¸ºæ¯ä¸ªè¾“å…¥ä¸²åªæ˜¯ä¿ç•™äº†<code>target</code>çš„ç›¸å¯¹é¡ºåºï¼Œä¸­é—´ç¼ºå¤±äº†ä¸€äº›å…ƒç´ ï¼Œæ‰€ä»¥åœ¨æ„å»ºé“¾è¡¨æ—¶ï¼Œå‡­å€Ÿå±€éƒ¨ç›¸å¯¹é¡ºåºç›´æ¥æ’å…¥<code>ListNode</code>å¯èƒ½ä¼šé€ æˆå…¨å±€é¡ºåºçš„é”™è¯¯ã€‚<strong>ä¾‹å¦‚åœ¨å¾—åˆ°<code>3-&gt;5-&gt;7</code>è¿™ä¸ªé“¾è¡¨åï¼Œå†å¤„ç†ç¬¬äºŒä¸ªè¾“å…¥ä¸²<code>5-1-9</code>ï¼Œæ ¹æ®ä»¥ä¸Šçš„é€»è¾‘å°±ä¼šæŠŠ<code>Node1</code>ç›´æ¥æ’åˆ°<code>Node5</code>èº«åï¼Œå¾—åˆ°<code>3-&gt;5-&gt;1-&gt;9-&gt;7</code>,æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ï¼Œä¸»è¦åŸå› å°±æ˜¯å±€éƒ¨çš„ç›¸å¯¹é¡ºåºä¸ä¸€å®šèƒ½ç›´æ¥æ˜ å°„å…¨å±€é¡ºåºã€‚</strong></p><p><strong>æ‰€ä»¥ï¼Œè¿™é“é¢˜çš„æ ¸å¿ƒå°±åœ¨äºè®°å½•é¡ºåºï¼Œå¹¶ä¸”æ˜¯å…¨å±€é¡ºåºã€‚</strong>ç”±ä¹‹å‰çš„æƒ³æ³•æ‹“å±•å¼€æ¥ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†<strong>ä¸ºæ¯ä¸ªæ•°å­—å»ºç«‹å¯¹åº”çš„<code>ListNode</code></strong>çš„æƒ³æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>Node</code>æ˜¯å¦å¯ä»¥æ˜¯ä¸€ä¸ª<code>GraphNode</code>å‘¢ï¼Ÿæˆ‘ä»¬æ—¢ç„¶å¯ä»¥ç”¨<code>LinkedList</code>å­˜è¿™äº›æ•°æ®ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥æ‹“å±•æˆç”¨<code>Graph</code>å­˜è¿™äº›æ•°æ®å‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬ç”¨<code>Graph</code>å­˜å‚¨è¿™äº›æ•°æ®ï¼Œé‚£ä¹ˆåœ¨<code>Graph</code>ä¸­èƒ½ä½“ç°<strong>é¡ºåº</strong>çš„æ— éå°±æ˜¯<strong>æœ‰å‘è¾¹</strong>ï¼ˆè‹¥å­˜åœ¨è¾¹<code>A ---&gt; B</code>ï¼Œä»£è¡¨å¾—å…ˆåˆ°è¾¾<code>A</code>æ‰èƒ½åˆ°è¾¾<code>B</code>ï¼‰ã€‚<strong>æœ‰å‘è¾¹ + ç‚¹ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æœ‰å‘å›¾</strong>ï¼Œç»“åˆæ¡ä»¶ä¸­è¯´æ˜çš„<code>target</code>ä¸­ä¸å­˜åœ¨é‡å¤å…ƒç´ ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†<strong>æœ‰å‘æ— ç¯å›¾ï¼ˆ<code>DAG</code>ï¼‰</strong>ã€‚é‚£ä¹ˆåœ¨<code>DAG</code>ä¸­ï¼Œèƒ½æ‰¾å‡ºæ‰€è°“çš„<strong>å…¨å±€é¡ºåº</strong>çš„ï¼Œå°±æ˜¯<code>Topological Sort</code>ã€‚</p><h3 id="å…·ä½“ä»£ç "><a href="#å…·ä½“ä»£ç " class="headerlink" title="å…·ä½“ä»£ç "></a>å…·ä½“ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> google;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Solution solution = <span class="keyword">new</span> Solution();</span><br><span class="line">        List&lt;String&gt; stream = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        stream.add(<span class="string">"3-5-7"</span>);</span><br><span class="line">        stream.add(<span class="string">"3-1"</span>);</span><br><span class="line">        stream.add(<span class="string">"5-1-9"</span>);</span><br><span class="line">        stream.add(<span class="string">"7-1"</span>);</span><br><span class="line">        stream.add(<span class="string">"1-9"</span>);</span><br><span class="line">        solution.reconstruct(stream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reconstruct an ordered sequence from the given stream.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stream stream of sequences</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reconstruct</span><span class="params">(List&lt;String&gt; stream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stream == <span class="keyword">null</span> || stream.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. extract nodes, edges from the input stream</span></span><br><span class="line">        Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();    <span class="comment">// mapping between node_num and node_index</span></span><br><span class="line">        Map&lt;Integer, String&gt; outputMapping = <span class="keyword">new</span> HashMap&lt;&gt;();   <span class="comment">// mapping between node_index and output_str</span></span><br><span class="line">        List&lt;Integer[]&gt; edges = <span class="keyword">new</span> ArrayList&lt;&gt;();  <span class="comment">// record the edges [A, B] means an edge pointing from A to B</span></span><br><span class="line">        <span class="keyword">int</span> nodeIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (String s : stream) &#123;</span><br><span class="line">            String[] nums = s.split(<span class="string">"-"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; nums.length;i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> nodeNum = Integer.parseInt(nums[i]);</span><br><span class="line">                <span class="keyword">if</span> (!map.containsKey(nodeNum)) &#123;</span><br><span class="line">                    map.put(nodeNum, nodeIndex++);</span><br><span class="line">                    outputMapping.put(nodeIndex - <span class="number">1</span>, nums[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i != nums.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    edges.add(<span class="keyword">new</span> Integer[]&#123;nodeNum, Integer.parseInt(nums[i + <span class="number">1</span>])&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. construct the graph structure</span></span><br><span class="line">        <span class="keyword">int</span> nodeCount = map.keySet().size();</span><br><span class="line">        <span class="keyword">boolean</span>[][] graph = <span class="keyword">new</span> <span class="keyword">boolean</span>[nodeCount][nodeCount];  <span class="comment">// adjacency matrix</span></span><br><span class="line">        <span class="keyword">int</span>[] indegrees = <span class="keyword">new</span> <span class="keyword">int</span>[nodeCount];   <span class="comment">// record the indegree of each node</span></span><br><span class="line">        <span class="keyword">for</span> (Integer[] edge : edges) &#123;</span><br><span class="line">            <span class="keyword">int</span> from = edge[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> to = edge[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (!graph[map.get(from)][map.get(to)]) &#123;</span><br><span class="line">                <span class="comment">// avoid duplicated edges in the input stream</span></span><br><span class="line">                graph[map.get(from)][map.get(to)] = <span class="keyword">true</span>;</span><br><span class="line">                indegrees[map.get(to)]++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. finding out nodes with 0 indegree</span></span><br><span class="line">        Queue&lt;Integer&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; indegrees.length;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (indegrees[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                queue.add(i);</span><br><span class="line">                result.append(outputMapping.get(i) + <span class="string">"-"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. topological sort</span></span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = queue.poll();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; graph[index].length;j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (graph[index][j]) &#123;</span><br><span class="line">                    graph[index][j] = <span class="keyword">false</span>;</span><br><span class="line">                    indegrees[j]--;</span><br><span class="line">                    <span class="keyword">if</span> (indegrees[j] == <span class="number">0</span>) &#123;</span><br><span class="line">                        queue.add(j);</span><br><span class="line">                        result.append(outputMapping.get(j) + <span class="string">"-"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(result.substring(<span class="number">0</span>, result.length() - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…</p><ol><li>å¤„ç†æ¯ä¸€ä¸ªè¾“å…¥ä¸²ï¼Œå°†å…¶å†…éƒ¨çš„æ•°å­—è§£æå‡ºæ¥ï¼Œå¹¶ä¸ºæ¯ä¸ªæ•°å­—â€œç”Ÿæˆâ€ä¸€ä¸ªå¯¹åº”çš„<code>Node</code>å’Œå…¶<code>NodeIndex</code>ã€‚</li><li>æ ¹æ®ç¬¬ä¸€æ­¥å¾—åˆ°çš„å„ä¸ª<code>Node</code>å’Œå…¶<code>NodeIndex</code>ï¼Œç»“åˆè¾“å…¥ä¸²ï¼Œâ€œç”Ÿæˆâ€å„ç‚¹ä¹‹é—´çš„æœ‰å‘è¾¹ï¼Œå³æˆ‘ä»¬çš„<strong>å›¾ç»“æ„</strong>ï¼Œæ­¤å¤„ç”¨<code>adjacency matrix</code>å®ç°ã€‚</li><li>å¼€å§‹æ‰§è¡Œ<code>topological sort</code>çš„é€»è¾‘ï¼Œå…ˆæ„å»º<code>indegree</code>æ•°ç»„ï¼Œæ‰¾åˆ°å…¥åº¦ä¸º<code>0</code>çš„ç‚¹ã€‚</li><li>åŸºäºå…¥åº¦ä¸º<code>0</code>çš„ç‚¹ï¼Œåˆ©ç”¨<code>Queue</code>å®ç°<code>topological sort</code>ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> Java </tag>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ã€Šæ¨èç³»ç»Ÿå®è·µã€‹ç¬”è®° #4</title>
      <link href="/2018/06/01/recsys-note4/"/>
      <url>/2018/06/01/recsys-note4/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h3 id="åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ¨è"><a href="#åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ¨è" class="headerlink" title="åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ¨è"></a>åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ¨è</h3><p>åœ¨æ¨èæ—¶ï¼Œåº”è¯¥è€ƒè™‘<code>æ—¶é—´</code>ï¼Œ<code>åœ°ç‚¹</code>ï¼Œ<code>å¿ƒæƒ…</code>â€¦â€¦</p><ol><li><p>æ—¶é—´ä¸Šä¸‹æ–‡ä¿¡æ¯</p><ul><li><p>æ—¶é—´æ•ˆåº”</p><ul><li>ç”¨æˆ·å…´è¶£æŒç»­å˜åŒ–</li><li>ç‰©å“æœ¬èº«æœ‰ç”Ÿå‘½å‘¨æœŸ</li><li>å­£èŠ‚ï¼èŠ‚æ—¥æ•ˆåº”ï¼ˆåœ£è¯èŠ‚ï¼Œå¥¥æ–¯å¡â€¦â€¦ï¼‰</li></ul></li><li><p>æ—¶é—´ä¸Šä¸‹æ–‡æ¨èç®—æ³•</p><ul><li><p>æœ€è¿‘æœ€çƒ­é—¨ç®—æ³•</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/recentlyhot.png" alt=""></p></li><li><p>ç»“åˆæ—¶é—´ä¸Šä¸‹æ–‡çš„<code>Item-based CF</code></p><p>  <strong>ç”¨æˆ·åœ¨ç›¸éš”æ—¶é—´å¾ˆçŸ­å†…å–œæ¬¢çš„ç‰©å“å…·æœ‰æ›´é«˜ç›¸ä¼¼åº¦</strong>ï¼Œ<strong>è¿‘æœŸè¡Œä¸ºç›¸æ¯”å¾ˆä¹…ä¹‹å‰çš„è¡Œä¸ºæ›´èƒ½ä½“ç°ç”¨æˆ·ç°åœ¨çš„å…´è¶£ï¼Œåº”åŠ å¼ºç”¨æˆ·è¿‘æœŸè¡Œä¸ºçš„æƒé‡ã€‚</strong></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/time1.png" alt=""></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/time2.png" alt=""></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/time3.png" alt=""></p></li><li><p>ç»“åˆæ—¶é—´ä¸Šä¸‹æ–‡çš„<code>User-based CF</code></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/time_ubcf1.png" alt=""></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/time_ubcf2.png" alt=""></p></li><li><p>æ—¶é—´æ®µå›¾æ¨¡å‹</p></li></ul></li></ul></li><li><p>åœ°ç‚¹ä¸Šä¸‹æ–‡ä¿¡æ¯</p><p> <strong>ä¸åŒåœ°åŒºçš„ç”¨æˆ·å…´è¶£æœ‰æ‰€ä¸åŒï¼ˆè·ç¦»å¾ˆé‡è¦ï¼‰</strong></p><ul><li><p>åŸºäºä½ç½®çš„æ¨èç®—æ³•</p><ul><li>ç‰©å“ï¼ç”¨æˆ·å‡å¯åˆ†ä¸ºæœ‰ç©ºé—´å±æ€§çš„å’Œæ— ç©ºé—´å±æ€§çš„ï¼Œä¾‹å¦‚é¤é¦†ï¼å•†åº—å¸¦æœ‰ç©ºé—´å±æ€§ï¼Œå›¾ä¹¦ï¼ç”µå½±åˆ™æ²¡æœ‰ã€‚</li><li>æ•°æ®ç»“æ„ï¼š<code>(user, user_location, item, item_location, rating)</code></li><li><p>å¯å°†ä½ç½®ä¿¡æ¯æ•°æ®é›†åˆ’åˆ†æˆæ ‘çŠ¶ç»“æ„</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/country.png" alt=""></p></li><li><p>åªæœ‰<code>user_location</code>æ—¶ï¼Œå¯¹äºç»™å®šçš„ä¸€ä¸ª<code>user_location</code>ï¼Œå°†å…¶åˆ†é…åˆ°æŸä¸ªå¶å­èŠ‚ç‚¹ä¸­ï¼Œåˆ©ç”¨è¯¥å¶å­èŠ‚ç‚¹ä¸Šçš„ç”¨æˆ·è¡Œä¸ºç»™ç”¨æˆ·ä½œæ¨èã€‚ç¼ºç‚¹æ˜¯å¶å­èŠ‚ç‚¹ä¸Šçš„ç”¨æˆ·æ•°é‡&amp;ç”¨æˆ·è¡Œä¸ºæ•°æ®è¾ƒå°‘ï¼Œæ¨èåªæ˜¯åŸºäºå±€éƒ¨ã€‚æ‰€ä»¥å¯ä»¥ä»<code>root</code>å‡ºå‘ï¼Œåˆ°å¶å­çš„è·¯å¾„ä¸­åˆ©ç”¨æ¯ä¸ªä¸­é—´èŠ‚ç‚¹è®­ç»ƒå‡ºä¸€ä¸ªæ¨èæ¨¡å‹ï¼Œæœ€ç»ˆçš„æ¨èæ¨¡å‹æ˜¯ä¸€ç³»åˆ—çš„ä¸­é—´æ¨èåˆ—è¡¨åŠ æƒè€Œæˆã€‚</p></li><li><p>åªæœ‰<code>item_location</code>æ—¶ï¼Œå…ˆå¿½ç•¥ç‰©å“ä½ç½®ä¿¡æ¯ï¼Œç›´æ¥ç”¨<code>Item-based CF</code>è®¡ç®—å‡º<code>p(u, i)</code>ï¼Œæœ€åå†å¼•å…¥è·ç¦»ä»£ä»·ä½œæƒ©ç½šã€‚</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/penalty.png" alt=""></p></li></ul></li></ul></li></ol><h3 id="åˆ©ç”¨ç¤¾äº¤ç½‘ç»œæ•°æ®"><a href="#åˆ©ç”¨ç¤¾äº¤ç½‘ç»œæ•°æ®" class="headerlink" title="åˆ©ç”¨ç¤¾äº¤ç½‘ç»œæ•°æ®"></a>åˆ©ç”¨ç¤¾äº¤ç½‘ç»œæ•°æ®</h3><ol><li><p>è·å–ç¤¾äº¤ç½‘ç»œæ•°æ®çš„é€”å¾„</p><ul><li>e-mail</li><li>ç”¨æˆ·æ³¨å†Œä¿¡æ¯</li><li>ç”¨æˆ·çš„ä½ç½®æ•°æ®</li><li>è®ºå› &amp; è®¨è®ºç»„</li><li>å³æ—¶èŠå¤©å·¥å…·</li><li>ç¤¾äº¤ç½‘ç«™</li></ul></li><li><p>ç¤¾äº¤ç½‘ç»œæ•°æ®ç®€ä»‹</p><ul><li>å›¾ç»“æ„<code>G = (V, E, W)</code>, å…¶ä¸­<code>V</code>æ˜¯ç”¨æˆ·èŠ‚ç‚¹ï¼Œ<code>E</code>æ˜¯ç”¨æˆ·å…³ç³»è¾¹ï¼Œ<code>W</code>æ˜¯è¾¹æƒé‡</li><li>å•å‘å…³æ³¨ =&gt; æœ‰å‘å›¾ï¼ˆå¦‚Twitterï¼‰ï¼›äº’ç›¸å…³æ³¨ =&gt; æ— å‘å›¾ï¼ˆå¦‚Facebookï¼‰ï¼›åŸºäºç¤¾åŒºå…³ç³»ï¼Œæ— æ˜ç¡®æ–¹å‘</li></ul></li><li><p>åŸºäºç¤¾äº¤ç½‘ç»œçš„æ¨è</p><ul><li><p>åŸºäºé‚»åŸŸçš„ç¤¾ä¼šåŒ–æ¨èç®—æ³•</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/familiarity.png" alt=""></p><p>  ç†Ÿæ‚‰ç¨‹åº¦ = åŒæ–¹å…±åŒå¥½å‹çš„æ¯”ä¾‹</p><p>  ç›¸ä¼¼åº¦ = <code>User-based CF</code>ä¸­ä½™å¼¦ç›¸ä¼¼åº¦</p><p>  ä¼˜åŒ–ï¼š</p><ul><li>ä¸éœ€è¦å–æ‰€æœ‰çš„å¥½å‹è¿›è¡Œè®¡ç®—ï¼Œåªå–ç›¸ä¼¼åº¦é«˜çš„å‰<code>K</code>ä¸ª</li><li>åªå–æœ€è¿‘çŸ­æ—¶é—´å†…å‘ç”Ÿçš„æ“ä½œè®°å½•è¿›è¡Œè®¡ç®—</li></ul></li><li><p>åŸºäºå›¾çš„ç¤¾ä¼šåŒ–æ¨è</p><ul><li>ç»“åˆç¤¾äº¤ç½‘ç»œå›¾ &amp; ç”¨æˆ·ç‰©å“äºŒåˆ†å›¾ï¼ˆä¹Ÿå¯åŠ å…¥ç¤¾åŒºçš„é¡¶ç‚¹ï¼‰</li><li>ç”¨æˆ·ä¸ç”¨æˆ·ä¹‹é—´çš„æƒé‡ = <code>a * (ç›¸ä¼¼åº¦ + ç†Ÿæ‚‰åº¦)</code></li><li>ç”¨æˆ·ä¸ç‰©å“ä¹‹é—´çš„æƒé‡ = <code>b * (ç”¨æˆ·å¯¹ç‰©å“çš„å–œçˆ±ç¨‹åº¦)</code></li><li>é€šè¿‡è°ƒèŠ‚<code>a</code>å’Œ<code>b</code>å‚æ•°ç¡®å®šå“ªéƒ¨åˆ†å¯¹ç³»ç»Ÿå½±å“è¾ƒå¤§</li></ul></li><li><p>ä¿¡æ¯æµï¼ˆFeedï¼‰æ¨è</p><p>  å¸®åŠ©ç”¨æˆ·ä»ä¿¡æ¯å¢™ä¸ŠæŒ‘é€‰æœ‰ç”¨çš„ä¿¡æ¯ï¼Œç»¼åˆè€ƒè™‘ä¿¡æ¯æµä¸­æ¯ä¸ªä¼šè¯çš„é•¿åº¦ã€æ—¶é—´ã€ç”¨æˆ·å…´è¶£é—´çš„ç›¸ä¼¼åº¦ç­‰ã€‚</p></li></ul></li><li><p>å¥½å‹æ¨èç³»ç»Ÿ</p><ul><li><p>åŸºäºå†…å®¹çš„åŒ¹é…</p><p>  ç»™ç”¨æˆ·æ¨èå’Œä»–ä»¬æœ‰ç›¸ä¼¼å†…å®¹å±æ€§çš„ç”¨æˆ·ï¼ˆäººå£ç»Ÿè®¡å­¦å±æ€§ã€ç”¨æˆ·å…´è¶£ã€ç”¨æˆ·ä½ç½®â€¦â€¦ï¼‰</p></li><li><p>åŸºäºå…±åŒå…´è¶£çš„å¥½å‹æ¨è</p><p>  åˆ©ç”¨<code>User-based CF</code>è®¡ç®—ç”¨æˆ·ä¹‹é—´çš„å…´è¶£ç›¸ä¼¼åº¦</p></li><li><p>åŸºäºç¤¾äº¤ç½‘ç»œå›¾</p><p>  <strong>æ¨èå¥½å‹çš„å¥½å‹ =&gt; æ¨èç†Ÿæ‚‰çš„å¥½å‹çš„å¥½å‹</strong></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/w_out.png" alt=""></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/w_in.png" alt=""></p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/w_out_in.png" alt=""></p><p>  <strong>ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸é«˜ï¼Œé€‚åˆåœ¨çº¿åº”ç”¨</strong></p></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¨èç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æ¨è </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ã€Šæ¨èç³»ç»Ÿå®è·µã€‹ç¬”è®° #3</title>
      <link href="/2018/05/24/recsys-note3/"/>
      <url>/2018/05/24/recsys-note3/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜"><a href="#æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜" class="headerlink" title="æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜"></a>æ¨èç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜</h3><p><strong><em>å¦‚ä½•åœ¨æ²¡æœ‰å¤§é‡ç”¨æˆ·æ•°æ®çš„æƒ…å†µä¸‹è®¾è®¡æ¨èç³»ç»Ÿ</em></strong> =&gt; <strong><em>å†·å¯åŠ¨é—®é¢˜</em></strong></p><ol><li><p>å†·å¯åŠ¨é—®é¢˜</p><ul><li>ç”¨æˆ·å†·å¯åŠ¨ =&gt; å¦‚ä½•ç»™å…¨æ–°çš„ç”¨æˆ·ä½œæ¨è</li><li>ç‰©å“å†·å¯åŠ¨ =&gt; å¦‚ä½•æŠŠæ–°åŠ å…¥çš„ç‰©å“æ¨èç»™ç”¨æˆ·</li><li>ç³»ç»Ÿå†·å¯åŠ¨ =&gt; å¦‚ä½•åœ¨ä¸€ä¸ªæ–°å¼€å‘çš„ç½‘ç«™ä¸Šè®¾è®¡å¼€å‘ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ</li></ul></li><li><p>å¸¸è§çš„å†·å¯åŠ¨è§£å†³æ–¹æ¡ˆ</p><ul><li>ä½œ<strong>éä¸ªæ€§åŒ–</strong>çš„æ¨èï¼šç›´æ¥æŒ‰çƒ­é—¨æ’è¡Œæ¦œè¿›è¡Œæ¨è</li><li>åˆ©ç”¨ç”¨æˆ·æ³¨å†Œæ—¶æä¾›çš„ä¸ªäººä¿¡æ¯ï¼š<code>age</code>, <code>sex</code>â€¦â€¦</li><li>åˆ©ç”¨ç”¨æˆ·çš„ç¤¾äº¤ç½‘ç»œä¿¡æ¯ï¼š<code>Facebook</code>, <code>å¾®åš</code>â€¦â€¦</li><li>ç”¨æˆ·æ³¨å†Œï¼ç™»é™†æ—¶å…ˆè®©å…¶å¯¹ä¸€äº›ç»™å®šç‰©å“è¿›è¡Œåé¦ˆï¼Œé‡‡é›†å…¶å…´è¶£çˆ±å¥½</li><li>å¯¹äºæ–°ç‰©å“ï¼Œå¯ä»<strong>å†…å®¹ç›¸ä¼¼æ€§</strong>çš„æ–¹å‘è¿›è¡Œæ¨èï¼Œä¸ä¸€å®šåªè€ƒè™‘è¡Œä¸ºç›¸ä¼¼æ€§</li><li>äº‹å…ˆå¼•å…¥ã€å»ºç«‹ä¸“å®¶çŸ¥è¯†åº“ï¼Œå»ºç«‹ç‰©å“ç›¸å…³åº¦è¡¨</li></ul></li><li><p>è¯¦ç»†è§£å†³æ–¹æ¡ˆ</p><ul><li><p>åˆ©ç”¨ç”¨æˆ·æ³¨å†Œä¿¡æ¯</p><ul><li><p><code>sex</code>, <code>age</code>, <code>DOB</code>, <code>job</code>, <code>ethnic</code>, <code>edu</code>, <code>location</code>ç­‰äººå£ç»Ÿè®¡å­¦ä¿¡æ¯ &amp; ç”¨æˆ·å…´è¶£æè¿°â€¦</p></li><li><p>æ¨èæµç¨‹</p><ul><li>è·å–ç”¨æˆ·æ³¨å†Œä¿¡æ¯</li><li>æ ¹æ®ä¿¡æ¯ç»™ç”¨æˆ·åˆ†ç±»</li><li>æ¨èå…¶æ‰€å±åˆ†ç±»ä¸­ç”¨æˆ·å–œæ¬¢çš„ç‰©å“</li></ul></li><li><p>ç†è®ºä¾æ®</p><p>  <code>p(f, i)</code>ä¸ºç‰©å“<code>i</code>åœ¨<code>f</code>ç‰¹å¾äººç¾¤ä¸­å—å–œçˆ±çš„ç¨‹åº¦ã€‚</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/p(f,i" alt="">.png)</p></li></ul></li><li><p>å¯åŠ¨åˆæœŸå…ˆè®©ç”¨æˆ·ç»™éƒ¨åˆ†ç‰©å“è¯„åˆ†</p><p>  å¾…è¯„åˆ†çš„ç‰©å“è¦</p><ul><li>æ¯”è¾ƒçƒ­é—¨</li><li>å…·æœ‰ä»£è¡¨æ€§ &amp; åŒºåˆ†æ€§</li><li><p>å…·æœ‰å¤šæ ·æ€§</p><p>å¯ç”¨ä¸€ä¸ª<code>Decision Tree</code>æ¥é€‰æ‹©å¯åŠ¨è¯„åˆ†ç‰©å“é›†åˆ</p></li></ul></li><li><p>åˆ©ç”¨ç‰©å“çš„å†…å®¹å±æ€§</p><p>  åœ¨<code>Item-based CF</code>ä¸­ï¼Œæ–°<code>item</code>åŠ å…¥æ—¶ï¼Œä¸ä¼šç«‹åˆ»æ›´æ–°ç‰©å“ç›¸å…³æ€§çŸ©é˜µï¼Œå› ä¸ºè®¡ç®—è€—æ—¶ç‰¹åˆ«å¤§ï¼Œæ‰€ä»¥è¦åˆ©ç”¨ç‰©å“çš„å†…å®¹å±æ€§è¿›è¡Œå†·å¯åŠ¨æ¨èã€‚</p><p>  å¯¹äºæ–‡æœ¬æ•°æ®è€Œè¨€ï¼Œè®¡ç®—å†…å®¹ç›¸ä¼¼åº¦å‰ï¼Œéœ€è¦åˆ©ç”¨NLPç›¸å…³æŠ€æœ¯è½¬åŒ–ä¸ºå‘é‡ï¼ˆ<code>keyword vector</code>ï¼‰ï¼Œä½†å‘é‡ç©ºé—´æ¨¡å‹ä¸¢å¤±äº†å¤šä¸ª<code>keyword</code>ä¹‹é—´çš„å…³è”å’Œä½ç½®ä¿¡æ¯ã€‚<strong>è€Œä¸”å¾ˆå¤šæ—¶å€™ï¼Œä¸¤ç¯‡æ–‡æœ¬æ²¡æœ‰ï¼ˆæˆ–å¾ˆå°‘ï¼‰ç›´æ¥ç›¸åŒçš„å…³é”®è¯ï¼Œä½†æ˜¯ä¸»é¢˜å´é«˜åº¦ç›¸å…³ã€‚</strong>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä½¿ç”¨<code>LDAï¼ˆLatent Dirichlet Allocationï¼‰</code>æ¥æŒ–æ˜æ–‡æœ¬ä¸»é¢˜ã€‚</p><p>  LDAæ ¸å¿ƒå…ƒç´ </p><ul><li>æ–‡æ¡£<code>D</code>: <code>D[i]</code>ä»£è¡¨æ–‡æ¡£é›†åˆä¸­ç¬¬<code>i</code>ç¯‡æ–‡æ¡£</li><li>è¯é¢˜<code>Z</code>: <code>Z[i][j]</code>ä»£è¡¨<code>i</code>æ–‡æ¡£ä¸­<code>j</code>è¯æ‰€å±çš„è¯é¢˜</li><li><p>è¯è¯­<code>W</code>: <code>W[i][j]</code>ä»£è¡¨<code>i</code>æ–‡æ¡£ä¸­çš„<code>j</code>è¯</p><p>è®¡ç®—æ­¥éª¤</p></li><li><p>å…ˆåˆ©ç”¨<code>LDA</code>æŒ–æ˜å‡ºä¸¤ç¯‡æ–‡æœ¬çš„è¯é¢˜åˆ†å¸ƒ</p></li><li>å†é€šè¿‡<code>KL-Divergenceï¼ˆKLæ•£åº¦ï¼‰</code>æ¯”è¾ƒä¸¤ä¸ªåˆ†å¸ƒçš„ç›¸ä¼¼åº¦</li></ul></li><li><p>åˆ©ç”¨ä¸“å®¶çš„ä½œç”¨ =&gt; è®©ä¸“å®¶æ‰‹åŠ¨ï¼åŠæ‰‹åŠ¨åœ°æ‰“æ ‡ç­¾</p></li></ul></li></ol><h3 id="åˆ©ç”¨ç”¨æˆ·æ ‡ç­¾æ•°æ®"><a href="#åˆ©ç”¨ç”¨æˆ·æ ‡ç­¾æ•°æ®" class="headerlink" title="åˆ©ç”¨ç”¨æˆ·æ ‡ç­¾æ•°æ®"></a>åˆ©ç”¨ç”¨æˆ·æ ‡ç­¾æ•°æ®</h3><ol><li><p><code>UGC</code> = User Generated Content ç”¨æˆ·ç”Ÿæˆæ•°æ®ï¼Œå³è®©æ™®é€šç”¨æˆ·ç»™ç‰©å“æ‰“æ ‡ç­¾ã€‚</p></li><li><p>æ ‡ç­¾ç³»ç»Ÿçš„æ¨èé—®é¢˜</p><ul><li>å¦‚ä½•åˆ©ç”¨ç”¨æˆ·æ‰“æ ‡ç­¾çš„è¡Œä¸ºä¸ºå…¶æ¨èç‰©å“</li><li>å¦‚ä½•åœ¨ç”¨æˆ·ç»™ç‰©å“æ‰“æ ‡ç­¾æ—¶ä¸ºå…¶æ¨èé€‚åˆè¯¥ç‰©å“çš„æ ‡ç­¾</li></ul></li><li><p>ç”¨æˆ·æ ‡ç­¾è¡Œä¸º</p><p> æ•°æ®ç»“æ„ï¼š<code>behavior = (u, i, b)</code>, <code>u</code> = ç”¨æˆ·ï¼Œ<code>i</code> = ç‰©å“ï¼Œ<code>b</code> = æ ‡ç­¾ã€‚</p></li><li><p>åŸºäºæ ‡ç­¾çš„ç®€å•æ¨èç®—æ³•</p><ul><li>ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·æœ€å¸¸ç”¨çš„æ ‡ç­¾</li><li><p>å¯¹äºæ¯ä¸ªå¸¸ç”¨æ ‡ç­¾ï¼Œç»Ÿè®¡è¢«æ‰“è¿‡è¯¥æ ‡ç­¾æ¬¡æ•°æœ€å¤šçš„ç‰©å“</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/tag_rec1.png" alt=""></p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/tag_rec2.png" alt=""></p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/tag_rec3.png" alt=""></p></li></ul></li><li><p>åŸºäºé‚»åŸŸçš„æ ‡ç­¾æ‰©å±•</p><p> <strong>è‹¥ä¸¤ä¸ªæ ‡ç­¾åŒæ—¶å‡ºç°åœ¨å¾ˆå¤šç‰©å“çš„æ ‡ç­¾é›†åˆä¸­ï¼Œè¿™ä¸¤ä¸ªæ ‡ç­¾å°±å…·æœ‰è¾ƒå¤§çš„ç›¸ä¼¼åº¦</strong>ï¼Œæ‰€ä»¥å¯ä»¥åŸºäºé‚»åŸŸåŸç†è®¡ç®—å‡ºç›¸ä¼¼æ ‡ç­¾ã€‚</p></li><li><p>æ ‡ç­¾æ¸…ç†</p><ul><li>å»é™¤è¯é¢‘å¾ˆé«˜çš„<code>stopword</code></li><li>å»é™¤å› è¯æ ¹ä¸åŒé€ æˆçš„åŒä¹‰è¯</li><li>å»é™¤å› åˆ†éš”ç¬¦é€ æˆçš„åŒä¹‰è¯</li><li>è®©ç”¨æˆ·ä¸»åŠ¨åé¦ˆä¸åˆé€‚çš„è¯</li></ul></li><li><p>åŸºäºå›¾çš„æ ‡ç­¾æ¨èç®—æ³•</p><p> æ•°æ®ç»“æ„ï¼š<code>V = {V(u), V(i), V(b)}</code>ï¼Œ<code>V(u)</code>ä»£è¡¨ç”¨æˆ·é¡¶ç‚¹ï¼Œ<code>V(i)</code>ä»£è¡¨ç‰©å“é¡¶ç‚¹ï¼Œ<code>V(b)</code>ä»£è¡¨æ ‡ç­¾é¡¶ç‚¹ã€‚</p><p> å»ºç«‹å›¾ç»“æ„ä¹‹åï¼Œå¯ç”¨PersonalRankç®—æ³•è¿›è¡Œéšæœºæ¸¸èµ°ã€‚</p></li><li><p>ç»™ç”¨æˆ·æ¨èæ ‡ç­¾</p><ul><li>ä¸ºä»€ä¹ˆè¦ç»™ç”¨æˆ·æ¨èæ ‡ç­¾<ul><li>æ–¹ä¾¿ç”¨æˆ·è¾“å…¥æ ‡ç­¾ï¼Œé™ä½ç”¨æˆ·æ‰“æ ‡ç­¾çš„éš¾åº¦</li><li>æé«˜æ ‡ç­¾è´¨é‡ï¼Œå‡å°‘å†—ä½™çš„åŒä¹‰è¯</li></ul></li><li>å¦‚ä½•ç»™ç”¨æˆ·æ¨èæ ‡ç­¾<ul><li>ç›´æ¥æ¨èæ•´ä¸ªç³»ç»Ÿé‡Œæœ€çƒ­é—¨çš„æ ‡ç­¾</li><li>ç»™ç”¨æˆ·æ¨èç‰©å“<code>i</code>ä¸Šçš„æœ€çƒ­é—¨æ ‡ç­¾<code>item[i][b]</code></li><li>ç»™ç”¨æˆ·æ¨èä»–è‡ªå·±å¸¸ç”¨çš„æ ‡ç­¾</li><li>èåˆä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•ï¼Œè¿›è¡Œçº¿æ€§åŠ æƒ</li><li>æˆ–è€…åŸºäºå›¾ä½œæ ‡ç­¾æ¨è</li></ul></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¨èç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æ¨è </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ã€Šæ¨èç³»ç»Ÿå®è·µã€‹ç¬”è®° #2</title>
      <link href="/2018/05/19/recsys-note2/"/>
      <url>/2018/05/19/recsys-note2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h3 id="åˆ©ç”¨ç”¨æˆ·è¡Œä¸ºæ•°æ®"><a href="#åˆ©ç”¨ç”¨æˆ·è¡Œä¸ºæ•°æ®" class="headerlink" title="åˆ©ç”¨ç”¨æˆ·è¡Œä¸ºæ•°æ®"></a>åˆ©ç”¨ç”¨æˆ·è¡Œä¸ºæ•°æ®</h3><ol><li>ç”¨æˆ·è¡Œä¸ºæ•°æ®ç±»åˆ«<ul><li>session log</li><li>impression log</li><li>click log</li></ul></li><li>ç”¨æˆ·è¡Œä¸ºç±»å‹<ul><li>æ˜¾æ€§åé¦ˆ => æ˜ç¡®é€‰æ‹©<code>å–œæ¬¢</code> or <code>ä¸å–œæ¬¢</code>ï¼Œæ•°é‡è¾ƒå°‘</li><li>éšæ€§åé¦ˆ => æ²¡æœ‰æ˜ç¡®é€‰æ‹©ï¼Œå¤šæ•°ä¸º<code>æµè§ˆ</code> or <code>ç‚¹å‡»</code>ï¼Œæ•°æ®æå¤š</li></ul></li><li><p>ç”¨æˆ·è¡Œä¸ºè®°å½•çš„æ•°æ®ç»“æ„</p><p>item</p><p>remark</p><p>user_id</p><p>ç”¨æˆ·id</p><p>item_id</p><p>ç‰©å“id</p><p>behavior_type</p><p>è¡Œä¸ºç±»å‹ï¼ˆè´­ä¹°ï¼æµè§ˆï¼ç‚¹èµï¼ç‚¹ç­ã€‚ã€‚ã€‚ï¼‰</p><p>context</p><p>ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ—¶é—´ï¼åœ°ç‚¹ã€‚ã€‚ã€‚ï¼‰</p><p>behavior_weight</p><p>æƒé‡ï¼ˆè§†é¢‘è§‚çœ‹æ—¶é•¿ï¼æ–‡ç« è¯„åˆ†ã€‚ã€‚ã€‚ï¼‰</p><p>behavior_content</p><p>å†…å®¹ï¼ˆè¯„è®ºçš„æ–‡æœ¬ï¼æ‰“æ ‡ç­¾ä¸­çš„æ ‡ç­¾ã€‚ã€‚ã€‚ï¼‰</p></li><li><p>åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®çš„ç®—æ³•</p><ul><li>ç”¨æˆ·ååŒè¿‡æ»¤ç®—æ³•ï¼ˆUser-based CFï¼‰</li><li>ç‰©å“ååŒè¿‡æ»¤ç®—æ³•ï¼ˆItem-based CFï¼‰</li></ul></li><li><p>ç”¨æˆ·ååŒè¿‡æ»¤ç®—æ³•</p><ul><li><p>ç®—æ³•æ­¥éª¤</p><ol><li>æ‰¾åˆ°å’Œç›®æ ‡ç”¨æˆ·ç›¸ä¼¼çš„ç”¨æˆ·é›†åˆ<code>U</code></li><li>æ‰¾åˆ°<code>U</code>ä¸­æ¯ä¸ªç”¨æˆ·<code>u</code>å–œæ¬¢çš„ç‰©å“<code>i</code>ï¼Œä¸”å½“å‰ç›®æ ‡ç”¨æˆ·æœªå¯¹<code>i</code>æœ‰è¿‡ä»»ä½•è¡Œä¸º</li><li>åˆ©ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ç”¨æˆ·é—´çš„ç›¸ä¼¼åº¦ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/cosine_similarity.png" alt=""></li></ol></li><li><p>ä¸‰ä¸ªä¸­é—´ç»“æœçŸ©é˜µ</p><ul><li><code>W[][]</code>ï¼š<code>W[u][v]</code>ä»£è¡¨äº†ç”¨æˆ·<code>u</code>å’Œç”¨æˆ·<code>v</code>é—´çš„ç›¸ä¼¼åº¦</li><li><code>C[][]</code>ï¼š<code>C[u][v]</code>ç­‰äº<code>|N(u)|âˆ©|N(v)|</code></li><li><code>N[]</code>ï¼š<code>N[u]</code>ç­‰äºç”¨æˆ·<code>u</code>å‘ç”Ÿè¿‡è¡Œä¸ºçš„ç‰©å“æ•°</li></ul></li><li>ä¼˜åŒ–æ”¹è¿›<ul><li>ä¸ºäº†æé«˜ç®—æ³•æ•ˆç‡ï¼Œå…¶å®å½“<code>|N(u)|âˆ©|N(v)| = 0</code>çš„æ—¶å€™ï¼ˆå³ä¸¤ä¸ªç”¨æˆ·é—´æ²¡æœ‰ä»»ä½•äº¤é›†ï¼‰ï¼Œå‹æ ¹ä¸ç”¨å»è®¡ç®—<code>u</code>å’Œ<code>v</code>é—´çš„ç›¸ä¼¼åº¦ã€‚æ‰€ä»¥å¯ä»¥å»ºç«‹<code>ç‰©å“-ç”¨æˆ·å€’æ’è¡¨</code>ï¼Œæ²¡æœ‰äº¤é›†çš„ç”¨æˆ·<strong>ç»å¯¹ä¸ä¼š</strong>å‡ºç°åœ¨åŒä¸€ä¸ªç‰©å“æ‰€å±çš„é“¾ä¸­ã€‚</li><li>ä»ç†è®ºä¸Šè®²ï¼Œåº”è¯¥<strong>å¤šè€ƒè™‘å†·é—¨ç‰©å“çš„è´¡çŒ®åº¦ï¼Œé€‚å½“æƒ©ç½šçƒ­é—¨ç‰©å“å¸¦æ¥çš„ç›¸å…³æ€§</strong>ï¼Œå› ä¸ºçƒ­é—¨ç‰©å“å¯èƒ½æ¯ä¸ªäººéƒ½ä¼šä¹°ï¼Œä¸åº”è¯¥å¸¦æ¥å¤ªå¤šçš„ä¸ªæ€§åŒ–ç›¸å…³æ€§ã€‚æ‰€ä»¥è¦å¯¹åŸå§‹çš„å…¬å¼å¼•å…¥æƒ©ç½šæœºåˆ¶ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/user_penalty.png" alt=""></li></ul></li></ul></li><li><p>ç‰©å“ååŒè¿‡æ»¤ç®—æ³• <strong>ç‰©å“ç›¸ä¼¼åº¦å¹¶ä¸æ˜¯åˆ©ç”¨ç‰©å“çš„å†…å®¹å±æ€§è®¡ç®—å…¶ç›¸ä¼¼åº¦ï¼Œè€Œæ˜¯ä»ç”¨æˆ·è¡Œä¸ºè®°å½•çš„è§’åº¦è®¡ç®—</strong></p><ul><li>ç®—æ³•æ­¥éª¤<ol><li>è®¡ç®—ç‰©å“é—´çš„ç›¸ä¼¼åº¦ï¼ˆçŸ©é˜µï¼‰</li><li>æ ¹æ®ç›¸ä¼¼åº¦çŸ©é˜µå’Œç”¨æˆ·çš„å†å²è¡Œä¸ºè®°å½•ç”Ÿæˆæ¨èåˆ—è¡¨</li></ol></li><li>ä¸‰ä¸ªä¸­é—´ç»“æœçŸ©é˜µ<ul><li><code>W[][]</code>ï¼š<code>W[i][j]</code>ä»£è¡¨äº†ç‰©å“<code>i</code>å’Œç‰©å“<code>j</code>é—´çš„ç›¸ä¼¼åº¦</li><li><code>C[][]</code>ï¼š<code>C[i][j]</code>ç­‰äº<code>|N(i)|âˆ©|N(j)|</code>, å°±æ˜¯åŒæ—¶å¯¹<code>i</code>å’Œ<code>j</code>å‘ç”Ÿè¿‡è¡Œä¸ºçš„ç”¨æˆ·æ•°</li><li><code>N[]</code>ï¼š<code>N[i]</code>ç­‰äºå¯¹ç‰©å“<code>i</code>å‘ç”Ÿè¿‡è¡Œä¸ºçš„ç”¨æˆ·æ•°</li></ul></li><li><p>ç®—æ³•ä¼˜ç‚¹ èƒ½å¤Ÿæä¾›æ¨èè§£é‡Šï¼Œåˆ©ç”¨ç”¨æˆ·å†å²ä¸Šå–œæ¬¢çš„ç‰©å“ä¸ºç°åœ¨çš„æ¨èç»“æœè¿›è¡Œè§£é‡Šã€‚ä¸åƒ<code>User-based CF</code>é‚£æ ·æ— æ³•æä¾›åˆç†çš„è§£é‡Šã€‚</p></li><li><p>ä¼˜åŒ–æ”¹è¿›</p><ul><li><p>å¼•å…¥Inverse User Frequencyå¯¹æ´»è·ƒç”¨æˆ·è¿›è¡Œæƒ©ç½š =&gt; æ´»è·ƒç”¨æˆ·å¯¹ç‰©å“ç›¸ä¼¼åº¦çš„è´¡çŒ®åº”å°äºéæ´»è·ƒç”¨æˆ· <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/IUF.png" alt=""> <strong>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ç›´æ¥å¿½ç•¥ç‰¹åˆ«å¤§çš„å…´è¶£åˆ—è¡¨ï¼Œæé«˜ç®—æ³•æ•ˆç‡ã€‚</strong></p></li><li><p>å°†ç›¸ä¼¼åº¦çŸ©é˜µæŒ‰è¡Œå½’ä¸€åŒ– <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/normalize.png" alt=""> Example: <code>A</code>ç±»ç±»å†…ç‰©å“ç›¸ä¼¼åº¦0.5ï¼Œ<code>B</code>ç±»ç±»å†…ç‰©å“ç›¸ä¼¼åº¦0.6ï¼ŒABç±»é—´ç‰©å“ç›¸ä¼¼åº¦0.2ã€‚ç”±äº<code>B</code>ç±»ç±»å†…ç‰©å“ç›¸ä¼¼åº¦æœ€é«˜ï¼Œæ‰€ä»¥æ¨è10ä¸ªç‰©å“æ—¶10ä¸ªéƒ½ä¼šæ˜¯<code>B</code>ç±»ç‰©å“ã€‚è¿›è¡Œå½’ä¸€åŒ–åï¼Œ<code>A</code>ç±»ä¸<code>B</code>ç±»ç±»å†…ç‰©å“ç›¸ä¼¼åº¦å‡ä¸º1ï¼Œæ¨è10ä¸ªç‰©å“æ—¶ä¼šæœ‰5ä¸ª<code>A</code>ç‰©å“&amp;5ä¸ª<code>B</code>ç‰©å“</p></li></ul></li></ul></li><li><p><code>User-based CF</code>ä¸<code>Item-based CF</code>ç»¼åˆæ¯”è¾ƒ</p><ul><li><code>User-based CF</code>ç€é‡äºåæ˜ å’Œç”¨æˆ·å…´è¶£ç›¸ä¼¼çš„å°ç¾¤ä½“çš„çƒ­ç‚¹</li><li><code>Item-based CF</code>ç€é‡äºç»´æŠ¤ç›®æ ‡ç”¨æˆ·çš„å†å²å…´è¶£</li><li><code>User-based CF</code>ç»´æŠ¤ç”¨æˆ·ç›¸ä¼¼åº¦çŸ©é˜µï¼Œ<code>Item-based CF</code>ç»´æŠ¤ç‰©å“ç›¸ä¼¼åº¦çŸ©é˜µã€‚éœ€è¦è€ƒè™‘æ•°æ®å­˜å‚¨çš„ä»£ä»·å’ŒçŸ©é˜µè®¡ç®—çš„ä»£ä»· => ç”¨æˆ·æ•°å¤š or ç‰©å“æ•°å¤š</li></ul></li><li><p>å“ˆåˆ©æ³¢ç‰¹é—®é¢˜ ã€Šå“ˆåˆ©æ³¢ç‰¹ã€‹å¾ˆçƒ­é—¨ï¼Œå‡ ä¹ä¹°äº†ä»»ä½•ä¹¦çš„äººéƒ½ä¼šå»ä¹°ã€Šå“ˆåˆ©æ³¢ç‰¹ã€‹ï¼Œæ‰€ä»¥<strong>å¯¹çƒ­é—¨ç‰©å“è¦è¿›è¡Œæƒ©ç½š</strong>ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/harryporter.png" alt=""> é€šè¿‡æé«˜alphaçš„å–å€¼ï¼ˆ<code>[0.5, 1.0]</code>ï¼‰ï¼Œå¯æƒ©ç½šçƒ­é—¨ç‰©å“ã€‚</p></li><li><p>éšè¯­ä¹‰æ¨¡å‹ï¼ˆ<code>Latent Factor Model</code>)</p><ul><li><p>æ¨¡å‹èƒŒæ™¯ <strong>ä»…é ç”¨æˆ·è¡Œä¸ºæ•°æ®æ— æ³•è§£å†³è·¨é¢†åŸŸçš„é—®é¢˜</strong>ï¼Œä¾‹å¦‚å¾ˆå¤šäººçœ‹å®Œ7ç‚¹çš„æ–°é—»è”æ’­ä¼šç»§ç»­å¼€ç€ç”µè§†çœ‹8ç‚¹çš„ç”µè§†å‰§ï¼Œä½†ç»™çœ‹äº†ç”µè§†å‰§çš„äººæ¨èæ–°é—»è”æ’­æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚<strong>ä¸¤ä¸ªä¸åŒé¢†åŸŸçš„æœ€çƒ­é—¨ç‰©å“é—´å¾€å¾€ä¼šå­˜åœ¨è¾ƒé«˜çš„ç›¸ä¼¼åº¦</strong>ï¼Œä¸æ˜¯å› ä¸ºå®ƒä»¬çœŸçš„ç›¸ä¼¼ï¼Œåªæ˜¯å› ä¸ºå®ƒä»¬éƒ½å¾ˆçƒ­é—¨ï¼Œæ‰€ä»¥å¤§å®¶éƒ½ä¼šçœ‹ã€‚</p></li><li><p>éœ€è¦è§£å†³çš„é—®é¢˜ éšè¯­ä¹‰æ¨¡å‹ï¼ˆ<code>Latent Factor Model</code>) => <strong>åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®çš„èšç±»</strong>ï¼Œè§£å†³</p><ul><li>å¦‚ä½•ç»™ç‰©å“åˆ†ç±»ï¼ˆåŸºäºç”¨æˆ·è¡Œä¸ºï¼Œè€Œä¸æ˜¯å†…å®¹å±æ€§ï¼‰</li><li>å¦‚ä½•ç¡®å®šç”¨æˆ·å¯¹å“ªäº›ç±»çš„ç‰©å“æ„Ÿå…´è¶£ï¼Œä»¥åŠæ„Ÿå…´è¶£çš„ç¨‹åº¦</li><li>å¯¹äºä¸€ä¸ªç»™å®šçš„æ³ªï¼Œé€‰æ‹©å…¶ä¸­å“ªäº›ç‰©å“ä½œæ¨èï¼Œæ¨èçš„æƒé‡æ˜¯å¤šå°‘ï¼Ÿ</li></ul></li><li><p>ç†è®º <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/LFM1.png" alt=""> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/LFM2.png" alt=""> åé¢å¸¦<code>lambda</code>çš„ä¸¤é¡¹ä¸ºæ­£åˆ™é¡¹ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚ ä½¿ç”¨ï¼ˆéšæœºï¼‰æ¢¯åº¦ä¸‹é™ï¼Œæœ€å°åŒ–æŸå¤±å‡½æ•°<code>C</code>ï¼Œè®¡ç®—å¾—åˆ°<code>p</code>å’Œ<code>q</code>ã€‚ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/LFM3.png" alt=""> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/LFM4.png" alt=""></p></li><li><p>å…³é”®å‚æ•°</p><ul><li>éšç‰¹å¾ä¸ªæ•°<code>F</code>(æˆ–è€…å«<code>K</code>)</li><li>æ¢¯åº¦ä¸‹é™çš„æ­¥é•¿ï¼å­¦ä¹ é€Ÿç‡<code>alpha</code></li><li>æ­£åˆ™åŒ–å‚æ•°<code>lambda</code></li><li>æ­£ï¼è´Ÿæ ·æœ¬çš„æ¯”ä¾‹<code>ratio</code></li></ul></li><li>å¸¸è§é—®é¢˜ éšè¯­ä¹‰æ¨¡å‹ï¼ˆ<code>Latent Factor Model</code>)åœ¨<strong>æ˜¾å¼è¯„åˆ†æ•°æ®é›†</strong>ä¸Šè¡¨ç°å¾ˆå¥½ï¼Œè€Œå¯¹äº<strong>éšå¼è¯„åˆ†æ•°æ®é›†</strong>è€Œè¨€é‡ç‚¹åœ¨äºå¦‚ä½•ç”Ÿæˆè´Ÿæ ·æœ¬ã€‚ç”Ÿæˆè´Ÿæ ·æœ¬çš„åŸåˆ™æœ‰<ul><li>å¯¹äºæ¯ä¸ªç”¨æˆ·ï¼Œè¦ä¿è¯æ­£ï¼è´Ÿæ ·æœ¬çš„å¹³è¡¡ï¼ˆç›¸è¿‘æˆ–ç›¸ç­‰ï¼‰</li><li>å°†åŸæ•°æ®é›†ä¸­éå¸¸çƒ­é—¨ï¼Œä½†ç”¨æˆ·å´æ²¡æœ‰è¿‡è¡Œä¸ºçš„ç‰©å“å½“ä½œè´Ÿæ ·æœ¬ => ä¸å°†å†·é—¨ç‰©å“ä½œä¸ºè´Ÿæ ·æœ¬æ˜¯å› ä¸ºç”¨æˆ·å¯èƒ½å‹æ ¹æ²¡æœ‰å‘ç°å†·é—¨ç‰©å“ï¼Œè€Œä¸æ˜¯å¯¹å†·é—¨ç‰©å“ä¸æ„Ÿå…´è¶£ã€‚</li></ul></li><li>æ¨¡å‹ç‰¹ç‚¹<ul><li>éšè¯­ä¹‰æ¨¡å‹ï¼ˆ<code>Latent Factor Model</code>)æœ‰è¾ƒå¥½çš„ç†è®ºåŸºç¡€ï¼Œæ˜¯ä¸€ç§å­¦ä¹ æ–¹æ³•ï¼Œæœ‰å­¦ä¹ è¿‡ç¨‹</li><li>ä¸­é—´ç»“æœçš„å­˜å‚¨ç©ºé—´åªéœ€è¦<code>O(F * (M + N))</code>ï¼Œï¼ˆ<code>F</code>ä¸ºéšç‰¹å¾ä¸ªæ•°ï¼Œ<code>M</code>ä¸ºç”¨æˆ·æ•°ï¼Œ<code>N</code>ä¸ºç‰©å“æ•°ï¼‰ï¼Œè€ŒååŒè¿‡æ»¤åˆ™éœ€è¦<code>O(N * N)</code></li><li>æ—¶é—´å¤æ‚åº¦ä¸º<code>O(K * F *S)</code>ï¼Œï¼ˆ<code>F</code>ä¸ºéšç‰¹å¾ä¸ªæ•°ï¼Œ<code>K</code>ä¸ºè¡Œä¸ºè®°å½•æ•°ï¼Œ<code>S</code>ä¸ºè¿­ä»£æ¬¡æ•°ï¼‰</li><li>ä¸é€‚åˆç”¨äºå®æ—¶æ¨èï¼Œç”¨æˆ·å‘ç”Ÿäº†æ–°è¡Œä¸ºåï¼Œæ¨èåˆ—è¡¨ä¸ä¼šå‘ç”Ÿå˜åŒ–</li><li>å¾ˆéš¾åƒ<code>Item-based CF</code>ä¸€æ ·ç”¨è‡ªç„¶è¯­è¨€è§£é‡Šæ¨èåŸå› </li></ul></li></ul></li><li><p>åŸºäº<strong>å›¾</strong>çš„æ¨èæ¨¡å‹ <strong>ç”¨æˆ·è¡Œä¸ºå®¹æ˜“ç”¨å›¾ç»“æ„è¡¨ç¤º</strong>ï¼Œ<code>G = (V, E)</code>ï¼Œ<code>V = V(u) âˆ© V(i)</code>ã€‚ç”¨æˆ·å’Œç‰©å“å‡æ˜¯å›¾ä¸­çš„é¡¶ç‚¹ï¼Œè‹¥ç”¨æˆ·<code>u</code>å¯¹ç‰©å“<code>i</code>å‘ç”Ÿè¿‡è¡Œä¸ºï¼Œåˆ™å­˜åœ¨è¾¹<code>e(u, i)</code>ã€‚ æ‰€ä»¥ç»™ç”¨æˆ·<code>u</code>æ¨èç‰©å“ = æ‰¾åˆ°è·Ÿ<code>V(u)</code>æ— <strong>ç›´æ¥è¾¹</strong>ç›¸è¿çš„é¡¶ç‚¹ä¸­ç›¸å…³æ€§æœ€é«˜çš„é¡¶ç‚¹ã€‚ é¡¶ç‚¹ä¸¤ä¸¤é—´çš„ç›¸å…³æ€§å–å†³äº</p><ul><li>ä¸¤ç‚¹é—´çš„è·¯å¾„æ•°</li><li>ä¸¤ç‚¹é—´è·¯å¾„çš„é•¿åº¦</li><li>ä¸¤ç‚¹é—´è·¯å¾„æ‰€ç»è¿‡çš„ç‚¹</li></ul><p><strong>å¦‚æœä¸¤ç‚¹é—´æœ‰å¾ˆå¤šæ¡ä¸åŒè·¯å¾„ï¼ä¸¤ç‚¹é—´æ¯æ¡è·¯å¾„çš„é•¿åº¦è¾ƒçŸ­ï¼ä¸¤ç‚¹é—´çš„è·¯å¾„ä¸ä¼šç»è¿‡å‡ºåº¦è¾ƒå¤§çš„ç‚¹ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç›¸å…³æ€§ç›¸å¯¹è€Œè¨€å°±æ¯”è¾ƒé«˜ã€‚</strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/PR.png" alt=""></p><p><strong><em>PersonalRankç®—æ³•</em></strong>ï¼Œé‡‡ç”¨äº†<strong>éšæœºæ¸¸èµ°</strong>çš„æ¦‚å¿µï¼Œå›¾ä¸­æ¯ä¸ªç‰©å“é¡¶ç‚¹<code>V(i)</code>è¢«è®¿é—®çš„æ¦‚ç‡<code>PR(v(i))</code>å³ä¸ºè¯¥ç‰©å“<code>i</code>æœ€ååœ¨æ¨èåˆ—è¡¨ä¸­çš„æƒé‡ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¨èç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æ¨è </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ã€Šæ¨èç³»ç»Ÿå®è·µã€‹ç¬”è®° #1</title>
      <link href="/2018/05/12/recsys-note1/"/>
      <url>/2018/05/12/recsys-note1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%ç”±æœ¬äººï¼ˆHaoxiang Ma)åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p></blockquote><h2 id="æ¦‚å¿µä¸å®šä¹‰"><a href="#æ¦‚å¿µä¸å®šä¹‰" class="headerlink" title="æ¦‚å¿µä¸å®šä¹‰"></a>æ¦‚å¿µä¸å®šä¹‰</h2><ol><li>æ¨èç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤åˆç³»ç»Ÿï¼Œç”¨äºå°†<code>User</code>å’Œ<code>Item</code>äº’ç›¸å…³è”ï¼Œç»™<code>User</code>æ¨èâ€œåˆé€‚çš„â€<code>Item</code>ï¼ŒåŒæ—¶ç»™<code>Item</code>æ‰¾åˆ°æ½œåœ¨çš„ä¹°å®¶ï¼ç”¨æˆ·ã€‚ç³»ç»Ÿèµ·æºäº<strong>ä¿¡æ¯è¿‡è½½</strong>é—®é¢˜ï¼Œéšç€äº’è”ç½‘ä¿¡æ¯çˆ†ç‚¸æ€§å¢é•¿ï¼Œç”¨æˆ·æ²¡æœ‰åŠæ³•çŸ­æ—¶é—´å†…æ¥å—å®Œæ‰€æœ‰ä¿¡æ¯ã€‚</li><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¨èç³»ç»Ÿçš„ç»“æ„ä¸º<ul><li>å‰ç«¯é¡µé¢</li><li>åç«¯æœåŠ¡ï¼ˆæ—¥å¿—ç³»ç»Ÿï¼‰</li><li>æ¨èç®—æ³•ç³»ç»Ÿ</li></ul></li><li>å¦‚ä½•è¯„ä»·ä¸€ä¸ªæ¨èç³»ç»Ÿçš„ä¼˜åŠ£ï¼Ÿè¦ä»å¤šä¸ªè§’åº¦å…¥æ‰‹è¿›è¡Œè€ƒå¯Ÿ<ul><li>ç¦»çº¿å®éªŒ<ol><li>é¦–å…ˆä»æµ·é‡æ—¥å¿—æ–‡ä»¶ä¸­æ”¶é›†ã€æ¸…æ´—æ‰€éœ€çš„ç”¨æˆ·æ•°æ®ï¼Œç”Ÿæˆæ ‡å‡†æ•°æ®é›†</li><li>å°†æ•°æ®é›†éšæœºåˆ†æˆ<code>è®­ç»ƒé›†</code> &amp; <code>æµ‹è¯•é›†</code></li><li>ç”¨<code>è®­ç»ƒé›†</code>è®­ç»ƒå‡ºå…´è¶£æ¨¡å‹ï¼Œåœ¨<code>æµ‹è¯•é›†</code>ä¸Šè¿›è¡Œé¢„æµ‹æµ‹è¯•</li><li>å»ºç«‹ä¸€ä¸ªè¯„ä»·å…¬å¼å»è¯„ä¼°æµ‹è¯•ç»“æœ</li></ol></li><li>ç”¨æˆ·è°ƒæŸ¥ï¼ˆé—®å·ï¼‰<ol><li>è®¾è®¡é—®å·ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™é€‰å–ç”¨æˆ·è¿›è¡Œè°ƒæŸ¥</li><li><strong>æˆæœ¬è¾ƒé«˜ï¼Œéš¾ä»¥è®¾è®¡</strong></li></ol></li><li>åœ¨çº¿å®éªŒï¼ˆ<strong><em>A/B Test</em></strong>ï¼‰<ol><li>å°†ç”¨æˆ·éšæœºï¼æŒ‰ç…§ç‰¹å®šè§„åˆ™åˆ†æˆ<code>K</code>ç»„ï¼Œåœ¨æ¯ç»„ç”¨æˆ·ä¸Šå„è‡ªåº”ç”¨ä¸åŒçš„ç®—æ³•ï¼Œç„¶åæ¯”è¾ƒä¸åŒç»„ç”¨æˆ·çš„è¯„ä»·æŒ‡æ ‡ï¼ˆç‚¹å‡»ç‡ï¼Œè½¬åŒ–ç‡ç­‰ç­‰ï¼‰</li><li>éœ€è¦åœ¨å‰ç«¯çš„æµé‡å…¥å£å°±å°†ç”¨æˆ·åˆ†ç»„ï¼Œå¹¶æ‰“ä¸Šç»„åˆ«æ ‡ç­¾ï¼Œå„ç»„åˆ†åˆ«æ”¶é›†æ—¥å¿—</li></ol></li><li>è®¾è®¡æ–°ç³»ç»Ÿæ—¶éœ€è¦ç»“åˆä»¥ä¸Š3ç§æ–¹æ³•<ol><li>ç”¨<code>ç¦»çº¿å®éªŒ</code>è¯æ˜å„ä¸ªç¦»çº¿æŒ‡æ ‡ä¼˜äºå½“å‰ç³»ç»Ÿ</li><li>ç”¨<code>ç”¨æˆ·è°ƒæŸ¥ï¼ˆé—®å·ï¼‰</code>è¯æ˜ç”¨æˆ·æ»¡æ„åº¦é«˜äºå½“å‰ç³»ç»Ÿ</li><li>ç”¨<code>åœ¨çº¿å®éªŒï¼ˆA/B Testï¼‰</code>ç¡®å®šå•†ä¸šæŒ‡æ ‡&amp;å…¶ä»–æ‰€å…³å¿ƒçš„æŒ‡æ ‡ä¸Šä¼˜äºå½“å‰ç³»ç»Ÿ</li></ol></li></ul></li><li><p>è¯„ä»·æŒ‡æ ‡</p><ul><li>ç”¨æˆ·æ»¡æ„åº¦ => é€šè¿‡é—®å·è°ƒæŸ¥æˆ–å‰ç«¯åé¦ˆé¡µé¢</li><li><p>é¢„æµ‹å‡†ç¡®åº¦ => é€šè¿‡<code>ç¦»çº¿å®éªŒ</code></p><ol><li><p>è¯„åˆ†é¢„æµ‹å‹ç³»ç»Ÿï¼ˆé¢„æµ‹ç”¨æˆ·ç»™ä»–æ²¡æœ‰è§è¿‡çš„<code>Item</code>æ‰“å¤šå°‘åˆ†ï¼‰</p><ul><li><p>RMSEï¼ˆå‡æ–¹æ ¹è¯¯å·®ï¼‰ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/RMSE.png" alt=""></p></li><li><p>MAEï¼ˆå¹³å‡ç»å¯¹è¯¯å·®ï¼‰ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/MAE.png" alt=""></p></li></ul></li><li><p>TopNæ¨èå‹ç³»ç»Ÿï¼ˆç»™ç”¨æˆ·æ¨è<code>N</code>ä¸ªä»–æ²¡è§è¿‡çš„<code>Item</code>)</p><ul><li><p>Precisionï¼ˆå‡†ç¡®ç‡ï¼‰ ç®€å•æ¥è¯´å°±æ˜¯<strong>æ¨èå‡ºæ¥çš„ç»“æœä¸­æœ‰å¤šå°‘ä¸ªæ˜¯å½“å‰ç”¨æˆ·çœŸæ­£æ„Ÿå…´è¶£çš„</strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/precision.png" alt=""></p></li><li><p>Recallï¼ˆå¬å›ç‡ï¼‰ ç®€å•æ¥è¯´å°±æ˜¯<strong>æœ‰å¤šå°‘å½“å‰ç”¨æˆ·çœŸæ­£æ„Ÿå…´è¶£çš„ç‰©å“è¢«æˆåŠŸæ¨èå‡ºæ¥</strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/recall.png" alt=""></p></li><li><p>ä¸ºäº†å…¨é¢ä¸€ç‚¹ï¼Œå¯ä»¥å¯¹TopNä¸­çš„<code>N</code>å–å¤šä¸ªå€¼ï¼Œç»˜åˆ¶å‡ºä¸€æ¡<code>p/r curve</code></p></li></ul></li><li><p>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ›´å¤šä¼šä½¿ç”¨<strong>TopN</strong>æ¨¡å‹ï¼Œå› ä¸ºç”¨æˆ·ç»™ä¸€ä¸ª<code>Item</code>æ‰“é«˜åˆ†ä¸ç­‰äºä»–å¾ˆæƒ³è´­ä¹°ï¼é˜…è¯»è¯¥ç‰©å“</p></li></ol></li><li><p>è¦†ç›–ç‡ => ç³»ç»Ÿèƒ½å¤Ÿæ¨èå‡ºæ¥çš„ç‰©å“å æ€»ç‰©å“é›†åˆçš„æ¯”ä¾‹ <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/coverage.png" alt=""></p></li><li><p>å¤šæ ·æ€§</p><ul><li><p>æ¨èç»“æœåˆ—è¡¨ä¸­ç‰©å“ä¸¤ä¸¤ä¹‹é—´çš„<strong>ä¸ç›¸ä¼¼æ€§</strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/diversity1.png" alt=""></p></li><li><p>ç³»ç»Ÿæ€»ä½“çš„<strong>ä¸ç›¸ä¼¼æ€§</strong> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/diversity2.png" alt=""></p></li></ul></li><li><p>æ–°é¢–æ€§ => ç»™ç”¨æˆ·æ¨èä»–ä»¬ä»æ¥æœªå¬è¯´è¿‡çš„ï¼Œåƒä¸‡ä¸èƒ½æ¨èä»–ä»¬å·²ç»çœ‹è¿‡ï¼è´­ä¹°è¿‡çš„</p></li><li><p>æƒŠå–œåº¦</p></li><li>ä¿¡ä»»åº¦</li><li>å®æ—¶æ€§</li><li>å¥å£®æ€§</li><li>å•†ä¸šç›®æ ‡</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ¨èç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> æ¨è </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Leetcodeé¢˜è§£] - Construct Binary Tree from XX-Order</title>
      <link href="/2018/04/22/leetcode-105106/"/>
      <url>/2018/04/22/leetcode-105106/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¡Œæ–‡ç”±æœ¬äºº(Haoxiang Ma)åŸåˆ›ï¼Œæ€è·¯å€Ÿé‰´äº†Leetcodeé«˜ç¥¨ç­”æ¡ˆï¼ŒåŠ ä»¥ä¸ªäººåˆ†æï¼Œå®ç°ï¼Œæ€»ç»“ã€‚å¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é¢˜ç›®èƒŒæ™¯"><a href="#é¢˜ç›®èƒŒæ™¯" class="headerlink" title="é¢˜ç›®èƒŒæ™¯"></a>é¢˜ç›®èƒŒæ™¯</h2><ul><li><strong>[Leetcode 105]</strong> <code>Construct Binary Tree from Preorder and Inorder Traversal</code></li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Given preorder and inorder traversal of a tree, construct the binary tree.</span><br><span class="line"></span><br><span class="line">Note:</span><br><span class="line">You may assume that duplicates do not exist in the tree.</span><br><span class="line"></span><br><span class="line">For example, given</span><br><span class="line"></span><br><span class="line">preorder = [3,9,20,15,7]</span><br><span class="line">inorder = [9,3,15,20,7]</span><br><span class="line">Return the following binary tree:</span><br><span class="line"></span><br><span class="line">    3</span><br><span class="line">   / \</span><br><span class="line">  9  20</span><br><span class="line">    /  \</span><br><span class="line">   15   7</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç»™å®šäºŒå‰æ ‘çš„å…ˆåºéå†ç»“æœ+äºŒå‰æ ‘çš„ä¸­åºéå†ç»“æœï¼Œé‡æ„äºŒå‰æ ‘ã€‚</p><ul><li><strong>[Leetcode 106]</strong> <code>Construct Binary Tree from Inorder and Postorder Traversal</code></li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Given inorder and postorder traversal of a tree, construct the binary tree.</span><br><span class="line"></span><br><span class="line">Note:</span><br><span class="line">You may assume that duplicates do not exist in the tree.</span><br><span class="line"></span><br><span class="line">For example, given</span><br><span class="line"></span><br><span class="line">inorder = [9,3,15,20,7]</span><br><span class="line">postorder = [9,15,7,20,3]</span><br><span class="line">Return the following binary tree:</span><br><span class="line"></span><br><span class="line">    3</span><br><span class="line">   / \</span><br><span class="line">  9  20</span><br><span class="line">    /  \</span><br><span class="line">   15   7</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç»™å®šäºŒå‰æ ‘çš„ä¸­åºéå†ç»“æœ+äºŒå‰æ ‘çš„ååºéå†ç»“æœï¼Œé‡æ„äºŒå‰æ ‘ã€‚</p><h2 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h2><p>105å’Œ106ä¸¤é¢˜çš„é¢˜ç›®èƒŒæ™¯ç±»ä¼¼ï¼Œéƒ½æ˜¯ç»™å®šæŸä¸¤ç§äºŒå‰æ ‘çš„éå†ç»“æœï¼Œè¦æ±‚é‡æ„äºŒå‰æ ‘ï¼Œ<strong>ä¸”ä¸¤é¢˜å‡æä¾›äº†ä¸­åºéå†ç»“æœ</strong>ã€‚</p><p>é¦–å…ˆï¼Œå¯¹é¢˜ä¾‹ä¸­çš„äºŒå‰æ ‘ç»“æ„ä»¥åŠå…¶å¯¹åº”çš„ä¸‰ç§éå†ç»“æœè¿›è¡Œå¯¹æ¯”å’Œåˆ†æã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    3</span><br><span class="line">   / \</span><br><span class="line">  9  20</span><br><span class="line">    /  \</span><br><span class="line">   15   7</span><br><span class="line">   </span><br><span class="line">preorder = [3,9,20,15,7]</span><br><span class="line">inorder = [9,3,15,20,7]</span><br><span class="line">postorder = [9,15,7,20,3]</span><br></pre></td></tr></table></figure><p>ä»”ç»†è§‚å¯Ÿä»¥ä¸Šä¸‰ç§éå†ç»“æœï¼Œä¸éš¾å‘ç°ä»¥ä¸‹è§„å¾‹ï¼š</p><ol><li><p><strong>ä»å·¦åˆ°å³</strong>éå†preorderåºåˆ—ï¼Œå¯¹äºæ¯ä¸€ä¸ªå…ƒç´ ï¼Œå‡èƒ½åœ¨inorderåºåˆ—ä¸­æ‰¾åˆ°ã€‚ä¸”è¯¥å…ƒç´ åœ¨äºŒå‰æ ‘ä¸­çš„<strong>å·¦å­æ ‘</strong>ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨inorderåºåˆ—é‡Œè¯¥å…ƒç´ çš„<strong>å·¦è¾¹</strong>ï¼Œè¯¥å…ƒç´ åœ¨äºŒå‰æ ‘ä¸­çš„<strong>å³å­æ ‘</strong>ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨inorderåºåˆ—é‡Œè¯¥å…ƒç´ çš„<strong>å³è¾¹</strong>ã€‚ä¾‹å¦‚å¯¹äº3ï¼Œå…¶åœ¨äºŒå‰æ ‘ä¸­å·¦å­æ ‘é‡Œæœ‰9ï¼Œæ­£å¥½åœ¨inorderåºåˆ—é‡Œ9åœ¨3çš„å·¦è¾¹ï¼›å…¶å³å­æ ‘é‡Œæœ‰20,15,7ï¼Œæ­£å¥½åœ¨inorderåºåˆ—é‡Œ20,15,7éƒ½åœ¨3çš„å³è¾¹ã€‚</p></li><li><p><strong>ä»å³åˆ°å·¦</strong>éå†postorderåºåˆ—ï¼Œå¯¹äºæ¯ä¸€ä¸ªå…ƒç´ ï¼Œå‡èƒ½åœ¨inorderåºåˆ—ä¸­æ‰¾åˆ°ã€‚ä¸”è¯¥å…ƒç´ åœ¨äºŒå‰æ ‘ä¸­çš„<strong>å·¦å­æ ‘</strong>ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨inorderåºåˆ—é‡Œè¯¥å…ƒç´ çš„<strong>å·¦è¾¹</strong>ï¼Œè¯¥å…ƒç´ åœ¨äºŒå‰æ ‘ä¸­çš„<strong>å³å­æ ‘</strong>ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨inorderåºåˆ—é‡Œè¯¥å…ƒç´ çš„<strong>å³è¾¹</strong>ã€‚ä¾‹å¦‚å¯¹äº20ï¼Œå…¶åœ¨äºŒå‰æ ‘ä¸­å·¦å­æ ‘é‡Œæœ‰15ï¼Œæ­£å¥½åœ¨inorderåºåˆ—é‡Œ15åœ¨20çš„å·¦è¾¹ï¼›å…¶å³å­æ ‘é‡Œæœ‰7ï¼Œæ­£å¥½åœ¨inorderåºåˆ—é‡Œ7åœ¨20çš„å³è¾¹ã€‚</p></li></ol><p>æ ¹æ®ä»¥ä¸Šè§‚å¯Ÿåˆ°çš„è§„å¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´å¾—å‡ºä»¥ä¸‹æ€è·¯ï¼š</p><p>å¯¹äº105è¿™é“é¢˜ï¼Œç»™å®špreorderå’Œinorderï¼Œæˆ‘ä»¬å¯ä»¥<strong>ä»å·¦åˆ°å³</strong>éå†preorderåºåˆ—ï¼Œå¯¹äºæ¯ä¸€ä¸ªå…ƒç´ <strong>E<sub>i</sub></strong>ï¼Œæˆ‘ä»¬ï¼š</p><ol><li>é€‰å®š<strong>E<sub>i</sub></strong>ï¼Œæ„é€ å½“å‰èŠ‚ç‚¹ã€‚</li><li>åœ¨inorderåºåˆ—ä¸­æ‰¾åˆ°<strong>E<sub>i</sub></strong>ï¼Œå‡å®šå…¶indexä¸ºjã€‚</li><li>åœ¨inorderåºåˆ—ä¸­ï¼Œä»inorder_startåˆ°j-1çš„å…ƒç´ è‚¯å®šåœ¨<strong>E<sub>i</sub></strong>çš„å·¦å­æ ‘é‡Œï¼Œä»j+1åˆ°inorder_endçš„å…ƒç´ è‚¯å®šåœ¨<strong>E<sub>i</sub></strong>çš„å³å­æ ‘é‡Œã€‚</li><li>ç»§ç»­é€’å½’æ„é€ å·¦å­æ ‘å’Œå³å­æ ‘</li></ol><p>å¯¹äº106è¿™é“é¢˜ï¼Œç»™å®špostorderå’Œinorderï¼Œæˆ‘ä»¬å¯ä»¥<strong>ä»å³åˆ°å·¦</strong>éå†postorderåºåˆ—ï¼Œå¯¹äºæ¯ä¸€ä¸ªå…ƒç´ <strong>E<sub>i</sub></strong>ï¼Œæˆ‘ä»¬ï¼š</p><ol><li>é€‰å®š<strong>E<sub>i</sub></strong>ï¼Œæ„é€ å½“å‰èŠ‚ç‚¹ã€‚</li><li>åœ¨inorderåºåˆ—ä¸­æ‰¾åˆ°<strong>E<sub>i</sub></strong>ï¼Œå‡å®šå…¶indexä¸ºjã€‚</li><li>åœ¨inorderåºåˆ—ä¸­ï¼Œä»inorder_startåˆ°j-1çš„å…ƒç´ è‚¯å®šåœ¨<strong>E<sub>i</sub></strong>çš„å·¦å­æ ‘é‡Œï¼Œä»j+1åˆ°inorder_endçš„å…ƒç´ è‚¯å®šåœ¨<strong>E<sub>i</sub></strong>çš„å³å­æ ‘é‡Œã€‚</li><li>ç»§ç»­é€’å½’æ„é€ å·¦å­æ ‘å’Œå³å­æ ‘</li></ol><p>å¯ä»¥çœ‹åˆ°ï¼Œ105å’Œ106çš„æ€è·¯åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«ä»…ä»…åœ¨äºpreorderå’Œpostorderæœ¬èº«çš„æ€§è´¨å·®å¼‚ï¼Œä¸€ä¸ªå…ˆè®¿é—®rootï¼Œå¦ä¸€ä¸ªåè®¿é—®rootã€‚æ‰€ä»¥å¯¹äºpreorderåºåˆ—æˆ‘ä»¬è¦<strong>ä»å·¦åˆ°å³</strong>éå†ï¼Œè€Œå¯¹äºpostorderæˆ‘ä»¬è¦<strong>ä»å³åˆ°å·¦</strong>éå†ã€‚</p><h2 id="å…·ä½“ä»£ç "><a href="#å…·ä½“ä»£ç " class="headerlink" title="å…·ä½“ä»£ç "></a>å…·ä½“ä»£ç </h2><ul><li><strong>[Leetcode 105]</strong> Construct Binary Tree from Preorder and Inorder</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">buildTree</span><span class="params">(<span class="keyword">int</span>[] preorder, <span class="keyword">int</span>[] inorder)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> build(preorder, inorder, </span><br><span class="line">         <span class="number">0</span>, preorder.length - <span class="number">1</span>, </span><br><span class="line">         <span class="number">0</span>, inorder.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] pre, <span class="keyword">int</span>[] in, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> preStart, <span class="keyword">int</span> preEnd, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> inStart, <span class="keyword">int</span> inEnd)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(pre == <span class="keyword">null</span> || in == <span class="keyword">null</span> || preStart &gt; preEnd || inStart &gt; inEnd) &#123;</span><br><span class="line">            <span class="comment">// corner case</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// select current root element</span></span><br><span class="line">        <span class="keyword">int</span> curVal = pre[preStart];</span><br><span class="line">        TreeNode cur = <span class="keyword">new</span> TreeNode(curVal);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// search for current root element in inorder sequence</span></span><br><span class="line">        <span class="keyword">int</span> index = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = inStart;i &lt;= inEnd;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(in[i] == curVal) &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(index == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// invalid sequence</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// count how many elements are in left &amp; right subtree</span></span><br><span class="line">        <span class="keyword">int</span> left = index - inStart;</span><br><span class="line">        <span class="keyword">int</span> right = inEnd - index;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// build recursively</span></span><br><span class="line">        cur.left = build(pre, in, preStart + <span class="number">1</span>, preStart + left, inStart, index - <span class="number">1</span>);</span><br><span class="line">        cur.right = build(pre, in, preStart + left + <span class="number">1</span>, preEnd, index + <span class="number">1</span>, inEnd);</span><br><span class="line">        <span class="keyword">return</span> cur;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>[Leetcode 106]</strong> Construct Binary Tree from Inorder and Postorder</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">buildTree</span><span class="params">(<span class="keyword">int</span>[] inorder, <span class="keyword">int</span>[] postorder)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> build(inorder, postorder, </span><br><span class="line">         <span class="number">0</span>, inorder.length - <span class="number">1</span>, </span><br><span class="line">         <span class="number">0</span>, postorder.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">build</span><span class="params">(<span class="keyword">int</span>[] in, <span class="keyword">int</span>[] post, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> inStart, <span class="keyword">int</span> inEnd, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> postStart, <span class="keyword">int</span> postEnd)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(in == <span class="keyword">null</span> || post == <span class="keyword">null</span> || inStart &gt; inEnd || postStart &gt; postEnd) &#123;</span><br><span class="line">        <span class="comment">// corner case</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// select current root element</span></span><br><span class="line">        <span class="keyword">int</span> curVal = pre[preStart];</span><br><span class="line">        TreeNode cur = <span class="keyword">new</span> TreeNode(curVal);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// search for current root element in inorder sequence</span></span><br><span class="line">        <span class="keyword">int</span> index = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = inStart;i &lt;= inEnd;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(in[i] == curVal) &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(index == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// invalid sequence</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// count how many elements are in left &amp; right subtree</span></span><br><span class="line">        <span class="keyword">int</span> left = index - inStart;</span><br><span class="line">        <span class="keyword">int</span> right = inEnd - index;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// build recursively</span></span><br><span class="line">        cur.left = build(in, post, inStart, index - <span class="number">1</span>, postStart, postStart + left - <span class="number">1</span>);</span><br><span class="line">        cur.right = build(in, post, index + <span class="number">1</span>, inEnd, postStart + left, postEnd - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> cur;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹äºè¿™ä¸¤é“é¢˜ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹</p><ol><li>preorderåºåˆ—é‡Œrootæ’åœ¨å‰é¢ï¼Œpostorderåºåˆ—é‡Œrootæ’åœ¨åé¢ã€‚</li><li>ä»<strong>æ•°ç»„</strong>ä¸­é‡æ„äºŒå‰æ ‘ï¼Œå¾€å¾€å°±æ˜¯<strong>ç±»ä¼¼äºå…ˆåºéå†çš„é€’å½’å†™æ³•</strong>ï¼Œå…ˆåœ¨æ•°ç»„ä¸­å®šä½åˆ°å½“å‰èŠ‚ç‚¹çš„å€¼ï¼Œæ„é€ å¥½å½“å‰èŠ‚ç‚¹ï¼Œæ¥ç€<strong>ç¡®å®šå¥½æ•°ç»„è¾¹ç•Œ</strong>ï¼Œé€’å½’æ„é€ å·¦å­æ ‘ &amp; å³å­æ ‘ã€‚</li><li><p>ç±»ä¼¼çš„æ„é€ äºŒå‰æ ‘é¢˜ç›®ï¼Œå¯å‚è€ƒ</p><ul><li><p><strong>[Leetcode 108]</strong> Convert Sorted Array to Binary Search Tree</p><p>åŒæ ·æ˜¯ä»<strong>æ•°ç»„</strong>ä¸­é‡æ„äºŒå‰æ ‘ã€‚</p></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> Leetcode </category>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> Leetcode </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Leetcodeé¢˜è§£] - Unique BST I &amp;&amp; II</title>
      <link href="/2018/04/05/lc-uniquebstiii/"/>
      <url>/2018/04/05/lc-uniquebstiii/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¡Œæ–‡ç”±æœ¬äºº(Haoxiang Ma)åŸåˆ›ï¼Œæ€è·¯å€Ÿé‰´äº†Leetcodeé«˜ç¥¨ç­”æ¡ˆï¼ŒåŠ ä»¥ä¸ªäººåˆ†æä¸æ€»ç»“ã€‚å¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><ul><li><strong><em>Unique Binary Search Tree II</em></strong></li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Given an integer n, generate all structurally unique BST&apos;s (binary search trees) that store values 1...n.</span><br><span class="line"></span><br><span class="line">For example,</span><br><span class="line">Given n = 3, your program should return all 5 unique BST&apos;s shown below.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   1         3     3      2      1</span><br><span class="line">    \       /     /      / \      \</span><br><span class="line">     3     2     1      1   3      2</span><br><span class="line">    /     /       \                 \</span><br><span class="line">   2     1         2                 3</span><br></pre></td></tr></table></figure><ul><li>å³ç»™å®šä¸€ä¸ªæ­£æ•´æ•°<code>n</code>ï¼Œæ±‚å‡º<code>1 ~ n</code>èƒ½æ„æˆçš„<strong>æ‰€æœ‰</strong>äºŒå‰æœç´¢æ ‘ï¼Œè¿”å›æ‰€æœ‰å¯èƒ½çš„æ ¹èŠ‚ç‚¹ã€‚</li></ul><ul><li><strong><em>Unique Binary Search Trees</em></strong></li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Given n, how many structurally unique BST&apos;s (binary search trees) that store values 1...n?</span><br><span class="line"></span><br><span class="line">For example,</span><br><span class="line">Given n = 3, there are a total of 5 unique BST&apos;s.</span><br><span class="line"></span><br><span class="line">   1         3     3      2      1</span><br><span class="line">    \       /     /      / \      \</span><br><span class="line">     3     2     1      1   3      2</span><br><span class="line">    /     /       \                 \</span><br><span class="line">   2     1         2                 3</span><br></pre></td></tr></table></figure><ul><li>å³ç»™å®šä¸€ä¸ªæ­£æ•´æ•°<code>n</code>ï¼Œæ±‚å‡º<code>1 ~ n</code>èƒ½æ„æˆçš„<strong>æ‰€æœ‰</strong>äºŒå‰æœç´¢æ ‘çš„æ€»æ£µæ•°ï¼Œè¿”å›æ€»æ£µæ•°ã€‚</li></ul><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>ä»¥ä¸Šä¸¤é“é¢˜æ®Šé€”åŒå½’ï¼Œè¾“å…¥å‡ä¸ºä¸€ä¸ªæ­£æ•´æ•°<code>n</code>ï¼Œä¸€ä¸ªæ˜¯è¦ç”Ÿæˆ<strong>æ‰€æœ‰</strong>åˆæ³•çš„äºŒå‰æœç´¢æ ‘ï¼Œå¦ä¸€ä¸ªåˆ™æƒ³æ±‚å‡º<strong>åˆæ³•</strong>äºŒå‰æœç´¢æ ‘çš„æ€»æ£µæ ‘ã€‚</p><p><strong>å‡å¦‚æˆ‘ä»¬æœ‰åŠæ³•åŸºäº<code>1 ~ n</code>ç”Ÿæˆæ‰€æœ‰åˆæ³•çš„<code>BST</code>ï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯é¢˜1è¿˜æ˜¯é¢˜2å‡èƒ½è¢«è½»æ¾è§£å†³äº†ã€‚</strong></p><p>æ€è·¯ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>å‡¡æ˜¯é‡åˆ°æ±‚<strong>æ‰€æœ‰</strong>ï¼Œ<strong>å…¨éƒ¨</strong>çš„é¢˜ç›®ï¼ŒåŸºæœ¬å¯å‚è€ƒ<code>DFS</code>çš„æ€è·¯ã€‚å› ä¸º<code>DFS</code>å°±æ˜¯åœ¨è§£é›†æ„æˆçš„å›¾é‡Œä¸æ–­èµ°èµ°èµ°ï¼Œä¸€è·¯èµ°åˆ°é»‘ï¼Œé‡åˆ°æ»¡è¶³æ¡ä»¶çš„å°±å¡è¿›ç»“æœé‡Œï¼Œé‡åˆ°æ­»è·¯å°±å¾€å›èµ°è¯•è¯•åˆ«çš„è·¯ã€‚è‡ªç„¶å°±èƒ½æŠŠæ•´ä¸ªè§£é›†ï¼ˆæ‰€æœ‰å¯èƒ½æ€§ï¼‰ç»™éå†å®Œï¼Œ<strong>æ‰€æœ‰</strong>ç¬¦åˆæ¡ä»¶çš„è§£ä¹Ÿå°±éƒ½è¢«æ‰¾åˆ°äº†ã€‚</li><li>æ—¢ç„¶è®©æˆ‘ä»¬ç”Ÿæˆ<code>BST</code>ï¼Œé‚£æˆ‘ä»¬å°±å‚è€ƒå‚è€ƒ<code>BST</code>çš„ç‰¹æ€§ã€‚ç”¨æœ€é€šä¿—æ˜“æ‡‚çš„è¯æ¥è®²ï¼Œ<code>BST</code>ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå…¶å·¦å­æ ‘é‡Œæ‰€æœ‰å­å­™çš„å€¼å‡å°äºå®ƒï¼Œå…¶å³å­æ ‘é‡Œæ‰€æœ‰å­å­™çš„å€¼å‡å¤§äºå®ƒã€‚</li></ol><p>åŸºäºä»¥ä¸Šä¸¤ç‚¹ï¼Œæˆ‘ä»¬è¿›è¡Œ<code>DFS</code>çš„æµç¨‹å°±å¾ˆæ¸…æ™°äº†ã€‚</p><p>åœ¨<code>1 ~ n</code>ä¸­ï¼Œæˆ‘ä»¬éšä¾¿æŒ‘ä¸€ä¸ªæ•°<code>k</code>ä½œä¸ºå½“å‰çš„<code>root</code>ï¼Œ<code>k</code>å¯ä»¥æ˜¯<code>1 ~ n</code>ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä¸ºäº†ç”Ÿæˆæ‰€æœ‰å¯èƒ½æ€§ï¼Œæˆ‘ä»¬å¯ç”¨ä¸€ä¸ª<code>for</code>å¾ªç¯å¯¹æ‰€æœ‰å¯èƒ½çš„å–å€¼è¿›è¡Œéå†ã€‚æ­¤å¤–ï¼Œå› ä¸ºä»¥ä¸ŠæåŠçš„<code>BST</code>çš„æ€§è´¨ï¼Œæ‰€ä»¥æ¯”<code>k</code>å°çš„<code>1 ~ k-1</code>éƒ½è¦è¢«æ”¾åˆ°å·¦å­æ ‘ï¼Œæ¯”<code>k</code>å¤§çš„<code>k+1 ~ n</code>éƒ½è¦è¢«æ”¾åˆ°å³å­æ ‘ã€‚å³åˆ°äº†æ„å»ºå·¦å­æ ‘çš„æ—¶å€™ï¼Œèƒ½ç”¨çš„æ•°å­—å°±æ˜¯<code>1 ~ k-1</code>ï¼Œåˆ°äº†æ„å»ºå³å­æ ‘çš„æ—¶å€™ï¼Œèƒ½ç”¨çš„æ•°å­—å°±æ˜¯<code>k+1 ~ n</code>ã€‚ä¸€ç›´è¿™æ ·<code>DFS</code>èµ°ä¸‹å»æ„å»ºå·¦å­æ ‘å’Œå³å­æ ‘ï¼Œ<strong>ç›´åˆ°æ²¡æœ‰ä»»ä½•å¯ç”¨çš„æ•°å­—</strong>ï¼Œå°±è¿”å›<code>null</code>ã€‚</p><h2 id="è¯¦ç»†ä»£ç "><a href="#è¯¦ç»†ä»£ç " class="headerlink" title="è¯¦ç»†ä»£ç "></a>è¯¦ç»†ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;TreeNode&gt; <span class="title">generateTrees</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†corner case</span></span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dfs(<span class="number">1</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;TreeNode&gt; <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        List&lt;TreeNode&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(start &gt; end) &#123;</span><br><span class="line">            result.add(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹äºå½“å‰å¯é€‰çš„æ•°å­—start ~ endï¼Œå…¶ä¸­ä»»æ„ä¸€ä¸ªéƒ½èƒ½é€‰ä¸ºå½“å‰çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = start;i &lt;= end;i++) &#123;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„å·¦å­æ ‘(start ~ i-1)å’Œå³å­æ ‘(i+1 ~ end)</span></span><br><span class="line">            List&lt;TreeNode&gt; leftNodes = dfs(start, i - <span class="number">1</span>);</span><br><span class="line">            List&lt;TreeNode&gt; rightNodes = dfs(i + <span class="number">1</span>, end);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¯¹äºå·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å¯èƒ½æ€§å’Œå³å­æ ‘çš„æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å¯èƒ½æ€§ï¼Œ</span></span><br><span class="line">            <span class="comment">// ä½œä¸€ä¸ªç¬›å¡å°”ç§¯ï¼Œæ±‚å‡ºæ‰€æœ‰ç»„åˆçš„å¯èƒ½æ€§</span></span><br><span class="line">            <span class="keyword">for</span>(TreeNode left : leftNodes) &#123;</span><br><span class="line">                <span class="keyword">for</span>(TreeNode right : rightNodes) &#123;</span><br><span class="line">                    TreeNode cur = <span class="keyword">new</span> TreeNode(i);</span><br><span class="line">                    cur.left = left;</span><br><span class="line">                    cur.right = right;</span><br><span class="line">                    result.add(cur);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><p>åŸºäºä»¥ä¸Š<code>DFS</code>æ€è·¯çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>1 ~ n</code>ç”Ÿæˆæ‰€æœ‰åˆæ³•çš„<code>BST</code>ï¼Œè§£å†³äº†é—®é¢˜ã€‚</p><ul><li>å¦‚æœéœ€è¦è¿”å›æ‰€æœ‰å¯èƒ½çš„<code>BST</code>ï¼Œç›´æ¥è¿”å›æœ€ç»ˆçš„<code>List&lt;TreeNode&gt;</code>å³å¯ã€‚</li><li>å¦‚éœ€è¿”å›æ€»æ£µæ•°ï¼Œè¿”å›æœ€ç»ˆç”Ÿæˆçš„<code>List</code>çš„<code>size</code>å³å¯ã€‚</li></ul><p>âš ï¸<strong>ä½†æ˜¯ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½å†åšå¾—æ›´å¥½ä¸€ç‚¹å‘¢ï¼Ÿåƒé¢˜ç›®2ä¸­åªè¦æ±‚å‡ºä¸€ä¸ªæ€»æ£µæ•°ï¼Œä¸€ä¸ªæ­£æ•´æ•°è€Œå·²ï¼Œæˆ‘ä»¬éœ€è¦å¦‚æ­¤â€œå¤§å…´åœŸæœ¨â€åœ°æŠŠæ‰€æœ‰åˆæ³•çš„<code>BST</code>æ„é€ å‡ºæ¥ï¼Œæœ€åâ€œè½»ææ·¡å†™â€åœ°è¿”å›<code>List</code>çš„<code>size</code>å—ï¼Ÿæ˜¯å¦å­˜åœ¨ä¸€äº›æ•°å­¦è§„å¾‹ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬ç›´æ¥æ±‚å‡ºåŸºäº<code>1 ~ n</code>çš„åˆæ³•<code>BST</code>çš„æ€»æ£µæ•°å‘¢ï¼Ÿ</strong></p><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥å°è¯•å°†é—®é¢˜å…¬å¼åŒ–ã€‚</p><p>æˆ‘ä»¬ç”¨<code>Sum(n)</code>è¡¨ç¤º<code>n</code>ä¸ªè¿ç»­æ•°èƒ½æ„æˆçš„åˆæ³•<code>BST</code>æ€»æ£µæ•°ï¼›ç”¨<code>F(k, n)</code>è¡¨ç¤ºç»™å®š<code>n</code>ä¸ªè¿ç»­æ•°æ—¶ï¼Œä»¥<code>k</code>ä¸ºæ ¹çš„åˆæ³•<code>BST</code>çš„æ£µæ•°ã€‚æ˜¾ç„¶æˆ‘ä»¬èƒ½å¤Ÿå¾—åˆ°ä»¥ä¸‹çš„æ¨å¯¼å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// ç»™å®šnä¸ªè¿ç»­æ•°ï¼Œ</span><br><span class="line">// èƒ½å¤Ÿæ„æˆçš„åˆæ³•BSTæ€»æ£µæ•° = ä»¥1ä¸ºæ ¹çš„BSTæ£µæ•° </span><br><span class="line">+ ä»¥2ä¸ºæ ¹çš„BSTæ£µæ•° </span><br><span class="line"> + ... </span><br><span class="line"> + ä»¥nä¸ºæ ¹çš„BSTæ£µæ•°ã€‚</span><br><span class="line"> </span><br><span class="line">Sum(n) = F(1, n) + F(2, n) + F(3, n) + ... + F(n, n)     (1)</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œä»¥<code>k</code>ä¸ºæ ¹çš„åˆæ³•<code>BST</code>çš„æ£µæ•°ï¼š<code>F(k, n)</code>åˆç­‰äºå¤šå°‘å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä»¥<code>k</code>ä¸ºæ ¹ï¼Œæ ¹æ®<code>BST</code>çš„æ€§è´¨ï¼Œ<strong>å·¦å­æ ‘é‡Œåªèƒ½å­˜æ”¾<code>1 ~ k-1</code>è¿™<code>k-1</code>ä¸ªè¿ç»­æ•°ï¼Œå³å­æ ‘é‡Œåªèƒ½å­˜æ”¾<code>k+1 ~ n</code>è¿™<code>n-k</code>ä¸ªè¿ç»­æ•°</strong>ã€‚æ‰€ä»¥<code>F(k, n)</code>å–å†³äºå…¶å·¦å­æ ‘çš„å¯èƒ½æ€§ * å…¶å³å­æ ‘çš„å¯èƒ½æ€§ï¼š</p><p><code>F(k, n) = Sum(k-1) * Sum(n-k)     (2)</code></p><p>åŸºäºä»¥ä¸Š(1)å’Œ(2)æ¨å¯¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å†™å¾—åˆ°ï¼š</p><p>`<br>// Corner Case: Sum(0) = 1 å› ä¸º0ä¸ªæ•°åªèƒ½ç”Ÿæˆç©ºæ ‘ï¼Œç©ºæ ‘æ°¸è¿œåªæœ‰1ç§<br>// Corner Case: Sum(1) = 1 å› ä¸º1ä¸ªæ•°åªèƒ½ç”Ÿæˆå•ä¸ªèŠ‚ç‚¹çš„æ ‘ï¼Œä¹Ÿæ°¸è¿œåªæœ‰1ç§</p><p>Sum(n) = F(1, n) + F(2, n) + â€¦ + F(n, n)<br>       = Sum(0)<em>Sum(n-1) + Sum(1)</em>Sum(n-2) + â€¦ + Sum(n-1)*Sum(0)     (3)<br>`</p><p>ç”¨(3)å¼è¿›è¡Œè®¡ç®—ï¼Œä¸€ç§éå¸¸ç±»ä¼¼äº<code>DP</code>çš„æ€æƒ³ï¼Œå³å¯é¿å…æµªè´¹å¤§ç‰‡å†…å­˜å’Œæ—¶é—´ç”Ÿæˆæ‰€æœ‰åˆæ³•çš„<code>BST</code>ï¼Œç›´æ¥èƒ½é€šè¿‡<strong>æ•°å€¼è¿ç®—</strong>å¾—åˆ°æœ€ç»ˆç»“æœã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numTrees</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span>[] Sum = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">        Sum[<span class="number">0</span>] = <span class="number">1</span>;    <span class="comment">// 0ä¸ªæ•°æ—¶åªæœ‰1ç§ï¼Œç©ºæ ‘</span></span><br><span class="line">        Sum[<span class="number">1</span>] = <span class="number">1</span>;    <span class="comment">// 1ä¸ªæ•°æ—¶åªæœ‰1ç§ï¼Œå•ä¸ªèŠ‚ç‚¹çš„æ ‘</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>;i &lt;= n;i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; i;j++) &#123;</span><br><span class="line">                Sum[i] += Sum[j] * Sum[i - j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Sum[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ­¤é¢˜åˆ©ç”¨äº† </p><ol><li><code>BST</code>çš„ç‰¹æ€§ï¼Œâ€œå·¦å°å³å¤§â€æ¥æ„å»ºæ‰€éœ€çš„ç»“æœã€‚</li><li><code>DFS</code>çš„æ€æƒ³ç”Ÿæˆ<strong>æ‰€æœ‰</strong>è§£ã€‚</li><li>æ•°å­¦æ¨å¯¼å¼è¿›è¡Œä¼˜åŒ–ï¼Œ<strong>å½“æ‰€æ±‚çš„è§£åªæ˜¯ä¸€ä¸ªç®€å•çš„æ•´æ•°å€¼æ—¶ï¼Œå¯æ€è€ƒæ˜¯å¦éœ€è¦çœŸæ­£ç”Ÿæˆæ‰€æœ‰æ•°æ®ï¼Œå¾ˆå¤šæƒ…å†µä¸‹åªæ˜¯éœ€è¦æˆ‘ä»¬è¿›è¡Œæ¨å¯¼ï¼Œåˆ©ç”¨DPçš„æ€æƒ³è¿›è¡Œæ•°å€¼è¿ç®—å³å¯ã€‚</strong></li></ol>]]></content>
      
      
      <categories>
          
          <category> Leetcode </category>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> Leetcode </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ä»€ä¹ˆæ˜¯Copy-On-Write</title>
      <link href="/2018/03/31/whatiscow/"/>
      <url>/2018/03/31/whatiscow/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Ma)åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æ‰€è°“<code>Copy-On-Write</code>ï¼Œç®€ç§°<code>COW</code>ï¼Œæ­£å¦‚å®ƒçš„åå­—æ‰€ç¤ºï¼Œå³ä¸º<code>å†™æ—¶å¤åˆ¶</code>ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒæ˜¯å®¹å™¨çš„ä¸€ç§ç‰¹æ€§ï¼Œæˆ–è€…è¯´å¯ä»¥åˆ©ç”¨è¿™ç§ç‰¹æ€§å¼€å‘ä¸€ç§<code>COWå®¹å™¨</code>ã€‚ ç®€å•æ¥è¯´ï¼Œ<code>å†™æ—¶å¤åˆ¶</code>å°±æ˜¯åœ¨ç”¨æˆ·ï¼ˆçº¿ç¨‹ï¼‰å¯¹æŸä¸€ä¸ªå®¹å™¨ï¼ˆå¦‚Listï¼‰è¿›è¡Œå†™æ“ä½œï¼ˆå¢ï¼åˆ ï¼æ”¹ï¼‰æ—¶ï¼Œä¸ç›´æ¥åœ¨å®¹å™¨ä¸Šè¿›è¡Œæ“ä½œï¼Œè€Œæ˜¯å…ˆ<strong>å¤åˆ¶</strong>ä¸€ä¸ªä¸åŸå®¹å™¨ä¸€æ¨¡ä¸€æ ·çš„å®¹å™¨å‡ºæ¥ï¼Œç„¶ååœ¨å¤åˆ¶å‡ºæ¥çš„å®¹å™¨ä¸Šè¿›è¡ŒçœŸæ­£çš„å†™æ“ä½œã€‚ åœ¨<code>Java</code>ä¸­ï¼Œå¸¸è§çš„<code>COWå®¹å™¨</code>æœ‰<code>CopyOnWriteArrayList&lt;E&gt;</code>å’Œ<code>CopyOnWriteArraySet&lt;E&gt;</code>ã€‚</p><h2 id="å…·ä½“è§£æ"><a href="#å…·ä½“è§£æ" class="headerlink" title="å…·ä½“è§£æ"></a>å…·ä½“è§£æ</h2><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/Timeline.png" alt=""> å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ€å¼€å§‹æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå®¹å™¨ï¼ˆå†…å­˜åœ°å€<code>0x80</code>ï¼‰ï¼Œå’Œä¸€ä¸ªæŒ‡å‘è¯¥å®¹å™¨çš„å¼•ç”¨<code>A</code>ã€‚ç»è¿‡<code>T1</code>å’Œ<code>T2</code>åï¼Œæ²¡æœ‰ä»»ä½•ç”¨æˆ·ï¼ˆçº¿ç¨‹ï¼‰å¯¹å…¶è¿›è¡Œå†™æ“ä½œã€‚ åˆ°è¾¾<code>T3</code>æ—¶åˆ»æ—¶ï¼ŒæŸä¸ªç”¨æˆ·ï¼ˆçº¿ç¨‹ï¼‰ç”³è¯·å‘å®¹å™¨å†™å…¥<code>123</code>è¿™ä¸ªæ•°æ®ã€‚æ­¤æ—¶ç”±äº<code>Copy-On-Write</code>ç‰¹æ€§ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å¾€<code>0x80</code>åœ°å€çš„å®¹å™¨å†™å…¥ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶å‡ºä¸€ä¸ªè·ŸåŸå®¹å™¨ä¸€æ¨¡ä¸€æ ·çš„å®¹å™¨Bï¼ˆå†…å­˜åœ°å€<code>0x95</code>ï¼‰ï¼Œç„¶åå¾€<code>0x95</code>å¤„çš„è¿™ä¸ªå®¹å™¨Bå†™å…¥<code>123</code>è¿™æ¡æ•°æ®ã€‚<strong>å†™å…¥å®Œæˆåï¼Œå…³é”®æ˜¯è¦å°†<code>å¼•ç”¨A</code>è¿›è¡Œé‡æŒ‡å‘ï¼ŒæŒ‡å‘<code>0x95</code>ï¼Œä¸å†æŒ‡å‘åŸæœ¬çš„<code>0x80</code>ã€‚</strong>ä¸€ç³»åˆ—åŠ¨ä½œå®Œæˆåï¼Œåˆ°äº†<code>T4</code>æ—¶åˆ»ï¼Œ<code>å¼•ç”¨A</code>æ‰€æŒ‡å‘çš„å°±æ˜¯ä¸€ä¸ªå­˜æœ‰<code>123</code>è¿™æ¡æ•°æ®çš„å®¹å™¨ã€‚ ï¼ˆâš ï¸å¦‚æ— æ„å¤–ï¼Œ<code>0x80</code>å¤„çš„åŸå®¹å™¨æ‰€å çš„å†…å­˜ç©ºé—´åœ¨æŸä¸ªæ—¶å€™ä¼šè¢«gcå›æ”¶æ‰ï¼‰ ç»è¿‡äº†ä»¥ä¸Šçš„å›¾è§£ï¼Œç›¸ä¿¡è¯»è€…å·²ç»å¯¹<code>Copy-On-Write</code>è¿‡ç¨‹æœ‰äº†ä¸€å®šçš„ç†è§£ã€‚æ¥ä¸‹æ¥è°ˆè°ˆå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚ç‚¹ã€‚</p><ol><li><p>æ’ä»–æ€§çš„å†™æ“ä½œ åœ¨å¯¹<code>COWå®¹å™¨</code>è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šäºå†…å­˜ä¸­é¢å¤–å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬å‡ºæ¥è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥<strong>å†™æ“ä½œå¿…ç„¶æ˜¯æ’ä»–æ€§çš„</strong>ã€‚ç»<strong>ä¸èƒ½</strong>å…è®¸<code>N</code>ä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œå†™æ“ä½œï¼Œç„¶åå¤åˆ¶å‡º<code>N</code>ä¸ªå‰¯æœ¬ï¼Œå„çº¿ç¨‹è‡ªå·±å¯¹è‡ªå·±çš„é‚£ä¸ªå‰¯æœ¬è¿›è¡Œæ“ä½œï¼Œé‚£æ ·çš„è¯æ— æ³•ä¿è¯å®¹å™¨å†…çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ<code>N</code>ä¸ªå‰¯æœ¬ä¸­çš„æ•°æ®éƒ½ä¸æ˜¯å®Œæ•´çš„æ•°æ®ã€‚ <strong>ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦å¯¹å†™æ“ä½œåŠ ä¸Šä¸€ä¸ª<code>æ’ä»–é”</code>ï¼Œåœ¨æŸä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹<code>COWå®¹å™¨</code>è¿›è¡Œå†™æ“ä½œã€‚</strong></p></li><li><p>è¯»å†™åˆ†ç¦» å¯¹äº<code>è¯»</code>æ“ä½œè€Œè¨€ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»å–å®¹å™¨å†…çš„æ•°æ®ï¼Œä¸å­˜åœ¨ä»»ä½•æ•°æ®ä¸€è‡´æ€§é—®é¢˜æˆ–å®‰å…¨é—®é¢˜ã€‚å¯¹äº<code>å†™</code>æ“ä½œï¼Œå› ä¸ºä¼šå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬å®¹å™¨ï¼Œåœ¨å‰¯æœ¬å®¹å™¨ä¸Šå†™ï¼Œå†™æˆåŠŸåå†ä¿®æ”¹å¼•ç”¨ï¼Œæ‰€ä»¥åœ¨æŸä¸ªæ—¶åˆ»ï¼Œ<code>å†™</code>å’Œ<code>è¯»</code>é’ˆå¯¹çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå®¹å™¨ï¼Œå®ç°äº†<strong>è¯»å†™åˆ†ç¦»</strong>ã€‚ æœ‰äº†<strong>è¯»å†™åˆ†ç¦»</strong>ï¼Œå°±èƒ½æ˜¾è‘—æé«˜<code>è¯»</code>æ“ä½œçš„æ•ˆç‡ï¼Œå› ä¸ºå†™é”æ˜¯ä¼šæ’æ–¥å…¶ä»–æ‰€æœ‰æ“ä½œçš„ï¼Œä¸€æ—¦ä¸€ä¸ªå®¹å™¨ï¼è¡¨ï¼æ–‡ä»¶è¢«åŠ ä¸Šäº†å†™é”ï¼Œé‚£ä¹ˆä»»ä½•äººéƒ½æ— æ³•å†è¯»ï¼å†™è¯¥å®¹å™¨ï¼è¡¨ï¼æ–‡ä»¶çš„å†…å®¹ã€‚æ—¢ç„¶<code>COWå®¹å™¨</code>çš„å¤åˆ¶æœºåˆ¶èƒ½ä¿è¯è¯»å’Œå†™æ˜¯åœ¨ä¸åŒçš„å®¹å™¨ä¸Šè¿›è¡Œï¼Œä¹Ÿå°±æ„å‘³ç€æ°¸è¿œéƒ½ä¸ä¼šå› ä¸ºå†™é”çš„å­˜åœ¨è€Œé˜»å¡<code>è¯»</code>æ“ä½œï¼Œè‡ªç„¶å°±èƒ½é¡ºç•…æ— æ¯”åœ°å¹¶å‘è¯»å–äº†ã€‚</p></li></ol><h2 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h2><p>åŸºäºå†™æ—¶å¤åˆ¶çš„ç‰¹ç‚¹ï¼Œ<code>COWå®¹å™¨</code>ç‰¹åˆ«é€‚ç”¨äºå¤§é‡è¯»å–ï¼Œæå°‘é‡å†™å…¥çš„åº”ç”¨åœºæ™¯ã€‚å› ä¸ºå†™æ“ä½œæ˜¯æ’ä»–æ€§é˜»å¡çš„ï¼Œæ‰€ä»¥ä¸€æ—¦æœ‰è¾ƒå¤šçš„å†™æ“ä½œéœ€æ±‚ï¼Œé‚£<code>COWå®¹å™¨</code>çš„æ€§èƒ½å°†ä¼šç¾éš¾æ€§åœ°ä¸‹é™ã€‚å½“å†™æ“ä½œè¾ƒå¤šæ—¶ï¼Œå¯å°†å¤šä¸ªå†™æ“ä½œåˆå¹¶æˆä¸€æ‰¹å†™æ“ä½œï¼Œcallä¸€æ¬¡å†™å…¥æ–¹æ³•å†™å…¥å¤šæ¡æ•°æ®ï¼Œé¿å…å¤šæ¬¡callå†™æ–¹æ³•ï¼Œé¿å…å¤šæ¬¡å®¹å™¨å¤åˆ¶ã€‚</p><ol><li>ä¼˜ç‚¹<ul><li>é€‚ç”¨äº<strong>å¤§é‡è¯»å–ï¼Œæå°‘é‡å†™å…¥</strong>çš„åº”ç”¨åœºæ™¯ï¼Œæ”¯æŒé«˜æ•ˆçš„å¹¶å‘è¯»å–</li></ul></li><li>ç¼ºç‚¹<ul><li><strong>å†…å­˜æ¶ˆè€—å¤§</strong>ã€‚å½“å®¹å™¨ä¸­çš„æ•°æ®å¾ˆå¤šæ—¶ï¼Œå¤åˆ¶æ“ä½œå°†ä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜ï¼Œå¯èƒ½ä¼šé¢‘ç¹å¼•å‘GC</li><li><strong>æ— æ³•ä¿è¯æ•°æ®<code>å¼ºä¸€è‡´æ€§</code>ï¼Œåªèƒ½ä¿è¯<code>æœ€ç»ˆä¸€è‡´æ€§</code></strong>ï¼Œå› ä¸ºè¯»çš„æ—¶å€™æœ‰å¯èƒ½å·²å®Œæˆäº†å†™æ“ä½œï¼Œä½†å®¹å™¨æŒ‡é’ˆæœªæ¥å¾—åŠé‡æŒ‡å‘ï¼Œä½†ç»è¿‡å¤šä¸ªæ—¶é—´çª—å£åæœ€ç»ˆæ•°æ®æ˜¯ä¸€è‡´çš„</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Javaä¸­çš„æ·±å¤åˆ¶&amp;æµ…å¤åˆ¶</title>
      <link href="/2018/03/23/deepcopyinjava/"/>
      <url>/2018/03/23/deepcopyinjava/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡å†…å®¹å‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>åœ¨ç¨‹åºä¸­ï¼Œå‡ºäºç‰¹å®šçš„éœ€æ±‚ï¼Œå¾€å¾€è¦å¯¹ä¸€äº›å¯¹è±¡è¿›è¡Œå¤åˆ¶ï¼Œç„¶åå¯¹å¤åˆ¶åçš„å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œ<strong>ä¸”ä¸æƒ³è®©è¿™äº›æ“ä½œå½±å“åˆ°åŸå¯¹è±¡çš„æ•°æ®</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œææ¸…æ¥š<code>æ·±å¤åˆ¶ï¼ˆDeep Copyï¼‰</code>å’Œ<code>æµ…å¤åˆ¶ï¼ˆShallow Copyï¼‰</code>æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p><p>ä½•è°“<code>æµ…å¤åˆ¶</code>ï¼Ÿç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œå¤åˆ¶ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œç„¶åâ€œç…§æ¬â€åŸå¯¹è±¡ä¸­çš„æ•°æ®æ¥å¡«å……æ–°å¯¹è±¡çš„æ•°æ®åŸŸã€‚è™½ç„¶æ–°æ—§å¯¹è±¡æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼ˆåœ¨å†…å­˜ä¸­çš„åœ°å€ä¸åŒï¼‰ï¼Œä½†æ˜¯å®ƒä»¬å†…éƒ¨çš„æ•°æ®æ˜¯ä¸€æ ·çš„ã€‚</p><p>è¿™æ ·çœ‹æ¥ï¼Œ<code>æµ…å¤åˆ¶</code>ä¸æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€çš„<code>å¤åˆ¶</code>å˜›ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¸”æ–°å¯¹è±¡ä¸­çš„æ•°æ®è·ŸåŸå¯¹è±¡ä¸€æ ·ï¼Œå·²ç»æ˜¯éå¸¸å®Œç¾çš„å¤åˆ¶å•Šï¼Œä¸ºä»€ä¹ˆè¿˜è¦åŠ ä¸€ä¸ª<code>æµ…</code>å­—å‘¢ï¼Ÿ</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/shallow.png" alt=""></p><p>åŸå› åœ¨äºï¼Œ<strong>åœ¨Javaä¸­</strong>ï¼Œä¸€ä¸ªå¯¹è±¡é‡Œå¯èƒ½æœ‰<code>primitive</code>ç±»å‹çš„æ•°æ®å¦‚<code>int</code>,<code>long</code>ç­‰ï¼Œæ›´å¯èƒ½åŒ…å«äº†<code>referrenceï¼ˆå¼•ç”¨ï¼‰</code>ç±»å‹çš„æ•°æ®å¦‚æŒ‡å‘è‡ªå®šä¹‰ç±»å®ä¾‹çš„å¼•ç”¨ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œ<strong>å¼•ç”¨çš„å€¼ä»…ä»…æ˜¯å…¶æ‰€æŒ‡å‘å¯¹è±¡çš„å†…å­˜åœ°å€</strong>ã€‚é€šè¿‡<code>æµ…å¤åˆ¶</code>ï¼Œæˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªå†…å­˜åœ°å€â€œç…§æ¬â€è¿‡å»æ–°å¯¹è±¡ä¸­ï¼Œé‚£ä¹ˆæ–°å¯¹è±¡å’Œæ—§å¯¹è±¡ä¸­çš„ä¸€ä¸ªæˆå‘˜å¼•ç”¨å°±ä¼šæŒ‡å‘åŒä¸€å—å†…å­˜ï¼Œæ“ä½œçš„æ—¶å€™å°†ä¼šäº’ç›¸å½±å“ï¼Œä¸æˆ‘ä»¬ç†æƒ³çŠ¶æ€ä¸‹çš„<code>å¤åˆ¶</code>ç›¸å·®ç”šè¿œã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»<code>Building1</code>å¯¹è±¡å¤åˆ¶å‡ºæ¥<code>Building2</code>å¯¹è±¡åï¼Œå®ƒä»¬æœ¬èº«æ‰€å¤„çš„å†…å­˜åœ°å€ä¸ä¸€æ ·ï¼Œå·²ç»æˆä¸ºäº†ä¸¤ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä½†ç”±äº<code>Building</code>ä¸­åŒ…å«äº†ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„æ•°æ®<code>Floor</code>ï¼Œè€Œ<code>æµ…å¤åˆ¶</code>åªå°†å¼•ç”¨çš„å€¼ç…§æ¬è¿‡å»æ–°å¯¹è±¡ä¸­ï¼Œå¯¼è‡´ä¸¤ä¸ªä¸åŒçš„<code>Building</code>ä¸­çš„<code>Floor</code>æŒ‡å‘äº†å†…å­˜é‡Œçš„åŒä¸€ä¸ª<code>Floor</code>ã€‚</p><p><strong>æ‰€è°“çš„<code>æµ…</code>æŒ‡çš„å°±æ˜¯å¯¹äº<code>referrenceï¼ˆå¼•ç”¨ï¼‰</code>ç±»å‹çš„æ•°æ®åªæ˜¯â€œæµ…æ˜¾â€åœ°â€œç…§æ¬â€å…¶å€¼ï¼Œæ²¡æœ‰æ·±åº¦åœ°â€œå¤åˆ¶â€å‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</strong></p><p>æ‰€ä»¥å¯¹åº”<code>æµ…å¤åˆ¶</code>ï¼Œä¸ºäº†è§£å†³å®ƒçš„é—®é¢˜ï¼Œæˆ‘ä»¬è‡ªç„¶å°±æœ‰<code>æ·±å¤åˆ¶</code>çš„æ¦‚å¿µã€‚æ‰€è°“<code>æ·±å¤åˆ¶</code>å°±æ˜¯ä¸ºäº†å®Œå®Œå…¨å…¨ã€å½»å½»åº•åº•åœ°å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œ<strong>æ·±åº¦</strong>çš„å¤åˆ¶ï¼Œé¿å…æ–°æ—§å¯¹è±¡ä¸­çš„å¼•ç”¨ä»æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸï¼Œäº’ç›¸å½±å“ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/deep.png" alt=""></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»<code>Building1</code>å¯¹è±¡å¤åˆ¶å‡ºæ¥<code>Building2</code>å¯¹è±¡ï¼Œä¸¤è€…çš„<code>Floor</code>å¼•ç”¨æŒ‡å‘çš„å·²æ˜¯å†…å­˜åŒºåŸŸä¸­ä¸åŒçš„<code>Floor</code>å¯¹è±¡ï¼Œæ— è®ºå¯¹<code>Building1</code>å†æ€ä¹ˆæŠ˜è…¾ï¼Œä¹Ÿä¸ä¼šå¯¹<code>Building2</code>äº§ç”Ÿå½±å“ï¼Œå®ŒæˆçœŸæ­£ç†æƒ³çŠ¶æ€ä¸‹çš„<code>å¤åˆ¶</code>ã€‚</p><p><strong>æœ¬æ–‡å°†æ¢è®¨åœ¨<code>Java</code>ä¸­å¦‚ä½•å®ç°å¯¹è±¡çš„<code>æ·±å¤åˆ¶</code>ã€‚</strong></p><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p>é¦–å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„è‡ªå®šä¹‰ç±»<code>Building</code>å’Œ<code>Floor</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Building ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Building</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> Floor floor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Building</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.floor = <span class="keyword">new</span> Floor();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Building</span><span class="params">(Floor floor)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.floor = floor;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Floorç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Floor</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Floor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Floor</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.count = count;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>Building</code>ä¸­åŒ…å«ä¸€ä¸ª<code>Floor</code>æˆå‘˜å˜é‡ã€‚</p><ol><li><p><code>clone</code>æ–¹æ³•ä¸<code>Cloneable</code>æ¥å£</p><p> <strong>å®ç°<code>æ·±å¤åˆ¶</code>çš„ç¬¬ä¸€ç§æ–¹æ³•ï¼Œéœ€è¦å¤åˆ¶çš„ç±»å®ç°<code>Cloneable</code>æ¥å£ï¼Œå¹¶é‡å†™<code>clone</code>æ–¹æ³•ã€‚</strong>åœ¨<code>Java</code>çš„ä¸Šå¸ç±»<code>Object</code>ä¸­ï¼Œæœ‰ä¸€ä¸ªçº¯å¤©ç„¶çš„<code>clone</code>æ–¹æ³•ï¼Œä½†æ˜¯å…¶ä¸­å¹¶æ²¡æœ‰å…·ä½“çš„ä»£ç é€»è¾‘ï¼Œä»…ä»…æ˜¯å£°æ˜äº†ä¸€ä¸ª<code>CloneNotSupportedException</code>å¼‚å¸¸ï¼Œæ‰€ä»¥å¿…é¡»å¯¹å…¶è¿›è¡Œé‡å†™ã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br></pre></td></tr></table></figure><p> è€Œ<code>Cloneable</code>æ¥å£ä¸­ä¹Ÿæ²¡æœ‰ä»»ä½•çš„æ–¹æ³•å£°æ˜ï¼Œå®Œå…¨æ˜¯ä¸€ä¸ªæ ‡è®°æ€§çš„ç©ºæ¥å£(<code>Mark-Interface</code>)ã€‚<strong>å®ç°è¯¥æ¥å£çš„ä½œç”¨ä»…ä»…æ˜¯ä½œä¸€ä¸ª<code>æ ‡è®°(mark)</code>ï¼Œå‘Šè¯‰JVMï¼Œæˆ‘å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œè¿™ä¸ªç±»çš„å®ä¾‹å¯¹è±¡å¯è¢«å¤åˆ¶</strong>ã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>âš ï¸ âš ï¸ âš ï¸æ³¨æ„ï¼Œå¦‚æœä¸å®ç°<code>Cloneable</code>æ¥å£ï¼Œå³ä½¿é‡å†™äº†<code>clone</code>æ–¹æ³•ï¼Œåœ¨è°ƒç”¨æ—¶ä¹Ÿä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæ²¡æœ‰<strong>æ ‡è®°</strong>ï¼Œæ²¡æœ‰<strong>â€œå‘Šè¯‰â€</strong>JVMï¼Œè¿™æ˜¯å¯ä»¥è¢«å¤åˆ¶çš„ã€‚</p></blockquote><p> æ‰€ä»¥åŸºäº<code>Building</code>ç±»å’Œ<code>Floor</code>ç±»çš„å®šä¹‰ï¼Œæˆ‘ä»¬åº”è¯¥è®©å®ƒä»¬éƒ½å®ç°<code>Cloneable</code>æ¥å£ï¼Œä¸”é‡å†™<code>clone</code>æ–¹æ³•ã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Buildingç±»å®ç°Cloneableæ¥å£</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Building</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> Floor floor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Building</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.floor = <span class="keyword">new</span> Floor();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Building</span><span class="params">(Floor floor)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.floor = floor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line"><span class="comment">// å…ˆcloneå‡ºä¸€ä¸ªBuildingå¯¹è±¡</span></span><br><span class="line">Building newBuilding = (Building) <span class="keyword">super</span>.clone(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åå†æ‰‹åŠ¨cloneå‡ºä¸€ä¸ªFloorå¯¹è±¡</span></span><br><span class="line">newBuilding.floor = (Floor) floor.clone();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›cloneå‡ºçš„Buildingå¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> newBuilding;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Floorç±»å®ç°Cloneableæ¥å£</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Floor</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Floor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Floor</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.count = count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.clone();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä¸ºäº†æµ‹è¯•æ˜¯å¦çœŸçš„è¿›è¡Œäº†<code>æ·±å¤åˆ¶</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹æ–°æ—§<code>Building</code>å¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å¦ç›¸åŒï¼Œå†çœ‹çœ‹å®ƒä»¬å†…éƒ¨çš„<code>Floor</code>å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€æ˜¯å¦ç›¸åŒã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">Building b1 = <span class="keyword">new</span> Building();</span><br><span class="line">Building b2 = b1;</span><br><span class="line">System.out.println(b2 == b1); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">Building b3 = (Building) b1.clone(); </span><br><span class="line">System.out.println(b3 == b1);<span class="comment">// false</span></span><br><span class="line">System.out.println(b3.floor == b1.floor); <span class="comment">// false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> é€šè¿‡å®ç°<code>Cloneable</code>æ¥å£ï¼Œé‡å†™<code>clone</code>æ–¹æ³•ï¼ŒæˆåŠŸè¿›è¡Œäº†<code>æ·±å¤åˆ¶</code>ã€‚</p><p> <strong>âš ï¸ç„¶è€Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•å®ç°<code>æ·±å¤åˆ¶</code>ï¼Œæœ‰ç€å·¨å¤§çš„ç¼ºé™·ã€‚</strong><br> <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/chain.png" alt=""><br> åœ¨ä»¥ä¸Šä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæœ‰2ä¸ªè‡ªå®šä¹‰ç±»ï¼Œ<code>Building</code>åŒ…å«<code>Floor</code>ã€‚ä½†æ˜¯å½“è¿™ç§åŒ…å«å…³ç³»å˜å¾—æ›´åŠ å¤æ‚ï¼Œæœ‰æ— æ•°å¤šä¸ªè‡ªå®šä¹‰ç±»ï¼Œä¸€å±‚åˆä¸€å±‚åœ°åŒ…å«ä¸‹å»æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªè‡ªå®šä¹‰ç±»éƒ½å®ç°<code>Cloneable</code>æ¥å£ï¼Œé‡å†™<code>clone</code>æ–¹æ³•ã€‚ï¼ˆä¾‹å¦‚<code>Building</code>åŒ…å«<code>Floor</code>ï¼Œ<code>Floor</code>åŒ…å«<code>Room</code>ï¼‰ã€‚æ›´éº»çƒ¦çš„æ˜¯ï¼Œå¤„äºé«˜å±‚æ¬¡çš„ç±»çš„<code>clone</code>æ–¹æ³•ä¼šå¾ˆå¤æ‚ï¼Œè¦ä¸€ä¸ªä¸€ä¸ªåœ°å¯¹ä½å±‚æ¬¡çš„ç±»è°ƒç”¨<code>clone</code>æ–¹æ³•ï¼Œä¸€æ—¦å…¶ä¸­æœ‰å‡ ä¸ªç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆè¦é‡æ–°æ”¹å†™å¤šä¸ª<code>clone</code>æ–¹æ³•ï¼Œä¸€ç‚¹ä¹Ÿä¸ç§‘å­¦ã€‚</p></li><li><p>åˆ©ç”¨<code>Serializable</code>æ¥å£</p><p> é¦–å…ˆè¯´è¯´ä»€ä¹ˆæ˜¯<code>Serializeï¼ˆåºåˆ—åŒ–ï¼‰</code>å’Œ<code>Deserialize(ååºåˆ—åŒ–ï¼‰</code>ã€‚</p><ul><li><strong><code>Serializeï¼ˆåºåˆ—åŒ–ï¼‰</code>æŒ‡çš„æ˜¯å°†å†…å­˜ä¸­çš„å¯¹è±¡è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œè¿›è€Œå°†å¯¹è±¡æ•°æ®å­˜å‚¨åˆ°ç£ç›˜æ–‡ä»¶é‡Œ</strong>ã€‚</li><li><p><strong><code>Deserialize(ååºåˆ—åŒ–ï¼‰</code>æŒ‡çš„æ˜¯ä»ç£ç›˜æ–‡ä»¶ä¸­è¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œæ ¹æ®ä¸€å®šçš„è§„åˆ™è½¬åŒ–ä¸ºå†…å­˜ä¸­çš„å¯¹è±¡</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>Java</code>ä¸­ï¼Œå¦‚æœæƒ³å°†ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–ï¼Œé¦–å…ˆå¾—æ ‡è®°å…¶ä¸ºâ€œå¯åºåˆ—åŒ–â€ï¼Œå³å®ç°<code>Serializable</code>æ¥å£ã€‚<strong>è·Ÿ<code>Cloneable</code>æ¥å£ä¸€æ ·ï¼Œ<code>Serializable</code>æ¥å£ä¹Ÿæ˜¯ä¸€ä¸ªç©ºè¡è¡çš„<code>Mark-Interface</code>ï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨æ˜¯ç”¨äºæ ‡è®°è¯¥ç±»å¯è¢«åºåˆ—åŒ–ã€‚</strong></p><p>ä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œä¸å†ä½¿ç”¨<code>Building</code>å’Œ<code>Floor</code>è¿›è¡Œè¯´æ˜ã€‚ä»¥ä¸‹ä½¿ç”¨<code>Human</code>ç±»å’Œ<code>Head</code>ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> Head head;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.head = <span class="keyword">new</span> Head();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">(Head head)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.head = head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ·±å¤åˆ¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å¤åˆ¶å¾—åˆ°çš„Humanå¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Human <span class="title">deepClone</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">objectOutputStream.writeObject(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line"><span class="keyword">return</span> (Human) objectInputStream.readObject();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Head</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Head</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Head</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.val = val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç ä¸º<code>Human</code>ç±»ä¸­çš„<code>deepClone()</code>æ–¹æ³•ã€‚é¦–å…ˆå…ˆå°†å½“å‰å¯¹è±¡(<code>this</code>)å†™åˆ°ä¸€ä¸ª<code>ObjectOutputStream</code>ä¸­ï¼Œç„¶åå†æ–°å»ºä¸€ä¸ª<code>ObjectInputStream</code>ï¼Œå¹¶åˆ©ç”¨è¯¥<code>ObjectInputStream</code>çš„<code>readObject()</code>æ–¹æ³•ä»æµä¸­è·å¾—ä¸€ä¸ª<strong>æ–°æ„å»º</strong>çš„Javaå¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ£€æµ‹ä¸€ä¸‹æ˜¯å¦çœŸæ­£å®Œæˆäº†<code>æ·±å¤åˆ¶</code>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">Human h1 = <span class="keyword">new</span> Human();</span><br><span class="line">Human h2 = h1.deepClone();</span><br><span class="line">System.out.println(h1 == h2);<span class="comment">// false</span></span><br><span class="line">System.out.println(h1.head == h2.head);  <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>âš ï¸é€šè¿‡å®ç°<code>Serializable</code>æ¥å£ï¼Œå¯ä»¥é¿å…é‡å†™å¤šä¸ª<code>clone()</code>æ–¹æ³•ï¼Œä¹Ÿå¯å®ç°æ·±å¤åˆ¶ã€‚</p></li></ul></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨<code>Java</code>ä¸­ï¼Œæƒ³è¦å®ç°çœŸæ­£çš„<code>æ·±å¤åˆ¶</code>ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•</p><ol><li>å®ç°<code>Cloneable</code>æ¥å£ï¼Œé‡å†™<code>clone()</code>æ–¹æ³•ã€‚<ul><li>ä¼˜ç‚¹ï¼šç›´è§‚ï¼Œå®¹æ˜“ç†è§£ï¼Œè´´åˆäººç±»æ€ç»´ã€‚</li><li>ç¼ºç‚¹ï¼šå½“æœ‰éå¸¸å¤šä¸ªè‡ªå®šä¹‰ç±»ï¼Œä¸”äº’ç›¸åŒ…å«çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å¤§é‡å¤æ‚åœ°é‡å†™æ–¹æ³•ï¼Œå¯¹ç»“æ„æ”¹åŠ¨éå¸¸ä¸å‹å¥½ã€‚</li></ul></li><li>å®ç°<code>Serializable</code>æ¥å£ï¼Œåˆ©ç”¨<code>åºåˆ—åŒ–</code>å’Œ<code>ååºåˆ—åŒ–</code>ã€‚<ul><li>ä¼˜ç‚¹ï¼šå½“å¤šä¸ªç±»ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸éœ€è¦å¤§é‡é‡å†™å¤åˆ¶ä»£ç ã€‚</li><li>ç¼ºç‚¹ï¼šä¸ç›´è§‚ï¼Œä¸è´´åˆäººç±»æ€ç»´ã€‚</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ä¸€è‡´æ€§Hashç®—æ³•â€”â€”åˆ†æä¸æ¨¡æ‹Ÿ</title>
      <link href="/2018/03/17/consistent-hash/"/>
      <url>/2018/03/17/consistent-hash/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡100%å†…å®¹ç”±æœ¬äºº(Haoxiang Ma)åŸåˆ›ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªå­˜å‚¨é›†ç¾¤â€”â€”<code>Cluster_A</code>ï¼Œ<code>Cluster_A</code>åŒ…å«äº†<code>N</code>ä¸ªå­˜å‚¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šå­˜å‚¨äº†å¤§é‡æ•°æ®ã€‚é‚£ä¹ˆåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ–°è¿›å…¥é›†ç¾¤çš„æ•°æ®ä¼šè¢«è®¡ç®—å‡ºå…¶å¯¹åº”çš„Hashå€¼ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¢«åˆ†é…åˆ°æŸä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸Šã€‚æœ€å¸¸è§çš„åˆ†é…ç­–ç•¥å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// sha256æˆ–è€…md5å‡ä¸ºå¸¸è§çš„hashå‡½æ•°</span><br><span class="line">node_id = hash(data) % N</span><br></pre></td></tr></table></figure><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ç§æ•°æ®åˆ†é…ç­–ç•¥çš„æ€§èƒ½å–å†³äºhashç®—æ³•çš„æ€§èƒ½ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºä»€ä¹ˆå¤§é—®é¢˜ã€‚ä½†æ˜¯å¾€å¾€åœ¨ä¸€ä¸ªå¤§é›†ç¾¤ä¸­ä¼šå‡ºç°<strong>å¢ï¼åˆ èŠ‚ç‚¹</strong>çš„éœ€æ±‚ï¼Œè¯•æƒ³å½“<code>N</code>å˜æˆ<code>N+1</code>æˆ–<code>N-1</code>æ—¶ï¼Œæ•°æ®æ‰€å¯¹åº”çš„æ–°<code>node_id</code>å¤§æ¦‚ç‡ä¼šä¸åŸ<code>node_id</code>ä¸ä¸€æ ·ã€‚é‚£ä¹ˆç”¨æˆ·æƒ³ä»é›†ç¾¤è¯»æ•°æ®æ—¶å°±ä¼šæ‰¾ä¸åˆ°è¯¥æ•°æ®ï¼Œå› ä¸ºç®—å‡ºæ¥çš„æ–°<code>node_id</code>ä¸æ•°æ®çœŸæ­£å­˜å‚¨çš„<code>node_id</code>ä¸ä¸€æ ·äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// åŸdata_1æ‰€å±çš„node_id = 50</span><br><span class="line">// data_1è¢«å­˜åœ¨50å·èŠ‚ç‚¹ä¸Š</span><br><span class="line">node_id1 = hash(data_1) % N = 50 </span><br><span class="line"></span><br><span class="line">// å¢åŠ ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹ådata_1å¯¹åº”çš„node_id</span><br><span class="line">// ç”¨æˆ·è¯»å–data_1æ—¶ï¼Œç³»ç»Ÿç®—å‡ºåº”è¯¥å»30å·èŠ‚ç‚¹å–æ•°æ®ï¼Œå¯¼è‡´è¯»å–å¤±è´¥</span><br><span class="line">node_id1 = hash(data_1) % (N+1) = 30</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸ä¸¢å¤±ï¼Œåœ¨å¢ï¼åˆ èŠ‚ç‚¹å‘ç”Ÿåï¼Œéœ€è¦å¯¹é›†ç¾¤é‡Œçš„æ‰€æœ‰æ•°æ®è¿›è¡Œ<strong>é‡æ–°Hash</strong>ï¼Œä»¥è¿›è¡Œæ•°æ®çš„é‡æ–°åˆ†é…ã€‚<strong>ç„¶è€Œï¼Œå¦‚æœæ¯æ¬¡å¢ï¼åˆ èŠ‚ç‚¹éƒ½å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œé‡åˆ†é…ï¼Œç³»ç»Ÿå¼€é”€å°†ä¼šæ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—ï¼Œåœ¨å®é™…å·¥ç¨‹ä¸­éš¾ä»¥æ‰¿å—ï¼Œæ€»ä¸å¯èƒ½è®©ç”¨æˆ·ç­‰å¾…å‡ ååˆ†é’Ÿçš„é‡Hashè¿‡ç¨‹æ‰èƒ½æˆåŠŸè¯»å–æ•°æ®å§</strong>ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§ç‰¹æ®Šçš„è§£å†³æ–¹æ¡ˆâ€”â€”<strong><em>ä¸€è‡´æ€§Hashç®—æ³•</em></strong>æ¨ªç©ºå‡ºä¸–ã€‚</p><h2 id="ç®—æ³•è¯¦è§£"><a href="#ç®—æ³•è¯¦è§£" class="headerlink" title="ç®—æ³•è¯¦è§£"></a>ç®—æ³•è¯¦è§£</h2><p><strong>ä¸€è‡´æ€§Hashç®—æ³•çš„æ ¸å¿ƒï¼Œæ˜¯æŠŠèŠ‚ç‚¹æœ¬èº«ä¹Ÿæ˜ å°„åˆ°å’Œæ•°æ®ä¸€è‡´çš„Hashç©ºé—´ã€‚</strong></p><p>è¿™å¥è¯å¬èµ·æ¥ä¼¼ä¹æœ‰ç‚¹æ‹—å£ï¼Œ<strong>ç®€å•è€Œè¨€å°±æ˜¯ä½¿ç”¨ä¸€æ ·çš„Hashæ–¹æ³•ï¼Œä¸ä»…å¯¹æ•°æ®è¿›è¡ŒHashï¼ŒåŒæ—¶ä¹Ÿå¯¹èŠ‚ç‚¹è¿›è¡ŒHashã€‚</strong>é€šè¿‡è¿™æ ·åšï¼Œå°±èƒ½å°†æ•°æ®å’ŒèŠ‚ç‚¹æ”¾ç½®åˆ°ä¸€ä¸ªç©ºé—´ä¸­ï¼Œå‡è®¾<code>hash(x)</code>çš„å€¼åŸŸä¸º<code>[0, M]</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥ç”¨ä¸€ä¸ªäºŒç»´çš„ç¯è¡¨ç¤ºæ­¤Hashç©ºé—´ã€‚ç„¶åå¯¹æ¯ä¸€æ¡æ•°æ®<code>data</code>è®¡ç®—<code>hash(data)</code>ï¼ŒæŠŠæ•°æ®æ”¾ç½®åˆ°ç¯ä¸Šé¡ºæ—¶é’ˆæ–¹å‘æœ€è¿‘çš„èŠ‚ç‚¹è¿›è¡Œå­˜å‚¨ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/consistent_hash.png" alt=""></p><ul><li><p>æ­£å¸¸æƒ…å†µï¼ˆæ— èŠ‚ç‚¹å¢åˆ ï¼‰</p><p>  å‡è®¾é›†ç¾¤å†…èŠ‚ç‚¹æ•°é‡<code>N = 100</code>ï¼Œæ•°æ®æ¡æ•°<code>DATA_COUNT = 100000</code>ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœHashç®—æ³•çš„ç»“æœæ˜¯å‡åŒ€çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹åº”è¯¥å­˜å‚¨<code>100000 / 100 = 1000</code>æ¡æ•°æ®ã€‚ä¸ºæ­¤æˆ‘ç”¨Pythonå†™äº†ä¸€ä¸ªæ¨¡æ‹Ÿç¨‹åºã€‚</p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack_from</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">NUM_NODES = <span class="number">100</span></span><br><span class="line">NUM_DATA = <span class="number">100000</span></span><br><span class="line">nodes = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_NODES)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># hash function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(data)</span>:</span></span><br><span class="line">    data_md5 = md5(str(data)).digest()</span><br><span class="line">    <span class="keyword">return</span> unpack_from(<span class="string">"=I"</span>, data_md5)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># distribute data to different nodes</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distribute</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> range(NUM_DATA):</span><br><span class="line">        h = hash(data)</span><br><span class="line">        index = h % NUM_NODES</span><br><span class="line">        nodes[index] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        Case 1: æ­£å¸¸æƒ…å†µä¸‹çš„æ•°æ®åˆ†å¸ƒ</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    distribute()</span><br><span class="line">    max_node = max(nodes)</span><br><span class="line">    min_node = min(nodes)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"Node with max data: &#123;0&#125; piece of data"</span>.format(max_node))</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"Node with min data: &#123;0&#125; piece of data"</span>.format(min_node))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plot scatter graph</span></span><br><span class="line">    x = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_NODES)]</span><br><span class="line">    y = nodes</span><br><span class="line">    plt.scatter(x, y, c=<span class="string">'r'</span>)</span><br><span class="line">    plt.yticks(range(<span class="number">0</span>, <span class="number">2</span> * NUM_DATA / NUM_NODES, <span class="number">100</span>))</span><br><span class="line">    plt.xlabel(<span class="string">"Node Index"</span>)</span><br><span class="line">    plt.ylabel(<span class="string">"Data Count"</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><p>  ç»è¿‡æ¨¡æ‹Ÿï¼Œå¾—åˆ°å¦‚ä¸‹çš„æ•°æ®åˆ†å¸ƒæ•£ç‚¹å›¾ï¼š</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/common.png" alt=""></p><p>  å¯ä»¥çœ‹å‡ºæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å‡åœ¨<code>1000</code>ä¸Šä¸‹æµ®åŠ¨ï¼Œå·®è·ä¸å¤§ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å‡åŒ€åˆ†å¸ƒã€‚</p></li><li><p>å¢åŠ ï¼åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹</p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack_from</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">LESS_NUM_NODES = <span class="number">99</span>         <span class="comment"># less nodes</span></span><br><span class="line">ORIGINAL_NUM_NODES = <span class="number">100</span>    <span class="comment"># original nodes</span></span><br><span class="line">MORE_NUM_NODES = <span class="number">101</span>        <span class="comment"># more nodes</span></span><br><span class="line">NUM_DATA = <span class="number">100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hash function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(data)</span>:</span></span><br><span class="line">    data_md5 = md5(str(data)).digest()</span><br><span class="line">    <span class="keyword">return</span> unpack_from(<span class="string">"=I"</span>, data_md5)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># distribute data to more nodes</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distribute_more</span><span class="params">()</span>:</span></span><br><span class="line">    transfer_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> range(NUM_DATA):</span><br><span class="line">        h = hash(data)</span><br><span class="line">        original_index = h % ORIGINAL_NUM_NODES</span><br><span class="line">        more_index = h % MORE_NUM_NODES</span><br><span class="line">        <span class="keyword">if</span> original_index != more_index:</span><br><span class="line">            transfer_count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> transfer_count</span><br><span class="line"></span><br><span class="line"><span class="comment"># distribute data to less nodes</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distribute_less</span><span class="params">()</span>:</span></span><br><span class="line">    transfer_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> range(NUM_DATA):</span><br><span class="line">        h = hash(data)</span><br><span class="line">        original_index = h % ORIGINAL_NUM_NODES</span><br><span class="line">        less_index = h % LESS_NUM_NODES</span><br><span class="line">        <span class="keyword">if</span> original_index != less_index:</span><br><span class="line">            transfer_count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> transfer_count</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        Case 2: å½“å‡ºç°å¢/åˆ èŠ‚ç‚¹æ—¶çš„æ•°æ®åˆ†å¸ƒæƒ…å†µ</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ–°å¢èŠ‚ç‚¹</span></span><br><span class="line">    transfer_count = distribute_more()</span><br><span class="line">    print(<span class="string">"##### When one new node is added #####"</span>)</span><br><span class="line">    print(<span class="string">"Data that need to be transferred: &#123;&#125;"</span>.format(transfer_count))</span><br><span class="line">    print(<span class="string">"Percentage of data that need to be transferred: &#123;&#125;%"</span>.format(transfer_count * <span class="number">100.0</span> / NUM_DATA))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">    transfer_count = distribute_less()</span><br><span class="line">    print(<span class="string">"\n##### When one old node is deleted #####"</span>)</span><br><span class="line">    print(<span class="string">"Data that need to be transferred: &#123;&#125;"</span>.format(transfer_count))</span><br><span class="line">    print(<span class="string">"Percentage of data that need to be transferred: &#123;&#125;%"</span>.format(transfer_count * <span class="number">100.0</span> / NUM_DATA))</span><br></pre></td></tr></table></figure><p>  æ•°æ®è¿ç§»æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case2.png" alt=""></p><p>  å¯ä»¥çœ‹åˆ°ï¼Œå°†èŠ‚ç‚¹ä¸ªæ•°ä»<code>N</code>å¢åŠ åˆ°<code>N+1</code>åæˆ–ä»<code>N</code>å‡å°‘åˆ°<code>N-1</code>åï¼Œæœ‰å·®ä¸å¤š<code>99%</code>çš„æ•°æ®ç»è¿‡é‡Hashåéƒ½è¦è¿›è¡Œæ•°æ®è¿ç§»ï¼Œè¿™æ ·çš„æ•°æ®è¿ç§»å‹åŠ›ç»å¯¹æ˜¯æ— æ³•æ‰¿å—çš„ã€‚</p></li><li><p>åº”ç”¨ä¸€è‡´æ€§Hashç®—æ³•åæ•°æ®è¿ç§»æƒ…å†µ</p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack_from</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> bisect_left</span><br><span class="line"></span><br><span class="line">ORIGINAL_NUM_NODES = <span class="number">100</span>    <span class="comment"># original node count</span></span><br><span class="line">NEW_NUM_NODES = <span class="number">101</span>         <span class="comment"># new node count</span></span><br><span class="line">NUM_DATA = <span class="number">100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hash function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(data)</span>:</span></span><br><span class="line">    data_md5 = md5(str(data)).digest()</span><br><span class="line">    <span class="keyword">return</span> unpack_from(<span class="string">"=I"</span>, data_md5)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># distribute data to different nodes</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distribute</span><span class="params">(original_nodes, new_nodes)</span>:</span></span><br><span class="line">    transfer_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> range(NUM_DATA):</span><br><span class="line">        h = hash(data)</span><br><span class="line">        original_index = bisect_left(original_nodes, h) % ORIGINAL_NUM_NODES</span><br><span class="line">        new_index = bisect_left(new_nodes, h) % NEW_NUM_NODES</span><br><span class="line">        <span class="keyword">if</span> original_index != new_index:</span><br><span class="line">            transfer_count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> transfer_count</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        Case 3: åº”ç”¨ä¸€è‡´æ€§Hashå, éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ¯”ä¾‹</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    original_nodes = sorted([hash(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(ORIGINAL_NUM_NODES)])   <span class="comment"># å¯¹nodeæœ¬èº«ä¹Ÿå–hash</span></span><br><span class="line">    new_nodes = sorted([hash(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(NEW_NUM_NODES)])             <span class="comment"># å¯¹nodeæœ¬èº«ä¹Ÿå–hash</span></span><br><span class="line"></span><br><span class="line">    transfer_count = distribute(original_nodes, new_nodes)</span><br><span class="line">    print(<span class="string">"Percentage of data that need to be transferred: &#123;&#125;%"</span>.format(transfer_count * <span class="number">100.0</span> / NUM_DATA))</span><br></pre></td></tr></table></figure><p>  æ•°æ®è¿ç§»æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case3.png" alt=""></p><p>  å®ç°äº†ä¸€è‡´æ€§Hashç®—æ³•åï¼Œæˆ‘ä»¬å°†èŠ‚ç‚¹ä¹Ÿæ˜ å°„åˆ°äº†åŒä¸€ç‰‡Hashç©ºé—´ï¼ŒæˆåŠŸåœ°å°†æ•°æ®è¿ç§»çš„æ¯”ä¾‹ä»<code>99%</code>é™ä½åˆ°<code>37%</code>å·¦å³ã€‚</p></li><li><p>åº”ç”¨ä¸€è‡´æ€§Hashç®—æ³•åæ•°æ®åˆ†å¸ƒæƒ…å†µ</p>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack_from</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> bisect_left</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">NUM_NODES = <span class="number">100</span>    <span class="comment"># original node count</span></span><br><span class="line">NUM_DATA = <span class="number">100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hash function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(data)</span>:</span></span><br><span class="line">    data_md5 = md5(str(data)).digest()</span><br><span class="line">    <span class="keyword">return</span> unpack_from(<span class="string">"=I"</span>, data_md5)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># distribute data to different nodes</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distribute</span><span class="params">(nodes, stat)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> range(NUM_DATA):</span><br><span class="line">        h = hash(data)</span><br><span class="line">        index = bisect_left(nodes, h) % NUM_NODES</span><br><span class="line">        stat[index] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">        Case 4: åº”ç”¨ä¸€è‡´æ€§Hashå, æ•°æ®çš„åˆ†å¸ƒæƒ…å†µ</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    nodes = sorted([hash(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_NODES)])</span><br><span class="line">    stat = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_NODES)]</span><br><span class="line"></span><br><span class="line">    distribute(nodes, stat)</span><br><span class="line">    max = max(stat)</span><br><span class="line">    min = min(stat)</span><br><span class="line">    print(<span class="string">"Node with max data: &#123;&#125; piece of data"</span>.format(max))</span><br><span class="line">    print(<span class="string">"Node with min data: &#123;&#125; piece of data"</span>.format(min))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plot scatter graph</span></span><br><span class="line">    x = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_NODES)]</span><br><span class="line">    y = stat</span><br><span class="line">    plt.scatter(x, y, c=<span class="string">'r'</span>)</span><br><span class="line">    plt.yticks(range(<span class="number">0</span>, <span class="number">10</span> * NUM_DATA / NUM_NODES, <span class="number">1000</span>))</span><br><span class="line">    plt.xlabel(<span class="string">"Node Index"</span>)</span><br><span class="line">    plt.ylabel(<span class="string">"Data Count"</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><p>  åº”ç”¨ä¸€è‡´æ€§Hashåï¼Œæ•°æ®åˆ†å¸ƒæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤º</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/case4.png" alt=""></p><p>  å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”æœŸæœ›å€¼<code>1000</code>ï¼Œå‡ºç°äº†åç§»çš„æ•°æ®ï¼Œå­˜åœ¨å¾ˆå¤šä½äº<code>1000</code>æ¡æ•°æ®çš„èŠ‚ç‚¹ã€‚è™½ç„¶æ•°æ®è¿ç§»ç‡é™ä½äº†ï¼Œä½†æ˜¯å‡ºç°äº†å¦ä¸€ä¸ªé—®é¢˜â€”â€”<strong>æ— æ³•å……åˆ†åˆ©ç”¨é›†ç¾¤ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œé€ æˆäº†æ•°æ®ä¸å¹³è¡¡</strong>ã€‚</p></li><li><p>ä¸€è‡´æ€§Hashç®—æ³•â€”â€”è§£å†³æ•°æ®ä¸å¹³è¡¡</p><p>  æ•°æ®ä¸å¹³è¡¡é—®é¢˜ï¼Œæ ¹æœ¬åŸå› å°±åœ¨äºå¯¹èŠ‚ç‚¹è¿›è¡ŒHashåï¼Œå®ƒä»¬çš„Hashå€¼åœ¨ç¯ä¸Šåˆ†å¸ƒä¸å¤Ÿå‡åŒ€ã€‚é‚£ä¹ˆä¸ºäº†â€œåˆ†å¸ƒå‡åŒ€â€ï¼Œè‡ªç„¶è€Œç„¶æˆ‘ä»¬å¯ä»¥åœ¨ç¯ä¸Šç¨€ç–çš„åŒºåŸŸå¤šæ·»åŠ ä¸€äº›â€œå‡â€èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<strong>è™šæ‹ŸèŠ‚ç‚¹ï¼ˆVirtual Nodeï¼‰</strong>ï¼Œä»¥å°†ç¨€ç–çš„åŒºåŸŸå¡«å……å¾—æ»¡ä¸€ç‚¹ã€‚</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/v_node.png" alt=""></p><p>  å¦‚å›¾æ‰€ç¤ºï¼Œé€šè¿‡åœ¨ç¨€ç–åŒºåŸŸå¢åŠ <strong>è™šæ‹ŸèŠ‚ç‚¹ï¼ˆVirtual Nodeï¼‰</strong>ï¼ŒåŸæœ¬ä»‹äº<code>Node #3</code>å’Œ<code>data #1</code>é—´çš„æ•°æ®å¯ä»¥è¢«â€œå­˜å‚¨â€åœ¨<code>V-Node #2</code>æˆ–è€…<code>V-Node #1</code>ä¸Šã€‚å†é€šè¿‡æŸ¥è¯¢<code>V-Node</code>åˆ°<code>Node</code>çš„æ˜ å°„å…³ç³»ï¼Œå³å¯ä»å®é™…çš„å­˜å‚¨èŠ‚ç‚¹å–å‡ºæ•°æ®ã€‚</p><p>  <img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/v_node_query.png" alt=""></p><p>  é€šè¿‡ä¿å­˜<code>V-Node</code>åˆ°<code>Node</code>çš„<code>mapping</code>ï¼Œå¯ä»¥è¿…é€Ÿå®šä½åˆ°å®é™…å­˜å‚¨èŠ‚ç‚¹ã€‚</p></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸€è‡´æ€§Hashç®—æ³•ï¼Œæ ¸å¿ƒåœ¨äºè§£å†³é›†ç¾¤èŠ‚ç‚¹å¢åˆ åœºæ™¯ä¸‹çš„æ•°æ®ä¸¢å¤± &amp; å¤§é‡æ•°æ®è¿ç§»é—®é¢˜ã€‚å®ç°çš„å…³é”®æ˜¯å°†èŠ‚ç‚¹æœ¬èº«ä¹Ÿé€šè¿‡Hashå‡½æ•°æ˜ å°„åˆ°æ•°æ®æ‰€åœ¨çš„Hashç©ºé—´ï¼Œä»è€Œä½¿æ•°æ®èƒ½å¤Ÿåœ¨æŸä¸€å›ºå®šç©ºé—´å†…ä½œâ€œç‰©ç†æ€§â€ï¼ˆé¡ºæ—¶é’ˆã€é€†æ—¶é’ˆâ€¦â€¦ï¼‰çš„ä½ç½®åˆ†é…ã€‚</p><h2 id="ç›¸å…³ä»£ç "><a href="#ç›¸å…³ä»£ç " class="headerlink" title="ç›¸å…³ä»£ç "></a>ç›¸å…³ä»£ç </h2><p>å…·ä½“ä»£ç è¯·æŸ¥çœ‹<a href="https://github.com/AcepcsMa/Consistent_Hash" target="_blank" rel="noopener">æˆ‘çš„Githubç›®å½•</a></p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ</title>
      <link href="/2018/03/04/join-di/"/>
      <url>/2018/03/04/join-di/</url>
      
        <content type="html"><![CDATA[<h1 id="æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ"><a href="#æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ"></a>æµ…è°ˆjoinä¸æ•°æ®å€¾æ–œè§£å†³æ–¹æ¡ˆ</h1><blockquote><p>æœ¬æ–‡100%ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p><code>join</code>æ“ä½œåœ¨ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ä¸­ç‰¹åˆ«å¸¸è§ï¼Œå¾€å¾€ç”¨æ¥è¿æ¥ä¸¤å¼ æˆ–å¤šå¼ åœ¨æŸäº›é”®ä¸Šæœ‰å…³è”çš„è¡¨ã€‚ä½†å½“æˆ‘ä»¬çš„æ•°æ®å¹¶æ²¡æœ‰è¢«ç»“æ„åŒ–å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰‹ä¸Šä»…æœ‰å¤§é‡çš„<strong><em>raw data</em></strong> â€”â€” æˆåƒä¸Šä¸‡ä¸ªç£ç›˜æ•°æ®æ–‡ä»¶ï¼ˆå¦‚.datæˆ–.txtï¼‰æ—¶ï¼Œåˆæˆ–è€…å½“å¤§é‡çš„æ•°æ®æ–‡ä»¶å­˜æ”¾åœ¨åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆHDFSï¼‰é‡Œï¼Œéš¾ä»¥å°†å…¶é«˜æ•ˆå¯¼å…¥MySQLä¸­æ—¶ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°å°±ä¼šæ€è€ƒï¼š<strong>æœ‰æ²¡æœ‰ä¸éœ€è¦ä¾é å…³ç³»å‹æ•°æ®åº“è€Œå®ç°çš„joinå‘¢ï¼Ÿå¯¹äºæµ·é‡æ–‡ä»¶èƒ½ä¸èƒ½ç”¨Map-Reduceå®ç°joinæ“ä½œå‘¢ï¼Ÿ</strong></p><p>å‡è®¾ç°åœ¨ç³»ç»Ÿä¸­æœ‰ä¸¤ç±»æ•°æ®æ–‡ä»¶ï¼š</p><ol><li><strong><em>ç”¨æˆ·æ•°æ®æ–‡ä»¶ï¼ˆUserï¼‰</em></strong></li><li><strong><em>è®¢å•æ•°æ®æ–‡ä»¶ï¼ˆOrderï¼‰</em></strong></li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// useræ–‡ä»¶ç»“æ„</span><br><span class="line">user_id, user_name, phone</span><br><span class="line">1,aa,10086</span><br><span class="line">2,bb,10010</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">// orderæ–‡ä»¶ç»“æ„</span><br><span class="line">order_id, user_id, price, date</span><br><span class="line">1,1,15.52018-01-01</span><br><span class="line">2,1,3.92018-01-01</span><br><span class="line">3,1,26.02018-01-03</span><br><span class="line">4,2,2.22018-01-04</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>éœ€æ±‚æ˜¯å°†<strong><em>ç”¨æˆ·æ•°æ®æ–‡ä»¶ï¼ˆUserï¼‰</em></strong>å’Œ<strong><em>è®¢å•æ•°æ®æ–‡ä»¶ï¼ˆOrderï¼‰</em></strong>é€šè¿‡<code>user_id</code>é”®ç›¸å…³è”ï¼Œå¾—åˆ°æ€»çš„ç”¨æˆ·ä¿¡æ¯+ç”¨æˆ·è®¢å•ä¿¡æ¯çš„æ€»â€œè¡¨â€ï¼ˆä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„å†…å®¹å¯çœ‹ä½œè¡¨çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æœŸæœ›å¾—åˆ°çš„æ€»è¡¨ç»“æ„</span><br><span class="line">user_id, user_name, phone, order_id, price, date</span><br><span class="line">1,aa,10086,1,  15.5,2018-01-01</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡å°†åŸºäºä»¥ä¸Šéœ€æ±‚ï¼Œå¯¹Map-Reduceå®ç°ä¸¤è¡¨å…³è”ï¼ˆjoinï¼‰è¿›è¡Œæ¢è®¨ã€‚</p><h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>è¦åˆ©ç”¨Map-Reduceå®ç°ä¸¤è¡¨å…³è”ï¼Œå…³é”®ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p><ol><li><p>å¦‚ä½•è¾¨åˆ«å½“å‰å¤„ç†çš„æ•°æ®æ¥è‡ªäº<strong><em>Userè¡¨</em></strong>è¿˜æ˜¯<strong><em>Orderè¡¨</em></strong></p><p> å› ä¸ºä¸¤ç§æ–‡ä»¶æœ‰ä¸åŒçš„æ•°æ®æ ¼å¼ï¼Œæˆ‘ä»¬åœ¨Mapperé‡Œå¯¹æ•°æ®é€è¡Œè¿›è¡Œå¤„ç†æ—¶ï¼Œå¿…é¡»è¦çŸ¥é“å½“å‰è¿™è¡Œæ•°æ®æ¥è‡ªäº<strong><em>Userè¡¨</em></strong>è¿˜æ˜¯<strong><em>Orderè¡¨</em></strong>ï¼Œ ä¸ç„¶æ ¹æœ¬æ²¡æœ‰åŠæ³•ç¼–å†™è¿›ä¸€æ­¥çš„å¤„ç†é€»è¾‘ã€‚å…¶å®çœ‹è¿‡æˆ‘ä¹‹å‰æ–‡ç« çš„åŒå­¦åº”è¯¥è§è¿‡åœ¨Mapperé‡Œè·å–å½“å‰æ•°æ®æ‰€å±æ–‡ä»¶åçš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯<strong><em>mapæ–¹æ³•</em></strong>çš„<code>Context</code>å‚æ•°å…¶å®å¸¦æœ‰äº†å¾ˆå¤šæœ¬æ¬¡Jobçš„è¿è¡Œä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†å½“å‰æ•°æ®æ¥è‡ªäºå“ªä¸ª<code>FileSplit</code>ï¼Œè¿›ä¸€æ­¥å¯ä»¥è·å¾—è¯¥<code>FileSplit</code>æ‰€å±çš„æ–‡ä»¶åã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FileSplit fileSplit = (FileSplit)context.getInputSplit();</span><br><span class="line">String fileName = fileSplit.getPath().getName();</span><br></pre></td></tr></table></figure></li><li><p>æœ‰ä¸¤ç§ä¸åŒçš„æ•°æ®æ–‡ä»¶ï¼Œå¯æ˜¯ä¸€ä¸ªMRä»»åŠ¡é‡Œåªæœ‰ä¸€ç§K-Vå¯¹å®šä¹‰</p><p> ä¸¤ç§æ–‡ä»¶æ ¼å¼ï¼Œä¸€ç§K-Vå¯¹å®šä¹‰ï¼Œé‚£å¾ˆè‡ªç„¶æˆ‘ä»¬å°±è¦æƒ³æƒ³å¦‚ä½•å°†ä¸¤ç§â€œåˆå¹¶â€æˆä¸€ç§ï¼ŒåŒæ—¶è¿˜èƒ½éšæ—¶å°†è¿™ä¸ªåˆå¹¶çš„äº§ç‰©åˆ†å¼€æˆä¸¤ç§ã€‚å…¶å®ä¹‹å‰çš„æ–‡ç« å·²ç»å¤šæ¬¡æåŠä¸€ç§åœ¨Map-Reduceé‡Œå¸¸ç”¨çš„æ¦‚å¿µâ€”â€”<strong>è‡ªå®šä¹‰JavaBean</strong>ï¼Œä½œä¸ºä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œå®ƒçš„å¤åˆæ€§è´¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬â€œé›†æˆâ€å¾ˆå¤šåŸç”Ÿæ•°æ®ç±»å‹ã€‚åœ¨å½“å‰é—®é¢˜é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª<code>JavaBean</code>ï¼Œ<strong>é›†æˆUserè¡¨ä¸Orderè¡¨çš„æ‰€æœ‰å­—æ®µ</strong>ï¼Œå¹¶é¢å¤–æ·»åŠ ä¸€ä¸ª<code>flag</code>å­—æ®µç”¨ä»¥è¡¨æ˜å®ä¾‹å¯¹è±¡æ˜¯<code>User</code>æ•°æ®è¿˜æ˜¯<code>Order</code>æ•°æ®ã€‚é€šè¿‡è¿™ä¸ª<code>JavaBean</code>å°±å¯ä»¥å®ç°â€œåˆå¹¶ä¸”éšæ—¶å¯åˆ†ç¦»â€çš„éœ€æ±‚äº†ã€‚</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JavaBean = &#123;user_id, order_id, user_name, phone, price, date&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><em>â€œjoinâ€</em></strong>çš„é€»è¾‘å…·ä½“æ€ä¹ˆå†™</p><p> åŸºäºç¬¬2ç‚¹ï¼Œå®ç°äº†ä¸€ä¸ªé›†æˆçš„JavaBeanåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨mapä¸­å°†æ•°æ®å°è£…æˆJavaBeanå®ä¾‹å¯¹è±¡ï¼Œç„¶åç”¨flagå­—æ®µæŒ‡æ˜æ•°æ®ç±»å‹ã€‚ä¸ºäº†å®ç°joinåŠŸèƒ½ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿åŒä¸€ä¸ª<code>User</code>çš„æ‰€æœ‰æ•°æ®éƒ½åˆ°è¾¾åŒä¸€ä¸ªReducerå¤„ï¼Œé‚£æ ·æ‰èƒ½å°†è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ä¸å…¶ç”¨æˆ·ä¿¡æ¯å…³è”èµ·æ¥ï¼Œé¿å…é—æ¼ã€‚ä¸ºäº†è®©åŒä¸€ä¸ªUserçš„æ•°æ®éƒ½åˆ°è¾¾åŒä¸€ä¸ªReducerï¼Œæˆ‘ä»¬è¦è®©Mapç«¯è¾“å‡ºçš„K-Vå¯¹ä¸º<code>&lt;UserID, JavaBean&gt;</code>ï¼Œé‚£ä¹ˆåœ¨Partitionçš„æ—¶å€™ï¼ŒåŒä¸€ä¸ªUserIDçš„æ•°æ®è‡ªç„¶ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªReducerã€‚</p><p> å½“Reduceræ‹¿åˆ°ä¸€æ‰¹<code>&lt;UserID, JavaBean&gt;</code>æ•°æ®åï¼Œå°†å…¶æ•´åˆä¸º<code>&lt;UserID, Iterable&lt;JavaBean&gt;&gt;</code>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<code>Iterable&lt;JavaBean&gt;&gt;</code>é‡Œé€šè¿‡åˆ¤æ–­<code>flag</code>çš„å€¼æ‰¾å‡º<code>User</code>çš„JavaBeanï¼Œç§°ä¸º<strong><em>U</em></strong>ã€‚ç„¶åå¯¹äºæ¯ä¸ª<code>Order</code>çš„JavaBeanï¼ˆç§°ä¸º<strong><em>O</em></strong>ï¼‰ï¼Œä»<strong><em>O</em></strong>ä¸­å–å‡º<code>order_id</code>, <code>price</code>, <code>date</code>ï¼Œä»<strong><em>U</em></strong>ä¸­å–å‡º<code>user_id</code>, <code>user_name</code>, <code>phone</code>ï¼Œç»„æˆç»“æœæ•°æ®<strong><em>R</em></strong>ã€‚</p> <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R = (order_id, price, dateï¼Œuser_id, user_name, phone)</span><br></pre></td></tr></table></figure><p> Reducerå¾ªç¯å°†å¤šä¸ª<code>&lt;R, NullWritable&gt;</code>å†™åˆ°æœ€ç»ˆContextä¸­ï¼Œä¾¿å®Œæˆäº†joiné€»è¾‘ã€‚</p></li></ol><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><ol><li><p>è‡ªå®šä¹‰JavaBean</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰JavaBean, å®ç°Writableæ¥å£, å› æœ¬ä»»åŠ¡ä¸å­˜åœ¨"æ¯”è¾ƒ", æ— éœ€å®ç°WritableComparable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinBean</span> <span class="keyword">implements</span> <span class="title">Writable</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> String userID;</span><br><span class="line"><span class="keyword">public</span> String uName;</span><br><span class="line"><span class="keyword">public</span> String phone;</span><br><span class="line"><span class="keyword">public</span> String orderID;</span><br><span class="line"><span class="keyword">public</span> String price;</span><br><span class="line"><span class="keyword">public</span> String date;</span><br><span class="line"><span class="keyword">public</span> String flag;<span class="comment">// ç”¨äºæ ‡è¯†Userè¿˜æ˜¯Order</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JoinBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JoinBean</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"uName='"</span> + uName + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", phone='"</span> + phone + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", orderID='"</span> + orderID + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", price='"</span> + price + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", date='"</span> + date + <span class="string">'\''</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserID</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> userID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserID</span><span class="params">(String userID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getuName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> uName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setuName</span><span class="params">(String uName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> phone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrderID</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> orderID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderID</span><span class="params">(String orderID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(String price)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">dataOutput.writeUTF(userID);</span><br><span class="line">dataOutput.writeUTF(uName);</span><br><span class="line">dataOutput.writeUTF(phone);</span><br><span class="line">dataOutput.writeUTF(orderID);</span><br><span class="line">dataOutput.writeUTF(price);</span><br><span class="line">dataOutput.writeUTF(date);</span><br><span class="line">dataOutput.writeUTF(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">userID = dataInput.readUTF();</span><br><span class="line">uName = dataInput.readUTF();</span><br><span class="line">phone = dataInput.readUTF();</span><br><span class="line">orderID = dataInput.readUTF();</span><br><span class="line">price = dataInput.readUTF();</span><br><span class="line">date = dataInput.readUTF();</span><br><span class="line">flag = dataInput.readUTF();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Mapper</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapperç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">JoinBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"user"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ORDER = <span class="string">"order"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> JoinBean info = <span class="keyword">new</span> JoinBean();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">FileSplit fileSplit = (FileSplit)context.getInputSplit();</span><br><span class="line">String fileName = fileSplit.getPath().getName();<span class="comment">// è·å–æ•°æ®æ‰€å±æ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line">String line = value.toString();</span><br><span class="line">String[] data = line.split(<span class="string">","</span>);</span><br><span class="line">String userID = data[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡flagæ ‡è¯†å®ä¾‹å¯¹è±¡æ˜¯Userè¿˜æ˜¯Order</span></span><br><span class="line"><span class="keyword">if</span>(fileName.startsWith(<span class="string">"user"</span>)) &#123;</span><br><span class="line">info.set(<span class="string">""</span>, data[<span class="number">1</span>], data[<span class="number">2</span>], <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, USER);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">info.set(<span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, data[<span class="number">1</span>], data[<span class="number">2</span>], data[<span class="number">3</span>], ORDER);</span><br><span class="line">&#125;</span><br><span class="line">context.write(<span class="keyword">new</span> Text(userID), info);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Reducer</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reducerç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">JoinBean</span>, <span class="title">JoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;JoinBean&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">JoinBean userInfo = <span class="keyword">new</span> JoinBean();</span><br><span class="line">List&lt;JoinBean&gt; orders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(JoinBean info : values) &#123;</span><br><span class="line"><span class="comment">// åŒä¸€ä¸ªUserIDï¼Œæœ‰ä¸”ä»…æœ‰1ä¸ªUserå¯¹è±¡ï¼Œå…¶ä»–å‡ä¸ºè¯¥Userçš„Orderå¯¹è±¡</span></span><br><span class="line"><span class="keyword">if</span>(info.getFlag().equals(<span class="string">"user"</span>)) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">BeanUtils.copyProperties(userInfo, info);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(info.getFlag().equals(<span class="string">"order"</span>))&#123;</span><br><span class="line">JoinBean order = <span class="keyword">new</span> JoinBean();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">BeanUtils.copyProperties(order, info);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125;</span><br><span class="line">orders.add(order);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ‰€éœ€å±æ€§, åˆå¹¶, è¾“å‡º</span></span><br><span class="line"><span class="keyword">for</span>(JoinBean order : orders) &#123;</span><br><span class="line">JoinBean record = <span class="keyword">new</span> JoinBean();</span><br><span class="line">record.set(key.toString(), userInfo.getuName(), userInfo.getPhone(), order.getOrderID(), order.getPrice(), order.getDate(), order.getFlag());</span><br><span class="line">context.write(record, NullWritable.get());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Driverï¼ˆç¨‹åºå…¥å£ï¼‰</p> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinDriver</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://localhost:9000"</span>);</span><br><span class="line">Job joinJob = Job.getInstance(conf);</span><br><span class="line"></span><br><span class="line">joinJob.setMapperClass(JoinMapper.class);</span><br><span class="line">joinJob.setReducerClass(JoinReducer.class);</span><br><span class="line"></span><br><span class="line">joinJob.setJarByClass(JoinDriver.class);</span><br><span class="line"></span><br><span class="line">joinJob.setMapOutputKeyClass(Text.class);</span><br><span class="line">joinJob.setMapOutputValueClass(JoinBean.class);</span><br><span class="line">joinJob.setOutputKeyClass(JoinBean.class);</span><br><span class="line">joinJob.setOutputValueClass(NullWritable.class);</span><br><span class="line"></span><br><span class="line">FileInputFormat.setInputPaths(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/input"</span>));</span><br><span class="line">FileOutputFormat.setOutputPath(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/output"</span>));</span><br><span class="line"></span><br><span class="line">System.exit(joinJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€"><a href="#æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€" class="headerlink" title="æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€"></a>æç«¯æƒ…å†µâ€”â€”â€œæ•°æ®å€¾æ–œâ€</h2><p>åœ¨è¿™ä¸ªé—®é¢˜é‡Œï¼Œæˆ‘ä»¬çš„æ•°æ®åˆ†ä¸º<code>User</code>å’Œ<code>Order</code>ä¸¤ç±»ï¼Œå…¶ä¸­æ˜æ˜¾<code>User</code>çš„æ•°æ®ä¼šæ¯”<code>Order</code>å°‘å¾—å¤šã€‚ä¸€ä½ç”¨æˆ·åªå¯èƒ½æœ‰ä¸€è¡Œ<code>User</code>è®°å½•ï¼ˆåœ¨ç³»ç»Ÿä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼‰ï¼Œè€Œä¸€ä½ç”¨æˆ·å´å¯ä»¥æœ‰Nè¡Œ<code>Order</code>è®°å½•ï¼Œå› ä¸ºä»–å¯ä»¥â€œç–¯ç‹‚è´­ç‰©â€äº§ç”Ÿäº†æˆåƒä¸Šä¸‡æ¡çš„è®¢å•æ•°æ®ã€‚</p><p>æç«¯æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä½<code>User</code>ï¼š<code>user_1</code>å¯¹åº”äº†<code>1000000</code>æ¡<code>Order</code>æ•°æ®ï¼Œå¦ä¸€ä½<code>User</code>ï¼š<code>user_2</code>å¯¹åº”äº†<code>2</code>æ¡<code>Order</code>æ•°æ®ã€‚é‚£ä¹ˆå¿…ç„¶æœ‰ä¸€ä¸ªè´Ÿè´£å¤„ç†<code>user_1</code>çš„Reducer<code>reducer_1</code>çš„è´Ÿè½½è¿‡é«˜ï¼Œå› ä¸ºè¦å¤„ç†<code>1000000</code>æ¡æ•°æ®ï¼Œå…¶ä»–è´Ÿè½½æå°‘çš„Reducerå¹²å®Œæ´»ä¹‹åå°±å¾—ç™½ç™½æµªè´¹æ—¶é—´ç­‰ç€<code>reducer_1</code>å®Œæˆä»»åŠ¡ï¼ˆ<strong><em>å¾€å¾€è¡¨ç°ä¸ºJobè¿›åº¦å¡åœ¨99%</em></strong>ï¼‰ï¼Œæ‰èƒ½æ±‡æŠ¥æ•´ä¸ªJobå·²å®Œæˆã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/dataIncline.png" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå› ä¸ºå¤§é‡çš„æ•°æ®æ¶Œå‘å°‘æ•°çš„èŠ‚ç‚¹ï¼Œåƒæ˜¯ä¸€ä¸ªå€¾æ–œçš„å¤©å¹³ï¼Œä¸€ç«¯é‡ä¸€ç«¯è½»ï¼Œæ‰€ä»¥ä»¥ä¸Šçš„æƒ…å†µä¾¿ç§°ä¸º<code>æ•°æ®å€¾æ–œ</code>ã€‚</p><p>ä¸ºäº†è§£å†³å½“å‰é—®é¢˜å¼•èµ·çš„æ•°æ®å€¾æ–œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§<strong>â€mapç«¯joinâ€œ</strong>çš„æ–¹å¼è¿›è¡Œå…³è”æ“ä½œï¼Œä»£æ›¿ä¹‹å‰åœ¨Reducerç«¯æ”¶é›†æ•°æ®è¿›è¡Œjoinçš„é€»è¾‘ã€‚ç›¸æ¯”<code>Order</code>è¡¨ï¼Œ<code>User</code>è¡¨æ— ç–‘å°å¾—å¤šï¼Œç”šè‡³å¯èƒ½æ˜¯å‡ ç™¾å€çš„é‡çº§å·®è·ï¼Œæ‰€ä»¥å®Œå…¨å¯èƒ½æŠŠè¿™ä¸ªå°è¡¨åˆ†å‘ç»™å„ä¸ªMapperï¼Œè®©æ¯ä¸ªMapperéƒ½æ‹¥æœ‰ä¸€ä»½<strong><em>å®Œæ•´çš„Userè¡¨</em></strong>ï¼Œè¿›è€Œå°†å…¶åŠ è½½å…¥å†…å­˜æ„é€ ä¸€ä¸ª<code>&lt;user_id, user_info&gt;</code>çš„å“ˆå¸Œè¡¨ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œåœ¨Mapperå†…åªéœ€è¦å¤„ç†<code>Order</code>çš„æ•°æ®ï¼Œç„¶åæ ¹æ®<code>Order</code>é‡Œçš„<code>user_id</code>æŸ¥åˆ°å“ˆå¸Œè¡¨é‡Œè¯¥idå¯¹åº”çš„<code>user_info</code>ï¼Œè¿æ¥èµ·æ¥ï¼Œå³å¯å®Œæˆjoinæ“ä½œã€‚</p><ul><li>MapJoinMapper</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ç°Mapç«¯joinçš„Mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; userTable = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> MapJoinBean outputKey = <span class="keyword">new</span> MapJoinBean();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ORDER_FILE = <span class="string">"order.txt"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapperä¼šè‡ªè¡Œè°ƒç”¨çš„ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context Jobä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç³»ç»Ÿ"æŠ•æ”¾"åˆ°æœ¬åœ°çš„cacheæ–‡ä»¶, æœ¬é—®é¢˜ä¸­åªæœ‰1ä¸ªï¼Œå³user.txt</span></span><br><span class="line">URI[] uris = context.getCacheFiles();</span><br><span class="line">FileSystem fs = FileSystem.get(context.getConfiguration());</span><br><span class="line">FSDataInputStream inputStream = fs.open(<span class="keyword">new</span> Path(uris[<span class="number">0</span>]));</span><br><span class="line">BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€è¡Œè¯»å–user.txtä¸­çš„æ•°æ®, æ„å»ºuserTable</span></span><br><span class="line">String line = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">String[] terms = line.split(<span class="string">","</span>);</span><br><span class="line"><span class="keyword">if</span>(!userTable.containsKey(terms[<span class="number">0</span>])) &#123;</span><br><span class="line">userTable.put(terms[<span class="number">0</span>], <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">&#125;</span><br><span class="line">userTable.get(terms[<span class="number">0</span>]).add(terms[<span class="number">1</span>]);</span><br><span class="line">userTable.get(terms[<span class="number">0</span>]).add(terms[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reader.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">FileSplit fileSplit = (FileSplit) context.getInputSplit();</span><br><span class="line">String fileName = fileSplit.getPath().getName();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸éœ€è¦å†å¤„ç†Useræ•°æ®æ–‡ä»¶äº†, å› ä¸ºå·²ç»é€šè¿‡setupæŠŠå…¶æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­çš„userTable</span></span><br><span class="line"><span class="keyword">if</span>(fileName.equals(ORDER_FILE)) &#123;</span><br><span class="line">String line = value.toString();</span><br><span class="line">String[] terms = line.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æœ¬åœ°çš„"å°è¡¨" â€”â€” userTableå¤„è·å¾—userIDå¯¹åº”çš„æ•°æ®</span></span><br><span class="line">String userName = userTable.get(terms[<span class="number">0</span>]).get(<span class="number">0</span>);</span><br><span class="line">String phone = userTable.get(terms[<span class="number">0</span>]).get(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸å†éœ€è¦flagå­—æ®µ, ç®€å•ç½®ä¸ºç©ºä¸²</span></span><br><span class="line">outputKey.set(terms[<span class="number">0</span>], userName, phone, terms[<span class="number">1</span>], terms[<span class="number">2</span>], terms[<span class="number">3</span>], <span class="string">""</span>);</span><br><span class="line">context.write(outputKey, NullWritable.get());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>MapJoinReducer</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapç«¯Joinçš„Reducer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>, <span class="title">MapJoinBean</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(MapJoinBean key, Iterable&lt;NullWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">context.write(key, NullWritable.get());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">+ MapJoinBean</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰JavaBean, å®ç°WritableComparableæ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinBean</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">MapJoinBean</span>&gt; </span>&#123;</span><br><span class="line"><span class="keyword">public</span> String userID;</span><br><span class="line"><span class="keyword">public</span> String uName;</span><br><span class="line"><span class="keyword">public</span> String phone;</span><br><span class="line"><span class="keyword">public</span> String orderID;</span><br><span class="line"><span class="keyword">public</span> String price;</span><br><span class="line"><span class="keyword">public</span> String date;</span><br><span class="line"><span class="keyword">public</span> String flag;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MapJoinBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MapJoinBean</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String userID, String uName, String phone, String orderID, String price, String date, String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"uName='"</span> + uName + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", phone='"</span> + phone + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", orderID='"</span> + orderID + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", price='"</span> + price + <span class="string">'\''</span> +</span><br><span class="line"><span class="string">", date='"</span> + date + <span class="string">'\''</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserID</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> userID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserID</span><span class="params">(String userID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.userID = userID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(String flag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getuName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> uName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setuName</span><span class="params">(String uName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.uName = uName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> phone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.phone = phone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrderID</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> orderID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderID</span><span class="params">(String orderID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.orderID = orderID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(String price)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.price = price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.date = date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">dataOutput.writeUTF(userID);</span><br><span class="line">dataOutput.writeUTF(uName);</span><br><span class="line">dataOutput.writeUTF(phone);</span><br><span class="line">dataOutput.writeUTF(orderID);</span><br><span class="line">dataOutput.writeUTF(price);</span><br><span class="line">dataOutput.writeUTF(date);</span><br><span class="line">dataOutput.writeUTF(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">userID = dataInput.readUTF();</span><br><span class="line">uName = dataInput.readUTF();</span><br><span class="line">phone = dataInput.readUTF();</span><br><span class="line">orderID = dataInput.readUTF();</span><br><span class="line">price = dataInput.readUTF();</span><br><span class="line">date = dataInput.readUTF();</span><br><span class="line">flag = dataInput.readUTF();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(MapJoinBean o)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(o == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(userID.compareTo(o.getUserID()) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> orderID.compareTo(o.getOrderID());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> userID.compareTo(o.getUserID());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>MapJoinDriver</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapJoinDriver</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException, URISyntaxException </span>&#123;</span><br><span class="line"></span><br><span class="line">Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://localhost:9000"</span>);</span><br><span class="line">Job joinJob = Job.getInstance(conf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Mapç«¯joinçš„Mapperå’ŒReducer</span></span><br><span class="line">joinJob.setMapperClass(MapJoinMapper.class);</span><br><span class="line">joinJob.setReducerClass(MapJoinReducer.class);</span><br><span class="line"></span><br><span class="line">joinJob.setJarByClass(MapJoinDriver.class);</span><br><span class="line"></span><br><span class="line">joinJob.setMapOutputKeyClass(MapJoinBean.class);</span><br><span class="line">joinJob.setMapOutputValueClass(NullWritable.class);</span><br><span class="line">joinJob.setOutputKeyClass(MapJoinBean.class);</span><br><span class="line">joinJob.setOutputValueClass(NullWritable.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å„èŠ‚ç‚¹"æŠ•æ”¾"Useræ•°æ®æ–‡ä»¶</span></span><br><span class="line">joinJob.addCacheFile(<span class="keyword">new</span> URI(<span class="string">"/join/input/user.txt"</span>));</span><br><span class="line"></span><br><span class="line">FileInputFormat.setInputPaths(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/input"</span>));</span><br><span class="line">FileOutputFormat.setOutputPath(joinJob, <span class="keyword">new</span> Path(<span class="string">"/join/output"</span>));</span><br><span class="line"></span><br><span class="line">System.exit(joinJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>åˆ©ç”¨Map-Reduceå¯ä»¥å®Œæˆæ•°æ®æ–‡ä»¶çš„joinæ“ä½œã€‚ä¸éœ€è¦å…ˆå°†æ•°æ®ç»“æ„åŒ–ï¼Œå¯¼å…¥MySQLã€‚</li><li>è‡ªå®šä¹‰<code>JavaBean</code>ç±»ï¼Œç”¨äºé›†æˆå¤šä¸ªå±æ€§çš„æ€è·¯ä»ç„¶å¾ˆæœ‰ç”¨ã€‚</li><li>å½“joinçš„åŒæ–¹æ˜¯ä¸€å¼ <strong>å¤§è¡¨</strong>å’Œä¸€å¼ <strong>å°è¡¨</strong>æ—¶ï¼Œå¯è€ƒè™‘å°†å°è¡¨åˆ†å‘åˆ°æ‰€æœ‰mapç«¯ï¼Œåœ¨æœ¬åœ°å°†å°è¡¨åŠ è½½åˆ°å†…å­˜ï¼Œä»è€Œå®ç°<strong>mapç«¯join</strong>ã€‚</li></ol><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>å…·ä½“ä»£ç è¯·ç‚¹å‡»<br><a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/join" target="_blank" rel="noopener">Joinæ“ä½œä¸Mapç«¯joinæ“ä½œä»£ç </a></p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hadoop </tag>
            
            <tag> mapreduce </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>è°ˆè°ˆå€’æ’ç´¢å¼•ï¼Œå‡çº§ç‰ˆâ€œWordCountâ€</title>
      <link href="/2018/02/25/ii-wc/"/>
      <url>/2018/02/25/ii-wc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯ï¼šAll-About-Search"><a href="#é—®é¢˜èƒŒæ™¯ï¼šAll-About-Search" class="headerlink" title="é—®é¢˜èƒŒæ™¯ï¼šAll About Search"></a>é—®é¢˜èƒŒæ™¯ï¼šAll About Search</h2><p>åœ¨æ•°æ®åº“é¢†åŸŸå’Œæœç´¢å¼•æ“é¢†åŸŸï¼Œ<strong><em>å€’æ’ç´¢å¼•</em></strong>æ˜¯ä¸€ç§å¾ˆé‡è¦çš„æ•°æ®ç»“æ„ã€‚åœ¨å¤§éƒ¨åˆ†çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ–‡æœ¬å‹æ•°æ®ï¼ˆTextï¼‰æ˜¯ä¸»æµï¼Œä¾é <strong><em>å€’æ’ç´¢å¼•</em></strong>è¿™ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ˜¾è‘—æé«˜<strong><em>æ–‡æœ¬æ•°æ®é¡¹ï¼ˆTermï¼‰</em></strong>çš„æœç´¢é€Ÿåº¦ï¼ˆæ— è®ºæ˜¯ç†è®ºè¿˜æ˜¯å®é™…åº”ç”¨ä¸­ï¼‰ã€‚</p><p>å‡è®¾ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰ä»¥ä¸‹æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// Document A</span><br><span class="line">My name is superman.</span><br><span class="line"></span><br><span class="line">// Document B</span><br><span class="line">I love my cat whose name is Kitty!</span><br><span class="line"></span><br><span class="line">// Document C</span><br><span class="line">Please name my car.</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸å¯¹ä»¥ä¸ŠåŸå§‹æ•°æ®ä½œé¢å¤–å¤„ç†ï¼Œå¾„ç›´å°†3ä¸ªæ–‡ä»¶ä¿å­˜è‡³ç£ç›˜çš„åŒä¸€ç›®å½•ä¸‹ï¼Œåˆ†åˆ«å‘½åä¸º<code>Document A</code>ã€<code>Document B</code>ã€<code>Document C</code>ã€‚é‚£ä¹ˆå½“éœ€è¦æŸ¥æ‰¾<code>car</code>è¿™ä¸ªæ•°æ®é¡¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦éå†æ–‡ä»¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰èƒ½è¾“å‡ºæœç´¢ç»“æœï¼š<code>Found in Document C!</code>ã€‚è‹¥å°†æ­¤åœºæ™¯æ‰©å±•è‡³<strong><em>N</em></strong>ä¸ªæ•°æ®æ–‡ä»¶ï¼Œå¹³å‡æ¯ä¸ªæ•°æ®æ–‡ä»¶çš„Term Countä¸º<strong><em>K</em></strong>ï¼Œé‚£ä¹ˆæ­¤æœç´¢ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦å°†ä¸º<code>O(N*K)</code>ï¼Œéšç€Nå’ŒKçš„å¢é•¿ï¼Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦æ— ç–‘æ˜¯ç¾éš¾æ€§çš„ã€‚</p><p>ä¹Ÿè®¸æœ‰äººä¼šè¯´ï¼Œæ—¢ç„¶æ¯ä¸ªæ–‡ä»¶æ˜¯ç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†ç›®å½•ä¸‹çš„æ•°æ®æ–‡ä»¶è¿›è¡Œ<strong><em>â€œPartitionâ€</em></strong>ï¼Œåˆ†æˆ<code>M</code>å—ï¼Œæ¯ä¸€å—åŒ…å«<code>N/M</code>ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶å¯åŠ¨<code>M</code>ä¸ªçº¿ç¨‹ç‹¬ç«‹è´Ÿè´£æœç´¢è‡ªå·±å—å†…çš„æ–‡ä»¶ï¼Œä¸å°±èƒ½å¤Ÿå¤§å¹…æé«˜é€Ÿåº¦ï¼Œè§£å†³æœç´¢çš„æ€§èƒ½é—®é¢˜äº†å—ï¼Ÿå…ˆæ’‡å¼€ç¡¬ç›˜çš„I/Oæ€§èƒ½ä¸è°ˆï¼Œ<strong>å¯åŠ¨ã€ååŒ<code>M</code>ä¸ªçº¿ç¨‹ï¼Œåˆå¹¶å¤šä¸ªçº¿ç¨‹çš„è®¡ç®—ç»“æœæ‰€éœ€è¦çš„ç³»ç»Ÿå¼€é”€å°†ä¼šæ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—</strong>ï¼Œå¾ˆæœ‰å¯èƒ½å°±å› ä¸ºè¿™ä¸ªæœç´¢ä»»åŠ¡å¯¼è‡´æ•´ä¸ªèŠ‚ç‚¹å´©æºƒã€‚å†è€…ï¼Œå½“ç³»ç»Ÿçš„ç”¨æˆ·æ•°å¿«é€Ÿå¢é•¿ï¼ŒåŒæ—¶æ‰§è¡Œå¤šä¸ªç”¨æˆ·çš„æœç´¢è¯·æ±‚æ—¶æ ¹æœ¬æ— æ³•ä¿è¯æœç´¢çš„åŠæ—¶æ€§ï¼Œéš¾ä»¥å¹¶å‘ã€‚</p><p>æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦è½¬å˜æ€è·¯ï¼Œ<strong>ä¸è¦å‚»å‚»åœ°æŠŠçœŸæ­£çš„â€œæœç´¢â€æ”¾åœ¨ç”¨æˆ·å‘é€æœç´¢è¯·æ±‚æ—¶æ‰§è¡Œ</strong>ï¼Œè€Œåº”è¯¥æ—©æ—©åœ°ä¸ºæ•°æ®æ–‡ä»¶é‡Œçš„æ¯ä¸ª<strong><em>æ•°æ®é¡¹ï¼ˆTermï¼‰</em></strong>å»ºç«‹èµ·<strong><em>ç´¢å¼•ï¼ˆTerm Indexï¼‰</em></strong>ï¼Œåˆ°ç”¨æˆ·éœ€è¦æœç´¢æ—¶å°±å¯ä»¥é€šè¿‡å·²å»ºç«‹å¥½çš„ç´¢å¼•å¿«é€Ÿå®šä½å¹¶è¿”å›ç»“æœï¼Œä¸éœ€è¦ä¸€æ¬¡åˆä¸€æ¬¡åœ°æ‰«æç£ç›˜æ–‡ä»¶ã€‚</p><p><strong><em>å€’æ’ç´¢å¼•ï¼ˆInverted Index)</em></strong>è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯åŸºäºä»¥ä¸Šéœ€æ±‚è€Œæ¥åˆ°äº†è¿™ä¸ªä¸–ç•Œä¸Šçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€ååº”ä¸‹çš„ç´¢å¼•åº”è¯¥æ˜¯ä»¥ä¸‹ç»“æ„</span><br><span class="line">DocumentIDTerms</span><br><span class="line">A  [My, name, is, superman]</span><br><span class="line">B  [I, love, my, cat, whose, name, is, Kitty]</span><br><span class="line">C  [Please, name, my, car]</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä»¥ä¸Šçš„ç»“æ„å»ºç«‹ç´¢å¼•ï¼Œä»éœ€è¦é€ä¸ªIDæ‰«æå…¶å¯¹åº”çš„Termsï¼Œæœç´¢çš„æ—¶é—´å¤æ‚åº¦ä»ç„¶æ˜¯<code>O(N*K)</code>ï¼Œå‹æ ¹æ²¡æœ‰æå‡ä»»ä½•æ€§èƒ½ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡â€œå€’æ’â€çš„æ–¹å¼æ”¹å˜ç´¢å¼•ç»“æ„</span><br><span class="line">TermDocumentIDs</span><br><span class="line">My[A, B, C]</span><br><span class="line">name[A, B, C]</span><br><span class="line">is[A, B]</span><br><span class="line">superman[A]</span><br><span class="line">I[B]</span><br><span class="line">love[B]</span><br><span class="line">cat[B]</span><br><span class="line">whose[B]</span><br><span class="line">Kitty[B]</span><br><span class="line">Please[C]</span><br><span class="line">car[C]</span><br></pre></td></tr></table></figure><p>æ‰€è°“â€œå€’æ’â€ï¼Œæ— éå°±æ˜¯å°†åŸæ¥çš„<strong><em>Key</em></strong>ï¼ˆ<code>DocuementID</code>ï¼‰å’Œ<strong><em>Value</em></strong>ï¼ˆ<code>Terms</code>ï¼‰é¢ å€’è¿‡æ¥ï¼Œç”¨<code>Term</code>ä½œä¸º<strong><em>Key</em></strong>ï¼Œ<code>DocumentIDs</code>ä½œä¸º<strong><em>Value</em></strong>ã€‚é€šè¿‡æ„å»ºè¿™æ ·çš„ç´¢å¼•ç»“æ„ï¼Œå½“æˆ‘ä»¬éœ€è¦æœç´¢<code>car</code>è¿™ä¸€æ•°æ®é¡¹æ—¶ï¼Œæˆ‘ä»¬åªéœ€ä»å¤´å¼€å§‹çº¿æ€§æ‰«æ<strong>ä¸€é</strong>ç´¢å¼•è¡¨ï¼Œå®šä½åˆ°<code>car</code>é‚£ä¸€è¡Œå¹¶ç›´æ¥å–å‡ºå…¶å¯¹åº”çš„<code>DocumentIDs</code>ï¼Œå•æ¬¡æœç´¢çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†<code>O(N)</code>ã€‚</p><p>å½“ç„¶åœ¨æ•°æ®é‡ç‰¹åˆ«å¤§æ—¶ï¼Œ<code>O(N)</code>ä»ç„¶ä¸æ˜¯ä¸€ä¸ªç†æƒ³çš„æŒ‡æ ‡ï¼Œä»ç„¶æœ‰è¿›æ­¥çš„ç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ª<code>Term</code>è¿›è¡ŒHashå¾—åˆ°<code>h = Hash(Term)</code>ï¼Œç„¶åè®°å½•<code>h</code>ä¸è¡Œå·çš„æ˜ å°„è¡¨<code>H_TABLE</code>ã€‚é‚£ä¹ˆæ¯æ¬¡æœç´¢æ—¶æ ¹æ®æœç´¢é¡¹çš„Hashå¯ä»¥æŸ¥<code>H_TABLE</code>å¿«é€Ÿå®šä½åˆ°å…·ä½“çš„æŸä¸€è¡Œï¼Œç›´æ¥å°±å¯å–å‡ºå…¶å¯¹åº”çš„<code>DocumentIDs</code>ï¼Œæ€»çš„æ—¶é—´å¤æ‚åº¦ç†è®ºä¸Šæ˜¯<code>O(1)</code>ã€‚<strong>ï¼ˆå…³äºHashå†²çªä¸ä¼˜åŒ–çš„é—®é¢˜æœ¬æ–‡æš‚æ—¶ä¸äºˆæ¢è®¨ï¼‰</strong></p><h2 id="å®ç°æ–¹æ¡ˆï¼šWordCount-Againï¼Ÿ"><a href="#å®ç°æ–¹æ¡ˆï¼šWordCount-Againï¼Ÿ" class="headerlink" title="å®ç°æ–¹æ¡ˆï¼šWordCount Againï¼Ÿ"></a>å®ç°æ–¹æ¡ˆï¼šWordCount Againï¼Ÿ</h2><p>å½“ç³»ç»Ÿä¸­æœ‰æµ·é‡çš„æ•°æ®æ–‡ä»¶æ—¶ï¼Œç¬¬ä¸€ååº”è‚¯å®šå°±æ˜¯ä½¿ç”¨Hadoopä»¥åŠHadoopç”Ÿæ€ä¸­çš„å·¥å…·å¸®åŠ©æˆ‘ä»¬å¤„ç†æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç”¨Map-Reduceæ¥æ„å»ºå€’æ’ç´¢å¼•è¡¨å‘¢ï¼Ÿ</p><p><strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œç¡®å®å¯ä»¥ä½¿ç”¨Map-Reduceã€‚è€Œä¸”ä»”ç»†ä¸€æƒ³ï¼Œè¿™ä¸å°±æ˜¯Hadoopä¸­çš„â€œHelloWorldâ€â€”â€”WordCountçš„ç¿»ç‰ˆå—ï¼Ÿï¼Ÿï¼Ÿ</strong>ç¡®å®ä¹Ÿå¯ä»¥è¿™ä¹ˆè¯´ï¼Œå¤„ç†é€»è¾‘è·ŸWordCountéå¸¸ç±»ä¼¼ï¼Œåªæ˜¯æˆ‘ä»¬éœ€è¦åœ¨Reducerä¸­ç¨å¾®å¤šåšä¸€ç‚¹ç‚¹å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ç§°ä¹‹ä¸º<strong><em>å‡çº§ç‰ˆWordCount</em></strong>å“ˆå“ˆğŸ˜„ğŸ˜„ğŸ˜„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// å¦‚æœ100%ç…§æ¬WordCountçš„é€»è¾‘ï¼Œé‚£ä¹ˆæœ€ç»ˆäº§å‡ºçš„ç»“æœæ–‡ä»¶ä¼šæ˜¯</span><br><span class="line">MyA</span><br><span class="line">MyB</span><br><span class="line">MyC</span><br><span class="line">nameA</span><br><span class="line">nameB</span><br><span class="line">nameC</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æˆ‘ä»¬æƒ³è¦çš„å€’æ’è¡¨æ ¼å¼æ˜¯éœ€è¦æŠŠåŒä¸€ä¸ª<code>Term</code>ä¸‹çš„æ‰€æœ‰<code>DocumentID</code>åˆå¹¶åˆ°ä¸€è¡Œé‡Œã€‚æ‰€ä»¥ä¸ºäº†æ•°æ®æ ¼å¼çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¾“å‡ºåšç‚¹å°å¤„ç†ã€‚äºæ˜¯æˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>DocumentBean</code>ç±»ï¼Œé€»è¾‘ä¸Šå¯ä»¥ç®€å•çœ‹ä½œ<code>DocumentBean = List&lt;DocumentID&gt;</code>ã€‚<strong>æœ€ç»ˆæˆ‘ä»¬éœ€è¦é€šè¿‡Reducerè¾“å‡º<code>&lt;Term, DocumentBean&gt;</code></strong>ï¼Œé‚£ä¹ˆç»“æœé‡Œçš„æ¯ä¸€è¡Œè‡ªç„¶å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼äº†ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é›†æˆå¤šä¸ªDocumentIDçš„Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DocumentBean</span> <span class="keyword">implements</span> <span class="title">Writable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> documentCount;</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; documentIDs;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DocumentBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">documentCount = <span class="number">0</span>;</span><br><span class="line">documentIDs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterable&lt;Text&gt; documentIDs)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.documentIDs.clear();</span><br><span class="line"><span class="keyword">for</span>(Text documentID : documentIDs) &#123;</span><br><span class="line"><span class="keyword">this</span>.documentIDs.add(documentID.toString());</span><br><span class="line">&#125;</span><br><span class="line">documentCount = <span class="keyword">this</span>.documentIDs.size();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">dataOutput.writeInt(documentCount);</span><br><span class="line"><span class="keyword">for</span>(String documentID : documentIDs) &#123;</span><br><span class="line">dataOutput.writeUTF(documentID);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">documentCount = dataInput.readInt();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; documentCount;i++) &#123;</span><br><span class="line">documentIDs.add(dataInput.readUTF());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span>(String documentID : documentIDs) &#123;</span><br><span class="line">sb.append(documentID).append(<span class="string">", "</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sb.substring(<span class="number">0</span>, sb.length() - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å€’æ’ç´¢å¼•çš„Mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvertedMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Text outputKey = <span class="keyword">new</span> Text();</span><br><span class="line"><span class="keyword">private</span> Text outputValue = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">FileSplit split = (FileSplit) context.getInputSplit();</span><br><span class="line">String fileName = split.getPath().getName();</span><br><span class="line">outputValue.set(fileName);</span><br><span class="line"></span><br><span class="line">String line = value.toString();</span><br><span class="line">String[] terms = line.split(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">for</span>(String term : terms) &#123;</span><br><span class="line">outputKey.set(term);</span><br><span class="line">context.write(outputKey, outputValue);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å€’æ’ç´¢å¼•çš„Reducer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvertedReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">DocumentBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DocumentBean outputValue = <span class="keyword">new</span> DocumentBean();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">outputValue.set(values);</span><br><span class="line">context.write(key, outputValue);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvertedDriver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://localhost:9000"</span>);</span><br><span class="line"></span><br><span class="line">Job invertedJob = Job.getInstance(conf);</span><br><span class="line"></span><br><span class="line">invertedJob.setJarByClass(InvertedDriver.class);</span><br><span class="line"></span><br><span class="line">invertedJob.setMapperClass(InvertedMapper.class);</span><br><span class="line">invertedJob.setReducerClass(InvertedReducer.class);</span><br><span class="line"></span><br><span class="line">invertedJob.setMapOutputKeyClass(Text.class);</span><br><span class="line">invertedJob.setMapOutputValueClass(Text.class);</span><br><span class="line">invertedJob.setOutputKeyClass(Text.class);</span><br><span class="line">invertedJob.setOutputValueClass(DocumentBean.class);</span><br><span class="line"></span><br><span class="line">FileInputFormat.setInputPaths(invertedJob, <span class="keyword">new</span> Path(<span class="string">"/inverted_index/data/"</span>));</span><br><span class="line">FileOutputFormat.setOutputPath(invertedJob, <span class="keyword">new</span> Path(<span class="string">"/inverted_index/output/"</span>));</span><br><span class="line"></span><br><span class="line">System.exit(invertedJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“ï¼šWhat-Should-Be-Remembered"><a href="#æ€»ç»“ï¼šWhat-Should-Be-Remembered" class="headerlink" title="æ€»ç»“ï¼šWhat Should Be Remembered"></a>æ€»ç»“ï¼šWhat Should Be Remembered</h2><ul><li>åˆ©ç”¨è‡ªå®šä¹‰çš„<strong><code>Bean</code></strong>ç±»æ¥è¾…ä½Map-Reduceï¼Œå®ç°å„ç§å¤æ‚åŠŸèƒ½çš„æ€è·¯å·²ç»å¾ˆæ™®éäº†ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è¾“å‡ºè¾“å‡ºæ ¼å¼ï¼å®ç°ä¸¤è¡¨joinï¼äºŒæ¬¡æ’åºç­‰ç­‰ç­‰ç­‰ã€‚</li></ul><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/invertedIndex.png" alt=""></p><ul><li><strong>å€’æ’ç´¢å¼•è¡¨çš„è®¾è®¡ä¸ä¼˜åŒ–å…¶å®å¾ˆå¤æ‚ï¼Œæœ¬æ–‡è°ˆåˆ°çš„å†…å®¹åªæ˜¯ç®¡ä¸­çª¥è±¹</strong>ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨å€’æ’ç´¢å¼•è¡¨ä¸­ç”šè‡³å¯ä»¥å­˜å‚¨æ¯ä¸ªTermåœ¨ä¸åŒæ–‡ä»¶ä¸­çš„å‡ºç°æ¬¡æ•°ï¼æ–‡ä»¶æ›´æ–°ï¼ˆæ’å…¥ï¼‰æ—¶é—´ï¼Termçš„TF-IDFå€¼ç­‰ç­‰ç­‰ç­‰ã€‚é€šè¿‡å­˜å‚¨è¿™äº›æ–‡æœ¬æ•°æ®å¯ä»¥å¸®åŠ©æ­å»ºé«˜æ•ˆçš„æ¨èç³»ç»Ÿï¼Œæˆ–è€…å¯¹æœç´¢æ’åºè¿›è¡Œä¼˜åŒ–ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> bigdata </tag>
            
            <tag> hadoop </tag>
            
            <tag> mapreduce </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>æµ·é‡å°æ–‡ä»¶ä¼˜åŒ–ä¹‹è‡ªå®šä¹‰InputFormat</title>
      <link href="/2018/02/17/customizeinputformat/"/>
      <url>/2018/02/17/customizeinputformat/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>HDFSä½œä¸ºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œæå…¶é€‚ç”¨äºæµ·é‡å¤§æ–‡ä»¶çš„å­˜å‚¨åœºæ™¯ã€‚æ¯ä¸ªå¤§æ–‡ä»¶åœ¨ç³»ç»Ÿåº•å±‚ä¼šè¢«åˆ‡åˆ†æˆå¤šä¸ª<strong><em>Block</em></strong>ï¼ˆBlock Sizeé»˜è®¤ä¸º128MBï¼‰ï¼Œä¸”æ¯ä¸ªBlockä¼šè‡ªåŠ¨è¢«å†—ä½™å¤„ç†ï¼ˆé»˜è®¤å¤‡ä»½æ•°ä¸º3ä»½ï¼‰ä»¥ä¿è¯ä¸€å®šç¨‹åº¦ä¸Šçš„æ•°æ®å®‰å…¨ã€‚</p><p>HDFSå¯¹å¤§æ–‡ä»¶å‹å¥½ï¼Œä½†æ˜¯ä¸–äº‹å¾€å¾€ä¸å°½å¦‚äººæ„ã€‚â€œå­˜å‚¨â€å¯¹äºæ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿè€Œè¨€åªæ˜¯å…¶ä¸­ä¸€ç¯ï¼Œåœ¨å­˜å‚¨ä¹‹å‰å¿…é¡»å…ˆæœ‰æ•°æ®æ”¶é›†çš„æµç¨‹ã€‚å‡å¦‚å‰ç«¯è¿›è¡Œæ•°æ®æ”¶é›†æ—¶raw dataä¸ºæµ·é‡çš„å°æ•°æ®æ–‡ä»¶ï¼ˆä»1KBåˆ°10MBä¸ç­‰ï¼‰ï¼Œä¸”æ²¡æœ‰ç»è¿‡åˆå¹¶å°±ç›´æ¥é€šè¿‡HDFSçš„ä¸Šä¼ APIå†™åˆ°HDFSä¸­ï¼Œé‚£ä¹ˆNameNodeä¸Šå°±ä¼šä¿å­˜å¤§é‡çš„Blockå…ƒæ•°æ®è®°å½•ï¼ˆ<strong>å³ä½¿å•ä¸ªå°æ–‡ä»¶çš„å¤§å°è¿œè¿œä¸åˆ°ä¸€ä¸ªBlockçš„å®¹é‡ï¼Œä½†åœ¨é€»è¾‘ä¸Šä¹Ÿä¼šè¢«åˆ‡åˆ†ä¸ºä¸€ä¸ªBlockï¼Œè™½ç„¶ç‰©ç†ä¸Šå¹¶æ²¡æœ‰å ç”¨ä¸€ä¸ªçœŸæ­£çš„Blockçš„ç‰©ç†å®¹é‡</strong>ï¼‰ã€‚</p><p>ç›¸æ¯”NameNodeä¸­å­˜å‚¨å¤§é‡Blockå…ƒæ•°æ®å¸¦æ¥çš„å½±å“ï¼Œæ›´å€¼å¾—å…³æ³¨çš„æ˜¯<strong>æµ·é‡å°æ–‡ä»¶è¾“å…¥å¯¹Map-Reduceä»»åŠ¡çš„å½±å“</strong>ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/normalMap.png" alt="ç†æƒ³æƒ…å†µ"></p><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œå‡è®¾Map-Reduceä»»åŠ¡çš„æ–‡ä»¶è¾“å…¥æ˜¯/xx/xx/xx.datï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å‡è®¾xx.datæ–‡ä»¶çš„å¤§å°åˆšå¥½æ˜¯3ä¸ªBlockçš„å¤§å°ï¼ˆ3 * 128MBï¼‰ï¼Œæš‚ä¸”å¿½ç•¥å¤‡ä»½æƒ…å†µã€‚å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ä»¥è¯¥æ–‡ä»¶ä½œä¸ºè¾“å…¥å¯åŠ¨Map-Reduceä»»åŠ¡æ—¶ï¼Œç³»ç»ŸgetSplit()è‡ªç„¶è€Œç„¶åœ°å°†è¯¥æ–‡ä»¶åˆ†æˆ3ä¸ªSplitï¼Œå®šä½åˆ°å„Splitæ‰€åœ¨çš„DataNodeå¹¶åœ¨ä¸Šé¢å¯åŠ¨Mapä»»åŠ¡ã€‚3ä¸ªMapä»»åŠ¡å„è‡ªå¤„ç†Local Dataï¼ˆHadoopæå€¡çš„Data Localityï¼‰ï¼Œç„¶åMapç«¯è¾“å‡ºä¼šè¢«ç›¸åº”çš„Reduceræ‹‰å–è¿›è¡ŒReduceæ“ä½œã€‚åœ¨ä»¥ä¸Šç†æƒ³æƒ…å†µä¸­ï¼Œå„ä¸ªMapä»»åŠ¡è´Ÿè½½åŸºæœ¬å‡è¡¡ï¼Œæ¯ä¸ªMapå¤„ç†çš„éƒ½æ˜¯æœ¬åœ°128MBçš„æ•°æ®ï¼Œç³»ç»Ÿè¿è¡ŒçŠ¶æ€è‰¯å¥½ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/abnormalMap.png" alt="æµ·é‡å°æ–‡ä»¶"></p><p>ç„¶è€Œï¼Œå¦‚æœMapç«¯è¾“å…¥ä¸ºæµ·é‡çš„å°æ–‡ä»¶ï¼Œé‚£ä¹ˆé»˜è®¤æ¯ä¸ªå°æ–‡ä»¶æœ¬èº«å°±ä¼šè¢«å½“ä½œä¸€ä¸ªSplitï¼ˆå°åˆ°ä¸å¯å†åˆ’åˆ†äº†ï¼‰ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡å¦‚ç³»ç»Ÿä¸­å°æ–‡ä»¶çš„åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€ï¼Œåœ¨æ¯ä¸ªå­˜æ”¾æœ‰å°æ–‡ä»¶çš„DataNodeä¸Šéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªMapä»»åŠ¡ã€‚ä½†æ˜¯å‡å¦‚å°æ–‡ä»¶çš„æ•°ç›®è¿œè¿œå¤§äºç³»ç»Ÿä¸­DataNodeçš„ä¸ªæ•°ï¼ˆ100ä¸‡ä¸ªå°æ–‡ä»¶ï¼Œ100ä¸ªDataNodeï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªDataNodeä¸Šå¯èƒ½å­˜æ”¾æœ‰Nä¸ªå°æ–‡ä»¶æ—¶ï¼Œé‚£ä¹ˆDataNodeå°±è¦ä¸æ–­å¯åŠ¨ä¸€ä¸ªåˆä¸€ä¸ªçš„Mapä»»åŠ¡ç›´åˆ°Nä¸ªå°æ–‡ä»¶éƒ½è¢«å¤„ç†å®Œã€‚æ›´æç«¯çš„æƒ…å†µæ˜¯<strong>å°æ–‡ä»¶åˆ†å¸ƒä¸å‡åŒ€ï¼Œåœ¨æŸä¸ªç‰¹å®šçš„DataNodeä¸Šå­˜æ”¾äº†80%çš„å°æ–‡ä»¶ï¼Œå‰©ä½™DataNodeä¸Šåªå­˜æ”¾äº†20%çš„å°æ–‡ä»¶</strong>ï¼Œé‚£ä¹ˆå…¶ä»–DataNodeåœ¨ç»“æŸè‡ªå·±æœ¬åœ°çš„è®¡ç®—åï¼Œè¿˜å¾—â€œé»˜é»˜ç­‰å¾…â€é‚£ä¸ªå­˜æ”¾äº†80%å°æ–‡ä»¶çš„DataNodeå®Œæˆå®ƒçš„æ‰€æœ‰mapå·¥ä½œï¼Œä¸¥é‡å½±å“äº†æ•´ä¸ªMap-Reduceä»»åŠ¡çš„æ•ˆç‡ã€‚</p><p>æ‰€ä»¥å¯¹äºæµ·é‡å°æ–‡ä»¶æ•°æ®ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨Map-Reduceä»»åŠ¡å‰å¿…é¡»å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œå¸¸è§çš„ä¼˜åŒ–æ€è·¯æœ‰</p><ol><li>åœ¨ç³»ç»Ÿå‰æ²¿å°±æŠŠå¤šä¸ªå°æ–‡ä»¶åˆå¹¶ï¼Œå°†åˆå¹¶åçš„å¤§æ–‡ä»¶å†™å…¥HDFS</li><li>å°æ–‡ä»¶å·²å¤§é‡åˆ†å¸ƒåœ¨HDFSä¸­ï¼Œé€šè¿‡ä¸€å®šæ‰‹æ®µåœ¨HDFSä¸­åˆå¹¶å®ƒä»¬</li><li>åœ¨å¯åŠ¨æ­£å¼çš„Map-Reduceä»»åŠ¡å‰ï¼Œå…ˆé¢„å¤„ç†åˆå¹¶å¤§é‡å°æ–‡ä»¶</li></ol><p>å…¶ä¸­<strong><em>æ€è·¯1</em></strong>çš„é€»è¾‘æ— å…³HDFSï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ã€‚<strong><em>æ€è·¯2ä¸æ€è·¯3æœ¬è´¨ä¸Šä¸€æ ·</em></strong>ï¼Œæ˜¯é€šè¿‡ä¸€å®šçš„æ‰‹æ®µè®©å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶ï¼Œä»¥å¤§æ–‡ä»¶ä½œä¸ºæ­£å¼çš„Map-Reduceä»»åŠ¡çš„æ•°æ®è¾“å…¥ã€‚</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/TextInputFormat.png" alt="Hadoopæºç "><br>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMap-Reduceä½¿ç”¨çš„é»˜è®¤è¾“å…¥æ ¼å¼ï¼ˆInputFormatï¼‰æ˜¯<strong><em>TextInputFormat</em></strong>ï¼Œé€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥<strong><em>TextInputFormat</em></strong>å®ç°çš„æ³›å‹æ˜¯<strong><em>\&lt;LongWritable, Text></em></strong>ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬Mapä»»åŠ¡çš„è¾“å…¥æ˜¯<strong><em>\&lt;LongWritable, Text></em></strong>ã€‚</p><p>è°ƒç”¨getRecordReaderæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªçœŸæ­£çš„<strong><em>RecordReader\&lt;LongWritable, Text></em></strong>å¯¹è±¡ï¼ˆå®ç°äº†å…·ä½“è¯»æ–‡ä»¶çš„é€»è¾‘ï¼‰ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚æ¯æ¬¡æˆ‘ä»¬æŠŠMap-Reduceçš„ä½œä¸šæäº¤ä¹‹åï¼Œç³»ç»Ÿä¼šæ ¹æ®è®¾å®šçš„InputFormatï¼ˆé»˜è®¤/è‡ªå®šä¹‰ï¼‰å»ºç«‹ä¸€ä¸ªRecordReaderå¯¹è±¡æ¥è¯»å–Splitï¼Œå¹¶æŒ‰ç…§ä¸€å®šæ ¼å¼å¯¹Splitè¿›è¡Œé¢„å¤„ç†ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œé»˜è®¤çš„RecordReaderä¸º<strong><em>LineRecordReader</em></strong>ï¼Œä¹Ÿå°±æ˜¯æŒ‰è¡Œè¯»å–Splitä¸­çš„æ•°æ®å†…å®¹ï¼Œæ¯è¯»å–ä¸€è¡Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª<strong><em>\&lt;LongWritable, Text></em></strong>ï¼ˆè¡Œèµ·å§‹åç§»é‡, æ–‡æœ¬å†…å®¹)çš„K-Vå¯¹ã€‚åˆ©ç”¨RecordReaderä¸æ–­åœ°è¯»å–ï¼Œå°±å¯ä»¥å®Œæˆmapç«¯çš„è¾“å…¥ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/mergeProcess.png" alt="åˆå¹¶è¿‡ç¨‹ç¤ºæ„å›¾"><br>åŸºäºä»¥ä¸ŠåŸç†ï¼Œå®ç°å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶çš„é€»è¾‘å…¶å®å¾ˆç®€å•ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå®šä¹‰InputFormatï¼Œå¯¹æ¯ä¸ªå°æ–‡ä»¶ä¸å†é€è¡Œè¯»å–ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå°æ–‡ä»¶çš„å†…å®¹å…¨éƒ¨è¯»å–ä»¥ç”Ÿæˆ<strong><em>\&lt;å°æ–‡ä»¶å, æ–‡ä»¶å…¨éƒ¨å†…å®¹></em></strong>çš„K-Vå¯¹ï¼Œç„¶åå°†Nä¸ªå°æ–‡ä»¶çš„Nä¸ªK-Vå¯¹é€šè¿‡<strong><em>1ä¸ªReducer</em></strong>æœ€ç»ˆåˆå¹¶æˆä¸€ä¸ªå¤§æ–‡ä»¶(<strong>æœ¬ä¾‹ä½¿ç”¨SequenceFile</strong>)ã€‚</p><p><strong>æ‰€ä»¥ï¼Œå…³é”®å°±åœ¨äºå®ç°è‡ªå®šä¹‰çš„InputFormatç±»ä¸è‡ªå®šä¹‰çš„RecordReaderç±»ã€‚</strong></p><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><h4 id="ç®€è¦åŸç†"><a href="#ç®€è¦åŸç†" class="headerlink" title="ç®€è¦åŸç†"></a>ç®€è¦åŸç†</h4><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/relations.png" alt="åˆå¹¶è¿‡ç¨‹ç¤ºæ„å›¾"><br>ç½‘ä¸Šçš„å„ç§è‡ªå®šä¹‰InputFormatæ•™ç¨‹ä¸­æ€»æ˜¯å…ˆè´´ä¸€å¤§æ®µä»£ç ï¼Œè®©äººå¾ˆéš¾ä¸€ä¸‹å­ææ¸…æ¥šInputFormatã€RecordReaderå’ŒMap-Reduceä»»åŠ¡çš„å…³ç³»ã€‚ç®€å•æ¥è¯´ï¼ŒInputFormatå’ŒRecordReaderçš„åŠŸèƒ½å¦‚ä¸‹</p><ul><li><strong>è‡ªå®šä¹‰çš„InputFormatä¸ºæœ¬æ¬¡Map-Reduceä»»åŠ¡æä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReader</strong></li><li><strong>è‡ªå®šä¹‰çš„RecordReaderå®ç°å…·ä½“çš„å¦‚ä½•ä»Splitä¸­è¯»å–æ•°æ®çš„é€»è¾‘</strong></li></ul><h4 id="Javaä»£ç "><a href="#Javaä»£ç " class="headerlink" title="Javaä»£ç "></a>Javaä»£ç </h4><p>é¦–å…ˆå®ç°è‡ªå®šä¹‰çš„RecordReaderç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰çš„RecordReader, ç”¨äºå°†Splitä¸­çš„å†…å®¹è½¬æ¢ä¸ºè‡ªå®šä¹‰çš„K-Vå¯¹å½¢å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRecordReader</span> <span class="keyword">extends</span> <span class="title">RecordReader</span>&lt;<span class="title">Text</span>, <span class="title">BytesWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> FileSplit split;<span class="comment">// è¯»å…¥çš„æ–‡ä»¶split</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isFinished;<span class="comment">// è½¬æ¢æ˜¯å¦å®Œæˆçš„æ ‡å¿—ä½</span></span><br><span class="line"><span class="keyword">private</span> Text key;<span class="comment">// è¾“å‡ºKey</span></span><br><span class="line"><span class="keyword">private</span> BytesWritable value;<span class="comment">// è¾“å‡ºValue</span></span><br><span class="line"><span class="keyword">private</span> JobContext context;<span class="comment">// ä½œä¸šå†…å®¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–RecordReaderæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inputSplit è¯»å…¥çš„æ–‡ä»¶split</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> taskAttemptContext ä½œä¸šå†…å®¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(InputSplit inputSplit, TaskAttemptContext taskAttemptContext)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.isFinished = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">this</span>.key = <span class="keyword">new</span> Text();</span><br><span class="line"><span class="keyword">this</span>.value = <span class="keyword">new</span> BytesWritable();</span><br><span class="line"><span class="keyword">this</span>.split = (FileSplit) inputSplit;</span><br><span class="line"><span class="keyword">this</span>.context = taskAttemptContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘Šè¯‰è°ƒç”¨è€…æ˜¯å¦è¿˜æœ‰æœªè¯»çš„ä¸‹ä¸€ä¸ªK-Vå¯¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true / false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKeyValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!isFinished) &#123;</span><br><span class="line"></span><br><span class="line">String fileName = <span class="keyword">this</span>.split.getPath().getName();</span><br><span class="line"><span class="keyword">this</span>.key.set(fileName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> contentLength = (<span class="keyword">int</span>)split.getLength();</span><br><span class="line"><span class="keyword">byte</span>[] content = <span class="keyword">new</span> <span class="keyword">byte</span>[contentLength];</span><br><span class="line">FileSystem fs = FileSystem.get(context.getConfiguration());</span><br><span class="line">FSDataInputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">inputStream = fs.open(<span class="keyword">this</span>.split.getPath());</span><br><span class="line">IOUtils.readFully(inputStream, content, <span class="number">0</span>, contentLength);</span><br><span class="line">value.set(content, <span class="number">0</span>, contentLength);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span>(inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">IOUtils.closeStream(inputStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">isFinished = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›å½“å‰è¯»åˆ°çš„Key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Text <span class="title">getCurrentKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›å½“å‰è¯»åˆ°çš„Value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BytesWritable <span class="title">getCurrentValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›è½¬æ¢è¿‡ç¨‹çš„çŠ¶æ€ (æ˜¯å¦è½¬æ¢å®Œæˆ)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true / false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getProgress</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.isFinished ? <span class="number">1.0f</span> : <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå®ç°è‡ªå®šä¹‰çš„InputFormatç±»ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰InputFormat, åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReader(ä»¥å®ç°è‡ªå®šä¹‰çš„è¯»å–è¾“å…¥æ–‡ä»¶é€»è¾‘)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInputFormat</span> <span class="keyword">extends</span> <span class="title">FileInputFormat</span>&lt;<span class="title">Text</span>, <span class="title">BytesWritable</span>&gt;</span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RecordReader&lt;Text, BytesWritable&gt; <span class="title">createRecordReader</span><span class="params">(InputSplit inputSplit,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                TaskAttemptContext taskAttemptContext)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªè‡ªå®šä¹‰çš„RecordReaderå¹¶è¿”å›</span></span><br><span class="line">RecordReader&lt;Text, BytesWritable&gt; recordReader = <span class="keyword">new</span> MyRecordReader();</span><br><span class="line">recordReader.initialize(inputSplit, taskAttemptContext);</span><br><span class="line"><span class="keyword">return</span> recordReader;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°äº†è‡ªå®šä¹‰çš„<strong><em>MyInputFormat</em></strong>ç±»å’Œ<strong><em>MyRecordReader</em></strong>ç±»åï¼ŒMapperå’ŒReducerå¹¶æ²¡æœ‰ä»€ä¹ˆå¯åšçš„ï¼Œmapç«¯åªæ˜¯ç®€å•åœ°å°†æ•°æ®è¾“å…¥ç›´æ¥è¾“å‡ºï¼Œreduceç«¯æ”¶é›†åˆ°K-Vå¯¹åå°†å…¶ç›´æ¥è¾“å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapper, è´Ÿè´£å¤„ç†ä»Splitä¸­è¯»å–çš„K-Vå‹æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Text</span>, <span class="title">BytesWritable</span>, <span class="title">Text</span>, <span class="title">BytesWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Text key, BytesWritable value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">context.write(key, value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reducer, è´Ÿè´£æ¥æ”¶K-Vå¯¹åè¾“å‡ºä¸ºç»“æœæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">BytesWritable</span>, <span class="title">Text</span>, <span class="title">BytesWritable</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;BytesWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"><span class="keyword">for</span>(BytesWritable value : values) &#123;</span><br><span class="line">context.write(key, value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæŠŠJobä¿¡æ¯è®¾ç½®å¥½åå°±å¯ä»¥æäº¤åˆ°é›†ç¾¤ä¸Šè¿è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HDFS_HOST = <span class="string">"hdfs://localhost:9000"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUM_REDUCE_TASKS = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_INPUT_PATH = <span class="string">"/small_files/data"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESULT_OUTPUT_PATH = <span class="string">"/small_files/output"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">conf.set(<span class="string">"fs.defaultFS"</span>, HDFS_HOST);</span><br><span class="line">Job myJob = Job.getInstance(conf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ç±»åè®¾ç½®è¿è¡Œçš„jaråŒ…</span></span><br><span class="line">myJob.setJarByClass(Driver.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Mapper Classä¸Reducer Class</span></span><br><span class="line">myJob.setMapperClass(MyMapper.class);</span><br><span class="line">myJob.setReducerClass(MyReducer.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Mapperä¸Reducerçš„è¾“å‡ºæ•°æ®ç±»å‹</span></span><br><span class="line">myJob.setMapOutputKeyClass(Text.class);</span><br><span class="line">myJob.setMapOutputValueClass(BytesWritable.class);</span><br><span class="line">myJob.setOutputKeyClass(Text.class);</span><br><span class="line">myJob.setOutputValueClass(BytesWritable.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®InputFormatä¸OutputFormat</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„InputFormatä½œä¸ºInputæ ¼å¼, Sequenceæ–‡ä»¶ä½œä¸ºOutputæ ¼å¼</span></span><br><span class="line">myJob.setInputFormatClass(MyInputFormat.class);</span><br><span class="line">myJob.setOutputFormatClass(SequenceFileOutputFormat.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰Reduce Taskæ•°é‡, å†³å®šæœ€ç»ˆè¾“å‡ºå¤šå°‘ä¸ªç»“æœæ–‡ä»¶</span></span><br><span class="line">myJob.setNumReduceTasks(NUM_REDUCE_TASKS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ•°æ®æ‰€åœ¨ç›®å½•, ç»“æœè¾“å‡ºç›®å½•</span></span><br><span class="line">FileInputFormat.setInputPaths(myJob, <span class="keyword">new</span> Path(FILE_INPUT_PATH));</span><br><span class="line">FileOutputFormat.setOutputPath(myJob, <span class="keyword">new</span> Path(RESULT_OUTPUT_PATH));</span><br><span class="line"></span><br><span class="line">System.exit(myJob.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å½“HDFSä¸­å­˜å‚¨äº†æµ·é‡å°æ–‡ä»¶æ—¶ï¼Œåˆ©ç”¨è‡ªå®šä¹‰çš„InputFormatå’ŒRecordReaderå¯åŠ¨Map-Reduceä»»åŠ¡å¯å°†å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§æ–‡ä»¶ã€‚è¿™ä¸ªåˆå¹¶çš„Jobå¯ä»¥æ”¾åœ¨æ­£å¼çš„Map-Reduceä»»åŠ¡å‰ï¼Œåˆ©ç”¨ControlledJobå¯¹åˆå¹¶Jobä¸æ­£å¼Jobè¿›è¡Œæ§åˆ¶ï¼Œåˆå¹¶ç»“æŸåæ‰å¯åŠ¨æ­£å¼Jobï¼›ä¹Ÿå¯ä»¥å®šæ—¶åœ°å¯¹HDFSä¸Šçš„æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œé¿å…éœ€è¦ç”¨æ—¶æ‰è¿›è¡Œåˆå¹¶ã€‚</p><p><strong>å½“ç„¶ï¼Œæœ€ä¼˜æ–¹æ¡ˆè¿˜æ˜¯åœ¨ç³»ç»Ÿå‰æ²¿å°±æŠŠæ•°æ®åˆå¹¶æˆå°½é‡å¤§çš„æ–‡ä»¶ï¼Œå†æŠŠå¤§æ–‡ä»¶å†™å…¥HDFSã€‚</strong></p><h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><p>å®Œæ•´ä»£ç è¯·æŸ¥çœ‹ï¼š<br><a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/inputformat" target="_blank" rel="noopener">æˆ‘çš„Githubç›®å½•</a></p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bigdata </tag>
            
            <tag> hadoop </tag>
            
            <tag> mapreduce </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>OS Xä¸‹MapReduceç¨‹åºè¿è¡Œçš„å‡ ç§æ¨¡å¼</title>
      <link href="/2018/02/13/osxmr/"/>
      <url>/2018/02/13/osxmr/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h1 id="1-MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹"><a href="#1-MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹" class="headerlink" title="1.MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹"></a>1.MapReduceç¨‹åºè¿è¡Œçš„æ¨¡å¼ç®€ä»‹</h1><ol><li>ç¨‹åºè¿è¡Œæ¨¡å¼<ul><li>æœ¬åœ°æ¨¡å¼<ul><li>åˆ©ç”¨æœ¬åœ°çš„JVMè¿è¡Œï¼Œä½¿ç”¨æœ¬åœ°çš„IDEè¿›è¡Œdebug</li></ul></li><li>è¿œç¨‹æ¨¡å¼<ul><li>æäº¤è‡³è¿œç¨‹çš„é›†ç¾¤ä¸Šè¿è¡Œï¼Œä½¿ç”¨æœ¬åœ°çš„IDEè¿›è¡Œdebug</li><li>æäº¤è‡³è¿œç¨‹çš„é›†ç¾¤ä¸Šè¿è¡Œï¼Œä¸ä½¿ç”¨æœ¬åœ°IDEè¿›è¡Œdebug</li></ul></li></ul></li><li>æ•°æ®å­˜æ”¾è·¯å¾„<ul><li>è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿï¼ˆhdfs)</li><li>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆlocal file system)</li></ul></li></ol><h1 id="2-å¼€å‘ç¯å¢ƒç®€ä»‹"><a href="#2-å¼€å‘ç¯å¢ƒç®€ä»‹" class="headerlink" title="2.å¼€å‘ç¯å¢ƒç®€ä»‹"></a>2.å¼€å‘ç¯å¢ƒç®€ä»‹</h1><ul><li>æ“ä½œç³»ç»Ÿï¼šmacOS Sierra 10.12.6</li><li>Javaç‰ˆæœ¬ï¼š1.8.0_131-b11</li><li>Hadoopç‰ˆæœ¬ï¼šhadoop-2.7.4</li><li>IDEï¼šIntelliJ IDEA</li></ul><h1 id="3-MapReduceç¨‹åºè¿è¡Œä¾‹å­"><a href="#3-MapReduceç¨‹åºè¿è¡Œä¾‹å­" class="headerlink" title="3.MapReduceç¨‹åºè¿è¡Œä¾‹å­"></a>3.MapReduceç¨‹åºè¿è¡Œä¾‹å­</h1><h2 id="3-1-ç¨‹åºéœ€æ±‚"><a href="#3-1-ç¨‹åºéœ€æ±‚" class="headerlink" title="3.1 ç¨‹åºéœ€æ±‚"></a>3.1 ç¨‹åºéœ€æ±‚</h2><blockquote><p>å­¦æ ¡é‡Œå¼€è®¾äº†å¤šé—¨è¯¾ç¨‹ï¼Œæœ‰è¯­æ–‡ï¼ˆchineseï¼‰ã€æ•°å­¦ï¼ˆmathï¼‰ã€è‹±è¯­ï¼ˆenglishï¼‰ç­‰ã€‚ç»è¿‡äº†ä¸€æ¬¡å¹´çº§ç»Ÿè€ƒåï¼Œæ¯ä¸ªå­¦ç”Ÿçš„æˆç»©éƒ½è¢«è®°å½•åœ¨å¤šä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œæ–‡æœ¬æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ã€‚</p></blockquote><ul><li><p>math.txt</p><p>Ben 75<br>Jack 60<br>May 85<br>Tom 91</p></li></ul><ul><li><p>english.txt</p><p>Jack 72<br>May 60<br>Tom 62<br>Ben 90</p></li></ul><ul><li><p>chinese.txt</p><p>Ben 79<br>May 88<br>Tom 68<br>Jack 70</p></li></ul><blockquote><p>ç°éœ€è¦æ ¹æ®ä»¥ä¸Šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œç®—å‡ºæ¯ä¸ªå­¦ç”Ÿåœ¨æœ¬æ¬¡ç»Ÿè€ƒä¸­çš„å¹³å‡åˆ†ï¼Œå¹¶å°†ç»“æœç”¨ä¸€ä¸ªæ€»çš„æ–‡ä»¶averageScore.txtè¿›è¡Œå­˜å‚¨ã€‚averageScore.txtçš„æ ¼å¼å¦‚ä¸‹ã€‚</p></blockquote><ul><li><p>averageScore.txt</p><p>#name #score<br>Ben 0.0<br>May 0.0<br>Tom 0.0<br>Jack 0.0</p></li></ul><h2 id="3-2-ç¨‹åºè®¾è®¡æ€è·¯"><a href="#3-2-ç¨‹åºè®¾è®¡æ€è·¯" class="headerlink" title="3.2 ç¨‹åºè®¾è®¡æ€è·¯"></a>3.2 ç¨‹åºè®¾è®¡æ€è·¯</h2><h3 id="3-2-1-Mapperçš„å¤„ç†é€»è¾‘"><a href="#3-2-1-Mapperçš„å¤„ç†é€»è¾‘" class="headerlink" title="3.2.1 Mapperçš„å¤„ç†é€»è¾‘"></a>3.2.1 Mapperçš„å¤„ç†é€»è¾‘</h3><p>Mapperæ¯æ¬¡ä»æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–<strong>1è¡Œå†…å®¹</strong>ï¼Œå³è°ƒç”¨1æ¬¡mapæ–¹æ³•ã€‚Mapperéœ€è¦æŠŠåŸå§‹æ•°æ®ä¸­ä¸€è¡Œçš„å†…å®¹æ‹†åˆ†æˆå­¦ç”Ÿå§“åï¼ˆstudent nameï¼‰å’Œè¯¥é—¨è¯¾ç¨‹çš„åˆ†æ•°ï¼ˆscoreï¼‰ã€‚æŒ‰ç…§éœ€æ±‚ï¼Œæœ¬ç¨‹åºæœ€ç»ˆè¦ç®—å‡ºæ¯ä¸€ä¸ªå­¦ç”Ÿçš„å¹³å‡åˆ†ï¼Œæ‰€ä»¥å­¦ç”Ÿå§“ååº”ä½œä¸ºä¸€ä¸ªkeyï¼Œå¯¹åº”çš„valueå³ä¸ºè¯¥ç”Ÿçš„å¹³å‡åˆ†<strong><em>ï¼ˆå®é™…ä¸Šæ˜¯ä¸ä¸¥è°¨çš„ï¼Œå› ä¸ºåœ¨å®é™…ç¯å¢ƒä¸­ä¼šå‡ºç°å¤šä¸ªå­¦ç”Ÿé‡åçš„ç°è±¡ï¼Œè‹¥ä¸ä½œç‰¹æ®Šå¤„ç†ï¼Œkeyæ˜¯ä¸å…è®¸é‡å¤çš„ã€‚æœ€æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨å­¦å·ä½œä¸ºkeyï¼Œä½†ä¸ºäº†æ¼”ç¤ºç›´è§‚ï¼Œä»…é‡‡ç”¨å­¦ç”Ÿå§“åä½œä¸ºkeyï¼‰</em></strong>ã€‚ Mapperè¯»å®Œä¸€è¡Œçš„æ•°æ®åï¼ŒæŠŠ<code>{student nameï¼Œscore}</code>è¿™ä¸ª<code>key-value</code>å†™å…¥ä¸­é—´ç»“æœï¼Œå‡†å¤‡ä¼ é€ç»™Reducerä½œä¸‹ä¸€æ­¥çš„è¿ç®—ã€‚</p><h3 id="3-2-2-Reducerçš„å¤„ç†é€»è¾‘"><a href="#3-2-2-Reducerçš„å¤„ç†é€»è¾‘" class="headerlink" title="3.2.2 Reducerçš„å¤„ç†é€»è¾‘"></a>3.2.2 Reducerçš„å¤„ç†é€»è¾‘</h3><p>Reduceræ¥æ”¶åˆ°çš„æ•°æ®ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªkeyä¸è¯¥keyå¯¹åº”çš„valueçš„ä¸€ä¸ª<strong>é›†åˆ</strong>ï¼ˆå¹¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªvalueï¼‰ã€‚åœ¨æœ¬éœ€æ±‚ä¸­ï¼Œä¼ å…¥reduceæ–¹æ³•çš„å‚æ•°æ˜¯å­¦ç”Ÿå§“åï¼Œä»¥åŠè¯¥ç”Ÿå¤šé—¨è¯¾ç¨‹åˆ†æ•°çš„é›†åˆï¼Œç±»ä¼¼äº<code>Ben,[60,70,80,...]</code>ã€‚æ‰€ä»¥Reduceréœ€è¦å°†é›†åˆä¸­çš„åˆ†æ•°æ±‚å’Œï¼Œç„¶åæ±‚å‡ºå¹³å‡å€¼ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª<code>{student name, average score}</code>çš„<code>key-value</code>å¯¹ã€‚</p><h3 id="3-2-3-å…·ä½“ä»£ç è®¾è®¡"><a href="#3-2-3-å…·ä½“ä»£ç è®¾è®¡" class="headerlink" title="3.2.3 å…·ä½“ä»£ç è®¾è®¡"></a>3.2.3 å…·ä½“ä»£ç è®¾è®¡</h3><ul><li><p>AVGMapperç±»<br>ç”¨äºå®ç°mapæ–¹æ³•</p><p>package mr;</p><p>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.LongWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Mapper;<br>import java.io.IOException;</p><p>/**</p><ul><li>Created by marco on 2017/8/17.<br>*/<br>public class AVGMapper extends Mapper&lt;LongWritable, Text, Text, DoubleWritable&gt;<br>{<br> @Override<br> protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException<br> {<pre><code>String line = value.toString();if(line.length() == 0)  // æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå‡ºç°ç©ºè¡Œ    return;String[] split = line.split(&quot; &quot;);String stuName = split[0];String stuScore = split[1];double score = Double.parseDouble(stuScore);    // è½¬æˆdoubleç±»å‹ï¼Œæ–¹ä¾¿åç»­æ±‚å‡å€¼è®¡ç®—context.write(new Text(stuName), new DoubleWritable(score));</code></pre> }<br>}</li></ul></li></ul><ul><li><p>AVGReducerç±»<br>ç”¨äºå®ç°reduceæ–¹æ³•</p><p>package mr;</p><p>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Reducer;<br>import java.io.IOException;</p><p>/**</p><ul><li><p>Created by marco on 2017/8/17.<br>*/<br>public class AVGReducer extends Reducer&lt;Text, DoubleWritable, Text, DoubleWritable&gt;<br>{<br> @Override<br> protected void reduce(Text key, Iterable<doublewritable> values, Context context) throws IOException, InterruptedException<br> {</doublewritable></p><pre><code>double sum = 0;int length = 0;for(DoubleWritable value : values){    sum += value.get();    length++;}double avgScore = sum / (double)length;context.write(key, new DoubleWritable(avgScore));</code></pre><p> }<br>}</p></li></ul></li></ul><ul><li><p>AVGRunnerç±»<br>ç”¨äºå…³è”Mapperä¸Reducerï¼Œå¹¶åˆ›å»ºMapReduceä»»åŠ¡ï¼ˆJobï¼‰æäº¤è¿è¡Œã€‚åŸºæœ¬ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>package mr;</p><p>import org.apache.hadoop.conf.Configuration;<br>import org.apache.hadoop.fs.FileSystem;<br>import org.apache.hadoop.fs.Path;<br>import org.apache.hadoop.io.DoubleWritable;<br>import org.apache.hadoop.io.Text;<br>import org.apache.hadoop.mapreduce.Job;<br>import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;<br>import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</p><p>/**</p><ul><li><p>Created by marco on 2017/8/17.<br>*/<br>public class AVGRunner<br>{<br> static public void main(String[] args) throws Exception<br> {</p><pre><code>// è®¾ç½®hdfsçš„handlerConfiguration fsConf = new Configuration();fsConf.set(&quot;fs.default.name&quot;,&quot;hdfs://localhost:9000/&quot;);FileSystem fs = FileSystem.get(fsConf);// MapReduceçš„é…ç½®å‚æ•°Configuration mrConf = new Configuration();// æ–°å»ºä¸€ä¸ªæ±‚å¹³å‡å€¼çš„JobJob avgJob = Job.getInstance(mrConf);avgJob.setJarByClass(AVGRunner.class);// è®¾ç½®Mapperç±»ä¸Reducerç±»avgJob.setMapperClass(AVGMapper.class);avgJob.setReducerClass(AVGReducer.class);// è®¾ç½®è¾“å…¥è¾“å‡ºçš„æ•°æ®ç»“æ„avgJob.setMapOutputKeyClass(Text.class);avgJob.setMapOutputValueClass(DoubleWritable.class);avgJob.setOutputKeyClass(Text.class);avgJob.setOutputValueClass(DoubleWritable.class);// æ£€æŸ¥ç»“æœè¾“å‡ºç›®å½•ï¼Œè‹¥å·²å­˜åœ¨åˆ™åˆ é™¤è¾“å‡ºç›®å½•if(fs.exists(new Path(&quot;/avg/output&quot;))){    fs.delete(new Path(&quot;/avg/output&quot;), true);}// è®¾ç½®æ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));// æäº¤ä»»åŠ¡ï¼Œç­‰å¾…å®ŒæˆSystem.exit(avgJob.waitForCompletion(true)?0:1);</code></pre><p> }<br>}</p></li></ul></li></ul><h2 id="3-3-MapReduceç¨‹åºè¿è¡Œ"><a href="#3-3-MapReduceç¨‹åºè¿è¡Œ" class="headerlink" title="3.3 MapReduceç¨‹åºè¿è¡Œ"></a>3.3 MapReduceç¨‹åºè¿è¡Œ</h2><blockquote><p>è‹¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ–‡ä»¶ï¼Œä¸”åœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œæ— éœ€é…ç½®hdfsç›¸å…³çš„å‚æ•°ï¼Œæ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•å¡«å†™æœ¬åœ°è·¯å¾„å³å¯ã€‚<strong>ï¼ˆç¡®ä¿ç»“æœè¾“å‡ºæ–‡ä»¶å¤¹æœªè¢«åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ï¼‰</strong></p></blockquote><pre><code>// å‡å¡«å†™æœ¬åœ°æ–‡ä»¶è·¯å¾„å³å¯FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));</code></pre><blockquote><p>è‹¥ä½¿ç”¨hdfsä¸Šçš„æ•°æ®æ–‡ä»¶ï¼Œä¸”åœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œåº”é…ç½®hdfsç›¸å…³å‚æ•°ï¼Œæ•°æ®ç›®å½•ä»¥åŠç»“æœè¾“å‡ºç›®å½•å‡å¡«å†™hdfsçš„è·¯å¾„ã€‚<strong>ï¼ˆç¡®ä¿ç»“æœè¾“å‡ºæ–‡ä»¶å¤¹æœªè¢«åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ï¼‰</strong></p></blockquote><pre><code>// è®¾ç½®hdfså‚æ•°ï¼Œå¹¶ç”¨è¯¥é…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„JobConfiguration fsConf = new Configuration();fsConf.set(&quot;fs.default.name&quot;,&quot;hdfs://localhost:9000/&quot;);Job avgJob = Job.getInstance(fsConf);// å‡å¡«å†™hdfsè·¯å¾„å³å¯FileInputFormat.setInputPaths(avgJob, new Path(&quot;&quot;));FileOutputFormat.setOutputPath(avgJob, new Path(&quot;&quot;));</code></pre><h3 id="3-3-1-æœ¬åœ°æ¨¡å¼è¿è¡Œ"><a href="#3-3-1-æœ¬åœ°æ¨¡å¼è¿è¡Œ" class="headerlink" title="3.3.1 æœ¬åœ°æ¨¡å¼è¿è¡Œ"></a>3.3.1 æœ¬åœ°æ¨¡å¼è¿è¡Œ</h3><p>æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œç›´æ¥ç¼–è¯‘æ‰§è¡ŒAVGRunnerçš„mainæ–¹æ³•å³å¯ï¼Œç¨‹åºè¿è¡Œç»“æŸåä¼šåœ¨è‡ªè¡Œè®¾ç½®çš„ç»“æœè¾“å‡ºç›®å½•ä¸­ç”Ÿæˆè¿è¡Œç»“æœã€‚</p><h3 id="3-3-2-è¿œç¨‹é›†ç¾¤è¿è¡Œ"><a href="#3-3-2-è¿œç¨‹é›†ç¾¤è¿è¡Œ" class="headerlink" title="3.3.2 è¿œç¨‹é›†ç¾¤è¿è¡Œ"></a>3.3.2 è¿œç¨‹é›†ç¾¤è¿è¡Œ</h3><p><strong>é¦–å…ˆä½¿ç”¨IDEå°†ç¨‹åºæ‰“æˆä¸€ä¸ªjaråŒ…ï¼Œæœ¬ä¾‹ä¸­å‘½åä¸ºhadoop.jar</strong> æäº¤åˆ°è¿œç¨‹é›†ç¾¤ä¸Šè¿è¡Œåˆ†ä¸¤ç§æƒ…å†µ</p><ul><li><p>ä½¿ç”¨æœ¬åœ°IDEï¼ˆIntelliJ IDEAï¼‰è¿è¡Œï¼Œä»»åŠ¡è¢«æäº¤åˆ°é›†ç¾¤è¿è¡Œï¼Œ<strong>ä½†å¯ä½¿ç”¨IDEè¿›è¡Œè·Ÿè¸ªdebug</strong> æ–°å»ºä¸€ä¸ªMapReduceçš„é…ç½®å¯¹è±¡ï¼Œå°†å·²ç»æ‰“åŒ…å¥½çš„jaråŒ…ä¼ å…¥é…ç½®ä¸­</p><pre><code>// MapReduceçš„é…ç½®å‚æ•°ï¼Œè¿œç¨‹è¿è¡Œï¼Œæœ¬åœ°debugConfiguration mrConf = new Configuration();mrConf.set(&quot;mapreduce.job.jar&quot;,&quot;hadoop.jar&quot;);mrConf.set(&quot;mapreduce.framework.name&quot;,&quot;yarn&quot;);//åˆ©ç”¨ä»¥ä¸Šé…ç½®æ–°å»ºä¸€ä¸ªJobJob avgJob = Job.getInstance(mrConf);avgJob.setJarByClass(AVGRunner.class);</code></pre></li></ul><ul><li><p>åœ¨ç»ˆç«¯ç›´æ¥ä½¿ç”¨hadoopå‘½ä»¤å°†ä»»åŠ¡æäº¤åˆ°é›†ç¾¤è¿è¡Œï¼Œ<strong>æ— æ³•ä½¿ç”¨IDEè¿›è¡Œè·Ÿè¸ªdebug</strong> ç›´æ¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥hadoopå‘½ä»¤</p><pre><code>hadoop jar $jaråŒ…åç§° $å¾…æ‰§è¡Œçš„ç±»çš„åç§°</code></pre></li></ul><pre><code>åœ¨æœ¬ä¾‹ä¸­åº”è¾“å…¥    hadoop jar avg.jar mr.AVGRunner</code></pre><blockquote><p><strong>####################### æ³¨æ„âš ï¸ #######################</strong> åœ¨OS Xä¸­ï¼Œä½¿ç”¨IntelliJ IDEAæ‰“åŒ…jaråŒ…åï¼Œè‹¥åœ¨ç»ˆç«¯ä¸­ç›´æ¥ä½¿ç”¨<code>hadoop jar $jaråŒ…åç§° $å¾…æ‰§è¡Œçš„ç±»çš„åç§°</code>æäº¤MapReduceä»»åŠ¡ï¼Œä¼šæŠ¥å‡ºå¼‚å¸¸ï¼Œå› ä¸ºOS Xç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå¯¹å¤§å°å†™ä¸æ•æ„Ÿ<strong><em>ï¼ˆcase-insensitiveï¼‰</em></strong>ã€‚ ç»è¿‡å¯¹æ­¤å¼‚å¸¸çš„æœç´¢ï¼Œ<strong>æš‚æ—¶çš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡åˆ é™¤jaråŒ…ä¸­çš„LICENSEæ–‡ä»¶</strong>ï¼Œä½¿ä»»åŠ¡é¡ºåˆ©æäº¤ã€‚</p><pre><code># åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤  zip -d $jaråŒ…åç§° META-INF/LICENSE  zip -d $jaråŒ…åç§° LICENSE</code></pre><p><strong>#####################################################</strong></p></blockquote><p><img src="http://upload-images.jianshu.io/upload_images/7445555-d6ff47959f4616b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†hadoopå‘½ä»¤æäº¤ä»»åŠ¡åï¼Œç³»ç»Ÿè°ƒç”¨äº†RPCæ¡†æ¶å’ŒYarnæ¡†æ¶ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œç”¨äºè¿œç¨‹è¿è¡Œï¼Œè€Œéä½¿ç”¨LocalJobSubmitteräºæœ¬åœ°è¿è¡Œã€‚<br><img src="http://upload-images.jianshu.io/upload_images/7445555-4c5e6823f3ec9ade.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">å¹¶ä¸”åœ¨MapReduceä»»åŠ¡ç®¡ç†é¡µé¢å¯çœ‹åˆ°ä»»åŠ¡å·²ç»å®Œæˆçš„å†å²è®°å½•ã€‚</p><h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h1><p>MapReduceä»»åŠ¡å¯åœ¨æœ¬åœ°è¿è¡Œï¼Œä¹Ÿå¯æäº¤åˆ°é›†ç¾¤ä¸Šè¿è¡Œã€‚ åœ¨å¼€å‘åˆæœŸï¼Œéœ€è¦ç¼–å†™Demoç¨‹åºæ—¶ï¼Œå¯åœ¨æœ¬åœ°è¿›è¡Œå¼€å‘ä¸æµ‹è¯•ï¼Œå°†æ•°æ®æ–‡ä»¶æ”¾ç½®åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œç›´æ¥ä½¿ç”¨IDEè¿è¡Œä¸»ç±»çš„mainæ–¹æ³•ï¼Œè§‚å¯Ÿè¿è¡Œç»“æœã€‚ ä¸Šçº¿å‰è°ƒè¯•ï¼Œå¯é‡‡ç”¨è¿œç¨‹æ¨¡å¼è¿è¡Œï¼Œä¸ç›´æ¥ä½¿ç”¨hadoopå‘½ä»¤æäº¤ï¼Œè€Œæ˜¯ä½¿ç”¨IDEè¿›è¡Œæäº¤ä¸debugï¼Œè¿™æ ·æ—¢å¯ä»¥ä¿è¯ç¨‹åºè¿è¡Œåœ¨è¿œå¤„é›†ç¾¤ä¸Šï¼ˆç”Ÿäº§ç¯å¢ƒorå¼€å‘ç¯å¢ƒï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨æœ¬åœ°æ–¹ä¾¿è·Ÿè¸ªè°ƒè¯•ã€‚ å¯ä¸Šçº¿æ—¶ï¼Œä½¿ç”¨hadoopå‘½ä»¤ç›´æ¥æäº¤åˆ°è¿œç¨‹é›†ç¾¤ï¼Œå¹¶é€šè¿‡localhost:50070<strong>ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>çš„ä»»åŠ¡ç®¡ç†é¡µé¢è¿›è¡Œè§‚å¯Ÿã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hadoop </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å¦‚ä½•åœ¨Map-Reduceä¸­å®ç°äºŒæ¬¡æ’åºï¼ˆå¯¹Valueæ’åºï¼‰</title>
      <link href="/2018/02/13/ssort/"/>
      <url>/2018/02/13/ssort/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒMap-Reduceä»»åŠ¡å®Œæˆåï¼Œè¾“å‡ºçš„ç»“æœæ–‡ä»¶æ€»æ˜¯æŒ‰ç…§Keyè¿›è¡Œå‡åºæ’åˆ—ï¼ˆshuffleé˜¶æ®µå®Œæˆï¼‰ã€‚ ä¾‹å¦‚Hadoopé‡Œç»å…¸çš„word countç¨‹åºï¼š</p><pre><code>// File1åŸå§‹æ•°æ®helloworldhelloappleappleapplebaby// è¾“å‡ºç»“æœæ–‡ä»¶ï¼Œå·²æŒ‰Keyè¿›è¡Œå‡åºæ’åºapple 3baby 1hello 2world 1</code></pre><p>æ˜¾ç„¶ï¼Œè¿™ç§é»˜è®¤çš„æ’åºæ–¹å¼å¾ˆå¤šæ—¶å€™èƒ½å¸®å¼€å‘è€…å‡è½»è´Ÿæ‹…ï¼Œå› ä¸ºå¼€å‘è€…ä¸ç”¨å»è‡ªè¡Œå®ç°å¯¹Keyè¿›è¡Œæ’åºçš„ç®—æ³•ï¼Œæ‰€æœ‰çš„æ’åºæ“ä½œå‡ç”±Hadoopå¸®å¼€å‘è€…å®Œæˆï¼ˆè¯¦æƒ…å‚è€ƒMap-Reduceä¸­çš„shuffleåŸç†ï¼Œ<strong><em>å…·ä½“å‚è€ƒmapç«¯çš„partition-&gt;spill-&gt;(spill.sort)-&gt;(combine)è¿‡ç¨‹</em></strong>ï¼‰ã€‚ <strong>ä¸€åˆ‡ä¼¼ä¹å¾ˆç¾å¥½ï¼Œå¯æ˜¯å¦‚æœæˆ‘ä»¬é‡åˆ°äº†è¦å¯¹valueæ’åºçš„éœ€æ±‚å‘¢ï¼Ÿ</strong></p><pre><code>// å‡è®¾æœ‰å¦‚ä¸‹ç”µå½±è¯„åˆ†æ•°æ® movies.dat// ä¸”æˆ‘ä»¬å¸Œæœ›å¯¹ratingè¿›è¡Œé™åºæ’åº, ä»¥ä¾¿åˆ†ææ¯éƒ¨ç”µå½±çš„è¯„åˆ†è¶‹åŠ¿MovieID, rating  001,    75.5  001,    89  001,    60  002,    55  002,    79  003,    92.5  003,    92.8  003,    60 ......// æœŸæœ›è¾“å‡ºå€¼ï¼ˆKeyæœ‰åºçš„åŒæ—¶ï¼ŒæŒ‰ratingé™åºæ’åºï¼‰  001   89.0  001   75.5  001   60.0  002   79.0  002   55.0  003   92.8  003   92.5  003   60.0</code></pre><p>åœ¨â€œæ’åºâ€çš„éœ€æ±‚ä¸‹ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°ä¼šæƒ³åˆ°ï¼š</p><ul><li>åˆ©ç”¨ç³»ç»Ÿé»˜è®¤çš„æ’åºã€‚</li><li>é¢„å¤„ç†æ•°æ®ï¼ŒæŠŠratingå½“æˆKeyï¼ŒmovieIDå½“æˆValueã€‚</li></ul><p>è™½ç„¶æŒ‰ç…§ä»¥ä¸Šçš„æƒ³æ³•ï¼Œç¡®å®æ˜¯å¯¹ä½œä¸ºKeyçš„ratingæ’åºäº†ï¼Œä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯<strong>é™åº</strong>è¾“å‡ºè€Œéé»˜è®¤çš„å‡åºè¾“å‡ºï¼Œä¸”è¾“å‡ºæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼ˆç¬¬ä¸€åˆ—åº”ä¸ºmovieIDï¼‰ã€‚ æ­¤æ—¶ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ç§<strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>çš„æ¦‚å¿µäº†ã€‚æ‰€è°“<strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>å…¶å®å°±æ˜¯äººå·¥åœ°å¯¹æ‰€éœ€å­—æ®µè¿›è¡Œæ’åºï¼Œåœ¨ç³»ç»Ÿçš„é»˜è®¤æ’åºåŸºç¡€ä¸Šåšç¬¬äºŒæ¬¡çš„æ’åºã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p><strong><em>äºŒæ¬¡æ’åºï¼ˆSecondary Sortï¼‰</em></strong>æ¦‚å¿µä¸Šä¸éš¾ç†è§£ï¼Œæ— éå°±æ˜¯è‡ªè¡Œå¤šåšä¸€æ¬¡ç‰¹å®šçš„æ’åºã€‚å¯æ˜¯è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿæ€ä¹ˆåœ¨map-reduceçš„æµç¨‹æ¡†æ¡†å†…å¯¹Valueè¿›è¡Œäººå·¥æ’åºå‘¢ï¼Ÿ å…¶å®å…³é”®æŠ€å·§å°±æ˜¯åˆ©ç”¨map-reduceä¼šå¯¹Keyæ’åºçš„ç‰¹ç‚¹ï¼Œè®©å®ƒâ€œé¡ºå¸¦â€å¯¹Valueè¿›è¡Œæ’åºã€‚ä¸ºäº†è¾¾åˆ°è¿™ç§â€œé¡ºå¸¦â€çš„æ•ˆæœï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°†åŸå§‹æ•°æ®ä¸­çš„Keyï¼ˆMovieIDï¼‰å’ŒValueï¼ˆratingï¼‰åˆå¹¶åˆ°ä¸€èµ·ä½œä¸ºæ–°çš„Keyï¼ˆMovieBeanï¼‰ï¼ŒåŒæ—¶ä»ç„¶ä¿æŒåŸValueï¼ˆratingï¼‰ä½œä¸ºValueã€‚å½“ç³»ç»Ÿå¯¹è¿™ä¸ªåˆå¹¶çš„Keyï¼ˆMovieBeanï¼‰æŒ‰ç…§æŸç§ç‰¹æ€§è¿›è¡Œæ’åºæ—¶ï¼Œå…¶å¯¹åº”çš„Valueä¹Ÿä¼šè¢«ç›¸åº”åœ°â€œæ’åºâ€ï¼ˆå› ä¸ºmapç«¯è¾“å‡ºæ—¶ï¼ŒKeyå’ŒValueæ˜¯ä¸€ä¸ªæ•´ä½“æ•°æ®ç»“æ„ï¼‰</strong>ï¼Œä¸ºæ­¤æˆ‘ä»¬åº”è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰çš„Beanç±»ã€‚</p><pre><code>/** * è‡ªå®šä¹‰çš„MovieBeanç±», å°†åŸå§‹æ•°æ®ä¸­çš„Keyå’ŒValueåˆå¹¶åˆ°ä¸€ä¸ªç±»ä¸­ã€‚ */public class MovieBean implements WritableComparable&lt;MovieBean&gt;{    public Text movieID;    public DoubleWritable score;    public MovieBean() {    }    public MovieBean(Text movieID, DoubleWritable score) {        this.movieID = movieID;        this.score = score;    }    public void set(Text movieID, DoubleWritable score) {        this.movieID = movieID;        this.score = score;    }    public Text getMovieID() {        return movieID;    }    public void setMovieID(Text movieID) {        this.movieID = movieID;    }    public DoubleWritable getScore() {        return score;    }    public void setScore(DoubleWritable score) {        this.score = score;    }    @Override    public String toString() {        return &quot;movieID=&quot; + movieID +                &quot;, score=&quot; + score;    }    /**     * é‡ç‚¹! åˆ©ç”¨è‡ªå®šä¹‰çš„compareToæ–¹æ³•å®ç°æ’åºæ•ˆæœ!     * @param o object of MovieBean     * @return result of comparison     */    @Override    public int compareTo(MovieBean o) {        if(o == null) {            throw new RuntimeException();        }        // movieIDç›¸åŒæ—¶, æŒ‰ç…§scoreè¿›è¡Œé™åºæ’åº        if(this.movieID.compareTo(o.getMovieID()) == 0) {            return -score.compareTo(o.getScore());        }        // movieIDä¸ç›¸åŒæ—¶, ç›´æ¥æŒ‰ç…§MovieIDæ’åº        return this.movieID.compareTo(o.getMovieID());    }    /**     * @param dataOutput åºåˆ—åŒ–è¾“å‡º     */    @Override    public void write(DataOutput dataOutput) throws IOException {        dataOutput.writeUTF(movieID.toString());        dataOutput.writeDouble(score.get());    }    /**     * @param dataInput åºåˆ—åŒ–è¾“å…¥     */    @Override    public void readFields(DataInput dataInput) throws IOException {        movieID = new Text(dataInput.readUTF());        score = new DoubleWritable(dataInput.readDouble());    }}</code></pre><p>æœ‰äº†è¿™ä¸ªè‡ªå®šä¹‰çš„<strong><em>MovieBean</em></strong>ç±»ä½œä¸ºæ–°çš„Keyåï¼ŒMapperç«¯çš„è¾“å‡ºå°±ä»åŸæ¥çš„ <strong><em>\&lt;MovieID, Rating&gt;</em></strong>é”®å€¼å¯¹è½¬æ¢æˆäº†<strong><em>\&lt;MovieBean, Rating&gt;</em></strong>é”®å€¼å¯¹ã€‚</p><pre><code>&lt;MovieID, Rating&gt;  =&gt;  &lt;(MovieID, Rating), Rating&gt;</code></pre><p>é‚£ä¹ˆReducerç«¯æ¥æ”¶åˆ°çš„å°†æ˜¯å¤§é‡çš„<strong><em>\&lt;MovieBean, Rating&gt;</em></strong>æ•°æ®ã€‚æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼Œå½“æˆ‘ä»¬çš„Keyæ˜¯<strong>ç®€å•ç±»å‹</strong>æ—¶ï¼ˆå¦‚IntWritableï¼ŒTextï¼ŒDoubleWritableï¼‰ï¼Œå¾ˆè‡ªç„¶å°±èƒ½å°†å¤šä¸ªK-Vå¯¹ä¸­ç›¸åŒçš„Keyæå–å‡ºæ¥ï¼Œä¸”å°†å¤šä¸ªValueåˆå¹¶æˆä¸€ä¸ªé›†åˆï¼Œæ„æˆReducerç«¯çš„è¾“å…¥æ•°æ®ç»“æ„<strong><em>\&lt;Key, List></em></strong>ã€‚ä½†æ˜¯å½“æˆ‘ä»¬çš„Keyæ˜¯å¤åˆç±»å‹ï¼Œä¾‹å¦‚MovieBeanæ˜¯MovieIDå’ŒRatingçš„å¤åˆç»“æ„æ—¶ï¼Œ<strong>å³ä½¿ä¸¤ä¸ªMovieBeanå¯¹è±¡çš„MovieIDç›¸åŒï¼Œä½†è¿™ä¸¤ä¸ªMovieBeanå´æ˜¯ä¸ä¼šè¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„ã€‚</strong></p><pre><code>// 1å·K-Vå¯¹&lt;(&quot;0001&quot;, 85.0), 85.0&gt;// 2å·K-Vå¯¹&lt;(&quot;0001&quot;, 68.0), 68.0&gt;// Reduceræ¥æ”¶åˆ°ä»¥ä¸Šä¸¤ä¸ªK-Vå¯¹åï¼Œå¹¶ä¸ä¼šæŠŠå®ƒä»¬åˆå¹¶æˆ&lt;MovieBean, List&lt;Value&gt;&gt;çš„æ•°æ®ç»“æ„// å› ä¸ºä¸¤ä¸ªK-Vå¯¹çš„Keyï¼ˆMovieBeanï¼‰å¹¶ä¸ç›¸åŒ</code></pre><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©ReduceræŠŠç›¸åŒMovieIDçš„MovieBeanå½“æˆæ˜¯ä¸€æ ·çš„Keyï¼Œç»§è€ŒæŠŠç›¸åŒMovieIDæ‰€å¯¹åº”çš„Ratingsåˆå¹¶æˆ<strong><em>\&lt;MovieBean, List></em></strong>ç»“æ„ï¼Œ<strong>æˆ‘ä»¬éœ€è¦é€šè¿‡å®ç°è‡ªå®šä¹‰çš„GroupingComparatoræ¥ _æ¬ºéª—_ Reducerã€‚</strong></p><pre><code>/** * è‡ªå®šä¹‰çš„GroupingComparator */public class MovieGroupingComparator extends WritableComparator {    /**     * æ„é€ å‡½æ•°, å‘ŠçŸ¥è‡ªå®šä¹‰Beanç±»     */    protected MovieGroupingComparator() {        super(MovieBean.class, true);    }    /**     * é‡å†™WritableComparatoræ¥å£çš„compareæ–¹æ³•(ç±»ä¼¼äºæ™®é€šComparatoræ¥å£)     * @param a movieA     * @param b movieB     * @return result of comparison     */    @Override    public int compare(WritableComparable a, WritableComparable b) {        MovieBean movieA = (MovieBean) a;        MovieBean movieB = (MovieBean) b;        // åªæ¯”è¾ƒä¸¤ä¸ªMovieBeançš„MovieID, å¿½ç•¥å…¶ä»–å±æ€§        return movieA.getMovieID().compareTo(movieB.getMovieID());    }}</code></pre><p>å®ç°ä»¥ä¸Šçš„è‡ªå®šä¹‰GroupingComparatoræ—¶ï¼Œæˆ‘ä»¬åœ¨compareæ–¹æ³•ä¸­åªè€ƒè™‘<strong><em>MovieID</em></strong>è¿™ä¸€ä¸ªå±æ€§ï¼Œç­‰åŒäº<strong>_æ¬ºéª—_</strong>äº†Reducerã€‚Reduceråˆ¤æ–­ä¸¤ä¸ªKeyæ˜¯å¦ç›¸åŒæ—¶<strong>åªè€ƒè™‘MovieIDæ˜¯å¦ç›¸åŒ</strong>ï¼Œä»è€Œå°†ä¸åŒçš„MovieBeanå¯¹è±¡æŠ½å–æˆä¸€ä¸ªç»Ÿä¸€çš„MovieBeanä½œä¸ºReducerçš„è¾“å…¥Keyï¼Œå³å¯é¡ºåˆ©åˆå¹¶å‡º<strong><em>\&lt;MovieBean, List></em></strong>è¿™æ ·çš„æ•°æ®ç»“æ„ã€‚</p><pre><code>// example// å‡è®¾Reducer0æ¥æ”¶åˆ°äº†ä»¥ä¸‹K-Vå¯¹&lt;(&quot;0001&quot;, 89.0), 89.0&gt;&lt;(&quot;0001&quot;, 76.8), 76.8&gt;&lt;(&quot;0001&quot;, 69.5), 69.5&gt;&lt;(&quot;0001&quot;, 69.3), 69.3&gt;// ç”±äºcompareæ–¹æ³•åªæ¯”è¾ƒMovieBeanä¸­çš„MovieIDå±æ€§, å®Œå…¨å¿½ç•¥Rating, æ‰€ä»¥// ä»¥ä¸Š4ä¸ªK-Vå¯¹ä¸­çš„MovieBeanå‡ä¼šè¢«è§†ä½œä¸€æ ·çš„Keyï¼Œæœ€ç»ˆåˆå¹¶æˆçš„æ•°æ®ç»“æ„å¦‚ä¸‹// (ä¸ºä»€ä¹ˆæ˜¯æœ‰åºçš„, å› ä¸ºåœ¨mapç«¯çš„spillè¿‡ç¨‹ä¸­å·²ç»ä¾ç…§ratingé™åºæ’åˆ—äº†,å‚è€ƒMovieBean// ç±»ä¸­é‡å†™çš„compareToæ–¹æ³•)&lt; Key, List&lt;Value&gt;&gt;&lt;(&quot;0001&quot;, 89.0), [89.0, 76.8, 69.5, 69.3]&gt;</code></pre><h2 id="ä½œä¸šæäº¤"><a href="#ä½œä¸šæäº¤" class="headerlink" title="ä½œä¸šæäº¤"></a>ä½œä¸šæäº¤</h2><p>è‡³æ­¤ï¼ŒäºŒæ¬¡æ’åºä¸­æ‰€æœ‰è‡ªå®šä¹‰çš„å·¥ä½œå·²ç»å®Œæˆã€‚<strong>ä½†æ˜¯åƒä¸‡ä¸è¦å¿˜è®°åœ¨æäº¤Jobä¹‹å‰ï¼Œç»™Jobè®¾ç½®ä»¥ä¸Šè‡ªå®šä¹‰GroupingComparator</strong>ï¼Œå¦åˆ™Jobä¼šä½¿ç”¨å†…ç½®é»˜è®¤çš„GroupingComparatorï¼Œé‚£æˆ‘ä»¬çš„äºŒæ¬¡æ’åºå°±æ— æ³•ç”Ÿæ•ˆäº†ã€‚</p><pre><code>movieJob.setGroupingComparatorClass(MovieGroupingComparator.class);</code></pre><p>å¦å¤–ï¼Œ<strong>å¦‚æœéœ€è¦è‡ªå®šä¹‰Reduceræ•°é‡</strong>ï¼ˆä¾‹å¦‚æœ‰æ—¶å¸Œæœ›è¾“å‡ºNä¸ªç»“æœæ–‡ä»¶ï¼Œåˆ™éœ€è¦Nä¸ªReducerï¼‰ï¼Œè¿˜è¦è‡ªå®šä¹‰Partitionerã€‚Partitionerçš„ä½œç”¨ç®€å•æ¥è¯´å°±æ˜¯ç»™Mapperç«¯äº§ç”Ÿçš„K-Vå¯¹æ‰“ä¸Šä¸€ä¸ª<strong><em>partition id</em></strong>çƒ™å°ï¼Œè®©ç³»ç»ŸçŸ¥é“è¿™ä¸ªK-Vå¯¹åº”è¯¥è¢«å“ªä¸ªReducerå–èµ°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ<strong>å¦‚æœ‰éœ€è¦ï¼ˆä¸æ˜¯å¿…é¡»ï¼‰</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§MovieIDè¿›è¡Œåˆ’åˆ†ï¼Œä¸åŒMovieIDçš„K-Vå¯¹åˆ’åˆ†åˆ°ä¸åŒçš„Reducerä¸Šè¿›è¡Œå¤„ç†ã€‚</p><pre><code>/** * è‡ªå®šä¹‰Partitioner, ç”¨äºåˆ’åˆ†K-Vå¯¹è¢«å“ªä¸ªReducerå–èµ° */public class MoviePartitioner extends Partitioner&lt;MovieBean, DoubleWritable&gt; {    @Override    public int getPartition(MovieBean movieBean, DoubleWritable doubleWritable, int numReducers) {        // ç›¸åŒMovieIDçš„å¿…å®šä¼šåˆ°åŒä¸€ä¸ªReducerä¸Š        return movieBean.getMovieID().hashCode() % numReducers;    }}</code></pre><p>æœ€åç»™Jobè®¾å®šè‡ªå®šä¹‰çš„Reduceræ•°ï¼Œå³å¯å¯åŠ¨Nä¸ªReducerè¿›è¡Œæ•°æ®å¤„ç†ã€‚</p><pre><code>final int NUM_REDUCE_TASK = 5;movieJob.setNumReduceTasks(NUM_REDUCE_TASK);</code></pre><p><img src="/Users/marco/Desktop/ss.png" alt=""></p><p>å•Reducerè¿è¡Œç»“æœ</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½¿ç”¨SecondarySortå¯ä»¥ä½¿æˆ‘ä»¬åœ¨Map-Reduceæ¡†æ¶å†…å®Œæˆè‡ªå®šä¹‰æ’åºã€‚ä¾æ‰˜Map-Reduceä¼šå¯¹Keyè¿›è¡Œæ’åºçš„ç‰¹æ€§ï¼Œå¯ä»¥å°†éœ€è¦æ’åºçš„å­—æ®µï¼ˆValueï¼‰ä¸åŸå§‹Keyåˆæˆä¸ºè‡ªå®šä¹‰çš„Beanä½œä¸ºæ–°çš„Keyï¼ŒåŸValueä¿æŒä¸åŠ¨ã€‚æœ‰äº†SecondarySortï¼Œæˆ‘ä»¬å°±ä¸å¿…åœ¨æ¡†æ¶å¤–åšé¢å¤–çš„å·¥ä½œè¿›è¡Œæ’åºï¼Œå¹²æ‰°ç¨‹åºçš„å¯è¯»æ€§ï¼›ä¹Ÿä¸å¿…å°†åŸå§‹Keyå’ŒValueå¯¹æ¢ï¼Œå½±å“è¾“å‡ºæ ¼å¼ã€‚</p><h2 id="ä»£ç åœ°å€"><a href="#ä»£ç åœ°å€" class="headerlink" title="ä»£ç åœ°å€"></a>ä»£ç åœ°å€</h2><p><a href="https://github.com/AcepcsMa/hadoop_examples/tree/master/src/sort" target="_blank" rel="noopener">Github-Secondary Sort</a></p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bigdata </tag>
            
            <tag> hadoop </tag>
            
            <tag> mapreduce </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>åˆ©ç”¨ZooKeeperå¼€å‘æœåŠ¡å™¨ä¸Šä¸‹çº¿æ„ŸçŸ¥ç¨‹åº</title>
      <link href="/2018/02/13/zkserver/"/>
      <url>/2018/02/13/zkserver/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…¨æ–‡ä¸ºæœ¬äººï¼ˆHaoxiang Maï¼‰åŸåˆ›å†…å®¹ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„ã€‚</p></blockquote><h2 id="What-is-ZooKeeper"><a href="#What-is-ZooKeeper" class="headerlink" title="What is ZooKeeper"></a>What is ZooKeeper</h2><p>ZooKeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ã€‚ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯ç”¨äºåè°ƒç®¡ç†å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå·¥å…·ï¼Œæ‰®æ¼”ç€ä¸€ä¸ªç¬¬ä¸‰æ–¹ç®¡ç†è€…çš„è§’è‰²ã€‚</p><h2 id="é—®é¢˜èƒŒæ™¯åˆ†æ"><a href="#é—®é¢˜èƒŒæ™¯åˆ†æ" class="headerlink" title="é—®é¢˜èƒŒæ™¯åˆ†æ"></a>é—®é¢˜èƒŒæ™¯åˆ†æ</h2><p>å‡è®¾ç°åœ¨æœ‰<strong>10</strong>ä¸ªåº”ç”¨ç¨‹åº(App#0 - App#9)ï¼Œè¿è¡Œåœ¨ç”±<strong>10</strong>å°æœåŠ¡å™¨(Server#0 - Server#9)ç»„æˆçš„é›†ç¾¤ä¸Šï¼ˆå‡è®¾å¹³å‡åˆ†é…ï¼Œæ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œä¸€ä¸ªç¨‹åºï¼‰ã€‚æ­¤æ—¶ç”±äºæŸä¸ªçƒ­é—¨çº¿ä¸Šæ´»åŠ¨çš„å¼€å§‹ï¼ˆå¦‚æŠ¢ç¥¨orä½ä»·ç§’æ€ç­‰ï¼‰ï¼Œçªç„¶é—´æœ‰æ•°ä»¥ç™¾ä¸‡è®¡çš„ç”¨æˆ·è®¿é—®æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œç­‰å¾…æœåŠ¡å™¨å¤„ç†å¹¶åº”ç­”ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/server.png" alt=""></p><p>å¾ˆä¸å¹¸<strong>10</strong>å°æœåŠ¡å™¨ä¸­æœ‰<strong>K</strong>å°å—ä¸ä½è´Ÿè½½å‹åŠ›ï¼Œå¯¼è‡´æœåŠ¡å™¨å´©æºƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯æ— æ³•æ„ŸçŸ¥æœåŠ¡å™¨çš„çŠ¶æ€ï¼ˆåœ¨çº¿ï¼ç¦»çº¿ï¼‰ï¼Œéƒ¨åˆ†å‘å·²ç»å´©æºƒçš„æœåŠ¡å™¨å‘é€è¯·æ±‚çš„å®¢æˆ·ç«¯å°†ä¼šæœ‰é•¿æ—¶é—´æ— æ³•è·å¾—åº”ç­”ï¼Œå®ƒä»¬åªèƒ½ä¸€ç›´é‡å¤åœ°å‘å·²ç»å´©æºƒçš„æœåŠ¡å™¨åœ°å€é‡å‘è¯·æ±‚ï¼Œæ— æ³•åˆ‡æ¢è‡³å¦å¤–<strong>ï¼ˆ10-Kï¼‰</strong>å°å®Œå¥½çš„æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/breakdown.png" alt=""></p><p>å…¶å®åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯èƒ½å¤ŸåŠæ—¶åœ°æ„ŸçŸ¥åˆ°é›†ç¾¤ä¸­å“ªäº›èŠ‚ç‚¹å·²ç»å´©æºƒï¼Œå“ªäº›èŠ‚ç‚¹ä»ç„¶å®Œå¥½ï¼Œæ˜¯å¯ä»¥åˆ‡æ¢è‡³å®Œå¥½çš„èŠ‚ç‚¹å¹¶å‘å…¶å‘é€è¯·æ±‚çš„ã€‚ç†è®ºä¸Šåªè¦é›†ç¾¤ä¸­ä»æœ‰1ä¸ªèŠ‚ç‚¹æ˜¯å®Œå¥½çš„ï¼Œå®ƒå³èƒ½å‘å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚</p><p><strong><em>æ‰€ä»¥æ•´ä¸ªé—®é¢˜çš„ç—‡ç»“å°±åœ¨äºï¼Œå¦‚ä½•è®©å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°æœåŠ¡å™¨ä¸Šä¸‹çº¿çŠ¶æ€ï¼Œä»¥ä¾¿åˆ‡æ¢è¯·æ±‚å‘é€çš„åœ°å€ã€‚</em></strong></p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/zk.png" alt=""></p><p>é‡æ–°å‚è€ƒZooKeeperçš„åŠŸèƒ½æè¿°ï¼ŒZooKeeperå¯ä»¥ç”¨æ¥åè°ƒç®¡ç†å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œé‚£å…¶å®å¯ä»¥ç”¨äºç®¡ç†æˆ‘ä»¬çš„åˆ†å¸ƒå¼æœºå™¨é›†ç¾¤ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<strong>åœ¨ç”¨æˆ·å’ŒæœåŠ¡å™¨é›†ç¾¤ä¸­é—´å¯è®¾ç½®ZooKeeperå±‚</strong>ï¼Œè®©ZooKeeperå®æ—¶æ„ŸçŸ¥æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç„¶åå®¢æˆ·ç«¯å¹¶ä¸ç›´æ¥å‘å…·ä½“èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œè€Œåº”å…ˆå‘ZooKeeperè¯¢é—®å½“å‰ä»ç„¶å­˜æ´»çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œç„¶åå†ä»ä¸­æŒ‘é€‰ä¸€ä¸ªè´Ÿè½½è¾ƒä½çš„æœåŠ¡å™¨èŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚ç”±äºZooKeeperæœ¬èº«çš„é«˜å¯ç”¨æ€§ï¼ˆæœ¬èº«ä¹Ÿå¯æ‹“å±•ä¸ºåˆ†å¸ƒå¼æ¶æ„ï¼‰ï¼Œæ‰€ä»¥å°±èƒ½å¤§å¤§åœ°æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p><h2 id="ZooKeeperæ•°æ®ç»“æ„"><a href="#ZooKeeperæ•°æ®ç»“æ„" class="headerlink" title="ZooKeeperæ•°æ®ç»“æ„"></a>ZooKeeperæ•°æ®ç»“æ„</h2><p>ZooKeeperæ•°æ®ç»“æ„é‡‡ç”¨äº†æ ‘çŠ¶ç»“æ„ï¼ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼‰ï¼Œä¸”ä¸æ˜¯ç®€å•çš„äºŒå‰æ ‘ï¼Œè€Œæ˜¯å¤šå‰æ ‘ã€‚åœ¨ZooKeeperçš„æ ‘ç»“æ„ä¸­ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹è¢«ç§°ä¸ºznodeï¼Œå¯é€šè¿‡æ§åˆ¶å°å‘½ä»¤æˆ–è€…Javaçš„SDKå¯¹å†…éƒ¨æ•°æ®è¿›è¡Œç®¡ç†ã€‚</p><p>znodeçš„ç±»å‹æœ‰<code>2*2=4</code>ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>PERSISTENT</li><li>PERSISTENT_SEQUENTIAL</li><li>EPHEMERAL</li><li>EPHEMERAL_SEQUENTIAL</li></ul><p>å…¶ä¸­<strong><em>PERSISTENT</em></strong>å’Œ<strong><em>EPHEMERAL</em></strong>çš„åŒºåˆ«æ­£å¦‚å…¶åï¼Œåœ¨æ— å¤–åŠ›å½±å“ä¸‹<strong><em>PERSISTENT</em></strong>èŠ‚ç‚¹ä¸ä¼šè¢«æ”¹å˜å’Œåˆ é™¤ï¼Œè€Œ<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹åœ¨åˆ›å»ºèŠ‚ç‚¹çš„sessionç»“æŸåä¼šè‡ªåŠ¨ä»æ ‘ä¸­åˆ é™¤ã€‚è‡³äº<strong><em>SEQUENTIAL</em></strong>ä¸<strong><em>éSEQUENTIAL</em></strong>åˆ™å½±å“äº†èŠ‚ç‚¹idè‡ªå¢ï¼Œ<strong><em>SEQUENTIAL</em></strong>èŠ‚ç‚¹çš„idä¼šè‡ªåŠ¨éµå¾ªçˆ¶èŠ‚ç‚¹ä¸‹çš„è‡ªå¢è§„åˆ™è¿›è¡Œå‘½åã€‚</p><p><img src="https://blog-image-1253224514.cos.ap-guangzhou.myqcloud.com/zkds.png" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨æœ¬é—®é¢˜ä¸­æˆ‘ä»¬å¯ä»¥æŠŠä¸€å°æœåŠ¡å™¨çœ‹ä½œæ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹çš„è¿™ä¸€ç‰¹æ€§è¿›è¡ŒæœåŠ¡å™¨çŠ¶æ€çš„ç›‘å¬ã€‚æœåŠ¡å™¨ä¸Šçº¿æ—¶åˆ›å»ºä¸zkä¹‹é—´çš„sessionå¹¶å‘zkæ³¨å†ŒèŠ‚ç‚¹ï¼Œåªè¦æœåŠ¡å™¨ä¸å´©æºƒï¼Œsessionä¾¿ä¸ä¼šç»“æŸï¼Œå³<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¯è¢«å®¢æˆ·ç«¯æ„ŸçŸ¥ï¼›å½“æœåŠ¡å™¨å´©æºƒæ—¶ï¼Œå…¶ä¸zkä¹‹é—´ä¿æŒçš„sessionè‡ªç„¶ä¹Ÿä¼šç»“æŸï¼Œ<strong><em>EPHEMERAL</em></strong>èŠ‚ç‚¹ä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œå®¢æˆ·ç«¯æŸ¥è¯¢æœåŠ¡å™¨åˆ—è¡¨æ—¶ç»å¯¹æ— æ³•è·å¾—å·²åˆ é™¤çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚</p><h2 id="Demoç¨‹åº"><a href="#Demoç¨‹åº" class="headerlink" title="Demoç¨‹åº"></a>Demoç¨‹åº</h2><ul><li><strong><em>Server.java (æœåŠ¡å™¨ç«¯ä»£ç )</em></strong></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> my.bigdata.zk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST_ADDRESS = <span class="string">"localhost:2181"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_TIMEOUT = <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SERVER_PARENT = <span class="string">"/servers"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ZooKeeper zkConnect = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿æ¥è‡³ZooKeeper</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">zkConnect = <span class="keyword">new</span> ZooKeeper(HOST_ADDRESS, DEFAULT_TIMEOUT, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">System.out.println(<span class="string">"Type:"</span> + watchedEvent.getType()</span><br><span class="line">+ <span class="string">" Path:"</span> + watchedEvent.getPath());</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘ZooKeeperæ³¨å†Œæœ¬æœåŠ¡å™¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data æœåŠ¡å™¨ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">String create = zkConnect.create(DEFAULT_SERVER_PARENT + <span class="string">"/server"</span>,</span><br><span class="line">data.getBytes(),</span><br><span class="line">ZooDefs.Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">CreateMode.EPHEMERAL_SEQUENTIAL);<span class="comment">// æ³¨å†ŒæˆephemeralèŠ‚ç‚¹ä»¥ä¾¿è‡ªåŠ¨åœ¨zkä¸Šæ³¨é”€</span></span><br><span class="line">System.out.println(create + <span class="string">" is registered!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡sleepæ¨¡æ‹ŸæœåŠ¡å™¨åœ¨çº¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿æ¥è‡³zk</span></span><br><span class="line">Server server = <span class="keyword">new</span> Server();</span><br><span class="line">server.connect();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘zkæ³¨å†ŒæœåŠ¡å™¨ä¿¡æ¯</span></span><br><span class="line">String data = args[<span class="number">0</span>];</span><br><span class="line">server.register(data);</span><br><span class="line"></span><br><span class="line">server.sleep();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯çš„é‡ç‚¹åœ¨äºï¼Œç¨‹åºå¯åŠ¨æ—¶å‘ZooKeeperçš„æŒ‡å®šèŠ‚ç‚¹ä¸‹æ³¨å†ŒæœåŠ¡å™¨ä¿¡æ¯ï¼Œç›¸å½“äºé€šçŸ¥ZooKeeperè¿™ä¸ªç¬¬ä¸‰æ–¹ï¼šâ€œæœåŠ¡å™¨å·²ä¸Šçº¿â€ã€‚å…¶æ¬¡ï¼Œæ³¨å†Œçš„èŠ‚ç‚¹ç±»å‹å¿…é¡»æ˜¯<strong>ephemeral</strong>èŠ‚ç‚¹ï¼Œä¸ºäº†å®ç°èŠ‚ç‚¹idè‡ªå¢(auto-increment)è¿˜å¯ä»¥ä½¿ç”¨<strong>ephemeral_sequential</strong>èŠ‚ç‚¹ã€‚</p><ul><li><strong><em>Client.java (å®¢æˆ·ç«¯ä»£ç )</em></strong></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> my.bigdata.zk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST_ADDRESS = <span class="string">"localhost:2181"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_TIMEOUT = <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SERVER_PARENT = <span class="string">"/servers"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ZooKeeper zkConnect = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; availableServers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿æ¥è‡³ZooKeeper</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">zkConnect = <span class="keyword">new</span> ZooKeeper(HOST_ADDRESS, DEFAULT_TIMEOUT, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">updateServerCondition();<span class="comment">// é‡å¤æ³¨å†Œ</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘zkæŸ¥è¯¢æœåŠ¡å™¨æƒ…å†µ, å¹¶updateæœ¬åœ°æœåŠ¡å™¨åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateServerCondition</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">List&lt;String&gt; children = zkConnect.getChildren(DEFAULT_SERVER_PARENT, <span class="keyword">true</span>);</span><br><span class="line">List&lt;String&gt; servers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(String child : children) &#123;</span><br><span class="line"><span class="keyword">byte</span>[] data = zkConnect.getData(DEFAULT_SERVER_PARENT + <span class="string">"/"</span> + child,</span><br><span class="line"><span class="keyword">false</span>,</span><br><span class="line"><span class="keyword">null</span>);</span><br><span class="line">servers.add(<span class="keyword">new</span> String(data));</span><br><span class="line">&#125;</span><br><span class="line">availableServers = servers;</span><br><span class="line">System.out.println(Arrays.toString(servers.toArray(<span class="keyword">new</span> String[<span class="number">0</span>])));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡sleepè®©å®¢æˆ·ç«¯æŒç»­è¿è¡Œï¼Œæ¨¡æ‹Ÿ"ç›‘å¬"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"client is working"</span>);</span><br><span class="line">Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿æ¥zk</span></span><br><span class="line">Client client = <span class="keyword">new</span> Client();</span><br><span class="line">client.connect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–serversèŠ‚ç‚¹ä¿¡æ¯ï¼ˆå¹¶ç›‘å¬ï¼‰ï¼Œä»ä¸­è·å–æœåŠ¡å™¨ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line">client.updateServerCondition();</span><br><span class="line"></span><br><span class="line">client.sleep();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯çš„é‡ç‚¹åœ¨äºï¼Œå®ƒä¸æ–­åœ°å‘ZooKeeperæŸä¸ªç‰¹å®šèŠ‚ç‚¹ï¼ˆæ­¤å¤„æ˜¯serversèŠ‚ç‚¹ï¼‰æ³¨å†Œäº†ä¸€ä¸ª<strong>Watcher</strong>ï¼Œé‚£ä¹ˆä¸€æ—¦è¯¥èŠ‚ç‚¹ä¸‹çš„ç»“æ„å‘ç”Ÿæ”¹å˜ï¼ŒZooKeeperä¼šå‘æ³¨å†Œäº†<strong>Watcher</strong>çš„å®¢æˆ·ç«¯å‘é€â€œçŠ¶æ€å˜åŒ–â€çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å³å¯åŠ¨æ€åœ°ä»ZooKeeperä¸­è·å–æœ€æ–°çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”šè‡³æ— éœ€â€œä¸»åŠ¨â€è¯¢é—®ã€‚</p><p>å½“ç„¶ï¼ŒZooKeeperçš„åº”ç”¨åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œè€ƒè™‘åˆ°å®ƒæœ¬èº«ä¹Ÿå¯æ‹“å±•ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨ï¼Œåœ¨è¿™ç§é«˜å¯ç”¨æ€§ä¿è¯ä¸‹å®ƒç®€ç›´å°±æ˜¯å¤šä¸ªåˆ†å¸ƒå¼åº”ç”¨çš„ä¸‡èƒ½ç®¡å®¶å’Œåè°ƒè€…ğŸ˜Šã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bigdata </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
